<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AGou&#39;s Docs-v2</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="https://infinitypro-img.infinitynewtab.com/custom-icon/8001de1jd3n68lbfnxxt564xvb0vl5.png?imageMogr2/thumbnail/240x/format/webp/blur/1x0/quality/100|imageslim">
    <script language="javascript" type="text/javascript" src="https://cdn.staticfile.org/jquery/1.7.2/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-2DZCW6NJZF"></script>
    <script language="javascript" type="text/javascript" content="function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag(&quot;js&quot;,new Date),gtag(&quot;config&quot;,&quot;G-2DZCW6NJZF&quot;);"></script>
    <meta name="description" content="岂能尽如人意，但求无愧我心。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/myDocsv2/assets/css/0.styles.21bb8301.css" as="style"><link rel="preload" href="/myDocsv2/assets/js/app.792c833e.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/5.dd197eb6.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/1.3bd7010a.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/2.0c757b52.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/41.1b06014c.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/17.ce9a229a.js" as="script"><link rel="prefetch" href="/myDocsv2/assets/js/10.560f0585.js"><link rel="prefetch" href="/myDocsv2/assets/js/100.d260e792.js"><link rel="prefetch" href="/myDocsv2/assets/js/101.59a52c3b.js"><link rel="prefetch" href="/myDocsv2/assets/js/102.c83fe080.js"><link rel="prefetch" href="/myDocsv2/assets/js/103.486f1569.js"><link rel="prefetch" href="/myDocsv2/assets/js/104.147ef422.js"><link rel="prefetch" href="/myDocsv2/assets/js/105.7cdddb7f.js"><link rel="prefetch" href="/myDocsv2/assets/js/106.6bb6504a.js"><link rel="prefetch" href="/myDocsv2/assets/js/107.958c4a2e.js"><link rel="prefetch" href="/myDocsv2/assets/js/108.89dea5fa.js"><link rel="prefetch" href="/myDocsv2/assets/js/109.25e918a2.js"><link rel="prefetch" href="/myDocsv2/assets/js/11.30085370.js"><link rel="prefetch" href="/myDocsv2/assets/js/110.5b72de31.js"><link rel="prefetch" href="/myDocsv2/assets/js/111.950db23b.js"><link rel="prefetch" href="/myDocsv2/assets/js/112.dea68ec6.js"><link rel="prefetch" href="/myDocsv2/assets/js/113.4cd2fdf5.js"><link rel="prefetch" href="/myDocsv2/assets/js/114.8fb68b8d.js"><link rel="prefetch" href="/myDocsv2/assets/js/115.853e9eac.js"><link rel="prefetch" href="/myDocsv2/assets/js/116.370ed12f.js"><link rel="prefetch" href="/myDocsv2/assets/js/117.e54ab1d2.js"><link rel="prefetch" href="/myDocsv2/assets/js/118.f875192d.js"><link rel="prefetch" href="/myDocsv2/assets/js/119.130ba6df.js"><link rel="prefetch" href="/myDocsv2/assets/js/12.bad43817.js"><link rel="prefetch" href="/myDocsv2/assets/js/120.ea722a75.js"><link rel="prefetch" href="/myDocsv2/assets/js/121.e6b1a38f.js"><link rel="prefetch" href="/myDocsv2/assets/js/122.cfa9c92b.js"><link rel="prefetch" href="/myDocsv2/assets/js/123.bd0e517c.js"><link rel="prefetch" href="/myDocsv2/assets/js/124.516b8976.js"><link rel="prefetch" href="/myDocsv2/assets/js/125.aa9491a0.js"><link rel="prefetch" href="/myDocsv2/assets/js/126.249ad6f3.js"><link rel="prefetch" href="/myDocsv2/assets/js/127.15e07998.js"><link rel="prefetch" href="/myDocsv2/assets/js/128.6e4e1f1d.js"><link rel="prefetch" href="/myDocsv2/assets/js/129.9fa7ef9d.js"><link rel="prefetch" href="/myDocsv2/assets/js/13.4f93795a.js"><link rel="prefetch" href="/myDocsv2/assets/js/130.7ed7958f.js"><link rel="prefetch" href="/myDocsv2/assets/js/131.6a4ed50f.js"><link rel="prefetch" href="/myDocsv2/assets/js/132.60d2ac03.js"><link rel="prefetch" href="/myDocsv2/assets/js/133.657186df.js"><link rel="prefetch" href="/myDocsv2/assets/js/134.de4a0998.js"><link rel="prefetch" href="/myDocsv2/assets/js/135.773bff70.js"><link rel="prefetch" href="/myDocsv2/assets/js/136.03b7adc5.js"><link rel="prefetch" href="/myDocsv2/assets/js/137.e59abdb8.js"><link rel="prefetch" href="/myDocsv2/assets/js/138.b00ee386.js"><link rel="prefetch" href="/myDocsv2/assets/js/139.11d16ca5.js"><link rel="prefetch" href="/myDocsv2/assets/js/14.5b43ffdb.js"><link rel="prefetch" href="/myDocsv2/assets/js/140.d2461af0.js"><link rel="prefetch" href="/myDocsv2/assets/js/141.51a02429.js"><link rel="prefetch" href="/myDocsv2/assets/js/142.de00d6b2.js"><link rel="prefetch" href="/myDocsv2/assets/js/143.2e00599f.js"><link rel="prefetch" href="/myDocsv2/assets/js/144.d91b742b.js"><link rel="prefetch" href="/myDocsv2/assets/js/145.fd4eeb59.js"><link rel="prefetch" href="/myDocsv2/assets/js/146.2da768b9.js"><link rel="prefetch" href="/myDocsv2/assets/js/147.2392d1bd.js"><link rel="prefetch" href="/myDocsv2/assets/js/148.3f9f1e85.js"><link rel="prefetch" href="/myDocsv2/assets/js/149.ccc77b35.js"><link rel="prefetch" href="/myDocsv2/assets/js/15.567b35e8.js"><link rel="prefetch" href="/myDocsv2/assets/js/150.bc27fad5.js"><link rel="prefetch" href="/myDocsv2/assets/js/151.8d88bccd.js"><link rel="prefetch" href="/myDocsv2/assets/js/152.2f8b753c.js"><link rel="prefetch" href="/myDocsv2/assets/js/153.3e99f777.js"><link rel="prefetch" href="/myDocsv2/assets/js/154.28a03309.js"><link rel="prefetch" href="/myDocsv2/assets/js/155.d31e6da9.js"><link rel="prefetch" href="/myDocsv2/assets/js/156.dbbb018d.js"><link rel="prefetch" href="/myDocsv2/assets/js/157.dacf2c34.js"><link rel="prefetch" href="/myDocsv2/assets/js/158.92d5a5c7.js"><link rel="prefetch" href="/myDocsv2/assets/js/159.163e1ce5.js"><link rel="prefetch" href="/myDocsv2/assets/js/16.246dc068.js"><link rel="prefetch" href="/myDocsv2/assets/js/160.f6373d44.js"><link rel="prefetch" href="/myDocsv2/assets/js/161.1ee05cbb.js"><link rel="prefetch" href="/myDocsv2/assets/js/162.90d44205.js"><link rel="prefetch" href="/myDocsv2/assets/js/163.0ab9f4cc.js"><link rel="prefetch" href="/myDocsv2/assets/js/164.e7b76b81.js"><link rel="prefetch" href="/myDocsv2/assets/js/165.f4e96a57.js"><link rel="prefetch" href="/myDocsv2/assets/js/166.9da04171.js"><link rel="prefetch" href="/myDocsv2/assets/js/167.7869b189.js"><link rel="prefetch" href="/myDocsv2/assets/js/168.fd171306.js"><link rel="prefetch" href="/myDocsv2/assets/js/169.a3accba0.js"><link rel="prefetch" href="/myDocsv2/assets/js/170.69b8ea3d.js"><link rel="prefetch" href="/myDocsv2/assets/js/171.8519d41a.js"><link rel="prefetch" href="/myDocsv2/assets/js/172.853e162a.js"><link rel="prefetch" href="/myDocsv2/assets/js/173.61f68a82.js"><link rel="prefetch" href="/myDocsv2/assets/js/174.4a6c4ebe.js"><link rel="prefetch" href="/myDocsv2/assets/js/175.4da076f8.js"><link rel="prefetch" href="/myDocsv2/assets/js/176.db59955f.js"><link rel="prefetch" href="/myDocsv2/assets/js/177.8e8a7c16.js"><link rel="prefetch" href="/myDocsv2/assets/js/178.c253fb27.js"><link rel="prefetch" href="/myDocsv2/assets/js/179.5662c8f8.js"><link rel="prefetch" href="/myDocsv2/assets/js/18.42c2a799.js"><link rel="prefetch" href="/myDocsv2/assets/js/180.54165af7.js"><link rel="prefetch" href="/myDocsv2/assets/js/181.e07c952b.js"><link rel="prefetch" href="/myDocsv2/assets/js/182.53626bff.js"><link rel="prefetch" href="/myDocsv2/assets/js/183.b92c4e7a.js"><link rel="prefetch" href="/myDocsv2/assets/js/184.640e2011.js"><link rel="prefetch" href="/myDocsv2/assets/js/185.82c83e0f.js"><link rel="prefetch" href="/myDocsv2/assets/js/186.0e7a9c8a.js"><link rel="prefetch" href="/myDocsv2/assets/js/187.b1279218.js"><link rel="prefetch" href="/myDocsv2/assets/js/188.919e8202.js"><link rel="prefetch" href="/myDocsv2/assets/js/189.12ca6319.js"><link rel="prefetch" href="/myDocsv2/assets/js/19.80fbdf4d.js"><link rel="prefetch" href="/myDocsv2/assets/js/190.0cabf0ec.js"><link rel="prefetch" href="/myDocsv2/assets/js/191.4473c05d.js"><link rel="prefetch" href="/myDocsv2/assets/js/192.cfd1676f.js"><link rel="prefetch" href="/myDocsv2/assets/js/193.be924226.js"><link rel="prefetch" href="/myDocsv2/assets/js/194.28405918.js"><link rel="prefetch" href="/myDocsv2/assets/js/195.895d8931.js"><link rel="prefetch" href="/myDocsv2/assets/js/196.a5074835.js"><link rel="prefetch" href="/myDocsv2/assets/js/197.5ac7add8.js"><link rel="prefetch" href="/myDocsv2/assets/js/198.1243e120.js"><link rel="prefetch" href="/myDocsv2/assets/js/199.1dedd774.js"><link rel="prefetch" href="/myDocsv2/assets/js/20.03b1f0ff.js"><link rel="prefetch" href="/myDocsv2/assets/js/200.47677147.js"><link rel="prefetch" href="/myDocsv2/assets/js/201.ae7c32ad.js"><link rel="prefetch" href="/myDocsv2/assets/js/202.b9ab3aba.js"><link rel="prefetch" href="/myDocsv2/assets/js/203.5716a175.js"><link rel="prefetch" href="/myDocsv2/assets/js/204.0dff0870.js"><link rel="prefetch" href="/myDocsv2/assets/js/205.5722c8b0.js"><link rel="prefetch" href="/myDocsv2/assets/js/206.94ecd56d.js"><link rel="prefetch" href="/myDocsv2/assets/js/207.fbef39ad.js"><link rel="prefetch" href="/myDocsv2/assets/js/208.f033c96a.js"><link rel="prefetch" href="/myDocsv2/assets/js/209.b022ee5b.js"><link rel="prefetch" href="/myDocsv2/assets/js/21.2048f6fd.js"><link rel="prefetch" href="/myDocsv2/assets/js/210.c8278e5f.js"><link rel="prefetch" href="/myDocsv2/assets/js/211.df648ec4.js"><link rel="prefetch" href="/myDocsv2/assets/js/212.c591597e.js"><link rel="prefetch" href="/myDocsv2/assets/js/213.59dd0072.js"><link rel="prefetch" href="/myDocsv2/assets/js/214.4250b8d5.js"><link rel="prefetch" href="/myDocsv2/assets/js/215.06bf9012.js"><link rel="prefetch" href="/myDocsv2/assets/js/216.f9f569dc.js"><link rel="prefetch" href="/myDocsv2/assets/js/217.0d90efa0.js"><link rel="prefetch" href="/myDocsv2/assets/js/218.941f9041.js"><link rel="prefetch" href="/myDocsv2/assets/js/219.087abc3e.js"><link rel="prefetch" href="/myDocsv2/assets/js/22.1468e026.js"><link rel="prefetch" href="/myDocsv2/assets/js/220.4519068e.js"><link rel="prefetch" href="/myDocsv2/assets/js/221.020f293f.js"><link rel="prefetch" href="/myDocsv2/assets/js/222.0eabad26.js"><link rel="prefetch" href="/myDocsv2/assets/js/223.ad574537.js"><link rel="prefetch" href="/myDocsv2/assets/js/224.ae6d0b7a.js"><link rel="prefetch" href="/myDocsv2/assets/js/225.8a723b88.js"><link rel="prefetch" href="/myDocsv2/assets/js/226.7285c5f4.js"><link rel="prefetch" href="/myDocsv2/assets/js/227.a14fc969.js"><link rel="prefetch" href="/myDocsv2/assets/js/228.66daebef.js"><link rel="prefetch" href="/myDocsv2/assets/js/229.6403de74.js"><link rel="prefetch" href="/myDocsv2/assets/js/23.e667901e.js"><link rel="prefetch" href="/myDocsv2/assets/js/230.03323ece.js"><link rel="prefetch" href="/myDocsv2/assets/js/231.f3295fcb.js"><link rel="prefetch" href="/myDocsv2/assets/js/232.9c83055f.js"><link rel="prefetch" href="/myDocsv2/assets/js/233.169da2a3.js"><link rel="prefetch" href="/myDocsv2/assets/js/234.2c098527.js"><link rel="prefetch" href="/myDocsv2/assets/js/235.62700dfa.js"><link rel="prefetch" href="/myDocsv2/assets/js/236.f682323d.js"><link rel="prefetch" href="/myDocsv2/assets/js/237.60773b74.js"><link rel="prefetch" href="/myDocsv2/assets/js/238.fb376db3.js"><link rel="prefetch" href="/myDocsv2/assets/js/239.21fe9787.js"><link rel="prefetch" href="/myDocsv2/assets/js/24.18db0e43.js"><link rel="prefetch" href="/myDocsv2/assets/js/240.412b1fd5.js"><link rel="prefetch" href="/myDocsv2/assets/js/241.eb5e205b.js"><link rel="prefetch" href="/myDocsv2/assets/js/242.1b505ffe.js"><link rel="prefetch" href="/myDocsv2/assets/js/243.07e81cfd.js"><link rel="prefetch" href="/myDocsv2/assets/js/244.82c529d0.js"><link rel="prefetch" href="/myDocsv2/assets/js/245.c3458778.js"><link rel="prefetch" href="/myDocsv2/assets/js/246.66e98887.js"><link rel="prefetch" href="/myDocsv2/assets/js/247.1a0993dd.js"><link rel="prefetch" href="/myDocsv2/assets/js/248.a63069b1.js"><link rel="prefetch" href="/myDocsv2/assets/js/249.dd372d75.js"><link rel="prefetch" href="/myDocsv2/assets/js/25.285160e4.js"><link rel="prefetch" href="/myDocsv2/assets/js/250.eb634570.js"><link rel="prefetch" href="/myDocsv2/assets/js/251.f04a5705.js"><link rel="prefetch" href="/myDocsv2/assets/js/252.6ad19080.js"><link rel="prefetch" href="/myDocsv2/assets/js/253.dd154571.js"><link rel="prefetch" href="/myDocsv2/assets/js/254.230b3e5e.js"><link rel="prefetch" href="/myDocsv2/assets/js/255.d40d9e7e.js"><link rel="prefetch" href="/myDocsv2/assets/js/256.28281885.js"><link rel="prefetch" href="/myDocsv2/assets/js/257.6298bda8.js"><link rel="prefetch" href="/myDocsv2/assets/js/258.2fefa56c.js"><link rel="prefetch" href="/myDocsv2/assets/js/259.cb5aea63.js"><link rel="prefetch" href="/myDocsv2/assets/js/26.fae61a7f.js"><link rel="prefetch" href="/myDocsv2/assets/js/260.b29da0f4.js"><link rel="prefetch" href="/myDocsv2/assets/js/261.3db0aa59.js"><link rel="prefetch" href="/myDocsv2/assets/js/262.0b3015b0.js"><link rel="prefetch" href="/myDocsv2/assets/js/263.7577edc3.js"><link rel="prefetch" href="/myDocsv2/assets/js/264.5ff38add.js"><link rel="prefetch" href="/myDocsv2/assets/js/265.e339901e.js"><link rel="prefetch" href="/myDocsv2/assets/js/266.a2027a85.js"><link rel="prefetch" href="/myDocsv2/assets/js/267.08188cb1.js"><link rel="prefetch" href="/myDocsv2/assets/js/268.d30558f8.js"><link rel="prefetch" href="/myDocsv2/assets/js/269.aa62020a.js"><link rel="prefetch" href="/myDocsv2/assets/js/27.b1a4cdea.js"><link rel="prefetch" href="/myDocsv2/assets/js/270.56fe4e52.js"><link rel="prefetch" href="/myDocsv2/assets/js/271.4dbe5ca9.js"><link rel="prefetch" href="/myDocsv2/assets/js/272.ebb4279a.js"><link rel="prefetch" href="/myDocsv2/assets/js/273.82120a56.js"><link rel="prefetch" href="/myDocsv2/assets/js/274.409c4f82.js"><link rel="prefetch" href="/myDocsv2/assets/js/275.b1030128.js"><link rel="prefetch" href="/myDocsv2/assets/js/276.e35f1ba0.js"><link rel="prefetch" href="/myDocsv2/assets/js/277.78b42eab.js"><link rel="prefetch" href="/myDocsv2/assets/js/278.1d224e38.js"><link rel="prefetch" href="/myDocsv2/assets/js/279.5c7dd3ae.js"><link rel="prefetch" href="/myDocsv2/assets/js/28.e9c369f8.js"><link rel="prefetch" href="/myDocsv2/assets/js/280.07aa017e.js"><link rel="prefetch" href="/myDocsv2/assets/js/281.dcb43aec.js"><link rel="prefetch" href="/myDocsv2/assets/js/282.22bc522a.js"><link rel="prefetch" href="/myDocsv2/assets/js/283.c8474c90.js"><link rel="prefetch" href="/myDocsv2/assets/js/284.581fa5ab.js"><link rel="prefetch" href="/myDocsv2/assets/js/285.208c4406.js"><link rel="prefetch" href="/myDocsv2/assets/js/286.5e6c6df0.js"><link rel="prefetch" href="/myDocsv2/assets/js/287.acef2acc.js"><link rel="prefetch" href="/myDocsv2/assets/js/288.ae3f5d32.js"><link rel="prefetch" href="/myDocsv2/assets/js/289.039c32e1.js"><link rel="prefetch" href="/myDocsv2/assets/js/29.a3644474.js"><link rel="prefetch" href="/myDocsv2/assets/js/290.80dfce69.js"><link rel="prefetch" href="/myDocsv2/assets/js/291.9396076f.js"><link rel="prefetch" href="/myDocsv2/assets/js/292.aafda658.js"><link rel="prefetch" href="/myDocsv2/assets/js/293.9d432ff9.js"><link rel="prefetch" href="/myDocsv2/assets/js/294.9bd1328b.js"><link rel="prefetch" href="/myDocsv2/assets/js/295.272f5c7a.js"><link rel="prefetch" href="/myDocsv2/assets/js/296.0cc8fe44.js"><link rel="prefetch" href="/myDocsv2/assets/js/297.67a972ae.js"><link rel="prefetch" href="/myDocsv2/assets/js/298.9d16d98c.js"><link rel="prefetch" href="/myDocsv2/assets/js/299.0f04c0eb.js"><link rel="prefetch" href="/myDocsv2/assets/js/30.b5a32504.js"><link rel="prefetch" href="/myDocsv2/assets/js/300.d4e215e6.js"><link rel="prefetch" href="/myDocsv2/assets/js/301.60d51efc.js"><link rel="prefetch" href="/myDocsv2/assets/js/302.abb371d9.js"><link rel="prefetch" href="/myDocsv2/assets/js/303.b22b36ac.js"><link rel="prefetch" href="/myDocsv2/assets/js/304.3261e7b2.js"><link rel="prefetch" href="/myDocsv2/assets/js/305.807e25af.js"><link rel="prefetch" href="/myDocsv2/assets/js/306.fe10f19e.js"><link rel="prefetch" href="/myDocsv2/assets/js/307.9f74b43c.js"><link rel="prefetch" href="/myDocsv2/assets/js/308.b8c9f8e6.js"><link rel="prefetch" href="/myDocsv2/assets/js/309.1e5c14f9.js"><link rel="prefetch" href="/myDocsv2/assets/js/31.12707513.js"><link rel="prefetch" href="/myDocsv2/assets/js/310.911f38ce.js"><link rel="prefetch" href="/myDocsv2/assets/js/311.3940d290.js"><link rel="prefetch" href="/myDocsv2/assets/js/312.af9de452.js"><link rel="prefetch" href="/myDocsv2/assets/js/313.e10357a1.js"><link rel="prefetch" href="/myDocsv2/assets/js/314.8d732c56.js"><link rel="prefetch" href="/myDocsv2/assets/js/315.97345578.js"><link rel="prefetch" href="/myDocsv2/assets/js/316.5de46f5d.js"><link rel="prefetch" href="/myDocsv2/assets/js/317.ecbaee88.js"><link rel="prefetch" href="/myDocsv2/assets/js/318.f16657b3.js"><link rel="prefetch" href="/myDocsv2/assets/js/319.e9fc2b8b.js"><link rel="prefetch" href="/myDocsv2/assets/js/32.4794eb28.js"><link rel="prefetch" href="/myDocsv2/assets/js/320.87a080c9.js"><link rel="prefetch" href="/myDocsv2/assets/js/321.dc421947.js"><link rel="prefetch" href="/myDocsv2/assets/js/322.0d8f158f.js"><link rel="prefetch" href="/myDocsv2/assets/js/323.9feb5296.js"><link rel="prefetch" href="/myDocsv2/assets/js/324.11b428d5.js"><link rel="prefetch" href="/myDocsv2/assets/js/325.51e26ebb.js"><link rel="prefetch" href="/myDocsv2/assets/js/326.d7c9128a.js"><link rel="prefetch" href="/myDocsv2/assets/js/327.d2a1a3da.js"><link rel="prefetch" href="/myDocsv2/assets/js/328.f3119b29.js"><link rel="prefetch" href="/myDocsv2/assets/js/329.01ae2bb1.js"><link rel="prefetch" href="/myDocsv2/assets/js/33.7e8c531c.js"><link rel="prefetch" href="/myDocsv2/assets/js/330.757b5be7.js"><link rel="prefetch" href="/myDocsv2/assets/js/331.335622c4.js"><link rel="prefetch" href="/myDocsv2/assets/js/332.79b5dfeb.js"><link rel="prefetch" href="/myDocsv2/assets/js/333.b5bff6cd.js"><link rel="prefetch" href="/myDocsv2/assets/js/334.b4e9badb.js"><link rel="prefetch" href="/myDocsv2/assets/js/335.aed5ff57.js"><link rel="prefetch" href="/myDocsv2/assets/js/336.14ce19b1.js"><link rel="prefetch" href="/myDocsv2/assets/js/337.f0e871b6.js"><link rel="prefetch" href="/myDocsv2/assets/js/338.ba74f399.js"><link rel="prefetch" href="/myDocsv2/assets/js/339.e308e875.js"><link rel="prefetch" href="/myDocsv2/assets/js/34.76ac76e5.js"><link rel="prefetch" href="/myDocsv2/assets/js/340.8afe9761.js"><link rel="prefetch" href="/myDocsv2/assets/js/341.5f7f2739.js"><link rel="prefetch" href="/myDocsv2/assets/js/342.856b7535.js"><link rel="prefetch" href="/myDocsv2/assets/js/343.b71213f5.js"><link rel="prefetch" href="/myDocsv2/assets/js/344.4e9b4c16.js"><link rel="prefetch" href="/myDocsv2/assets/js/345.fde23f4c.js"><link rel="prefetch" href="/myDocsv2/assets/js/346.20b96938.js"><link rel="prefetch" href="/myDocsv2/assets/js/347.476680bb.js"><link rel="prefetch" href="/myDocsv2/assets/js/348.ecf44b79.js"><link rel="prefetch" href="/myDocsv2/assets/js/349.19235284.js"><link rel="prefetch" href="/myDocsv2/assets/js/35.b761363a.js"><link rel="prefetch" href="/myDocsv2/assets/js/350.42e4d37c.js"><link rel="prefetch" href="/myDocsv2/assets/js/351.6982f677.js"><link rel="prefetch" href="/myDocsv2/assets/js/352.f17e6bce.js"><link rel="prefetch" href="/myDocsv2/assets/js/353.2be51bc7.js"><link rel="prefetch" href="/myDocsv2/assets/js/354.77f5d2fb.js"><link rel="prefetch" href="/myDocsv2/assets/js/355.f6285383.js"><link rel="prefetch" href="/myDocsv2/assets/js/356.94418b9f.js"><link rel="prefetch" href="/myDocsv2/assets/js/357.b8b20e21.js"><link rel="prefetch" href="/myDocsv2/assets/js/358.1b2e896c.js"><link rel="prefetch" href="/myDocsv2/assets/js/36.34a14d0e.js"><link rel="prefetch" href="/myDocsv2/assets/js/37.aa4916db.js"><link rel="prefetch" href="/myDocsv2/assets/js/38.deb490d2.js"><link rel="prefetch" href="/myDocsv2/assets/js/39.8672f15d.js"><link rel="prefetch" href="/myDocsv2/assets/js/40.644dee16.js"><link rel="prefetch" href="/myDocsv2/assets/js/42.e7ff72f1.js"><link rel="prefetch" href="/myDocsv2/assets/js/43.02a62ac3.js"><link rel="prefetch" href="/myDocsv2/assets/js/44.cd8672e0.js"><link rel="prefetch" href="/myDocsv2/assets/js/45.02596789.js"><link rel="prefetch" href="/myDocsv2/assets/js/46.a1c40368.js"><link rel="prefetch" href="/myDocsv2/assets/js/47.8d8b2f4d.js"><link rel="prefetch" href="/myDocsv2/assets/js/48.5dadf9f0.js"><link rel="prefetch" href="/myDocsv2/assets/js/49.ea5bbb89.js"><link rel="prefetch" href="/myDocsv2/assets/js/50.ad180d98.js"><link rel="prefetch" href="/myDocsv2/assets/js/51.0df9f4e8.js"><link rel="prefetch" href="/myDocsv2/assets/js/52.f04a6e1b.js"><link rel="prefetch" href="/myDocsv2/assets/js/53.74f2f2cf.js"><link rel="prefetch" href="/myDocsv2/assets/js/54.e8578653.js"><link rel="prefetch" href="/myDocsv2/assets/js/55.79a1b789.js"><link rel="prefetch" href="/myDocsv2/assets/js/56.693e099d.js"><link rel="prefetch" href="/myDocsv2/assets/js/57.82c7c63a.js"><link rel="prefetch" href="/myDocsv2/assets/js/58.15dea23c.js"><link rel="prefetch" href="/myDocsv2/assets/js/59.63d66b63.js"><link rel="prefetch" href="/myDocsv2/assets/js/6.97e7a4cb.js"><link rel="prefetch" href="/myDocsv2/assets/js/60.80a3efc6.js"><link rel="prefetch" href="/myDocsv2/assets/js/61.3f648458.js"><link rel="prefetch" href="/myDocsv2/assets/js/62.991be8f4.js"><link rel="prefetch" href="/myDocsv2/assets/js/63.c70d0dfb.js"><link rel="prefetch" href="/myDocsv2/assets/js/64.cbfa33ab.js"><link rel="prefetch" href="/myDocsv2/assets/js/65.f89bbfb7.js"><link rel="prefetch" href="/myDocsv2/assets/js/66.70c68ea1.js"><link rel="prefetch" href="/myDocsv2/assets/js/67.27436099.js"><link rel="prefetch" href="/myDocsv2/assets/js/68.6c730d30.js"><link rel="prefetch" href="/myDocsv2/assets/js/69.31e87a96.js"><link rel="prefetch" href="/myDocsv2/assets/js/7.b469f62b.js"><link rel="prefetch" href="/myDocsv2/assets/js/70.66a0fe4e.js"><link rel="prefetch" href="/myDocsv2/assets/js/71.150be7fc.js"><link rel="prefetch" href="/myDocsv2/assets/js/72.a2b6c89a.js"><link rel="prefetch" href="/myDocsv2/assets/js/73.65559007.js"><link rel="prefetch" href="/myDocsv2/assets/js/74.f61e2991.js"><link rel="prefetch" href="/myDocsv2/assets/js/75.fde71997.js"><link rel="prefetch" href="/myDocsv2/assets/js/76.cf3d3a31.js"><link rel="prefetch" href="/myDocsv2/assets/js/77.36633bd8.js"><link rel="prefetch" href="/myDocsv2/assets/js/78.82d49b8f.js"><link rel="prefetch" href="/myDocsv2/assets/js/79.6c213d15.js"><link rel="prefetch" href="/myDocsv2/assets/js/8.ebe4b359.js"><link rel="prefetch" href="/myDocsv2/assets/js/80.e6ee5654.js"><link rel="prefetch" href="/myDocsv2/assets/js/81.2d6febe8.js"><link rel="prefetch" href="/myDocsv2/assets/js/82.b1d7c015.js"><link rel="prefetch" href="/myDocsv2/assets/js/83.e4d15d98.js"><link rel="prefetch" href="/myDocsv2/assets/js/84.98d75c07.js"><link rel="prefetch" href="/myDocsv2/assets/js/85.8bd12af2.js"><link rel="prefetch" href="/myDocsv2/assets/js/86.3bc59854.js"><link rel="prefetch" href="/myDocsv2/assets/js/87.c26415ef.js"><link rel="prefetch" href="/myDocsv2/assets/js/88.12cc1dae.js"><link rel="prefetch" href="/myDocsv2/assets/js/89.1e08c26e.js"><link rel="prefetch" href="/myDocsv2/assets/js/9.bd9ef1a2.js"><link rel="prefetch" href="/myDocsv2/assets/js/90.4d879007.js"><link rel="prefetch" href="/myDocsv2/assets/js/91.089c1c17.js"><link rel="prefetch" href="/myDocsv2/assets/js/92.5aec83b9.js"><link rel="prefetch" href="/myDocsv2/assets/js/93.efe44a21.js"><link rel="prefetch" href="/myDocsv2/assets/js/94.ffc75f13.js"><link rel="prefetch" href="/myDocsv2/assets/js/95.d2012256.js"><link rel="prefetch" href="/myDocsv2/assets/js/96.87fef0cb.js"><link rel="prefetch" href="/myDocsv2/assets/js/97.aae1fc0b.js"><link rel="prefetch" href="/myDocsv2/assets/js/98.5f33b8aa.js"><link rel="prefetch" href="/myDocsv2/assets/js/99.f3fbb5db.js"><link rel="prefetch" href="/myDocsv2/assets/js/vendors~flowchart.f05697d3.js">
    <link rel="stylesheet" href="/myDocsv2/assets/css/0.styles.21bb8301.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-584a622c><div data-v-584a622c><div id="loader-wrapper" class="loading-wrapper" data-v-1c4f0192 data-v-584a622c data-v-584a622c><div class="loader-main" data-v-1c4f0192><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-73c95a87 data-v-584a622c data-v-584a622c><h3 class="title" style="display:none;" data-v-73c95a87 data-v-73c95a87>AGou's Docs-v2</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-73c95a87 data-v-73c95a87><input type="password" value="" data-v-73c95a87> <span data-v-73c95a87>Konck! Knock!</span> <button data-v-73c95a87>OK</button></label> <div class="footer" style="display:none;" data-v-73c95a87 data-v-73c95a87><span data-v-73c95a87><i class="iconfont reco-theme" data-v-73c95a87></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-73c95a87>vuePress-theme-reco</a></span> <span data-v-73c95a87><i class="iconfont reco-copyright" data-v-73c95a87></i> <a data-v-73c95a87><span data-v-73c95a87>AGou-ops</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-584a622c><header class="navbar" data-v-584a622c><div title="导航" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myDocsv2/" class="home-link router-link-active"><img src="/myDocsv2/favicon.png" alt="AGou's Docs-v2" class="logo"> <span class="site-name">AGou's Docs-v2</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myDocsv2/timeline/" class="nav-link"><i class="iconfont undefined"></i>
  🕟时间线
</a></div><div class="nav-item"><a href="/myDocsv2/" class="nav-link"><i class="iconfont undefined"></i>
  🏠Home
</a></div><div class="nav-item"><a href="/myDocsv2/guide/" class="nav-link"><i class="iconfont undefined"></i>
  🗺️Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      📄其它
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myDocsv2/Golang/" class="nav-link"><i class="iconfont undefined"></i>
  📚Golang
</a></li><li class="dropdown-item"><!----> <a href="/myDocsv2/k8s/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  🚢K8s
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      版本
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://agou-ops.cn/myDocs" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ver 1.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://agou-ops.cn/myDocsv2" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ver 2.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://agou-ops.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ✨myBlog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/AGou-ops/myDocsv2" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-584a622c></div> <aside class="sidebar" data-v-584a622c><div class="personal-info-wrapper" data-v-7e653f02><img src="/myDocsv2/favicon.png" alt="author-avatar" class="personal-img" data-v-7e653f02> <h3 class="name" data-v-7e653f02>
    AGou-ops
  </h3> <div class="num" data-v-7e653f02><div data-v-7e653f02><h3 data-v-7e653f02>2</h3> <h6 data-v-7e653f02>文章</h6></div> <div data-v-7e653f02><h3 data-v-7e653f02>1</h3> <h6 data-v-7e653f02>标签</h6></div></div> <hr data-v-7e653f02></div> <nav class="nav-links"><div class="nav-item"><a href="/myDocsv2/timeline/" class="nav-link"><i class="iconfont undefined"></i>
  🕟时间线
</a></div><div class="nav-item"><a href="/myDocsv2/" class="nav-link"><i class="iconfont undefined"></i>
  🏠Home
</a></div><div class="nav-item"><a href="/myDocsv2/guide/" class="nav-link"><i class="iconfont undefined"></i>
  🗺️Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      📄其它
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myDocsv2/Golang/" class="nav-link"><i class="iconfont undefined"></i>
  📚Golang
</a></li><li class="dropdown-item"><!----> <a href="/myDocsv2/k8s/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  🚢K8s
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      版本
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://agou-ops.cn/myDocs" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ver 1.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://agou-ops.cn/myDocsv2" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ver 2.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://agou-ops.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ✨myBlog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/AGou-ops/myDocsv2" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/myDocsv2/k8s/Installation/" class="sidebar-heading clickable router-link-active open"><span>K8s Installation</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/myDocsv2/k8s/Installation/使用 Kubeadm 部署（单master）.html" class="sidebar-link">使用 Kubeadm 部署(单master)</a></li><li><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html" class="active sidebar-link">⭐Kubernetes 二进制安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_1-环境准备" class="sidebar-link">1.环境准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_1-1-kubernetes高可用集群部署方式" class="sidebar-link">1.1.Kubernetes高可用集群部署方式</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_1-2-kubernetes集群弃用docker容器" class="sidebar-link">1.2.Kubernetes集群弃用docker容器</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_1-3-kubernetes集群所需的证书" class="sidebar-link">1.3.Kubernetes集群所需的证书</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_1-4-环境准备" class="sidebar-link">1.4.环境准备</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_1-5-安装cfssl证书生成工具" class="sidebar-link">1.5.安装cfssl证书生成工具</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_2-操作系统初始化配置" class="sidebar-link">2.操作系统初始化配置</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_3-部署etcd集群" class="sidebar-link">3.部署Etcd集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_3-1-使用cfssl证书工具生成etcd证书" class="sidebar-link">3.1.使用cfssl证书工具生成etcd证书</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_3-2-部署etcd集群" class="sidebar-link">3.2.部署etcd集群</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_4-部署docker服务" class="sidebar-link">4.部署Docker服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_4-1-安装docker" class="sidebar-link">4.1.安装docker</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_4-2-为docker创建systemctl启动脚本" class="sidebar-link">4.2.为docker创建systemctl启动脚本</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_5-部署kubernetes-master节点" class="sidebar-link">5.部署kubernetes master节点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_5-1-使用cfssl生成apiserver的证书文件" class="sidebar-link">5.1.使用cfssl生成apiserver的证书文件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_5-2-解压二进制文件复制相关组件程序" class="sidebar-link">5.2.解压二进制文件复制相关组件程序</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_5-3-部署kube-apiserver组件" class="sidebar-link">5.3.部署kube-apiserver组件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_5-4-部署kube-controller-manage组件" class="sidebar-link">5.4.部署kube-controller-manage组件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_5-5-部署kube-scheduler组件" class="sidebar-link">5.5.部署kube-scheduler组件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_5-6-准备kubectl所需的kubeconfig文件连接集群" class="sidebar-link">5.6.准备kubectl所需的kubeconfig文件连接集群</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_6-在master节点部署node节点相关组件" class="sidebar-link">6.在master节点部署node节点相关组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_6-1-在集群授权kubelet-bootstrap用户允许请求证书" class="sidebar-link">6.1.在集群授权kubelet-bootstrap用户允许请求证书</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_6-2-在master节点部署kubelet组件" class="sidebar-link">6.2.在master节点部署kubelet组件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_6-3-在master节点部署kube-proxy" class="sidebar-link">6.3.在master节点部署kube-proxy</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_6-4-授权apiserver访问kubelet" class="sidebar-link">6.4.授权apiserver访问kubelet</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_7-部署kubernetes-calico网络组件" class="sidebar-link">7.部署kubernetes calico网络组件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_8-部署kubernetes-node节点" class="sidebar-link">8.部署kubernetes node节点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_8-1-解压二进制文件复制相关组件程序" class="sidebar-link">8.1.解压二进制文件复制相关组件程序</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_8-2-部署kubelet组件" class="sidebar-link">8.2.部署kubelet组件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_8-3-部署kube-proxy组件" class="sidebar-link">8.3.部署kube-proxy组件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_8-4-快速增加新的node节点" class="sidebar-link">8.4.快速增加新的node节点</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_9-为集群部署coredns组件" class="sidebar-link">9.为集群部署coredns组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_9-1-部署coredns组件" class="sidebar-link">9.1.部署coredns组件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_9-2-运行一个busybox容器测试dns" class="sidebar-link">9.2.运行一个busybox容器测试dns</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_10-扩容master节点组建kubernetes高可用集群" class="sidebar-link">10.扩容master节点组建kubernetes高可用集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_10-1-kubernetes高可用架构概念" class="sidebar-link">10.1.kubernetes高可用架构概念</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_10-2-在集群中新增一个etcd节点" class="sidebar-link">10.2.在集群中新增一个etcd节点</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_10-3-部署master-2节点" class="sidebar-link">10.3.部署master-2节点</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_10-4-部署nginx-keepalived实现kubernetes高可用集群" class="sidebar-link">10.4.部署Nginx+Keepalived实现kubernetes高可用集群</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_10-5-切换kubernetes集群为高可用模式" class="sidebar-link">10.5.切换kubernetes集群为高可用模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_11-测试kubernetes高可用集群" class="sidebar-link">11.测试kubernetes高可用集群</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_12-在kubernetes集群运行一套服务验证集群的可用性" class="sidebar-link">12.在kubernetes集群运行一套服务验证集群的可用性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_12-1-创建资源yaml文件" class="sidebar-link">12.1.创建资源yaml文件</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_12-2-创建资源并进行测试" class="sidebar-link">12.2.创建资源并进行测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_13-部署kubernetes-dashboard" class="sidebar-link">13.部署kubernetes dashboard</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_13-1-部署dashboard" class="sidebar-link">13.1.部署dashboard</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes 二进制安装.html#_13-2-访问dashboard" class="sidebar-link">13.2.访问dashboard</a></li></ul></li></ul></li><li><a href="/myDocsv2/k8s/Installation/使用 Kubespray 部署.html" class="sidebar-link">使用 Kubespray 部署</a></li><li><a href="/myDocsv2/k8s/Installation/使用国内源及相关小工具.html" class="sidebar-link">使用国内源及相关小工具</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/myDocsv2/k8s/实战案例/" class="sidebar-heading clickable"><span>K8s 实战案例</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/myDocsv2/k8s/Quicklystart/" class="sidebar-heading clickable"><span>k8s 快速手册</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/myDocsv2/k8s/Helm/" class="sidebar-heading clickable"><span>Helm</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group depth-0"><a href="/myDocsv2/k8s/" class="sidebar-heading clickable router-link-active"><span>Others</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/myDocsv2/k8s/Kubernetes Yaml quicklystart.html" class="sidebar-link">⭐k8s Yaml quicklystart</a></li><li><a href="/myDocsv2/k8s/k8s command.html" class="sidebar-link">⭐k8s command quicklystart</a></li><li><a href="/myDocsv2/k8s/Kubernetes with Jenkins CICD.html" class="sidebar-link">Kubernetes with Jenkins CICD</a></li><li><a href="/myDocsv2/k8s/Prometheus+Grafana全方位监控Kubernetes集群.html" class="sidebar-link">Prometheus+Grafana全方位监控Kubernetes集群</a></li><li><a href="/myDocsv2/k8s/kompose Basic.html" class="sidebar-link">kompose Basic</a></li><li><a href="/myDocsv2/k8s/kubenetes远程调试工具.html" class="sidebar-link">kubenetes远程调试工具</a></li><li><a href="/myDocsv2/k8s/Kubernetes REST API.html" class="sidebar-link">Kubernetes REST API</a></li><li><a href="/myDocsv2/k8s/k3d.html" class="sidebar-link">k3d</a></li><li><a href="/myDocsv2/k8s/Minikube Basic.html" class="sidebar-link">Minikube Basic</a></li><li><a href="/myDocsv2/k8s/Remote access k8s.html" class="sidebar-link">Remote access k8s</a></li><li><a href="/myDocsv2/k8s/k8s 图解大全.html" class="sidebar-link">k8s 图解大全</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-73c95a87 data-v-584a622c><h3 class="title" style="display:none;" data-v-73c95a87 data-v-73c95a87></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-73c95a87 data-v-73c95a87><input type="password" value="" data-v-73c95a87> <span data-v-73c95a87>Konck! Knock!</span> <button data-v-73c95a87>OK</button></label> <div class="footer" style="display:none;" data-v-73c95a87 data-v-73c95a87><span data-v-73c95a87><i class="iconfont reco-theme" data-v-73c95a87></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-73c95a87>vuePress-theme-reco</a></span> <span data-v-73c95a87><i class="iconfont reco-copyright" data-v-73c95a87></i> <a data-v-73c95a87><span data-v-73c95a87>AGou-ops</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-584a622c><main class="page"><!----> <div class="page-title" style="display:none;"><h1></h1> <hr> <div data-v-7b2e794a><i class="iconfont reco-account" data-v-7b2e794a><span data-v-7b2e794a>AGou-ops</span></i> <!----> <i class="iconfont reco-eye" data-v-7b2e794a><span id="/myDocsv2/k8s/Installation/Kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-7b2e794a><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><blockquote><p>⚠️转载自：https://jiangxl.blog.csdn.net/article/details/120428703</p> <p>仅略作修改。</p></blockquote> <p>[toc]</p> <h2 id="_1-环境准备"><a href="#_1-环境准备" class="header-anchor">#</a> 1.环境准备</h2> <h3 id="_1-1-kubernetes高可用集群部署方式"><a href="#_1-1-kubernetes高可用集群部署方式" class="header-anchor">#</a> 1.1.Kubernetes高可用集群部署方式</h3> <blockquote><p>目前生产环境部署Kubernetes建主要有两种方式：</p> <p>kubeadm：提供kubeadm init和kubeadm join，用于快速部署Kubernetes集群，kubeadm安装的k8s集群，所有的k8s组件都是以pod形式运行。</p> <p>二进制包：从github上下载发行版的二进制包，手动部署每个组件，组成kubernetes集群。</p> <p>Kubeadm降低部署成本，从而屏蔽了很多细节，遇到问题很难排查，如果想更容易可控，推荐使用二进制包部署Kubernetes集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。</p></blockquote> <h3 id="_1-2-kubernetes集群弃用docker容器"><a href="#_1-2-kubernetes集群弃用docker容器" class="header-anchor">#</a> 1.2.Kubernetes集群弃用docker容器</h3> <blockquote><p>在k8s平台中，为了解决与容器运行时，比如docker的集成问题，在早期社区推出CRI接口，以支持更多的容器，当我们使用Docker作为容器运行时，首先kubelet调用dockershim的CRI容器接口连接docker进程，最后由docker启动容器。</p> <p>在k8s1.23版本中，k8s计划弃用kubelet中的dockershim接口，dockershim接口一旦弃用，kubelet去调用CRL时就没有可以与docker建立连接的一个接口，从而导致k8s弃用docker容器。</p></blockquote> <h3 id="_1-3-kubernetes集群所需的证书"><a href="#_1-3-kubernetes集群所需的证书" class="header-anchor">#</a> 1.3.Kubernetes集群所需的证书</h3> <blockquote><p>k8s所有组件均采用https加密通信，这些组件一般由两套根证书生成：一个用于k8s apiserver一个用于etcd数据库。</p> <p>按照角色来分，证书分为管理节点和工作节点。</p> <ul><li>管理节点：指controller-manager和scheduler连接apiserver所需的客户端证书。</li> <li>工作节点：指kubelet和kube-proxy连接apiserver所需要的客户端证书，而一般都会启用Bootstrap TLS机制，所以kubelet的证书初次启动会向apiserver申请颁发证书，由controller-manager组件自动颁发。</li> <li>图中红线是k8s各个组件通过携带k8s自建证书颁发机构生成的客户端证书访问apiserver，图中蓝线是k8sapiserver组件通过etcd颁发的客户端证书与etcd建立连接。</li></ul> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/3b600f8680a443168cb556a183c19b3f.png" alt="请添加图片描述"></p></blockquote> <h3 id="_1-4-环境准备"><a href="#_1-4-环境准备" class="header-anchor">#</a> 1.4.环境准备</h3> <table><thead><tr><th>角色</th> <th>IP</th> <th>组件</th></tr></thead> <tbody><tr><td>binary-k8s-master1</td> <td>192.168.20.10</td> <td>kube-apiserver、kube-controller-manage、kube-scheduler、kubelet、kube-proxy、docker、etcd、nginx、keepalived</td></tr> <tr><td>binary-k8s-master2</td> <td>192.168.20.11</td> <td>kube-apiserver、kube-controller-manage、kube-scheduler、kubelet、kube-proxy、docker、nginx、keepalived、etcd（扩容节点）</td></tr> <tr><td>binary-k8s-node1</td> <td>192.168.20.12</td> <td>kubelet、kube-proxy、docker、etcd</td></tr> <tr><td>binary-k8s-node2</td> <td>192.168.20.13</td> <td>kubelet、kube-proxy、docker、etcd</td></tr> <tr><td>负载均衡器IP</td> <td>192.168.20.9</td> <td>（作用于kube-apiserver的地址）</td></tr></tbody></table> <p>首先部署一套单master节点的kubernetes集群，然后在增加一台master节点，形成高可用集群。</p> <p>单master节点的kubernetes集群服务器规划。</p> <table><thead><tr><th>角色</th> <th>IP</th> <th>组件</th></tr></thead> <tbody><tr><td>binary-k8s-master1</td> <td>192.168.20.10</td> <td>kube-apiserver、kube-controller-manage、kube-schedule、etcd</td></tr> <tr><td>binary-k8s-node1</td> <td>192.168.20.12</td> <td>kubelet、kube-proxy、docker、etcd</td></tr> <tr><td>binary-k8s-node2</td> <td>192.168.20.13</td> <td>kubelet、kube-proxy、docker、etcd</td></tr></tbody></table> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/ea0354a4d3cc4b6397ee9397f42e35dc.png" alt="在这里插入图片描述"></p> <h3 id="_1-5-安装cfssl证书生成工具"><a href="#_1-5-安装cfssl证书生成工具" class="header-anchor">#</a> 1.5.安装cfssl证书生成工具</h3> <p>cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl更方便使用。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">chmod</span> +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> cfssl_linux-amd64 /usr/local/bin/cfssl
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> cfssljson_linux-amd64 /usr/local/bin/cfssljson
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_2-操作系统初始化配置"><a href="#_2-操作系统初始化配置" class="header-anchor">#</a> 2.操作系统初始化配置</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.关闭防火墙
systemctl stop firewalld 
systemctl disable firewalld

<span class="token number">2</span>.关闭selinux
<span class="token function">sed</span> -i <span class="token string">'s/enforcing/disabled/'</span> /etc/selinux/config 
setenforce <span class="token number">0</span> 

<span class="token number">3</span>.关闭交换分区
swapoff -a
<span class="token function">sed</span> -ri <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab

<span class="token number">4</span>.配置hosts
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
192.168.20.10 binary-k8s-master1
192.168.20.12 binary-k8s-node1
192.168.20.13 binary-k8s-node2
EOF</span>

<span class="token number">5</span>.优化内核参数
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
net.bridge.bridge-nf-call-ip6tables = 1 
net.bridge.bridge-nf-call-iptables = 1 
EOF</span>
sysctl --system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="_3-部署etcd集群"><a href="#_3-部署etcd集群" class="header-anchor">#</a> 3.部署Etcd集群</h2> <p>etcd是一个分布式键值存储系统，kubernetes使用etcd进行数据存储，为解决etcd单点故障，采用集群方式部署，3台组组建集群，可以坏1台，如果有5台可以坏2台。</p> <table><thead><tr><th>节点名称</th> <th>IP</th></tr></thead> <tbody><tr><td>etcd-1</td> <td>192.168.20.10</td></tr> <tr><td>etcd-2</td> <td>192.168.20.12</td></tr> <tr><td>etcd-3</td> <td>192.168.20.13</td></tr></tbody></table> <h3 id="_3-1-使用cfssl证书工具生成etcd证书"><a href="#_3-1-使用cfssl证书工具生成etcd证书" class="header-anchor">#</a> 3.1.使用cfssl证书工具生成etcd证书</h3> <p><strong>1.生成CA自签颁发机构证书</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> ca-config.json
<span class="token punctuation">{</span>
  <span class="token string">&quot;signing&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;default&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;87600h&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;profiles&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;www&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
         <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;87600h&quot;</span>,
         <span class="token string">&quot;usages&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;signing&quot;</span>,
            <span class="token string">&quot;key encipherment&quot;</span>,
            <span class="token string">&quot;server auth&quot;</span>,
            <span class="token string">&quot;client auth&quot;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> ca-csr.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;etcd CA&quot;</span>,
    <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
            <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
            <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>


<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca -
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">595276170535764345591605360849177409156623041535</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p><strong>2.使用自签CA签发Etcd HTTPS证书</strong></p> <p>申请证书的json文件中有一个hosts字段，这个字段的值就是etcd集群的IP地址，可以多写几个IP，作为预留IP，方便扩容etcd集群。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.创建证书申请文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> server-csr.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;etcd&quot;</span>,
    <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;192.168.20.10&quot;</span>,
    <span class="token string">&quot;192.168.20.11&quot;</span>,			<span class="token comment">#预留ip</span>
    <span class="token string">&quot;192.168.20.12&quot;</span>,
    <span class="token string">&quot;192.168.20.13&quot;</span>
    <span class="token punctuation">]</span>,
    <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
            <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
            <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.生成证书
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>www server-csr.json <span class="token operator">|</span> cfssljson -bare server
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">390637014214409356442509482537912246480465374076</span>
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><strong>3.查看生产的证书文件</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># ll
总用量 <span class="token number">36</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">288</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:16 ca-config.json
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">956</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:16 ca.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">210</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:16 ca-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:16 ca-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1265</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:16 ca.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1021</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:17 server.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">311</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:17 server-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:17 server-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1346</span> <span class="token number">8</span>月  <span class="token number">27</span> <span class="token number">17</span>:17 server.pem
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-2-部署etcd集群"><a href="#_3-2-部署etcd集群" class="header-anchor">#</a> 3.2.部署etcd集群</h3> <p><strong>1.下载etcd二进制文件</strong></p> <p>下载地址：https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</p> <p>部署二进制的程序集群最简单的方式就是在其中一台上面部署，然后将所有的文件scp到其他机器上修改配置，一套集群也就完成了。</p> <p>将下载好的文件上传至所有etcd节点。</p> <p>etcd配置文件解释</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-1&quot;</span>							<span class="token comment">#节点名称</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>					<span class="token comment">#数据目录</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2380&quot;</span>			<span class="token comment">#集群通信地址</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span>		<span class="token comment">#客户端访问的监听地址，在这里加一个http://127.0.0.1:2379，在当前节点查集群信息时就不需要指定证书去查询了</span>
	
<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2380&quot;</span>			<span class="token comment">#集群通告地址</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span>					<span class="token comment">#客户端通告地址，，在这里加一个http://127.0.0.1:2379，在当前节点查集群信息时就不需要指定证书去查询了</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span>						<span class="token comment">#集群节点地址</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>				<span class="token comment">#集群的唯一标识</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>						<span class="token comment">#加入集群的状态，new为新集群，existing表示加入现有集群</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>2.部署etcd-1节点</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.创建程序目录
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> /data/etcd/<span class="token punctuation">{</span>bin,conf,ssl,data<span class="token punctuation">}</span> -p

<span class="token number">2</span>.解压二进制文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf etcd-v3.4.9-linux-amd64.tar.gz

<span class="token number">3</span>.将二进制命令移动到制定出程序目录
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> etcd-v3.4.9-linux-amd64/etcd* /data/etcd/bin/

<span class="token number">4</span>.编辑配置文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-1&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token number">5</span>.编写systemctl控制脚本
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/etcd.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Etcd Server
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/etcd/conf/etcd.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/etcd/bin/etcd <span class="token punctuation">\</span>
--cert-file<span class="token operator">=</span>/data/etcd/ssl/server.pem <span class="token punctuation">\</span>
--key-file<span class="token operator">=</span>/data/etcd/ssl/server-key.pem <span class="token punctuation">\</span>
--peer-cert-file<span class="token operator">=</span>/data/etcd/ssl/server.pem <span class="token punctuation">\</span>
--peer-key-file<span class="token operator">=</span>/data/etcd/ssl/server-key.pem <span class="token punctuation">\</span>
--trusted-ca-file<span class="token operator">=</span>/data/etcd/ssl/ca.pem <span class="token punctuation">\</span>
--peer-trusted-ca-file<span class="token operator">=</span>/data/etcd/ssl/ca.pem <span class="token punctuation">\</span>
--logger<span class="token operator">=</span>zap
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token number">6</span>.复制证书文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> TLS/etcd/*.pem /data/etcd/ssl/

<span class="token number">7</span>.启动etcd-1节点
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start etcd
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> etcd

<span class="token comment">#第一个节点启动会一直处于其中中的状态，只有当第二个节点也启动了，第一个节点才能启动成功，因为集群版的etcd至少需要2个节点才能成功运行</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p><strong>3.配置etcd-2节点和etcd-3节点</strong></p> <p>部署完一个节点，可以直接将目录拷贝至其他节点，省去安装的一些步骤。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.推送etcd目录
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/etcd root@192.168.20.12:/data
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/etcd root@192.168.20.13:/data

<span class="token number">2</span>.推送systemctl启动文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /usr/lib/systemd/system/etcd.service root@192.168.20.12:/usr/lib/systemd/system/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /usr/lib/systemd/system/etcd.service root@192.168.20.13:/usr/lib/systemd/system/

<span class="token number">3</span>.修改etcd-2配置文件
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-2&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.12:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.12:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token number">4</span>.修改etcd-3配置文件
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-3&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token number">5</span>.启动etcd-1和etcd-2
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start etcd
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> etcd
------------
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start etcd
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p><strong>4.查看集群状态</strong><br>
etcd-1启动时会一直处于等待状态，当etcd-2执行启动命令时会立即启动成功，并且etcd-1也会立刻启动成功。</p> <p>查看etcd的日志可以使用这个命令：<code>[root@binary-k8s-master1 ~]\# journalctl -u etcd -f</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.查看服务端口
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> etcd
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:2379      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">9625</span>/etcd           
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:2380      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">9625</span>/etcd

<span class="token number">2</span>.查看集群状态
<span class="token comment">#如果配置文件中2379端口没有加一个127.0.0.1则这样查看集群状态</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> /data/etcd/bin/etcdctl --cacert<span class="token operator">=</span>/data/etcd/ssl/ca.pem --cert<span class="token operator">=</span>/data/etcd/ssl/server.pem --key<span class="token operator">=</span>/data/etcd/ssl/server-key.pem --endpoints<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379&quot;</span> endpoint health --write-out<span class="token operator">=</span>table
+----------------------------+--------+-------------+-------+
<span class="token operator">|</span>          ENDPOINT          <span class="token operator">|</span> HEALTH <span class="token operator">|</span>    TOOK     <span class="token operator">|</span> ERROR <span class="token operator">|</span>
+----------------------------+--------+-------------+-------+
<span class="token operator">|</span> https://192.168.20.10:2379 <span class="token operator">|</span>   <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token number">32</span>.322714ms <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> https://192.168.20.12:2379 <span class="token operator">|</span>   <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token number">31</span>.524079ms <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> https://192.168.20.13:2379 <span class="token operator">|</span>   <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token number">38</span>.985949ms <span class="token operator">|</span>       <span class="token operator">|</span>
+----------------------------+--------+-------------+-------+
<span class="token comment">#如果配置文件汇总2379端口加了一个127.0.0.1则可以使用如下方式查看集群信息无需指定证书</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 /data/etcd/conf<span class="token punctuation">]</span><span class="token punctuation">\</span>#  /data/etcd/bin/etcdctl member list --write-out<span class="token operator">=</span>table
+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span> STATUS  <span class="token operator">|</span>  NAME  <span class="token operator">|</span>         PEER ADDRS         <span class="token operator">|</span>                   CLIENT ADDRS                    <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span>
+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+
<span class="token operator">|</span> 12446003b2a53d43 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-2 <span class="token operator">|</span> https://192.168.20.12:2380 <span class="token operator">|</span> https://127.0.0.1:2379,https://192.168.20.12:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 51ae3f86f3783687 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-1 <span class="token operator">|</span> https://192.168.20.10:2380 <span class="token operator">|</span>  http://127.0.0.1:2379,https://192.168.20.10:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 667c9c7ba890c3f7 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-3 <span class="token operator">|</span> https://192.168.20.13:2380 <span class="token operator">|</span>  http://127.0.0.1:2379,https://192.168.20.13:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>配置文件状态<br> <img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/da2f8ef902c04e77a4e555d67cc32273.png" alt="在这里插入图片描述"></p> <p>etcd启动成功的日志</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/25e40829361b4c78b782ae1b180a90b7.png" alt="在这里插入图片描述"></p> <h2 id="_4-部署docker服务"><a href="#_4-部署docker服务" class="header-anchor">#</a> 4.部署Docker服务</h2> <p>所有kubernetes节点都需要安装docker服务，包括master和node节点。</p> <p>docker二进制文件下载地址：https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz</p> <h3 id="_4-1-安装docker"><a href="#_4-1-安装docker" class="header-anchor">#</a> 4.1.安装docker</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.解压二进制包
<span class="token function">tar</span> zxf docker-19.03.9.tgz

<span class="token number">2</span>.将可执行命令移动到系统路径
<span class="token function">mv</span> docker/* /usr/bin

<span class="token number">3</span>.创建配置文件
<span class="token function">mkdir</span> /etc/docker
<span class="token function">vim</span> /etc/docker/daemon.json
<span class="token punctuation">{</span>
  <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://9wn5tbfh.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_4-2-为docker创建systemctl启动脚本"><a href="#_4-2-为docker创建systemctl启动脚本" class="header-anchor">#</a> 4.2.为docker创建systemctl启动脚本</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.编写启动脚本
<span class="token function">vim</span> /usr/lib/systemd/system/docker.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Docker Application Container Engine
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://docs.docker.com
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target firewalld.service
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -s HUP 
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">LimitNPROC</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">LimitCORE</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">TimeoutStartSec</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">Delegate</span><span class="token operator">=</span>yes
<span class="token assign-left variable">KillMode</span><span class="token operator">=</span>process
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">StartLimitBurst</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">StartLimitInterval</span><span class="token operator">=</span>60s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token number">2</span>.启动docker
systemctl daemon-reload 
systemctl start <span class="token function">docker</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="_5-部署kubernetes-master节点"><a href="#_5-部署kubernetes-master节点" class="header-anchor">#</a> 5.部署kubernetes master节点</h2> <p>部署二进制的kubernetes组件大致可分为如下几个步骤：</p> <ul><li>1.解压二进制文件</li> <li>2.复制二进制程序到指定目录</li> <li>3.创建组件配置文件</li> <li>4.生成组件的kubeconfig文件</li> <li>5.创建systemctl脚本管理服务</li> <li>6.启动组件</li></ul> <p>kubernetes集群的master节点和node节点的二进制文件都从github上下载，master和node相关的所有组件都在一个程序包中。</p> <p>下载地址： https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/36b71f10da9442808c7a950d2dedd254.png" alt="在这里插入图片描述"></p> <h3 id="_5-1-使用cfssl生成apiserver的证书文件"><a href="#_5-1-使用cfssl生成apiserver的证书文件" class="header-anchor">#</a> 5.1.使用cfssl生成apiserver的证书文件</h3> <p><strong>1.生成CA自签颁发机构证书</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.准备CA配置文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> ca-config.json
<span class="token punctuation">{</span>
  <span class="token string">&quot;signing&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;default&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;87600h&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;profiles&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;kubernetes&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
         <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;87600h&quot;</span>,
         <span class="token string">&quot;usages&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;signing&quot;</span>,
            <span class="token string">&quot;key encipherment&quot;</span>,
            <span class="token string">&quot;server auth&quot;</span>,
            <span class="token string">&quot;client auth&quot;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> ca-csr.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes&quot;</span>,
    <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
            <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
            <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
            <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;k8s&quot;</span>,
            <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.生成证书文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca -
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:43 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:43 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">90951268335404710707183639990677546638148434604</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p><strong>2.使用自签CA签发apiserver HTTPS证书</strong></p> <p>签发的客户端证书配置文件中的hosts字段要包含所有Master/LB/VIP的IP地址，Node节点的地址可写可不写。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.准备客户端配置文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kube-apiserver-csr.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes&quot;</span>,
    <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;10.0.0.1&quot;</span>,
      <span class="token string">&quot;127.0.0.1&quot;</span>,
      <span class="token string">&quot;192.168.20.10&quot;</span>,
      <span class="token string">&quot;192.168.20.11&quot;</span>,
      <span class="token string">&quot;192.168.20.12&quot;</span>,
      <span class="token string">&quot;192.168.20.13&quot;</span>,
      <span class="token string">&quot;192.168.20.9&quot;</span>,
      <span class="token string">&quot;kubernetes&quot;</span>,
      <span class="token string">&quot;kubernetes.default&quot;</span>,
      <span class="token string">&quot;kubernetes.default.svc&quot;</span>,
      <span class="token string">&quot;kubernetes.default.svc.cluster&quot;</span>,
      <span class="token string">&quot;kubernetes.default.svc.cluster.local&quot;</span>
    <span class="token punctuation">]</span>,
    <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
            <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
            <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
            <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;k8s&quot;</span>,
            <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.生成证书文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-apiserver-csr.json <span class="token operator">|</span> cfssljson -bare kube-apiserver
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:25 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:25 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">714472722509814799589567099679496298525490716083</span>
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:25 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><strong>3.查看生产的证书文件</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># ll
总用量 <span class="token number">36</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">294</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-config.json
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">264</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1359</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1277</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">602</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1643</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.pem
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_5-2-解压二进制文件复制相关组件程序"><a href="#_5-2-解压二进制文件复制相关组件程序" class="header-anchor">#</a> 5.2.解压二进制文件复制相关组件程序</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> /data/kubernetes/<span class="token punctuation">{</span>bin,config,ssl,logs<span class="token punctuation">}</span> -p
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf kubernetes-server-linux-amd64.tar.gz 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token builtin class-name">cd</span> kubernetes/server/bin/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/kubernetes/server/bin<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kube-apiserver kube-scheduler kube-controller-manager /data/kubernetes/bin/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/kubernetes/server/bin<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kubectl /usr/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/e7c7eb9ad3ae4b0a8800c575d4e86023.png" alt="在这里插入图片描述"></p> <h3 id="_5-3-部署kube-apiserver组件"><a href="#_5-3-部署kube-apiserver组件" class="header-anchor">#</a> 5.3.部署kube-apiserver组件</h3> <h4 id="_5-3-1-创建kube-apiserver配置文件"><a href="#_5-3-1-创建kube-apiserver配置文件" class="header-anchor">#</a> 5.3.1.创建kube-apiserver配置文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-apiserver.conf
<span class="token assign-left variable">KUBE_APISERVER_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379 \
--bind-address=192.168.20.10 \
--secure-port=6443 \
--advertise-address=192.168.20.10 \
--allow-privileged=true \
--service-cluster-ip-range=10.0.0.0/24 \
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \
--authorization-mode=RBAC,Node \
--enable-bootstrap-token-auth=true \
--token-auth-file=/data/kubernetes/config/token.csv \
--service-node-port-range=30000-32767 \
--kubelet-client-certificate=/data/kubernetes/ssl/kube-apiserver.pem \
--kubelet-client-key=/data/kubernetes/ssl/kube-apiserver-key.pem \
--tls-cert-file=/data/kubernetes/ssl/kube-apiserver.pem  \
--tls-private-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \
--client-ca-file=/data/kubernetes/ssl/ca.pem \
--service-account-key-file=/data/kubernetes/ssl/ca-key.pem \
--service-account-issuer=api \
--service-account-signing-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \
--etcd-cafile=/data/etcd/ssl/ca.pem \
--etcd-certfile=/data/etcd/ssl/server.pem \
--etcd-keyfile=/data/etcd/ssl/server-key.pem \
--requestheader-client-ca-file=/data/kubernetes/ssl/ca.pem \
--proxy-client-cert-file=/data/kubernetes/ssl/kube-apiserver.pem \
--proxy-client-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \
--requestheader-allowed-names=kubernetes \
--requestheader-extra-headers-prefix=X-Remote-Extra- \
--requestheader-group-headers=X-Remote-Group \
--requestheader-username-headers=X-Remote-User \
--enable-aggregator-routing=true \
--audit-log-maxage=30 \
--audit-log-maxbackup=3 \
--audit-log-maxsize=100 \
--audit-log-path=/data/kubernetes/logs/k8s-audit.log&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>配置文件各参数含义</strong></p> <table><thead><tr><th>配置参数</th> <th>含义</th></tr></thead> <tbody><tr><td>–logtostderr</td> <td>是否开启日志</td></tr> <tr><td>–v</td> <td>日志的等级，等级越高内容越详细</td></tr> <tr><td>–log-dir</td> <td>日志存放路径</td></tr> <tr><td>–etcd-servers</td> <td>etcd集群地址</td></tr> <tr><td>–bind-address</td> <td>监听地址，也就是本机</td></tr> <tr><td>–secure-port</td> <td>https安全端口</td></tr> <tr><td>–advertise-address</td> <td>集群通告地址</td></tr> <tr><td>–allow-privileged</td> <td>企业授权</td></tr> <tr><td>–service-cluster-ip-range</td> <td>service资源IP地址段</td></tr> <tr><td>–enable-admission-plugins</td> <td>准入控制模块</td></tr> <tr><td>–authorization-mode</td> <td>认证授权，启用RBAC授权和节点自管理</td></tr> <tr><td>–enable-bootstrap-token-auth</td> <td>启用TLS bootstrap机制，启用之后kubelet可以自动给node节颁发证书</td></tr> <tr><td>–token-auth-file</td> <td>bootstrap token文件路径</td></tr> <tr><td>–service-node-port-range</td> <td>Service nodeport类型默认分配端口范围</td></tr> <tr><td>–kubelet-client-certificate</td> <td>apiserver访问kubelet的客户端证书文件</td></tr> <tr><td>–kubelet-client-key</td> <td>apiserver访问kubelet的客户端私钥文件</td></tr> <tr><td>–tls-cert-file</td> <td>apiserver https证书</td></tr> <tr><td>–tls-private-key-file</td> <td>apiserver https证书</td></tr> <tr><td>–client-ca-file</td> <td>ca证书路径</td></tr> <tr><td>–service-account-key-file</td> <td>ca私钥路径</td></tr> <tr><td>–service-account-issuer</td> <td>sa账号授权过期时间的一个配置，1.20以后才有的特性</td></tr> <tr><td>–service-account-signing-key-file</td> <td>证书文件路径</td></tr> <tr><td>–etcd-cafile</td> <td>etcd ca证书文件路径</td></tr> <tr><td>–etcd-certfile</td> <td>etcd 客户端证书文件路径</td></tr> <tr><td>–etcd-keyfile</td> <td>etcd 客户端私钥文件路径</td></tr> <tr><td>–requestheader-client-ca-file</td> <td>聚合层相关配置</td></tr> <tr><td>–proxy-client-cert-file</td> <td>聚合层相关配置</td></tr> <tr><td>–proxy-client-key-file</td> <td>聚合层相关配置</td></tr> <tr><td>–requestheader-allowed-names</td> <td>聚合层相关配置</td></tr> <tr><td>–requestheader-extra-headers-prefix</td> <td>聚合层相关配置</td></tr> <tr><td>–enable-aggregator-routing</td> <td>聚合层相关配置</td></tr></tbody></table> <h4 id="_5-3-2-创建tls-bootstrapping文件"><a href="#_5-3-2-创建tls-bootstrapping文件" class="header-anchor">#</a> 5.3.2.创建TLS Bootstrapping文件</h4> <p>TLS Bootstraping：Master apiserver启用TLS认证后，Node节点kubelet和kube-proxy要与kube-apiserver进行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。所以强烈建议在Node上使用这种方式，目前主要用于kubelet，kube-proxy还是由我们统一颁发一个证书。</p> <p>TLS bootstraping 工作流程：</p> <p>kubelet首先取查找bootstraping配置文件，然后去连接apiserver，开始验证bootstrap token文件，再验证证书文件，最后颁发证书启动成功，否则就会启动失败。<br> <img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/17a18dfd43ae4604863e590283b63ebd.png" alt="在这里插入图片描述"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.生成一个token值
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">head</span> -c <span class="token number">16</span> /dev/urandom <span class="token operator">|</span> od -An -t x <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">' '</span>
d7f96b0d86c574d0f64a713608db092

<span class="token number">2</span>.创建token文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/token.csv
d7f96b0d86c574d0f64a713608db0922,kubelet-bootstrap,10001,<span class="token string">&quot;system:node-bootstrapper&quot;</span>

<span class="token comment">#格式：token，用户名，UID，用户组</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_5-3-4-创建systemctl脚本管理apiserver"><a href="#_5-3-4-创建systemctl脚本管理apiserver" class="header-anchor">#</a> 5.3.4.创建systemctl脚本管理apiserver</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-apiserver.service 
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-apiserver.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-apiserver <span class="token variable">$KUBE_APISERVER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_5-3-5-启动kube-apiserver组件"><a href="#_5-3-5-启动kube-apiserver组件" class="header-anchor">#</a> 5.3.5.启动kube-apiserver组件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.拷贝我们需要的证书文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> TLS/k8s/*.pem /data/kubernetes/ssl/

<span class="token number">2</span>.启动kube-apiserver
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-apiserver 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-apiserver

<span class="token number">3</span>.查看端口
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:6443      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28546</span>/kube-apiserve 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_5-4-部署kube-controller-manage组件"><a href="#_5-4-部署kube-controller-manage组件" class="header-anchor">#</a> 5.4.部署kube-controller-manage组件</h3> <h4 id="_5-4-1-创建kube-controller-manage配置文件"><a href="#_5-4-1-创建kube-controller-manage配置文件" class="header-anchor">#</a> 5.4.1.创建kube-controller-manage配置文件</h4> <blockquote><p><strong>配置文件含义</strong></p> <p>–kubeconfig：指定用于连接apiserver的kubeconfig配置文件</p> <p>–leader-elect：用于高可用集群，自动选举</p> <p>–cluster-signing-cert-file：指定CA证书文件，为kubelet自动颁发证书</p> <p>–cluster-signing-key-file：指定CA私钥文件，为kubelet自动颁发证书</p> <p>–cluster-signing-duration：证书过期时间</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-controller-manager.conf 
<span class="token assign-left variable">KUBE_CONTROLLER_MANAGER_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--leader-elect=true \
--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig \
--bind-address=192.168.20.10 \
--allocate-node-cidrs=true \
--cluster-cidr=10.244.0.0/16 \
--service-cluster-ip-range=10.0.0.0/24 \
--cluster-signing-cert-file=/data/kubernetes/ssl/ca.pem \
--cluster-signing-key-file=/data/kubernetes/ssl/ca-key.pem  \
--root-ca-file=/data/kubernetes/ssl/ca.pem \
--service-account-private-key-file=/data/kubernetes/ssl/ca-key.pem \
--cluster-signing-duration=87600h0m0s&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_5-4-2-生成kubeconfig文件"><a href="#_5-4-2-生成kubeconfig文件" class="header-anchor">#</a> 5.4.2.生成kubeconfig文件</h4> <p>kube-controller-manage利用kubeconfig配置文件连接apiserver。</p> <p>kubeconfig文件中包括集群apiserver地址、证书文件、用户。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.由于kubeconfig需要证书文件的支持，因此要生成一个证书
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kube-controller-manager-csr.json 
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-controller-manager&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:masters&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-controller-manager-csr.json <span class="token operator">|</span> cfssljson -bare kube-controller-manager
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
l2021/09/01 <span class="token number">16</span>:36:19 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:19 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">719101376219834763931271155238486242405063666906</span>
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:19 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kube-controller-manager*pem /data/kubernetes/ssl/


<span class="token number">2</span>.生成kubeconfig文件
<span class="token comment">#在kubeconfig文件中增加集群apiserver信息</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.kubeconfig
<span class="token comment">#在kubeconfig文件中增加证书文件信息  </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials kube-controller-manager <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kube-controller-manager.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kube-controller-manager-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.kubeconfig
<span class="token comment">#在kubeconfig文件中增加用户信息  </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-controller-manager <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.kubeconfig

<span class="token number">3</span>.指定生成的kubeconfig文件为集群使用
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.kubeconfig  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/877a98a70b2f47919bcaae2d9d02a4d1.png" alt="在这里插入图片描述"></p> <h4 id="_5-4-3-创建systemctl脚本管理服务"><a href="#_5-4-3-创建systemctl脚本管理服务" class="header-anchor">#</a> 5.4.3.创建systemctl脚本管理服务</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-controller-manager.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Controller Manager
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-controller-manager <span class="token variable">$KUBE_CONTROLLER_MANAGER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_5-4-4-启动kube-controller-manage组件"><a href="#_5-4-4-启动kube-controller-manage组件" class="header-anchor">#</a> 5.4.4.启动kube-controller-manage组件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.启动服务
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-controller-manager
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-controller-manager

<span class="token number">2</span>.查看端口
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:6443      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28546</span>/kube-apiserve 
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:10257     <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28941</span>/kube-controll 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10252                :::*                    LISTEN      <span class="token number">28941</span>/kube-controll 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_5-5-部署kube-scheduler组件"><a href="#_5-5-部署kube-scheduler组件" class="header-anchor">#</a> 5.5.部署kube-scheduler组件</h3> <h4 id="_5-5-1-创建kube-scheduler配置文件"><a href="#_5-5-1-创建kube-scheduler配置文件" class="header-anchor">#</a> 5.5.1.创建kube-scheduler配置文件</h4> <blockquote><p>配置文件解释</p> <p>–kubeconfig：指定kubeconfig文件</p> <p>–leader-elect：选举</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-scheduler.conf 
<span class="token assign-left variable">KUBE_SCHEDULER_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--leader-elect \
--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig \
--bind-address=192.168.20.10&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_5-5-2-生成kubeconfig文件"><a href="#_5-5-2-生成kubeconfig文件" class="header-anchor">#</a> 5.5.2.生成kubeconfig文件</h4> <p>生成kubeconfig连接集群apiserver。</p> <p>kube-schedule利用kubeconfig配置文件连接apiserver。</p> <p>kubeconfig文件中包括集群apiserver地址、证书文件、用户。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.创建证书配置文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kube-scheduler-csr.json
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-scheduler&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:masters&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.生成证书
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-scheduler-csr.json <span class="token operator">|</span> cfssljson -bare kube-scheduler
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:40 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:40 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:40 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">91388852050290848663498441480862532526947759393</span>
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:42 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token number">3</span>.查看证书文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># ll
总用量 <span class="token number">68</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">294</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-config.json
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">264</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1359</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1277</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">602</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1643</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1045</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">255</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:46 kube-controller-manager-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1436</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1029</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">245</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1424</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler.pem

<span class="token number">4</span>.拷贝证书文件至指定路径
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kube-scheduler*.pem /data/kubernetes/ssl/

<span class="token number">5</span>.生成kubeconfig文件
<span class="token comment">#在kubeconfig文件中增加集群apiserver信息</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.kubeconfig
<span class="token comment">#在kubeconfig文件中增加证书文件信息 </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials kube-scheduler <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kube-scheduler.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kube-scheduler-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.kubeconfig
<span class="token comment">#在kubeconfig文件中增加用户信息 </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-scheduler <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.kubeconfig

<span class="token number">6</span>.指定生成的kubeconfig文件为集群使用
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><h4 id="_5-5-3-创建systemctl脚本管理服务"><a href="#_5-5-3-创建systemctl脚本管理服务" class="header-anchor">#</a> 5.5.3.创建systemctl脚本管理服务</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-scheduler.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Scheduler
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-scheduler <span class="token variable">$KUBE_SCHEDULER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_5-5-4-启动kube-scheduler组件"><a href="#_5-5-4-启动kube-scheduler组件" class="header-anchor">#</a> 5.5.4.启动kube-scheduler组件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.启动服务
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-scheduler
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-scheduler

<span class="token number">2</span>.查看端口
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:6443      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28546</span>/kube-apiserve 
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:10257     <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28941</span>/kube-controll 
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:10259     <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">6127</span>/kube-scheduler 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10251                :::*                    LISTEN      <span class="token number">6127</span>/kube-scheduler 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10252                :::*                    LISTEN      <span class="token number">28941</span>/kube-controll 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_5-6-准备kubectl所需的kubeconfig文件连接集群"><a href="#_5-6-准备kubectl所需的kubeconfig文件连接集群" class="header-anchor">#</a> 5.6.准备kubectl所需的kubeconfig文件连接集群</h3> <p>kubectl想要连接集群对各种资源进行操作，需要有一个kubeconfig文件连接apiserver才可以对集群进行操作，也就是kubeadm安装k8s集群后在master节点生成的/root/.kube目录，这个目录中的config文件就是kubectl用于连接apiserver的kubeconfig文件。</p> <h4 id="_5-6-1-生成证书文件"><a href="#_5-6-1-生成证书文件" class="header-anchor">#</a> 5.6.1.生成证书文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.创建证书配置文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kubectl-csr.json 
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubectl&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:masters&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.生成证书
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kubectl-csr.json <span class="token operator">|</span> cfssljson -bare kubectl
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:44 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:44 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:44 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:45 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:45 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">398472525484598388169457456772550114435870340604</span>
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:45 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token number">3</span>.查看生成的证书文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># ll
总用量 <span class="token number">84</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">294</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-config.json
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">264</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1359</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:20 ca.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1277</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">602</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1643</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1045</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">255</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:46 kube-controller-manager-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1436</span> <span class="token number">9</span>月   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1013</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">17</span>:20 kubectl.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">231</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">17</span>:20 kubectl-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">17</span>:20 kubectl-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1403</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">17</span>:20 kubectl.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1029</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">245</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1424</span> <span class="token number">9</span>月   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler.pem

<span class="token number">4</span>.拷贝证书文件到指定目录
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token punctuation">\</span>cp kubectl*.pem /data/kubernetes/ssl/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h4 id="_5-6-2-生成kubeconfig文件"><a href="#_5-6-2-生成kubeconfig文件" class="header-anchor">#</a> 5.6.2.生成kubeconfig文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.在kubeconfig文件中增加集群apiserver信息
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/root/.kube/config

<span class="token number">2</span>.在kubeconfig文件中增加证书文件信息
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials cluster-admin <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kubectl.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kubectl-key.pem  <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/root/.kube/config

<span class="token number">3</span>.在kubeconfig文件中增加用户信息 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>cluster-admin <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/root/.kube/config
  
<span class="token number">4</span>.指定生成的kubeconfig文件为集群使用
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/root/.kube/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_5-6-3-使用kubectl查看集群连接信息"><a href="#_5-6-3-使用kubectl查看集群连接信息" class="header-anchor">#</a> 5.6.3.使用kubectl查看集群连接信息</h4> <p>至此master节点相关组件部署完成。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
No resources found

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get cs
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/8ea5953c67f6460facc684905acb502c.png" alt="在这里插入图片描述"></p> <h2 id="_6-在master节点部署node节点相关组件"><a href="#_6-在master节点部署node节点相关组件" class="header-anchor">#</a> 6.在master节点部署node节点相关组件</h2> <h3 id="_6-1-在集群授权kubelet-bootstrap用户允许请求证书"><a href="#_6-1-在集群授权kubelet-bootstrap用户允许请求证书" class="header-anchor">#</a> 6.1.在集群授权kubelet-bootstrap用户允许请求证书</h3> <p>在此处做了这一步之后，node节点加入集群时就不需要做了。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl create clusterrolebinding kubelet-bootstrap <span class="token punctuation">\</span>
--clusterrole<span class="token operator">=</span>system:node-bootstrapper <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kubelet-bootstrap
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_6-2-在master节点部署kubelet组件"><a href="#_6-2-在master节点部署kubelet组件" class="header-anchor">#</a> 6.2.在master节点部署kubelet组件</h3> <p>由于master也需要启动某些pod，比如calico组件都是以pod方式运行的，因此在master节点也需要kubelet和kube-proxy组件。</p> <h4 id="_6-2-1-将kubelet和kube-proxy的二进制文件拷贝至对应目录"><a href="#_6-2-1-将kubelet和kube-proxy的二进制文件拷贝至对应目录" class="header-anchor">#</a> 6.2.1.将kubelet和kube-proxy的二进制文件拷贝至对应目录</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kubernetes/server/bin/<span class="token punctuation">{</span>kubelet,kube-proxy<span class="token punctuation">}</span> /data/kubernetes/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_6-2-2-创建kubelet配置文件"><a href="#_6-2-2-创建kubelet配置文件" class="header-anchor">#</a> 6.2.2.创建kubelet配置文件</h4> <blockquote><p>配置文件含义：</p> <p>–hostname-override：节点名称，集群中唯一</p> <p>–network-plugin：启用CNI网络</p> <p>–kubeconfig：指定自动生成的kubeconfig文件路径，用于连接apiserver</p> <p>–bootstrap-kubeconfig：指定首次启动向apiserver申请证书的kubeconfig文件路径</p> <p>–config：配置参数文件路径</p> <p>–cert-dir：kubelet证书生成目录路径</p> <p>–pod-infra-container-image：pod容器的根容器</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet.conf
<span class="token assign-left variable">KUBELET_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--hostname-override=binary-k8s-master1 \
--network-plugin=cni \
--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \
--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \
--config=/data/kubernetes/config/kubelet-config.yml \
--cert-dir=/data/kubernetes/ssl \
--pod-infra-container-image=pause-amd64:3.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_6-2-3-创建kubelet-config-yaml参数配置文件"><a href="#_6-2-3-创建kubelet-config-yaml参数配置文件" class="header-anchor">#</a> 6.2.3.创建kubelet-config.yaml参数配置文件</h4> <p>kubelet和kube-proxy服务的参数配置是以yaml形式来配置的</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet-config.yml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: <span class="token number">0.0</span>.0.0				<span class="token comment">#监听地址</span>
port: <span class="token number">10250</span>						<span class="token comment">#监听端口</span>
readOnlyPort: <span class="token number">10255</span>
cgroupDriver: cgroupfs			<span class="token comment">#驱动引擎</span>
clusterDNS:
- <span class="token number">10.0</span>.0.2
clusterDomain: cluster.local
failSwapOn: <span class="token boolean">false</span>
authentication:
  anonymous:
    enabled: <span class="token boolean">false</span>
  webhook:
    cacheTTL: 2m0s
    enabled: <span class="token boolean">true</span>
  x509:
    clientCAFile: /data/kubernetes/ssl/ca.pem		<span class="token comment">#ca证书文件路径</span>
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
evictionHard:
  imagefs.available: <span class="token number">15</span>%
  memory.available: 100Mi
  nodefs.available: <span class="token number">10</span>%
  nodefs.inodesFree: <span class="token number">5</span>%
maxOpenFiles: <span class="token number">1000000</span>
maxPods: <span class="token number">110</span>				<span class="token comment">#可运行的pod的数量</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_6-2-4-创建bootstrap-kubeconfig文件"><a href="#_6-2-4-创建bootstrap-kubeconfig文件" class="header-anchor">#</a> 6.2.4.创建bootstrap-kubeconfig文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.在kubeconfig文件中增加集群apiserver信息
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
  
<span class="token number">2</span>.在kubeconfig文件中增加token信息
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials <span class="token string">&quot;kubelet-bootstrap&quot;</span> <span class="token punctuation">\</span>
--token<span class="token operator">=</span>d7f96b0d86c574d0f64a713608db0922 <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
<span class="token comment">#这个token就是之前生成的/data/kubernetes/config/token.csv中的token</span>
  
<span class="token number">3</span>.在kubeconfig文件中增加用户信息 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span><span class="token string">&quot;kubelet-bootstrap&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig

<span class="token number">4</span>.指定生成的kubeconfig文件为集群使用
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_6-2-5-创建systemctl脚本并启动服务"><a href="#_6-2-5-创建systemctl脚本并启动服务" class="header-anchor">#</a> 6.2.5.创建systemctl脚本并启动服务</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.创建systemctl脚本
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kubelet.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Kubelet
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kubelet.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kubelet <span class="token variable">$KUBELET_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token number">2</span>.启动kubelet服务
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kubelet
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_6-2-6-将master节点作为node加入集群内部"><a href="#_6-2-6-将master节点作为node加入集群内部" class="header-anchor">#</a> 6.2.6.将master节点作为node加入集群内部</h4> <p>当kubelet组件启动成功后，就会想apiserver发送一个请求加入集群的信息，只有当master节点授权同意后，才可以正常加入，虽然是master节点部署的node组件，但是也会发生一个加入集群的信息，需要master同意。</p> <p>当kubelet启动之后，首先会在证书目录生成一个kubelet-client.key.tmp这个文件，当使用kubectl certificate approve命令授权成功node的请求之后，kubelet-client.key.tmp小时，随之会生成一个kubelet-client-current.pem的证书文件，用于与apiserver建立连接，此时再使用kubectl get node就会看到节点信息了。</p> <p>扩展：如果后期想要修改node的名称，那么就把生成的kubelet证书文件全部删除，然后使用kubectl delete node删除该节点，在修改kubelet配置文件中该节点的名称，然后使用kubectl delete csr删除授权信息，再重启kubelet生成新的授权信息，然后授权通过即可看到新的名字的node节点。</p> <p>只有当授权通过后，kubelet生成了证书文件，kubelet的端口才会被启动</p> <p>注意：当kubelet的授权被master请求通后，kube-proxy启动成功后，节点才会正真的加入集群，即使kubectl get node看到的节点是Ready，该节点也是不可用的，必须当kube-proxy启动完毕后，这个节点才算正真的启动完毕&lt;</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.直接在master节点上执行如下命令获取请求列表
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get csr
NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4   4s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token number">2</span>.授权同意此节点加入集群
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl certificate approve node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4
certificatesigningrequest.certificates.k8s.io/node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4 approved

<span class="token number">3</span>.查看node节点
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS     ROLES    AGE   VERSION
binary-k8s-master1   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   6s    v1.20.4
<span class="token comment">#此时master节点已经出现在集群节点列表中了</span>

<span class="token number">4</span>.查看kubelet端口
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kubelet
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:10248         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">29092</span>/kubelet       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:41132         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">29092</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10250                :::*                    LISTEN      <span class="token number">29092</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10255                :::*                    LISTEN      <span class="token number">29092</span>/kubelet 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/857b38edfb4c46e99ccd40e7fa296628.png" alt="在这里插入图片描述"></p> <h3 id="_6-3-在master节点部署kube-proxy"><a href="#_6-3-在master节点部署kube-proxy" class="header-anchor">#</a> 6.3.在master节点部署kube-proxy</h3> <h4 id="_6-3-1-创建kube-proxy配置文件"><a href="#_6-3-1-创建kube-proxy配置文件" class="header-anchor">#</a> 6.3.1.创建kube-proxy配置文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy.conf
<span class="token assign-left variable">KUBE_PROXY_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_6-3-2-创建kube-proxy参数配置文件"><a href="#_6-3-2-创建kube-proxy参数配置文件" class="header-anchor">#</a> 6.3.2.创建kube-proxy参数配置文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy-config.yml
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: <span class="token number">0.0</span>.0.0									<span class="token comment">#监听地址</span>
metricsBindAddress: <span class="token number">0.0</span>.0.0:10249							<span class="token comment">#监听端口</span>
clientConnection:
  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig			<span class="token comment">#kubeconfig文件用于和apiserver通信</span>
hostnameOverride: binary-k8s-master1				<span class="token comment">#当前节点名称</span>
clusterCIDR: <span class="token number">10.244</span>.0.0/16
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_6-3-3-生成kubeconfig文件"><a href="#_6-3-3-生成kubeconfig文件" class="header-anchor">#</a> 6.3.3.生成kubeconfig文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.创建证书配置文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kube-proxy-csr.json 
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-proxy&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;k8s&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>


<span class="token number">2</span>.生成证书
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-proxy-csr.json <span class="token operator">|</span> cfssljson -bare kube-proxy
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">677418055440191127932354470575565723194258386145</span>
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:24 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token number">3</span>.查看证书文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># ll *proxy*
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1009</span> <span class="token number">9</span>月   <span class="token number">3</span> <span class="token number">16</span>:04 kube-proxy.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">230</span> <span class="token number">9</span>月   <span class="token number">3</span> <span class="token number">16</span>:04 kube-proxy-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>月   <span class="token number">3</span> <span class="token number">16</span>:04 kube-proxy-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1403</span> <span class="token number">9</span>月   <span class="token number">3</span> <span class="token number">16</span>:04 kube-proxy.pem


<span class="token number">4</span>.拷贝证书文件至指定路径
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kube-proxy*.pem /data/kubernetes/ssl/

<span class="token number">5</span>.生成kubeconfig文件
<span class="token comment">#在kubeconfig文件中增加集群apiserver信息</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
<span class="token comment">#在kubeconfig文件中增加证书文件信息 </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials kube-proxy <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kube-proxy.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kube-proxy-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
<span class="token comment">#在kubeconfig文件中增加用户信息 </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-proxy <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig

<span class="token number">6</span>.指定生成的kubeconfig文件为集群使用
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h4 id="_6-3-4-创建systemctl脚本管理服务"><a href="#_6-3-4-创建systemctl脚本管理服务" class="header-anchor">#</a> 6.3.4.创建systemctl脚本管理服务</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-proxy.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Proxy
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-proxy.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-proxy <span class="token variable">$KUBE_PROXY_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_6-3-4-启动kube-proxy组件"><a href="#_6-3-4-启动kube-proxy组件" class="header-anchor">#</a> 6.3.4.启动kube-proxy组件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.启动服务
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-proxy
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-proxy

<span class="token number">2</span>.查看端口
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube-proxy
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10249                :::*                    LISTEN      <span class="token number">29354</span>/kube-proxy    
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10256                :::*                    LISTEN      <span class="token number">29354</span>/kube-proxy 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_6-4-授权apiserver访问kubelet"><a href="#_6-4-授权apiserver访问kubelet" class="header-anchor">#</a> 6.4.授权apiserver访问kubelet</h3> <p>如果不收取apiserver访问kubelet，那么将无法使用kubectl查看集群的一些信息，比如kubectl logs就无法使用。</p> <p>实际上就是创建一个rbac资源让apiserver能否访问kubelet的资源。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.编写资源yaml文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> apiserver-to-kubelet-rbac.yaml 
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="token string">&quot;true&quot;</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - <span class="token string">&quot;&quot;</span>
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
      - pods/log
    verbs:
      - <span class="token string">&quot;*&quot;</span>
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: <span class="token string">&quot;&quot;</span>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes

<span class="token number">2</span>.创建资源
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f apiserver-to-kubelet-rbac.yaml
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="_7-部署kubernetes-calico网络组件"><a href="#_7-部署kubernetes-calico网络组件" class="header-anchor">#</a> 7.部署kubernetes calico网络组件</h2> <p>在6中master节点已经加入集群，但是状态一直处于NotReady状态，就是由于集群没有网络组件导致的，部署好网络组件，master节点立马会成为Ready状态。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.部署calico
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f calico.yaml
configmap/calico-config created
customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrole.rbac.authorization.k8s.io/calico-node created
clusterrolebinding.rbac.authorization.k8s.io/calico-node created
daemonset.apps/calico-node created
serviceaccount/calico-node created
deployment.apps/calico-kube-controllers created
serviceaccount/calico-kube-controllers created

<span class="token number">2</span>.查看资源状态
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get pod -n kube-system
NAME                                      READY   STATUS    RESTARTS   AGE
calico-kube-controllers-97769f7c7-bnwcl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
calico-node-mghdj                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m

<span class="token number">3</span>.查看master节点的状态
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME          STATUS   ROLES    AGE   VERSION
k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   99m   v1.20.4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="_8-部署kubernetes-node节点"><a href="#_8-部署kubernetes-node节点" class="header-anchor">#</a> 8.部署kubernetes node节点</h2> <h3 id="_8-1-解压二进制文件复制相关组件程序"><a href="#_8-1-解压二进制文件复制相关组件程序" class="header-anchor">#</a> 8.1.解压二进制文件复制相关组件程序</h3> <p>以下操作仅在node1节点操作即可。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.准备二进制程序
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf kubernetes-server-linux-amd64.tar.gz 
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> -p /data/kubernetes/<span class="token punctuation">{</span>bin,config,ssl,logs<span class="token punctuation">}</span> 
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kubernetes/server/bin/<span class="token punctuation">{</span>kubelet,kube-proxy<span class="token punctuation">}</span> /data/kubernetes/bin/
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kubernetes/server/bin/kubectl /usr/bin/

<span class="token number">2</span>.将master节点上的证书文件拷贝至node节点
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/kubernetes/ssl/* binary-k8s-node1:/data/kubernetes/ssl/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/kubernetes/config/token.csv root@binary-k8s-node1:/data/kubernetes/config

<span class="token number">3</span>.删除从master节点上拷贝过来的kubelet证书
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/kubernetes/ssl/kubelet-client-*
<span class="token comment">#kubelet证书需要删除，当node节点的kubelet启动后会生成临时证书文件，当master授权通过后，证书文件产生</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_8-2-部署kubelet组件"><a href="#_8-2-部署kubelet组件" class="header-anchor">#</a> 8.2.部署kubelet组件</h3> <h4 id="_8-2-1-创建kubelet配置文件"><a href="#_8-2-1-创建kubelet配置文件" class="header-anchor">#</a> 8.2.1.创建kubelet配置文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet.conf 
<span class="token assign-left variable">KUBELET_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--hostname-override=binary-k8s-node1		#注意修改节点名称 \
--network-plugin=cni \
--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \
--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \
--config=/data/kubernetes/config/kubelet-config.yml \
--cert-dir=/data/kubernetes/ssl \
--pod-infra-container-image=pause-amd64:3.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_8-2-2-创建kubelet参数配置文件"><a href="#_8-2-2-创建kubelet参数配置文件" class="header-anchor">#</a> 8.2.2.创建kubelet参数配置文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet-config.yml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: <span class="token number">0.0</span>.0.0
port: <span class="token number">10250</span>
readOnlyPort: <span class="token number">10255</span>
cgroupDriver: cgroupfs
clusterDNS:
- <span class="token number">10.0</span>.0.2
clusterDomain: cluster.local
failSwapOn: <span class="token boolean">false</span>
authentication:
  anonymous:
    enabled: <span class="token boolean">false</span>
  webhook:
    cacheTTL: 2m0s
    enabled: <span class="token boolean">true</span>
  x509:
    clientCAFile: /data/kubernetes/ssl/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
evictionHard:
  imagefs.available: <span class="token number">15</span>%
  memory.available: 100Mi
  nodefs.available: <span class="token number">10</span>%
  nodefs.inodesFree: <span class="token number">5</span>%
maxOpenFiles: <span class="token number">1000000</span>
maxPods: <span class="token number">110</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_8-2-3-创建bootstrap-kubeconfig文件"><a href="#_8-2-3-创建bootstrap-kubeconfig文件" class="header-anchor">#</a> 8.2.3.创建bootstrap-kubeconfig文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.在kubeconfig文件中增加集群apiserver信息
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
  
<span class="token number">2</span>.在kubeconfig文件中增加token信息
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials <span class="token string">&quot;kubelet-bootstrap&quot;</span> <span class="token punctuation">\</span>
--token<span class="token operator">=</span>d7f96b0d86c574d0f64a713608db0922 <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
<span class="token comment">#这个token就是之前生成的/data/kubernetes/config/token.csv中的token</span>
  
<span class="token number">3</span>.在kubeconfig文件中增加用户信息 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span><span class="token string">&quot;kubelet-bootstrap&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig

<span class="token number">4</span>.指定生成的kubeconfig文件为集群使用
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_8-2-4-创建systemctl脚本并启动服务"><a href="#_8-2-4-创建systemctl脚本并启动服务" class="header-anchor">#</a> 8.2.4.创建systemctl脚本并启动服务</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.编写systemctl服务脚本
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kubelet.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Kubelet
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kubelet.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kubelet <span class="token variable">$KUBELET_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token number">2</span>.启动kubelet服务
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kubelet
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kubelet
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl status kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_8-2-5-master节点授权同意node节点加入集群"><a href="#_8-2-5-master节点授权同意node节点加入集群" class="header-anchor">#</a> 8.2.5.master节点授权同意node节点加入集群</h4> <p>kubelet服务启动后，会生成一个临时证书文件，然后向master节点发送一个csr授权请求，当master节点授权同意后，kubelet-clinet证书文件生成，端口也随之启动，节点正常加入集群。</p> <p>csr列表的授权信息也会自动清空，如果master节点的授权不及时，也可以重启一下kubelet重新发送一个csr请求。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.在node节点查看临时证书文件
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># ll /data/kubernetes/ssl/*.tmp
-rw-------. <span class="token number">1</span> root root  <span class="token number">227</span> <span class="token number">9</span>月   <span class="token number">6</span> <span class="token number">11</span>:28 kubelet-client.key.tmp
<span class="token comment">#只要kubelet启动就会产生一个临时证书文件</span>

<span class="token number">2</span>.在master节点查看csr授权请求列表
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get csr
NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI   11s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token number">3</span>.授权通过
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl certificate approve node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI
certificatesigningrequest.certificates.k8s.io/node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI approved

<span class="token number">4</span>.此时临时文件已删除，已经生成kubelet证书文件
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># ll /data/kubernetes/ssl/kubelet-client*
-rw-------. <span class="token number">1</span> root root <span class="token number">1236</span> <span class="token number">9</span>月   <span class="token number">6</span> <span class="token number">11</span>:28 kubelet-client-2021-09-06-11-28-54.pem
lrwxrwxrwx. <span class="token number">1</span> root root   <span class="token number">59</span> <span class="token number">9</span>月   <span class="token number">6</span> <span class="token number">11</span>:28 kubelet-client-current.pem -<span class="token operator">&gt;</span> /data/kubernetes/ssl/kubelet-client-2021-09-06-11-28-54.pem

<span class="token number">5</span>.node1节点成功加入集群
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2d22h   v1.20.4
binary-k8s-node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4h59m   v1.20.4

<span class="token number">6</span>.在node节点查看kubelet服务的端口
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kubelet
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:10248         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">29220</span>/kubelet       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:44151         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">29220</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10250                :::*                    LISTEN      <span class="token number">29220</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10255                :::*                    LISTEN      <span class="token number">29220</span>/kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_8-3-部署kube-proxy组件"><a href="#_8-3-部署kube-proxy组件" class="header-anchor">#</a> 8.3.部署kube-proxy组件</h3> <h4 id="_8-3-1-创建kube-proxy配置文件"><a href="#_8-3-1-创建kube-proxy配置文件" class="header-anchor">#</a> 8.3.1.创建kube-proxy配置文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy.conf
<span class="token assign-left variable">KUBE_PROXY_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_8-3-2-创建kube-proxy参数配置文件"><a href="#_8-3-2-创建kube-proxy参数配置文件" class="header-anchor">#</a> 8.3.2.创建kube-proxy参数配置文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy-config.yml
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: <span class="token number">0.0</span>.0.0									<span class="token comment">#监听地址</span>
metricsBindAddress: <span class="token number">0.0</span>.0.0:10249							<span class="token comment">#监听端口</span>
clientConnection:
  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig			<span class="token comment">#kubeconfig文件用于和apiserver通信</span>
hostnameOverride: binary-k8s-node1				<span class="token comment">#当前节点名称</span>
clusterCIDR: <span class="token number">10.244</span>.0.0/16
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_8-3-3-生成kube-config文件"><a href="#_8-3-3-生成kube-config文件" class="header-anchor">#</a> 8.3.3.生成kube-config文件</h4> <p>由于kube-proxy的证书文件在8.1中已经从master节点拷贝到node节点了，因此直接生成kubeconfig文件即可。</p> <p>集群中不同节点的组件都要用同一个证书文件。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.生成kubeconfig文件
<span class="token comment">#在kubeconfig文件中增加集群apiserver信息</span>
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
<span class="token comment">#在kubeconfig文件中增加证书文件信息 </span>
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials kube-proxy <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kube-proxy.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kube-proxy-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
<span class="token comment">#在kubeconfig文件中增加用户信息 </span>
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-proxy <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig

<span class="token number">2</span>.指定生成的kubeconfig文件为集群使用
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_8-3-4-创建systemctl脚本管理服务"><a href="#_8-3-4-创建systemctl脚本管理服务" class="header-anchor">#</a> 8.3.4.创建systemctl脚本管理服务</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-proxy.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Proxy
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-proxy.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-proxy <span class="token variable">$KUBE_PROXY_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.targ
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_8-3-5-启动kube-proxy组件"><a href="#_8-3-5-启动kube-proxy组件" class="header-anchor">#</a> 8.3.5.启动kube-proxy组件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.启动服务
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-proxy
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-proxy

<span class="token number">2</span>.查看端口
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube-proxy
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10249                :::*                    LISTEN      <span class="token number">26954</span>/kube-proxy    
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10256                :::*                    LISTEN      <span class="token number">26954</span>/kube-proxy  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_8-4-快速增加新的node节点"><a href="#_8-4-快速增加新的node节点" class="header-anchor">#</a> 8.4.快速增加新的node节点</h3> <p>二进制部署的程序特别好的一个地方就在于，能够快速部署一个新的服务，做法就是直接拷贝已经部署好的目录到一个新的位置，改改其中的参数即可启动使用了。</p> <h4 id="_8-4-1-将kubelet和kube-proxy目录拷贝至新的node节点"><a href="#_8-4-1-将kubelet和kube-proxy目录拷贝至新的node节点" class="header-anchor">#</a> 8.4.1.将kubelet和kube-proxy目录拷贝至新的node节点</h4> <p>要拷贝kubelet和kube-proxy部署目录以及systemctl启动脚本文件。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/kubernetes root@binary-k8s-node2:/data
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> /usr/lib/systemd/system/kube* root@binary-k8s-node2:/usr/lib/systemd/system/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_8-4-2-配置并启动kubelet组件"><a href="#_8-4-2-配置并启动kubelet组件" class="header-anchor">#</a> 8.4.2.配置并启动kubelet组件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.删除没用的证书文件
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/kubernetes/ssl/kubelet-client-*

<span class="token number">2</span>.修改kubelet配置文件中的节点名称
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet.conf 
<span class="token assign-left variable">KUBELET_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--hostname-override=binary-k8s-node2 \
--network-plugin=cni \
--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \
--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \
--config=/data/kubernetes/config/kubelet-config.yml \
--cert-dir=/data/kubernetes/ssl \
--pod-infra-container-image=pause-amd64:3.0&quot;</span>
<span class="token comment">#将--hostname-override值修改为当前节点名称即可</span>

<span class="token number">3</span>.启动kubelet
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload 
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kubelet
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_8-4-3-master节点授权新node节点的请求"><a href="#_8-4-3-master节点授权新node节点的请求" class="header-anchor">#</a> 8.4.3.master节点授权新node节点的请求</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.master节点查看授权信息列表
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get csr
NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE   48s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token number">2</span>.授权通过node节点的kubelet
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl certificate approve node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE
certificatesigningrequest.certificates.k8s.io/node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE approved

<span class="token number">3</span>.成功加入集群
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2d23h   v1.20.4
binary-k8s-node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   5h54m   v1.20.4
binary-k8s-node2     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   1s      v1.20.4

<span class="token number">4</span>.查看kubelet的端口
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:41121         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16694</span>/kubelet       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:10248         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10250                :::*                    LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10255                :::*                    LISTEN      <span class="token number">16694</span>/kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_8-4-4-配置并启动kube-proxy组件"><a href="#_8-4-4-配置并启动kube-proxy组件" class="header-anchor">#</a> 8.4.4.配置并启动kube-proxy组件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.修改kube-proxy参数配置文件中的主机名
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy-config.yml 
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: <span class="token number">0.0</span>.0.0
metricsBindAddress: <span class="token number">0.0</span>.0.0:10249
clientConnection:
  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig
hostnameOverride: binary-k8s-node2
clusterCIDR: <span class="token number">10.244</span>.0.0/16

<span class="token number">2</span>.启动kubelet
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload 
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-proxy
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-proxy

<span class="token number">3</span>查看kube-proxy端口
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:41121         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16694</span>/kubelet       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:10248         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10249                :::*                    LISTEN      <span class="token number">20410</span>/kube-proxy    
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10250                :::*                    LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10255                :::*                    LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10256                :::*                    LISTEN      <span class="token number">20410</span>/kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="_9-为集群部署coredns组件"><a href="#_9-为集群部署coredns组件" class="header-anchor">#</a> 9.为集群部署coredns组件</h2> <h3 id="_9-1-部署coredns组件"><a href="#_9-1-部署coredns组件" class="header-anchor">#</a> 9.1.部署coredns组件</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.coredns.yaml文件内容
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cat</span> coredns.yaml 
<span class="token comment"># Warning: This is a file generated from the base underscore template file: coredns.yaml.base</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coredns
  namespace: kube-system
  labels:
      kubernetes.io/cluster-service: <span class="token string">&quot;true&quot;</span>
      addonmanager.kubernetes.io/mode: Reconcile
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
    addonmanager.kubernetes.io/mode: Reconcile
  name: system:coredns
rules:
- apiGroups:
  - <span class="token string">&quot;&quot;</span>
  resources:
  - endpoints
  - services
  - pods
  - namespaces
  verbs:
  - list
  - <span class="token function">watch</span>
- apiGroups:
  - <span class="token string">&quot;&quot;</span>
  resources:
  - nodes
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="token string">&quot;true&quot;</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
    addonmanager.kubernetes.io/mode: EnsureExists
  name: system:coredns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:coredns
subjects:
- kind: ServiceAccount
  name: coredns
  namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
  labels:
      addonmanager.kubernetes.io/mode: EnsureExists
data:
  Corefile: <span class="token operator">|</span>
    .:53 <span class="token punctuation">{</span>
        log
        errors
        health <span class="token punctuation">{</span>
            lameduck 5s
        <span class="token punctuation">}</span>
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa <span class="token punctuation">{</span>
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl <span class="token number">30</span>
        <span class="token punctuation">}</span>
        prometheus :9153
        forward <span class="token builtin class-name">.</span> /etc/resolv.conf
        cache <span class="token number">30</span>
        loop
        reload
        loadbalance
    <span class="token punctuation">}</span>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: <span class="token string">&quot;true&quot;</span>
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: <span class="token string">&quot;CoreDNS&quot;</span>
spec:
  <span class="token comment"># replicas: not specified here:</span>
  <span class="token comment"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span>
  <span class="token comment"># 2. Default is 1.</span>
  <span class="token comment"># 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span>
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: <span class="token number">1</span>
  selector:
    matchLabels:
      k8s-app: kube-dns
  template:
    metadata:
      labels:
        k8s-app: kube-dns
      annotations:
        seccomp.security.alpha.kubernetes.io/pod: <span class="token string">'runtime/default'</span>
    spec:
      priorityClassName: system-cluster-critical
      serviceAccountName: coredns
      tolerations:
        - key: <span class="token string">&quot;CriticalAddonsOnly&quot;</span>
          operator: <span class="token string">&quot;Exists&quot;</span>
      nodeSelector:
        kubernetes.io/os: linux
      containers:
      - name: coredns
        image: coredns:1.6.7
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 512Mi 
          requests:
            cpu: 100m
            memory: 70Mi
        args: <span class="token punctuation">[</span> <span class="token string">&quot;-conf&quot;</span>, <span class="token string">&quot;/etc/coredns/Corefile&quot;</span> <span class="token punctuation">]</span>
        volumeMounts:
        - name: config-volume
          mountPath: /etc/coredns
          readOnly: <span class="token boolean">true</span>
        ports:
        - containerPort: <span class="token number">53</span>
          name: dns
          protocol: UDP
        - containerPort: <span class="token number">53</span>
          name: dns-tcp
          protocol: TCP
        - containerPort: <span class="token number">9153</span>
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: <span class="token number">8080</span>
            scheme: HTTP
          initialDelaySeconds: <span class="token number">60</span>
          timeoutSeconds: <span class="token number">5</span>
          successThreshold: <span class="token number">1</span>
          failureThreshold: <span class="token number">5</span>
        readinessProbe:
          httpGet:
            path: /ready
            port: <span class="token number">8181</span>
            scheme: HTTP
        securityContext:
          allowPrivilegeEscalation: <span class="token boolean">false</span>
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - all
          readOnlyRootFilesystem: <span class="token boolean">true</span>
      dnsPolicy: Default
      volumes:
        - name: config-volume
          configMap:
            name: coredns
            items:
            - key: Corefile
              path: Corefile
---
apiVersion: v1
kind: Service
metadata:
  name: kube-dns
  namespace: kube-system
  annotations:
    prometheus.io/port: <span class="token string">&quot;9153&quot;</span>
    prometheus.io/scrape: <span class="token string">&quot;true&quot;</span>
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: <span class="token string">&quot;true&quot;</span>
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: <span class="token string">&quot;CoreDNS&quot;</span>
spec:
  selector:
    k8s-app: kube-dns
  clusterIP: <span class="token number">10.0</span>.0.2 
  ports:
  - name: dns
    port: <span class="token number">53</span>
    protocol: UDP
  - name: dns-tcp
    port: <span class="token number">53</span>
    protocol: TCP
  - name: metrics
    port: <span class="token number">9153</span>
    protocol: TCP

<span class="token number">2</span>.部署coredns
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f coredns.yaml 
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br></div></div><h3 id="_9-2-运行一个busybox容器测试dns"><a href="#_9-2-运行一个busybox容器测试dns" class="header-anchor">#</a> 9.2.运行一个busybox容器测试dns</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl run -it --rm dns-test --image<span class="token operator">=</span>busybox:1.28.4 <span class="token function">sh</span>
If you don't see a <span class="token builtin class-name">command</span> prompt, try pressing enter.
/ <span class="token comment"># nslookup kubernetes</span>
Server:    <span class="token number">10.0</span>.0.2
Address <span class="token number">1</span>: <span class="token number">10.0</span>.0.2 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address <span class="token number">1</span>: <span class="token number">10.0</span>.0.1 kubernetes.default.svc.cluster.local

/ <span class="token comment"># nslookup kube-dns.kube-system</span>
Server:    <span class="token number">10.0</span>.0.2
Address <span class="token number">1</span>: <span class="token number">10.0</span>.0.2 kube-dns.kube-system.svc.cluster.local

Name:      kube-dns.kube-system
Address <span class="token number">1</span>: <span class="token number">10.0</span>.0.2 kube-dns.kube-system.svc.cluster.local
/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_10-扩容master节点组建kubernetes高可用集群"><a href="#_10-扩容master节点组建kubernetes高可用集群" class="header-anchor">#</a> 10.扩容master节点组建kubernetes高可用集群</h2> <h3 id="_10-1-kubernetes高可用架构概念"><a href="#_10-1-kubernetes高可用架构概念" class="header-anchor">#</a> 10.1.kubernetes高可用架构概念</h3> <p>kubernetes集群通过健康检查和重启策略实现了Pod故障自愈能力，也通过调度算法实现将Pod分布式部署，并可以通过设置Pod的副本数，实现高并发能力，即使Node节点出现故障，Master节点也会将故障的Node节点上的Pod迁移到正常工作的Node节点上，实现应用层的高可用性</p> <p>针对Kubernetes集群，高可用性包括Etcd数据库高可用、Matser节点组件的高可用，Etcd可以通过集群方式实现高可用，而只有单台Master节点，一旦Master节点上的组件出现了故障，整个集群将会不可用。</p> <p>Master节点是属于控制整个集群的角色，所有的组件都需要与Master节点的ApiServer进行交互，不断与Node节点上的Kubelet和Kube-Proxy进行通信来维护整个集群的工作状态，如果ApiServer发生故障，将无法与Node节点进行通信，也就无法管理集群。</p> <p>因此Kubernetes集群最主要的就是对Master节点进行高可用配置。</p> <p>Master节点主要有三个服务：kube-apiserver、kube-controller-manage、kube-scheduler，当集群有多台Master节点时，其中kube-controller-manage和kube-scheduler都可以通过自身的选举机制实现高可用，但是kube-apiserver就没有这种机制，因此主要针对kube-apiserver配置高可用即可，kube-apiserver提供的是HTTP API接口服务，因此可以像web服务那种，使用nginx+keepalived方式实现Master节点高可用，并且也可以水平扩容。</p> <p>配置kubernetes集群高可用的主要步骤就是：</p> <p>1、增加一台或多台Master节点，部署Master节点相关组件，在这个master节点上配置的监听地址还是自身的地址；</p> <p>2、在新增的Master节点上部署etcd，使etcd加入现有的etcd集群，使etcd的性能更强；</p> <p>3、配置nginx+keepalived实现Apiserver组件高可用；</p> <p>4、配置所有的Node节点，将所配置的Apiserver地址改成keepalived虚拟出来的VIP地址，实现集群高可用；</p> <p>高可用kubernetes集群一般3台master节点足矣，但是etcd数据库一定要多多益善</p> <h3 id="_10-2-在集群中新增一个etcd节点"><a href="#_10-2-在集群中新增一个etcd节点" class="header-anchor">#</a> 10.2.在集群中新增一个etcd节点</h3> <p>扩容etcd步骤：</p> <p>1、部署一台单节点的etcd，能够正常启动服务</p> <p>2、在现有etcd集群中增加新的etcd节点</p> <p>3、将单点的etcd配置成集群模式</p> <p>4、删除单点造成的数据文件</p> <p>5、所有节点修改配置文件增加新的etcd节点信息</p> <p>6、重启所有etcd节点</p> <h4 id="_10-2-1-首先新增加一台单点的etcd"><a href="#_10-2-1-首先新增加一台单点的etcd" class="header-anchor">#</a> 10.2.1.首先新增加一台单点的etcd</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.安装etcd程序
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf etcd-v3.4.9-linux-amd64.tar.gz 
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> /data/etcd/<span class="token punctuation">{</span>bin,conf,ssl,data<span class="token punctuation">}</span> -p
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> etcd-v3.4.9-linux-amd64/etcd* /data/etcd/bin/

<span class="token number">2</span>.创建单点配置文件
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Service]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-4&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[cluster]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-4=https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token number">4</span>.拷贝证书文件
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> root@192.168.20.10:/data/etcd/ssl/* /data/etcd/ssl/

<span class="token number">5</span>.拷贝systemctl管理脚本
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> root@192.168.20.10:/usr/lib/systemd/system/etcd.service /usr/lib/systemd/system/

<span class="token number">6</span>.启动etcd服务
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span>#  systemctl start etcd

<span class="token number">7</span>.查看端口
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> etcd
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.11:2379      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">15753</span>/etcd          
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:2379          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">15753</span>/etcd          
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.11:2380      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">15753</span>/etcd 

<span class="token number">8</span>.查看节点状态
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># /data/etcd/bin/etcdctl endpoint health --write-out<span class="token operator">=</span>table
+----------------+--------+------------+-------+
<span class="token operator">|</span>    ENDPOINT    <span class="token operator">|</span> HEALTH <span class="token operator">|</span>    TOOK    <span class="token operator">|</span> ERROR <span class="token operator">|</span>
+----------------+--------+------------+-------+
<span class="token operator">|</span> <span class="token number">127.0</span>.0.1:2379 <span class="token operator">|</span>   <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token number">7</span>.146222ms <span class="token operator">|</span>       <span class="token operator">|</span>
+----------------+--------+------------+-------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h4 id="_10-2-2-在现有etcd集群任意一个节点上增加新etcd节点"><a href="#_10-2-2-在现有etcd集群任意一个节点上增加新etcd节点" class="header-anchor">#</a> 10.2.2.在现有etcd集群任意一个节点上增加新etcd节点</h4> <blockquote><p>增加节点的命令为：<code>/data/etcd/bin/etcdctl member add 节点名称 --peer-urls=&quot;通信地址&quot;</code></p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.增加etcd-4节点
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># /data/etcd/bin/etcdctl member <span class="token function">add</span> etcd-4 --peer-urls<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
Member aae107adddd0d3d8 added to cluster 20b119eb5f91aa4b

<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-4&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;existing&quot;</span>
<span class="token comment">#输出的配置信息一定要在新的etcd-4节点的配置文件写入，否则会加入集群失败</span>

<span class="token number">2</span>.查看集群节点列表
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># /data/etcd/bin/etcdctl member list --write-out<span class="token operator">=</span>table
+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span>  STATUS   <span class="token operator">|</span>  NAME  <span class="token operator">|</span>         PEER ADDRS         <span class="token operator">|</span>                   CLIENT ADDRS                   <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span>
+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token operator">|</span> 12446003b2a53d43 <span class="token operator">|</span>   started <span class="token operator">|</span> etcd-2 <span class="token operator">|</span> https://192.168.20.12:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.12:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 51ae3f86f3783687 <span class="token operator">|</span>   started <span class="token operator">|</span> etcd-1 <span class="token operator">|</span> https://192.168.20.10:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.10:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 667c9c7ba890c3f7 <span class="token operator">|</span>   started <span class="token operator">|</span> etcd-3 <span class="token operator">|</span> https://192.168.20.13:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.13:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> aae107adddd0d3d8 <span class="token operator">|</span> unstarted <span class="token operator">|</span>        <span class="token operator">|</span> https://192.168.20.11:2380 <span class="token operator">|</span>                                                  <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token comment">#发现刚刚新加入的etcd-4节点处于unstarted状态，我们需要再配置etcd-4节点使用能够加入集群</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_10-2-3-配置新增的etcd节点加入集群"><a href="#_10-2-3-配置新增的etcd节点加入集群" class="header-anchor">#</a> 10.2.3.配置新增的etcd节点加入集群</h4> <p>在已有集群增加完新节点之后，还需要将新的etcd节点配置文件增加集群相关属性，然后删除由单点时造成的etcd数据文件，最后在所有节点的配置文件中增加新节点的通信地址，重启所有节点的etcd服务，到此扩容成功。</p> <p>主要在新的etcd节点中配置ETCD_NAME、ETCD_INITIAL_CLUSTER、ETCD_INITIAL_CLUSTER_TOKEN、ETCD_INITIAL_CLUSTER_STATE这三个参数。</p> <p>ETCD_NAME：集群节点名称</p> <p>ETCD_INITIAL_CLUSTER：由单点的一个节点信息改成集群所有节点的信息</p> <p>ETCD_INITIAL_CLUSTER_TOKEN：填写集群的唯一标识，表示加入哪个etcd集群</p> <p>ETCD_INITIAL_CLUSTER_STATE：集群状态调整为加入已存在的集群</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.修改etcd配置文件，增加集群配置参数
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Service]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-4&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[cluster]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;existing&quot;</span>

<span class="token number">2</span>.删除由单点时产生的数据文件
<span class="token comment">#如果不删除，加入集群时会失败</span>
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/etcd/data/*

<span class="token number">3</span>.所有etcd的配置文件中增加新节点的通信地址
注意：所有etcd节点的配置文件都要增加这一行配置
<span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span>

<span class="token number">4</span>.重启所有节点的ectd服务
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart etcd
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart etcd
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart etcd
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart etcd

<span class="token number">5</span>.再次查看集群的节点信息
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># /data/etcd/bin/etcdctl member list --write-out<span class="token operator">=</span>table
+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span> STATUS  <span class="token operator">|</span>  NAME  <span class="token operator">|</span>         PEER ADDRS         <span class="token operator">|</span>                   CLIENT ADDRS                   <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span>
+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token operator">|</span> 12446003b2a53d43 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-2 <span class="token operator">|</span> https://192.168.20.12:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.12:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 51ae3f86f3783687 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-1 <span class="token operator">|</span> https://192.168.20.10:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.10:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 667c9c7ba890c3f7 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-3 <span class="token operator">|</span> https://192.168.20.13:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.13:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> aae107adddd0d3d8 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-4 <span class="token operator">|</span> https://192.168.20.11:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.11:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token comment">#etcd到此扩容成功</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="_10-2-4-配置kube-apiserver增加新的etcd节点"><a href="#_10-2-4-配置kube-apiserver增加新的etcd节点" class="header-anchor">#</a> 10.2.4.配置kube-apiserver增加新的etcd节点</h4> <p>etcd节点新增完，需要配置下kube-apiserver组件，增加新的etcd节点信息。</p> <p>注意所有k8s master节点都必须修改配置kube-apiserver.conf文件增加新的etcd节点，否则etcd也不会为k8s所用。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.master节点修改配置文件增加新的etcd节点
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-apiserver.conf 
······
--etcd-servers<span class="token operator">=</span>https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379,https://192.168.20.11:2379 <span class="token punctuation">\</span>
······

<span class="token number">2</span>.重启apiserver组件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart kube-apiserver

<span class="token number">3</span>.查看组件信息
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get cs -o wide
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-3               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_10-3-部署master-2节点"><a href="#_10-3-部署master-2节点" class="header-anchor">#</a> 10.3.部署master-2节点</h3> <p>由于所有组件都是二进制方式部署的，因此可以在master1上将目录直接拷贝至master2上即可使用。</p> <h4 id="_10-3-1-部署docker"><a href="#_10-3-1-部署docker" class="header-anchor">#</a> 10.3.1.部署docker</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.安装docker
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf docker-19.03.9.tgz 
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> docker/* /usr/bin/

<span class="token number">2</span>.拷贝master1节点上的docker配置文件
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp root@binary-k8s-master1:/etc/docker /etc/

<span class="token number">3</span>.拷贝master1节点上的docker systemctl脚本
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp root@binary-k8s-master1:/usr/lib/systemd/system/docker.service /usr/lib/systemd/system/

<span class="token number">4</span>.启动docker
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start <span class="token function">docker</span>
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_10-3-2-部署kubernetes各个组件"><a href="#_10-3-2-部署kubernetes各个组件" class="header-anchor">#</a> 10.3.2.部署kubernetes各个组件</h4> <p>由于是二进制部署，直接拷贝master1节点上的/data/kubernetes目录即可，/data/kubernetes目录下包含了所有的master以及node相关组件</p> <p>master节点需要安装所有的master组件和node组件。</p> <p><strong>1.准备二进制程序</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.拷贝组件文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/kubernetes root@binary-k8s-master2:/data
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> /usr/bin/kubectl root@binary-k8s-master2:/usr/bin
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /usr/lib/systemd/system/kube* root@binary-k8s-master2:/usr/lib/systemd/system/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp .kube root@binary-k8s-master2:/root

<span class="token number">2</span>.如果没有扩容新的etcd节点的情况需要拷贝etcd证书
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/etcd/ssl root@binary-k8s-master2:/data/etcd/ss

<span class="token number">3</span>.删除kubelet文件
<span class="token comment">#kubelet某些问题都是动态生成的，且每个节点都不相同，因此需要删除重新生成</span>
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/kubernetes/config/kubelet.kubeconfig 
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/kubernetes/ssl/kubelet-client-*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>2.修改各个组件的配置文件</strong></p> <p>主要就是修改各个组件监听的本机ip地址和节点名称，生成的kubeconfig文件中的apiserver地址无需更改，保持master1即可，因为最后高可用的时候还是会改成VIP地址，当前无需更改。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.修改kube-apiserver配置文件中的IP地址
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-apiserver.conf 
······
--bind-address<span class="token operator">=</span><span class="token number">192.168</span>.20.11  <span class="token punctuation">\</span>
--advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.20.11 <span class="token punctuation">\</span>
······

<span class="token number">2</span>.修改kube-controller-manager配置文件中的IP地址
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-controller-manager.conf 
······
--bind-address<span class="token operator">=</span><span class="token number">192.168</span>.20.11 <span class="token punctuation">\</span>
······

<span class="token number">3</span>.修改kube-scheduler配置文件中的IP地址
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-scheduler.conf 
······
--bind-address<span class="token operator">=</span><span class="token number">192.168</span>.20.11&quot;
······

<span class="token number">4</span>.修改kubelet配置文件中的IP地址
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet.conf 
······
--hostname-override<span class="token operator">=</span>binary-k8s-master2 <span class="token punctuation">\</span>
······

<span class="token number">5</span>.修改kube-apiserver配置文件中的IP地址
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy-config.yml 
······
hostnameOverride: binary-k8s-master2
······
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>3.启动各个组件</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload 
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-apiserver
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-controller-manager
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-scheduler
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kubelet
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-proxy
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-apiserver
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-controller-manager
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-scheduler
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kubelet
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_10-3-3-授权master2节点加入集群"><a href="#_10-3-3-授权master2节点加入集群" class="header-anchor">#</a> 10.3.3.授权master2节点加入集群</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.查看授权新系列表
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get csr
NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE   4m45s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token number">2</span>.授权通过
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl certificate approve node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE
certificatesigningrequest.certificates.k8s.io/node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE approved

<span class="token number">3</span>.查看是否加入集群
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4d21h   v1.20.4
binary-k8s-master2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4m33s   v1.20.4
binary-k8s-node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2d3h    v1.20.4
binary-k8s-node2     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   45h     v1.20.4

<span class="token number">4</span>.查看核心组件状态
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get cs
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_10-4-部署nginx-keepalived实现kubernetes高可用集群"><a href="#_10-4-部署nginx-keepalived实现kubernetes高可用集群" class="header-anchor">#</a> 10.4.部署Nginx+Keepalived实现kubernetes高可用集群</h3> <p>keepalived是主流的高可用软件，基于VIP绑定实现服务器的双机热备，可以理解为keepalived是针对服务器IP的高可用集群，如果A机器宕机了，B机器会立刻成为master角色，抢占VIP地址，使其不间断的提供服务，从而形成高可用集群。</p> <p>使用nginx+keepalived做得k8s master节点高可用集群，只要master节点上面没有etcd组件，那么整个集群master节点只要有一个工作正常，整个集群就不会宕机。</p> <p>生产环境中nginx+keepalived是独立于集群之外的两台服务器，高可用集群一般情况下都是一主一备，两个节点就可以满足正常需求，正好master节点有2个，可以在两个master上都部署nginx和keepalived形成高可用集群。</p> <p>我们采用nginx四层负载均衡，四层负载均衡的作用就是对IP进行负载，不涉及应用层，由于我们使用keepalived做高可用集群，keepalived就是针对IP地址实现高可用，因此需要配合nginx四层负载均衡来实现，当用户访问keepalived的VIP时，直接将请求转发到对应的master角色主机上，将VIP地址转换成master节点IP+端口，这样一来，即使master1挂掉了，master2成为了master角色，请求转发进来，也会将VIP转换成master2节点的地址，高可用也就实现了。</p> <p><strong>kube-apiserver高可用架构图</strong></p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/4166bf6696044bc1b4f47efb7cf03acd.png" alt="在这里插入图片描述"></p> <h4 id="_10-4-1-部署nginx负载均衡"><a href="#_10-4-1-部署nginx负载均衡" class="header-anchor">#</a> 10.4.1.部署Nginx负载均衡</h4> <p>master1和master2上的nginx部署和配置文件内容一样，这里只写master1的操作步骤。</p> <p>nginx负载均衡采用四层负载。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.安装nginx和keepalived及nginx四层负载均衡模块等软件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span>#  yum -y <span class="token function">install</span> nginx keepalived nginx-mod-stream

<span class="token number">2</span>.修改nginx主配置文件增加include模块引入4层负载配置文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/nginx/nginx.conf
include /etc/nginx/conf.c/*.conf<span class="token punctuation">;</span>			<span class="token comment">#17行左右，与http模块同级</span>

<span class="token number">3</span>.编写配置文件
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> /etc/nginx/conf.c
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/nginx/conf.c/k8s-apiserver.conf 
stream <span class="token punctuation">{</span>
	log_format  main  <span class="token string">'$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent'</span><span class="token punctuation">;</span>

	access_log /var/log/nginx/k8s-apiserver.log main<span class="token punctuation">;</span>
	
	upstream k8s-apiserver <span class="token punctuation">{</span>
		server <span class="token number">192.168</span>.20.11:6443<span class="token punctuation">;</span>
		server <span class="token number">192.168</span>.20.12:6443<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	server <span class="token punctuation">{</span>
		listen <span class="token number">16443</span><span class="token punctuation">;</span>			<span class="token comment">#由于我们的nginx与k8s master在同一台机器上，防止端口冲突，因此改为16443端口</span>
		proxy_pass k8s-apiserver<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">4</span>.启动nginx
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># nginx -t
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># nginx

<span class="token number">5</span>.查看端口
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:16443           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">3181</span>/nginx: worker 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="_10-4-2-部署keepalived双机热备"><a href="#_10-4-2-部署keepalived双机热备" class="header-anchor">#</a> 10.4.2.部署keepalived双机热备</h4> <p>在配置keepalived的时候也需要配置一个<strong>vrrp_script</strong>模块，keepalived只能做到对网络故障和keepalived本身的监控，即当出现网络故障或者keepalived本身出现问题时，进行切换。但是这些还不够，我们还需要监控keepalived所在服务器上的其他业务进程，比如说nginx，keepalived+nginx实现nginx的负载均衡高可用，如果nginx异常，仅仅keepalived保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换。这个时候，我们可以通过编写脚本对nginx进程进行检测监控。</p> <p><strong>1.MASTER节点部署</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.安装keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span>#  yum -y <span class="token function">install</span> keepalived

<span class="token number">2</span>.配置keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/keepalived/keepalived.conf 
global_defs <span class="token punctuation">{</span>
   notification_email <span class="token punctuation">{</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server <span class="token number">127.0</span>.0.1
   smtp_connect_timeout <span class="token number">30</span>
   router_id NGINX_MASTER
<span class="token punctuation">}</span>

vrrp_script check_nginx <span class="token punctuation">{</span>				<span class="token comment">#定义健康检查脚本</span>
    script <span class="token string">&quot;/etc/keepalived/check_nginx.sh&quot;</span>
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{</span>
    state MASTER					<span class="token comment">#状态为MASTER</span>
    interface ens192				<span class="token comment">#将VIP绑定在哪块网卡上</span>
    virtual_router_id <span class="token number">51</span>			<span class="token comment">#实例ID，集群所有节点都要保持一致</span>
    priority <span class="token number">100</span>					<span class="token comment">#优先级，255最高</span>
    advert_int <span class="token number">1</span>					<span class="token comment">#指定VRRP心跳包通告间隔时间，默认1秒</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">192.168</span>.20.9/23					<span class="token comment">#定义VIP地址</span>
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>	
        check_nginx					
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">3</span>.编写检查nginx状态的检查脚本
<span class="token comment">#当nginx异常时，自动将当前主机的keepalived进程关闭，使BACKUP上的keepalived成为MASTER继续提供服务</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/keepalived/check_nginx.sh 
<span class="token assign-left variable">nginx_ch</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span><span class="token operator">|</span> <span class="token function">egrep</span> -cv <span class="token function">grep</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$nginx_ch</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
	systemctl stop keepalived
	<span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">else</span>
	<span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>

<span class="token number">4</span>.启动keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> keepalived

<span class="token number">5</span>.查看VIP地址
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> ens192
<span class="token number">2</span>: ens192: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc mq state UP group default qlen <span class="token number">1000</span>
    inet <span class="token number">192.168</span>.20.10/23 brd <span class="token number">192.168</span>.21.255 scope global noprefixroute ens192
    inet <span class="token number">192.168</span>.20.9/23 scope global secondary ens192
<span class="token comment">#VIP已经准备就绪</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p><strong>2.BACKUP节点部署</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.安装keepalived
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span>#  yum -y <span class="token function">install</span> keepalived

<span class="token number">2</span>.配置keepalived
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/keepalived/keepalived.conf 
global_defs <span class="token punctuation">{</span>
   notification_email <span class="token punctuation">{</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server <span class="token number">127.0</span>.0.1
   smtp_connect_timeout <span class="token number">30</span>
   router_id NGINX_MASTER
<span class="token punctuation">}</span>

vrrp_script check_nginx <span class="token punctuation">{</span>
    script <span class="token string">&quot;/etc/keepalived/check_nginx.sh&quot;</span>
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{</span>
    state BACKUP				<span class="token comment">#状态为BACKUP</span>
    interface ens192
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">90</span>				<span class="token comment">#优先级要比MASTER低</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">192.168</span>.20.9/23
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>
        check_nginx
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token number">3</span>.编写检查nginx状态的检查脚本
<span class="token comment">#当nginx异常时，自动将当前主机的keepalived进程关闭，使BACKUP上的keepalived成为MASTER继续提供服务</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/keepalived/check_nginx.sh 
<span class="token assign-left variable">nginx_ch</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span><span class="token operator">|</span> <span class="token function">egrep</span> -cv <span class="token function">grep</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$nginx_ch</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
	systemctl stop keepalived
	<span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">else</span>
	<span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>

<span class="token number">4</span>.启动keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h4 id="_10-4-3-使用vip访问kubernetes服务"><a href="#_10-4-3-使用vip访问kubernetes服务" class="header-anchor">#</a> 10.4.3.使用VIP访问kubernetes服务</h4> <p>可以正确获取到K8s版本信息，说明负载均衡器搭建正常。该请求数据流程：curl -&gt; vip(nginx) -&gt; apiserver。</p> <p>日志中也会记录访问记录。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">curl</span> -k https://192.168.20.9:16443/version
<span class="token punctuation">{</span>
  <span class="token string">&quot;major&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
  <span class="token string">&quot;minor&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;20&quot;</span>,
  <span class="token string">&quot;gitVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1.20.4&quot;</span>,
  <span class="token string">&quot;gitCommit&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;e87da0bd6e03ec3fea7933c4b5263d151aafd07c&quot;</span>,
  <span class="token string">&quot;gitTreeState&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;clean&quot;</span>,
  <span class="token string">&quot;buildDate&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-02-18T16:03:00Z&quot;</span>,
  <span class="token string">&quot;goVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;go1.15.8&quot;</span>,
  <span class="token string">&quot;compiler&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;gc&quot;</span>,
  <span class="token string">&quot;platform&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;linux/amd64&quot;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tail</span> -f /var/log/nginx/k8s-apiserver.log 
<span class="token number">127.0</span>.0.1 <span class="token number">192.168</span>.20.11:6443 - <span class="token punctuation">[</span>09/Sep/2021:11:28:15 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">79</span>
<span class="token number">127.0</span>.0.1 <span class="token number">192.168</span>.20.11:6443 - <span class="token punctuation">[</span>09/Sep/2021:11:28:20 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">178</span>
<span class="token number">192.168</span>.20.10 <span class="token number">192.168</span>.20.11:6443 - <span class="token punctuation">[</span>09/Sep/2021:15:20:29 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">178</span>
<span class="token number">192.168</span>.20.10 <span class="token number">192.168</span>.20.12:6443, <span class="token number">192.168</span>.20.11:6443 - <span class="token punctuation">[</span>09/Sep/2021:16:19:00 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">0</span>, <span class="token number">420</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_10-4-4-测试keepalived高可用"><a href="#_10-4-4-测试keepalived高可用" class="header-anchor">#</a> 10.4.4.测试keepalived高可用</h4> <p><strong>1.停掉master1上的keepalived，查看VIP是否会切换到master2节点</strong></p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/dba9f62a2a0744c3b3ccc86981ad86a4.png" alt="在这里插入图片描述"></p> <p><strong>2.重新启动master1上的keepalived，查看VIP是否会自动切换到master1</strong></p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/54cdc63de7c040519287127263385c0c.png" alt="在这里插入图片描述"></p> <h3 id="_10-5-切换kubernetes集群为高可用模式"><a href="#_10-5-切换kubernetes集群为高可用模式" class="header-anchor">#</a> 10.5.切换kubernetes集群为高可用模式</h3> <p>虽然我们增加了Master2 Node和负载均衡器，但是我们是从单Master架构扩容的，也就是说目前所有的Worker Node组件连接都还是Master1 Node，如果不改为连接VIP走负载均衡器，那么Master还是单点故障。</p> <p>由于已经可以通过keepalived的VIP地址访问到apiserver，高可用效果已达成，目前只需要将集群的所有节点（kubectl get node）能看到的一切节点，将配置文件中的apiserver的地址换成VIP地址加端口，才能真正的实现kubernetes高可用。</p> <p>之前前期使用VIP测试kube-apiserver没问题，即使在切换高可用的情况下，所有节点也不会处于NotReady状态。</p> <p><strong>1.切换高可用环境</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.binary-k8s-master1节点切换
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /data/kubernetes/config/*
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /root/.kube/config 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy

<span class="token number">2</span>.binary-k8s-master2切换
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /data/kubernetes/config/*
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /root/.kube/config
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy

<span class="token number">3</span>.binary-k8s-node1切换
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /data/kubernetes/config/*
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart kubelet kube-proxy

<span class="token number">4</span>.binary-k8s-node2切换
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /data/kubernetes/config/*
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart kubelet kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>2.查看集群状态及资源</strong></p> <p>到此为止kubernetes高可用集群实现完毕</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   5d22h   v1.20.4
binary-k8s-master2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   25h     v1.20.4
binary-k8s-node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3d5h    v1.20.4
binary-k8s-node2     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2d23h   v1.20.4

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get cs
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_11-测试kubernetes高可用集群"><a href="#_11-测试kubernetes高可用集群" class="header-anchor">#</a> 11.测试kubernetes高可用集群</h2> <p><strong>1.停掉master1上的keepalived验证集群是否可用</strong></p> <p>状态：“ok”</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/c146811a76994c2eb7ecea1a95bae2ab.png" alt="在这里插入图片描述"></p> <p><strong>2.停掉master1上所有k8s组件验证集群是否可用</strong></p> <p>状态：“ok”</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/a5cfe03d354441798591ae5add26898e.png" alt="在这里插入图片描述"></p> <h2 id="_12-在kubernetes集群运行一套服务验证集群的可用性"><a href="#_12-在kubernetes集群运行一套服务验证集群的可用性" class="header-anchor">#</a> 12.在kubernetes集群运行一套服务验证集群的可用性</h2> <p>简单部署一个基于nginx的web服务。</p> <h3 id="_12-1-创建资源yaml文件"><a href="#_12-1-创建资源yaml文件" class="header-anchor">#</a> 12.1.创建资源yaml文件</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> know-system.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-know-system
spec:
  replicas: <span class="token number">3</span>
  selector:
    matchLabels:
      app: know-system-pod
  template:
    metadata:
      labels:
        app: know-system-pod
    spec:
      containers:
      - name: know-system
        image: know-system:v1
        ports:
        - containerPort: <span class="token number">80</span>
      nodeName: binary-k8s-master1

---
apiVersion: v1
kind: Service
metadata:
  name: know-system-service
spec:
  selector:
    app: know-system-pod
  type: NodePort
  ports:
  - port: <span class="token number">80</span>
    targetPort: <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_12-2-创建资源并进行测试"><a href="#_12-2-创建资源并进行测试" class="header-anchor">#</a> 12.2.创建资源并进行测试</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f know-system.yaml 
deployment.apps/deploy-know-system created
service/know-system-service created

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get pod,svc
NAME                                     READY   STATUS    RESTARTS   AGE
pod/deploy-know-system-b4c9c55d7-5mf2f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s
pod/deploy-know-system-b4c9c55d7-97ckx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          48s
pod/deploy-know-system-b4c9c55d7-kb97t   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s

NAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/know-system-service   NodePort    <span class="token number">10.0</span>.0.38    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:32702/TCP   47s
service/kubernetes            ClusterIP   <span class="token number">10.0</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        10d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>访问https://集群任意节点+32702端口即可浏览web服务。</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/8c7dc7f2aad14d74a07b8ab6c35e09a9.png" alt="在这里插入图片描述"></p> <h2 id="_13-部署kubernetes-dashboard"><a href="#_13-部署kubernetes-dashboard" class="header-anchor">#</a> 13.部署kubernetes dashboard</h2> <h3 id="_13-1-部署dashboard"><a href="#_13-1-部署dashboard" class="header-anchor">#</a> 13.1.部署dashboard</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.部署yaml
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f kubernetes-dashboard.yaml 
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created

<span class="token number">2</span>.创建授权账号
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl create serviceaccount dashboard-admin -n kube-system
serviceaccount/dashboard-admin created
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl create clusterrolebinding dashboard-admin --clusterrole<span class="token operator">=</span>cluster-admin --serviceaccount<span class="token operator">=</span>kube-system:dashboard-admin
clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created

<span class="token number">3</span>.查看登陆使用的token字符串
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl describe secrets -n kube-system <span class="token variable"><span class="token variable">$(</span>kubectl -n kube-system get secret <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/dashboard-admin/{print $1}'</span><span class="token variable">)</span></span>
Name:         dashboard-admin-token-lnm2r
Namespace:    kube-system
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: 73b370c9-b1b4-4418-b02d-fee9b6cf6342

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkgwWGJXQ1duVVI4eFh4Ykw2U25JVk9fa2hDOGZVRTRRMVZyVmdwWXM1Nk0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tbG5tMnIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzNiMzcwYzktYjFiNC00NDE4LWIwMmQtZmVlOWI2Y2Y2MzQyIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.XWJLZDB7mNk_NNpXVv64LrbKy5f1hB2PS5qER5YFATzl3U9ISX05PCrnCEY-6uVSbPkRGZbTQZTBwiGjOfsyLZljvY3cbmGlH2oW2shUS8LDqli4MKA14JyUX1ubbQ8vq9uSqkQMCQBzZTUGIuZt95jw3-IMv2rfZ9ET8_uVuXIoZXbckY6VHFy8QOB6sy1n9j0j4qcOttyKHVXN8Q5KjsIlb44Y5HtiveKxpw_LA81eTwml_aiVvO9rgMKVdSHIg8CY1Mcp06ezz0kD0jsBLt7xaAujSNZnCiXzmpg51xujbR0k-4BVlwPBBpQLaSWGoHR3X7z5E02onXttbbX6-w
ca.crt:     <span class="token number">1359</span> bytes
namespace:  <span class="token number">11</span> bytes

<span class="token number">4</span>.查看pod的状态
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get pod,svc -n kubernetes-dashboard
NAME                                             READY   STATUS    RESTARTS   AGE
pod/dashboard-metrics-scraper-7445d59dfd-bg9c8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m51s
pod/kubernetes-dashboard-5ddcdf9c99-nkgqw        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m52s

NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
service/dashboard-metrics-scraper   ClusterIP   <span class="token number">10.0</span>.0.83    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8000</span>/TCP        8m52s
service/kubernetes-dashboard        NodePort    <span class="token number">10.0</span>.0.153   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>:30001/TCP   8m53s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h3 id="_13-2-访问dashboard"><a href="#_13-2-访问dashboard" class="header-anchor">#</a> 13.2.访问dashboard</h3> <p>访问https://集群任意节点+30001端口，然后填写刚刚查到的token值，点击登陆。</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/2c6c6346e8854ffcb85a23d3569c056e.png" alt="在这里插入图片描述"></p> <p>仪表盘</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/f2dfdb9364bb4b0e875851131d711e34.png" alt="在这里插入图片描述"></p></div> <footer class="page-edit" style="display:none;"><div class="edit-link"><a href="https://github.com/AGou-ops/myDocsv2/edit/master/docs/k8s/Installation/Kubernetes 二进制安装.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2022/06/01, 14:44:58</span></div></footer> <!----> <!----> <div class="article-list" data-v-2af88190><div class="article-title" data-v-2af88190><a href="/myDocsv2/timeline/" class="iconfont icon-shizhong" data-v-2af88190>最近更新</a></div> <div class="article-wrapper" data-v-2af88190><dl data-v-2af88190><dd data-v-2af88190>01</dd> <dt data-v-2af88190><a href="/myDocsv2/timeline/2022-03-09.html" data-v-2af88190><div data-v-2af88190>生命短暂，犹如露珠消散，人们在奔波中寻求答案。</div></a> <span data-v-2af88190>03-09</span></dt></dl><dl data-v-2af88190><dd data-v-2af88190>02</dd> <dt data-v-2af88190><a href="/myDocsv2/timeline/2018-05-06.html" data-v-2af88190><div data-v-2af88190>人生天地之间，若白驹过隙，忽然而已。</div></a> <span data-v-2af88190>05-06</span></dt></dl></div> <div data-v-2af88190><a href="/myDocsv2/timeline/" class="article-more" data-v-2af88190>更多文章 &gt;</a></div></div></main> <!----> <div class="comments-wrapper" data-v-584a622c><div class="valine-wrapper"><div id="valine"></div></div></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div><!----><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 AGou's Docs-v2
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><div></div><!----><div data-v-3338c3f8><div class="DetailsOpenFlag" style="right:1rem;bottom:9rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;font-size:14px;font-weight:500;display:none;" data-v-3338c3f8>
 展开

</div></div></div></div>
    <script src="/myDocsv2/assets/js/app.792c833e.js" defer></script><script src="/myDocsv2/assets/js/5.dd197eb6.js" defer></script><script src="/myDocsv2/assets/js/1.3bd7010a.js" defer></script><script src="/myDocsv2/assets/js/2.0c757b52.js" defer></script><script src="/myDocsv2/assets/js/41.1b06014c.js" defer></script><script src="/myDocsv2/assets/js/17.ce9a229a.js" defer></script>
  </body>
</html>
