<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AGou&#39;s Docs-v2</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="https://infinitypro-img.infinitynewtab.com/custom-icon/8001de1jd3n68lbfnxxt564xvb0vl5.png?imageMogr2/thumbnail/240x/format/webp/blur/1x0/quality/100|imageslim">
    <script language="javascript" type="text/javascript" src="https://cdn.staticfile.org/jquery/1.7.2/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-2DZCW6NJZF"></script>
    <script language="javascript" type="text/javascript" content="function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag(&quot;js&quot;,new Date),gtag(&quot;config&quot;,&quot;G-2DZCW6NJZF&quot;);"></script>
    <meta name="description" content="å²‚èƒ½å°½å¦‚äººæ„ï¼Œä½†æ±‚æ— æ„§æˆ‘å¿ƒã€‚">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/myDocsv2/assets/css/0.styles.21bb8301.css" as="style"><link rel="preload" href="/myDocsv2/assets/js/app.792c833e.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/5.dd197eb6.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/1.3bd7010a.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/2.0c757b52.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/41.1b06014c.js" as="script"><link rel="preload" href="/myDocsv2/assets/js/17.ce9a229a.js" as="script"><link rel="prefetch" href="/myDocsv2/assets/js/10.560f0585.js"><link rel="prefetch" href="/myDocsv2/assets/js/100.d260e792.js"><link rel="prefetch" href="/myDocsv2/assets/js/101.59a52c3b.js"><link rel="prefetch" href="/myDocsv2/assets/js/102.c83fe080.js"><link rel="prefetch" href="/myDocsv2/assets/js/103.486f1569.js"><link rel="prefetch" href="/myDocsv2/assets/js/104.147ef422.js"><link rel="prefetch" href="/myDocsv2/assets/js/105.7cdddb7f.js"><link rel="prefetch" href="/myDocsv2/assets/js/106.6bb6504a.js"><link rel="prefetch" href="/myDocsv2/assets/js/107.958c4a2e.js"><link rel="prefetch" href="/myDocsv2/assets/js/108.89dea5fa.js"><link rel="prefetch" href="/myDocsv2/assets/js/109.25e918a2.js"><link rel="prefetch" href="/myDocsv2/assets/js/11.30085370.js"><link rel="prefetch" href="/myDocsv2/assets/js/110.5b72de31.js"><link rel="prefetch" href="/myDocsv2/assets/js/111.950db23b.js"><link rel="prefetch" href="/myDocsv2/assets/js/112.dea68ec6.js"><link rel="prefetch" href="/myDocsv2/assets/js/113.4cd2fdf5.js"><link rel="prefetch" href="/myDocsv2/assets/js/114.8fb68b8d.js"><link rel="prefetch" href="/myDocsv2/assets/js/115.853e9eac.js"><link rel="prefetch" href="/myDocsv2/assets/js/116.370ed12f.js"><link rel="prefetch" href="/myDocsv2/assets/js/117.e54ab1d2.js"><link rel="prefetch" href="/myDocsv2/assets/js/118.f875192d.js"><link rel="prefetch" href="/myDocsv2/assets/js/119.130ba6df.js"><link rel="prefetch" href="/myDocsv2/assets/js/12.bad43817.js"><link rel="prefetch" href="/myDocsv2/assets/js/120.ea722a75.js"><link rel="prefetch" href="/myDocsv2/assets/js/121.e6b1a38f.js"><link rel="prefetch" href="/myDocsv2/assets/js/122.cfa9c92b.js"><link rel="prefetch" href="/myDocsv2/assets/js/123.bd0e517c.js"><link rel="prefetch" href="/myDocsv2/assets/js/124.516b8976.js"><link rel="prefetch" href="/myDocsv2/assets/js/125.aa9491a0.js"><link rel="prefetch" href="/myDocsv2/assets/js/126.249ad6f3.js"><link rel="prefetch" href="/myDocsv2/assets/js/127.15e07998.js"><link rel="prefetch" href="/myDocsv2/assets/js/128.6e4e1f1d.js"><link rel="prefetch" href="/myDocsv2/assets/js/129.9fa7ef9d.js"><link rel="prefetch" href="/myDocsv2/assets/js/13.4f93795a.js"><link rel="prefetch" href="/myDocsv2/assets/js/130.7ed7958f.js"><link rel="prefetch" href="/myDocsv2/assets/js/131.6a4ed50f.js"><link rel="prefetch" href="/myDocsv2/assets/js/132.60d2ac03.js"><link rel="prefetch" href="/myDocsv2/assets/js/133.657186df.js"><link rel="prefetch" href="/myDocsv2/assets/js/134.de4a0998.js"><link rel="prefetch" href="/myDocsv2/assets/js/135.773bff70.js"><link rel="prefetch" href="/myDocsv2/assets/js/136.03b7adc5.js"><link rel="prefetch" href="/myDocsv2/assets/js/137.e59abdb8.js"><link rel="prefetch" href="/myDocsv2/assets/js/138.b00ee386.js"><link rel="prefetch" href="/myDocsv2/assets/js/139.11d16ca5.js"><link rel="prefetch" href="/myDocsv2/assets/js/14.5b43ffdb.js"><link rel="prefetch" href="/myDocsv2/assets/js/140.d2461af0.js"><link rel="prefetch" href="/myDocsv2/assets/js/141.51a02429.js"><link rel="prefetch" href="/myDocsv2/assets/js/142.de00d6b2.js"><link rel="prefetch" href="/myDocsv2/assets/js/143.2e00599f.js"><link rel="prefetch" href="/myDocsv2/assets/js/144.d91b742b.js"><link rel="prefetch" href="/myDocsv2/assets/js/145.fd4eeb59.js"><link rel="prefetch" href="/myDocsv2/assets/js/146.2da768b9.js"><link rel="prefetch" href="/myDocsv2/assets/js/147.2392d1bd.js"><link rel="prefetch" href="/myDocsv2/assets/js/148.3f9f1e85.js"><link rel="prefetch" href="/myDocsv2/assets/js/149.ccc77b35.js"><link rel="prefetch" href="/myDocsv2/assets/js/15.567b35e8.js"><link rel="prefetch" href="/myDocsv2/assets/js/150.bc27fad5.js"><link rel="prefetch" href="/myDocsv2/assets/js/151.8d88bccd.js"><link rel="prefetch" href="/myDocsv2/assets/js/152.2f8b753c.js"><link rel="prefetch" href="/myDocsv2/assets/js/153.3e99f777.js"><link rel="prefetch" href="/myDocsv2/assets/js/154.28a03309.js"><link rel="prefetch" href="/myDocsv2/assets/js/155.d31e6da9.js"><link rel="prefetch" href="/myDocsv2/assets/js/156.dbbb018d.js"><link rel="prefetch" href="/myDocsv2/assets/js/157.dacf2c34.js"><link rel="prefetch" href="/myDocsv2/assets/js/158.92d5a5c7.js"><link rel="prefetch" href="/myDocsv2/assets/js/159.163e1ce5.js"><link rel="prefetch" href="/myDocsv2/assets/js/16.246dc068.js"><link rel="prefetch" href="/myDocsv2/assets/js/160.f6373d44.js"><link rel="prefetch" href="/myDocsv2/assets/js/161.1ee05cbb.js"><link rel="prefetch" href="/myDocsv2/assets/js/162.90d44205.js"><link rel="prefetch" href="/myDocsv2/assets/js/163.0ab9f4cc.js"><link rel="prefetch" href="/myDocsv2/assets/js/164.e7b76b81.js"><link rel="prefetch" href="/myDocsv2/assets/js/165.f4e96a57.js"><link rel="prefetch" href="/myDocsv2/assets/js/166.9da04171.js"><link rel="prefetch" href="/myDocsv2/assets/js/167.7869b189.js"><link rel="prefetch" href="/myDocsv2/assets/js/168.fd171306.js"><link rel="prefetch" href="/myDocsv2/assets/js/169.a3accba0.js"><link rel="prefetch" href="/myDocsv2/assets/js/170.69b8ea3d.js"><link rel="prefetch" href="/myDocsv2/assets/js/171.8519d41a.js"><link rel="prefetch" href="/myDocsv2/assets/js/172.853e162a.js"><link rel="prefetch" href="/myDocsv2/assets/js/173.61f68a82.js"><link rel="prefetch" href="/myDocsv2/assets/js/174.4a6c4ebe.js"><link rel="prefetch" href="/myDocsv2/assets/js/175.4da076f8.js"><link rel="prefetch" href="/myDocsv2/assets/js/176.db59955f.js"><link rel="prefetch" href="/myDocsv2/assets/js/177.8e8a7c16.js"><link rel="prefetch" href="/myDocsv2/assets/js/178.c253fb27.js"><link rel="prefetch" href="/myDocsv2/assets/js/179.5662c8f8.js"><link rel="prefetch" href="/myDocsv2/assets/js/18.42c2a799.js"><link rel="prefetch" href="/myDocsv2/assets/js/180.54165af7.js"><link rel="prefetch" href="/myDocsv2/assets/js/181.e07c952b.js"><link rel="prefetch" href="/myDocsv2/assets/js/182.53626bff.js"><link rel="prefetch" href="/myDocsv2/assets/js/183.b92c4e7a.js"><link rel="prefetch" href="/myDocsv2/assets/js/184.640e2011.js"><link rel="prefetch" href="/myDocsv2/assets/js/185.82c83e0f.js"><link rel="prefetch" href="/myDocsv2/assets/js/186.0e7a9c8a.js"><link rel="prefetch" href="/myDocsv2/assets/js/187.b1279218.js"><link rel="prefetch" href="/myDocsv2/assets/js/188.919e8202.js"><link rel="prefetch" href="/myDocsv2/assets/js/189.12ca6319.js"><link rel="prefetch" href="/myDocsv2/assets/js/19.80fbdf4d.js"><link rel="prefetch" href="/myDocsv2/assets/js/190.0cabf0ec.js"><link rel="prefetch" href="/myDocsv2/assets/js/191.4473c05d.js"><link rel="prefetch" href="/myDocsv2/assets/js/192.cfd1676f.js"><link rel="prefetch" href="/myDocsv2/assets/js/193.be924226.js"><link rel="prefetch" href="/myDocsv2/assets/js/194.28405918.js"><link rel="prefetch" href="/myDocsv2/assets/js/195.895d8931.js"><link rel="prefetch" href="/myDocsv2/assets/js/196.a5074835.js"><link rel="prefetch" href="/myDocsv2/assets/js/197.5ac7add8.js"><link rel="prefetch" href="/myDocsv2/assets/js/198.1243e120.js"><link rel="prefetch" href="/myDocsv2/assets/js/199.1dedd774.js"><link rel="prefetch" href="/myDocsv2/assets/js/20.03b1f0ff.js"><link rel="prefetch" href="/myDocsv2/assets/js/200.47677147.js"><link rel="prefetch" href="/myDocsv2/assets/js/201.ae7c32ad.js"><link rel="prefetch" href="/myDocsv2/assets/js/202.b9ab3aba.js"><link rel="prefetch" href="/myDocsv2/assets/js/203.5716a175.js"><link rel="prefetch" href="/myDocsv2/assets/js/204.0dff0870.js"><link rel="prefetch" href="/myDocsv2/assets/js/205.5722c8b0.js"><link rel="prefetch" href="/myDocsv2/assets/js/206.94ecd56d.js"><link rel="prefetch" href="/myDocsv2/assets/js/207.fbef39ad.js"><link rel="prefetch" href="/myDocsv2/assets/js/208.f033c96a.js"><link rel="prefetch" href="/myDocsv2/assets/js/209.b022ee5b.js"><link rel="prefetch" href="/myDocsv2/assets/js/21.2048f6fd.js"><link rel="prefetch" href="/myDocsv2/assets/js/210.c8278e5f.js"><link rel="prefetch" href="/myDocsv2/assets/js/211.df648ec4.js"><link rel="prefetch" href="/myDocsv2/assets/js/212.c591597e.js"><link rel="prefetch" href="/myDocsv2/assets/js/213.59dd0072.js"><link rel="prefetch" href="/myDocsv2/assets/js/214.4250b8d5.js"><link rel="prefetch" href="/myDocsv2/assets/js/215.06bf9012.js"><link rel="prefetch" href="/myDocsv2/assets/js/216.f9f569dc.js"><link rel="prefetch" href="/myDocsv2/assets/js/217.0d90efa0.js"><link rel="prefetch" href="/myDocsv2/assets/js/218.941f9041.js"><link rel="prefetch" href="/myDocsv2/assets/js/219.087abc3e.js"><link rel="prefetch" href="/myDocsv2/assets/js/22.1468e026.js"><link rel="prefetch" href="/myDocsv2/assets/js/220.4519068e.js"><link rel="prefetch" href="/myDocsv2/assets/js/221.020f293f.js"><link rel="prefetch" href="/myDocsv2/assets/js/222.0eabad26.js"><link rel="prefetch" href="/myDocsv2/assets/js/223.ad574537.js"><link rel="prefetch" href="/myDocsv2/assets/js/224.ae6d0b7a.js"><link rel="prefetch" href="/myDocsv2/assets/js/225.8a723b88.js"><link rel="prefetch" href="/myDocsv2/assets/js/226.7285c5f4.js"><link rel="prefetch" href="/myDocsv2/assets/js/227.a14fc969.js"><link rel="prefetch" href="/myDocsv2/assets/js/228.66daebef.js"><link rel="prefetch" href="/myDocsv2/assets/js/229.6403de74.js"><link rel="prefetch" href="/myDocsv2/assets/js/23.e667901e.js"><link rel="prefetch" href="/myDocsv2/assets/js/230.03323ece.js"><link rel="prefetch" href="/myDocsv2/assets/js/231.f3295fcb.js"><link rel="prefetch" href="/myDocsv2/assets/js/232.9c83055f.js"><link rel="prefetch" href="/myDocsv2/assets/js/233.169da2a3.js"><link rel="prefetch" href="/myDocsv2/assets/js/234.2c098527.js"><link rel="prefetch" href="/myDocsv2/assets/js/235.62700dfa.js"><link rel="prefetch" href="/myDocsv2/assets/js/236.f682323d.js"><link rel="prefetch" href="/myDocsv2/assets/js/237.60773b74.js"><link rel="prefetch" href="/myDocsv2/assets/js/238.fb376db3.js"><link rel="prefetch" href="/myDocsv2/assets/js/239.21fe9787.js"><link rel="prefetch" href="/myDocsv2/assets/js/24.18db0e43.js"><link rel="prefetch" href="/myDocsv2/assets/js/240.412b1fd5.js"><link rel="prefetch" href="/myDocsv2/assets/js/241.eb5e205b.js"><link rel="prefetch" href="/myDocsv2/assets/js/242.1b505ffe.js"><link rel="prefetch" href="/myDocsv2/assets/js/243.07e81cfd.js"><link rel="prefetch" href="/myDocsv2/assets/js/244.82c529d0.js"><link rel="prefetch" href="/myDocsv2/assets/js/245.c3458778.js"><link rel="prefetch" href="/myDocsv2/assets/js/246.66e98887.js"><link rel="prefetch" href="/myDocsv2/assets/js/247.1a0993dd.js"><link rel="prefetch" href="/myDocsv2/assets/js/248.a63069b1.js"><link rel="prefetch" href="/myDocsv2/assets/js/249.dd372d75.js"><link rel="prefetch" href="/myDocsv2/assets/js/25.285160e4.js"><link rel="prefetch" href="/myDocsv2/assets/js/250.eb634570.js"><link rel="prefetch" href="/myDocsv2/assets/js/251.f04a5705.js"><link rel="prefetch" href="/myDocsv2/assets/js/252.6ad19080.js"><link rel="prefetch" href="/myDocsv2/assets/js/253.dd154571.js"><link rel="prefetch" href="/myDocsv2/assets/js/254.230b3e5e.js"><link rel="prefetch" href="/myDocsv2/assets/js/255.d40d9e7e.js"><link rel="prefetch" href="/myDocsv2/assets/js/256.28281885.js"><link rel="prefetch" href="/myDocsv2/assets/js/257.6298bda8.js"><link rel="prefetch" href="/myDocsv2/assets/js/258.2fefa56c.js"><link rel="prefetch" href="/myDocsv2/assets/js/259.cb5aea63.js"><link rel="prefetch" href="/myDocsv2/assets/js/26.fae61a7f.js"><link rel="prefetch" href="/myDocsv2/assets/js/260.b29da0f4.js"><link rel="prefetch" href="/myDocsv2/assets/js/261.3db0aa59.js"><link rel="prefetch" href="/myDocsv2/assets/js/262.0b3015b0.js"><link rel="prefetch" href="/myDocsv2/assets/js/263.7577edc3.js"><link rel="prefetch" href="/myDocsv2/assets/js/264.5ff38add.js"><link rel="prefetch" href="/myDocsv2/assets/js/265.e339901e.js"><link rel="prefetch" href="/myDocsv2/assets/js/266.a2027a85.js"><link rel="prefetch" href="/myDocsv2/assets/js/267.08188cb1.js"><link rel="prefetch" href="/myDocsv2/assets/js/268.d30558f8.js"><link rel="prefetch" href="/myDocsv2/assets/js/269.aa62020a.js"><link rel="prefetch" href="/myDocsv2/assets/js/27.b1a4cdea.js"><link rel="prefetch" href="/myDocsv2/assets/js/270.56fe4e52.js"><link rel="prefetch" href="/myDocsv2/assets/js/271.4dbe5ca9.js"><link rel="prefetch" href="/myDocsv2/assets/js/272.ebb4279a.js"><link rel="prefetch" href="/myDocsv2/assets/js/273.82120a56.js"><link rel="prefetch" href="/myDocsv2/assets/js/274.409c4f82.js"><link rel="prefetch" href="/myDocsv2/assets/js/275.b1030128.js"><link rel="prefetch" href="/myDocsv2/assets/js/276.e35f1ba0.js"><link rel="prefetch" href="/myDocsv2/assets/js/277.78b42eab.js"><link rel="prefetch" href="/myDocsv2/assets/js/278.1d224e38.js"><link rel="prefetch" href="/myDocsv2/assets/js/279.5c7dd3ae.js"><link rel="prefetch" href="/myDocsv2/assets/js/28.e9c369f8.js"><link rel="prefetch" href="/myDocsv2/assets/js/280.07aa017e.js"><link rel="prefetch" href="/myDocsv2/assets/js/281.dcb43aec.js"><link rel="prefetch" href="/myDocsv2/assets/js/282.22bc522a.js"><link rel="prefetch" href="/myDocsv2/assets/js/283.c8474c90.js"><link rel="prefetch" href="/myDocsv2/assets/js/284.581fa5ab.js"><link rel="prefetch" href="/myDocsv2/assets/js/285.208c4406.js"><link rel="prefetch" href="/myDocsv2/assets/js/286.5e6c6df0.js"><link rel="prefetch" href="/myDocsv2/assets/js/287.acef2acc.js"><link rel="prefetch" href="/myDocsv2/assets/js/288.ae3f5d32.js"><link rel="prefetch" href="/myDocsv2/assets/js/289.039c32e1.js"><link rel="prefetch" href="/myDocsv2/assets/js/29.a3644474.js"><link rel="prefetch" href="/myDocsv2/assets/js/290.80dfce69.js"><link rel="prefetch" href="/myDocsv2/assets/js/291.9396076f.js"><link rel="prefetch" href="/myDocsv2/assets/js/292.aafda658.js"><link rel="prefetch" href="/myDocsv2/assets/js/293.9d432ff9.js"><link rel="prefetch" href="/myDocsv2/assets/js/294.9bd1328b.js"><link rel="prefetch" href="/myDocsv2/assets/js/295.272f5c7a.js"><link rel="prefetch" href="/myDocsv2/assets/js/296.0cc8fe44.js"><link rel="prefetch" href="/myDocsv2/assets/js/297.67a972ae.js"><link rel="prefetch" href="/myDocsv2/assets/js/298.9d16d98c.js"><link rel="prefetch" href="/myDocsv2/assets/js/299.0f04c0eb.js"><link rel="prefetch" href="/myDocsv2/assets/js/30.b5a32504.js"><link rel="prefetch" href="/myDocsv2/assets/js/300.d4e215e6.js"><link rel="prefetch" href="/myDocsv2/assets/js/301.60d51efc.js"><link rel="prefetch" href="/myDocsv2/assets/js/302.abb371d9.js"><link rel="prefetch" href="/myDocsv2/assets/js/303.b22b36ac.js"><link rel="prefetch" href="/myDocsv2/assets/js/304.3261e7b2.js"><link rel="prefetch" href="/myDocsv2/assets/js/305.807e25af.js"><link rel="prefetch" href="/myDocsv2/assets/js/306.fe10f19e.js"><link rel="prefetch" href="/myDocsv2/assets/js/307.9f74b43c.js"><link rel="prefetch" href="/myDocsv2/assets/js/308.b8c9f8e6.js"><link rel="prefetch" href="/myDocsv2/assets/js/309.1e5c14f9.js"><link rel="prefetch" href="/myDocsv2/assets/js/31.12707513.js"><link rel="prefetch" href="/myDocsv2/assets/js/310.911f38ce.js"><link rel="prefetch" href="/myDocsv2/assets/js/311.3940d290.js"><link rel="prefetch" href="/myDocsv2/assets/js/312.af9de452.js"><link rel="prefetch" href="/myDocsv2/assets/js/313.e10357a1.js"><link rel="prefetch" href="/myDocsv2/assets/js/314.8d732c56.js"><link rel="prefetch" href="/myDocsv2/assets/js/315.97345578.js"><link rel="prefetch" href="/myDocsv2/assets/js/316.5de46f5d.js"><link rel="prefetch" href="/myDocsv2/assets/js/317.ecbaee88.js"><link rel="prefetch" href="/myDocsv2/assets/js/318.f16657b3.js"><link rel="prefetch" href="/myDocsv2/assets/js/319.e9fc2b8b.js"><link rel="prefetch" href="/myDocsv2/assets/js/32.4794eb28.js"><link rel="prefetch" href="/myDocsv2/assets/js/320.87a080c9.js"><link rel="prefetch" href="/myDocsv2/assets/js/321.dc421947.js"><link rel="prefetch" href="/myDocsv2/assets/js/322.0d8f158f.js"><link rel="prefetch" href="/myDocsv2/assets/js/323.9feb5296.js"><link rel="prefetch" href="/myDocsv2/assets/js/324.11b428d5.js"><link rel="prefetch" href="/myDocsv2/assets/js/325.51e26ebb.js"><link rel="prefetch" href="/myDocsv2/assets/js/326.d7c9128a.js"><link rel="prefetch" href="/myDocsv2/assets/js/327.d2a1a3da.js"><link rel="prefetch" href="/myDocsv2/assets/js/328.f3119b29.js"><link rel="prefetch" href="/myDocsv2/assets/js/329.01ae2bb1.js"><link rel="prefetch" href="/myDocsv2/assets/js/33.7e8c531c.js"><link rel="prefetch" href="/myDocsv2/assets/js/330.757b5be7.js"><link rel="prefetch" href="/myDocsv2/assets/js/331.335622c4.js"><link rel="prefetch" href="/myDocsv2/assets/js/332.79b5dfeb.js"><link rel="prefetch" href="/myDocsv2/assets/js/333.b5bff6cd.js"><link rel="prefetch" href="/myDocsv2/assets/js/334.b4e9badb.js"><link rel="prefetch" href="/myDocsv2/assets/js/335.aed5ff57.js"><link rel="prefetch" href="/myDocsv2/assets/js/336.14ce19b1.js"><link rel="prefetch" href="/myDocsv2/assets/js/337.f0e871b6.js"><link rel="prefetch" href="/myDocsv2/assets/js/338.ba74f399.js"><link rel="prefetch" href="/myDocsv2/assets/js/339.e308e875.js"><link rel="prefetch" href="/myDocsv2/assets/js/34.76ac76e5.js"><link rel="prefetch" href="/myDocsv2/assets/js/340.8afe9761.js"><link rel="prefetch" href="/myDocsv2/assets/js/341.5f7f2739.js"><link rel="prefetch" href="/myDocsv2/assets/js/342.856b7535.js"><link rel="prefetch" href="/myDocsv2/assets/js/343.b71213f5.js"><link rel="prefetch" href="/myDocsv2/assets/js/344.4e9b4c16.js"><link rel="prefetch" href="/myDocsv2/assets/js/345.fde23f4c.js"><link rel="prefetch" href="/myDocsv2/assets/js/346.20b96938.js"><link rel="prefetch" href="/myDocsv2/assets/js/347.476680bb.js"><link rel="prefetch" href="/myDocsv2/assets/js/348.ecf44b79.js"><link rel="prefetch" href="/myDocsv2/assets/js/349.19235284.js"><link rel="prefetch" href="/myDocsv2/assets/js/35.b761363a.js"><link rel="prefetch" href="/myDocsv2/assets/js/350.42e4d37c.js"><link rel="prefetch" href="/myDocsv2/assets/js/351.6982f677.js"><link rel="prefetch" href="/myDocsv2/assets/js/352.f17e6bce.js"><link rel="prefetch" href="/myDocsv2/assets/js/353.2be51bc7.js"><link rel="prefetch" href="/myDocsv2/assets/js/354.77f5d2fb.js"><link rel="prefetch" href="/myDocsv2/assets/js/355.f6285383.js"><link rel="prefetch" href="/myDocsv2/assets/js/356.94418b9f.js"><link rel="prefetch" href="/myDocsv2/assets/js/357.b8b20e21.js"><link rel="prefetch" href="/myDocsv2/assets/js/358.1b2e896c.js"><link rel="prefetch" href="/myDocsv2/assets/js/36.34a14d0e.js"><link rel="prefetch" href="/myDocsv2/assets/js/37.aa4916db.js"><link rel="prefetch" href="/myDocsv2/assets/js/38.deb490d2.js"><link rel="prefetch" href="/myDocsv2/assets/js/39.8672f15d.js"><link rel="prefetch" href="/myDocsv2/assets/js/40.644dee16.js"><link rel="prefetch" href="/myDocsv2/assets/js/42.e7ff72f1.js"><link rel="prefetch" href="/myDocsv2/assets/js/43.02a62ac3.js"><link rel="prefetch" href="/myDocsv2/assets/js/44.cd8672e0.js"><link rel="prefetch" href="/myDocsv2/assets/js/45.02596789.js"><link rel="prefetch" href="/myDocsv2/assets/js/46.a1c40368.js"><link rel="prefetch" href="/myDocsv2/assets/js/47.8d8b2f4d.js"><link rel="prefetch" href="/myDocsv2/assets/js/48.5dadf9f0.js"><link rel="prefetch" href="/myDocsv2/assets/js/49.ea5bbb89.js"><link rel="prefetch" href="/myDocsv2/assets/js/50.ad180d98.js"><link rel="prefetch" href="/myDocsv2/assets/js/51.0df9f4e8.js"><link rel="prefetch" href="/myDocsv2/assets/js/52.f04a6e1b.js"><link rel="prefetch" href="/myDocsv2/assets/js/53.74f2f2cf.js"><link rel="prefetch" href="/myDocsv2/assets/js/54.e8578653.js"><link rel="prefetch" href="/myDocsv2/assets/js/55.79a1b789.js"><link rel="prefetch" href="/myDocsv2/assets/js/56.693e099d.js"><link rel="prefetch" href="/myDocsv2/assets/js/57.82c7c63a.js"><link rel="prefetch" href="/myDocsv2/assets/js/58.15dea23c.js"><link rel="prefetch" href="/myDocsv2/assets/js/59.63d66b63.js"><link rel="prefetch" href="/myDocsv2/assets/js/6.97e7a4cb.js"><link rel="prefetch" href="/myDocsv2/assets/js/60.80a3efc6.js"><link rel="prefetch" href="/myDocsv2/assets/js/61.3f648458.js"><link rel="prefetch" href="/myDocsv2/assets/js/62.991be8f4.js"><link rel="prefetch" href="/myDocsv2/assets/js/63.c70d0dfb.js"><link rel="prefetch" href="/myDocsv2/assets/js/64.cbfa33ab.js"><link rel="prefetch" href="/myDocsv2/assets/js/65.f89bbfb7.js"><link rel="prefetch" href="/myDocsv2/assets/js/66.70c68ea1.js"><link rel="prefetch" href="/myDocsv2/assets/js/67.27436099.js"><link rel="prefetch" href="/myDocsv2/assets/js/68.6c730d30.js"><link rel="prefetch" href="/myDocsv2/assets/js/69.31e87a96.js"><link rel="prefetch" href="/myDocsv2/assets/js/7.b469f62b.js"><link rel="prefetch" href="/myDocsv2/assets/js/70.66a0fe4e.js"><link rel="prefetch" href="/myDocsv2/assets/js/71.150be7fc.js"><link rel="prefetch" href="/myDocsv2/assets/js/72.a2b6c89a.js"><link rel="prefetch" href="/myDocsv2/assets/js/73.65559007.js"><link rel="prefetch" href="/myDocsv2/assets/js/74.f61e2991.js"><link rel="prefetch" href="/myDocsv2/assets/js/75.fde71997.js"><link rel="prefetch" href="/myDocsv2/assets/js/76.cf3d3a31.js"><link rel="prefetch" href="/myDocsv2/assets/js/77.36633bd8.js"><link rel="prefetch" href="/myDocsv2/assets/js/78.82d49b8f.js"><link rel="prefetch" href="/myDocsv2/assets/js/79.6c213d15.js"><link rel="prefetch" href="/myDocsv2/assets/js/8.ebe4b359.js"><link rel="prefetch" href="/myDocsv2/assets/js/80.e6ee5654.js"><link rel="prefetch" href="/myDocsv2/assets/js/81.2d6febe8.js"><link rel="prefetch" href="/myDocsv2/assets/js/82.b1d7c015.js"><link rel="prefetch" href="/myDocsv2/assets/js/83.e4d15d98.js"><link rel="prefetch" href="/myDocsv2/assets/js/84.98d75c07.js"><link rel="prefetch" href="/myDocsv2/assets/js/85.8bd12af2.js"><link rel="prefetch" href="/myDocsv2/assets/js/86.3bc59854.js"><link rel="prefetch" href="/myDocsv2/assets/js/87.c26415ef.js"><link rel="prefetch" href="/myDocsv2/assets/js/88.12cc1dae.js"><link rel="prefetch" href="/myDocsv2/assets/js/89.1e08c26e.js"><link rel="prefetch" href="/myDocsv2/assets/js/9.bd9ef1a2.js"><link rel="prefetch" href="/myDocsv2/assets/js/90.4d879007.js"><link rel="prefetch" href="/myDocsv2/assets/js/91.089c1c17.js"><link rel="prefetch" href="/myDocsv2/assets/js/92.5aec83b9.js"><link rel="prefetch" href="/myDocsv2/assets/js/93.efe44a21.js"><link rel="prefetch" href="/myDocsv2/assets/js/94.ffc75f13.js"><link rel="prefetch" href="/myDocsv2/assets/js/95.d2012256.js"><link rel="prefetch" href="/myDocsv2/assets/js/96.87fef0cb.js"><link rel="prefetch" href="/myDocsv2/assets/js/97.aae1fc0b.js"><link rel="prefetch" href="/myDocsv2/assets/js/98.5f33b8aa.js"><link rel="prefetch" href="/myDocsv2/assets/js/99.f3fbb5db.js"><link rel="prefetch" href="/myDocsv2/assets/js/vendors~flowchart.f05697d3.js">
    <link rel="stylesheet" href="/myDocsv2/assets/css/0.styles.21bb8301.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-584a622c><div data-v-584a622c><div id="loader-wrapper" class="loading-wrapper" data-v-1c4f0192 data-v-584a622c data-v-584a622c><div class="loader-main" data-v-1c4f0192><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-73c95a87 data-v-584a622c data-v-584a622c><h3 class="title" style="display:none;" data-v-73c95a87 data-v-73c95a87>AGou's Docs-v2</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-73c95a87 data-v-73c95a87><input type="password" value="" data-v-73c95a87> <span data-v-73c95a87>Konck! Knock!</span> <button data-v-73c95a87>OK</button></label> <div class="footer" style="display:none;" data-v-73c95a87 data-v-73c95a87><span data-v-73c95a87><i class="iconfont reco-theme" data-v-73c95a87></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-73c95a87>vuePress-theme-reco</a></span> <span data-v-73c95a87><i class="iconfont reco-copyright" data-v-73c95a87></i> <a data-v-73c95a87><span data-v-73c95a87>AGou-ops</span>
          Â Â 
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-584a622c><header class="navbar" data-v-584a622c><div title="å¯¼èˆª" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myDocsv2/" class="home-link router-link-active"><img src="/myDocsv2/favicon.png" alt="AGou's Docs-v2" class="logo"> <span class="site-name">AGou's Docs-v2</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myDocsv2/timeline/" class="nav-link"><i class="iconfont undefined"></i>
  ğŸ•Ÿæ—¶é—´çº¿
</a></div><div class="nav-item"><a href="/myDocsv2/" class="nav-link"><i class="iconfont undefined"></i>
  ğŸ Home
</a></div><div class="nav-item"><a href="/myDocsv2/guide/" class="nav-link"><i class="iconfont undefined"></i>
  ğŸ—ºï¸Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      ğŸ“„å…¶å®ƒ
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myDocsv2/Golang/" class="nav-link"><i class="iconfont undefined"></i>
  ğŸ“šGolang
</a></li><li class="dropdown-item"><!----> <a href="/myDocsv2/k8s/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  ğŸš¢K8s
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      ç‰ˆæœ¬
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://agou-ops.cn/myDocs" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ver 1.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://agou-ops.cn/myDocsv2" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ver 2.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://agou-ops.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  âœ¨myBlog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/AGou-ops/myDocsv2" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-584a622c></div> <aside class="sidebar" data-v-584a622c><div class="personal-info-wrapper" data-v-7e653f02><img src="/myDocsv2/favicon.png" alt="author-avatar" class="personal-img" data-v-7e653f02> <h3 class="name" data-v-7e653f02>
    AGou-ops
  </h3> <div class="num" data-v-7e653f02><div data-v-7e653f02><h3 data-v-7e653f02>2</h3> <h6 data-v-7e653f02>æ–‡ç« </h6></div> <div data-v-7e653f02><h3 data-v-7e653f02>1</h3> <h6 data-v-7e653f02>æ ‡ç­¾</h6></div></div> <hr data-v-7e653f02></div> <nav class="nav-links"><div class="nav-item"><a href="/myDocsv2/timeline/" class="nav-link"><i class="iconfont undefined"></i>
  ğŸ•Ÿæ—¶é—´çº¿
</a></div><div class="nav-item"><a href="/myDocsv2/" class="nav-link"><i class="iconfont undefined"></i>
  ğŸ Home
</a></div><div class="nav-item"><a href="/myDocsv2/guide/" class="nav-link"><i class="iconfont undefined"></i>
  ğŸ—ºï¸Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      ğŸ“„å…¶å®ƒ
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myDocsv2/Golang/" class="nav-link"><i class="iconfont undefined"></i>
  ğŸ“šGolang
</a></li><li class="dropdown-item"><!----> <a href="/myDocsv2/k8s/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  ğŸš¢K8s
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      ç‰ˆæœ¬
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://agou-ops.cn/myDocs" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ver 1.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://agou-ops.cn/myDocsv2" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  ver 2.0
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://agou-ops.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  âœ¨myBlog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/AGou-ops/myDocsv2" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/myDocsv2/k8s/Installation/" class="sidebar-heading clickable router-link-active open"><span>K8s Installation</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/myDocsv2/k8s/Installation/ä½¿ç”¨ Kubeadm éƒ¨ç½²ï¼ˆå•masterï¼‰.html" class="sidebar-link">ä½¿ç”¨ Kubeadm éƒ¨ç½²(å•master)</a></li><li><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html" class="active sidebar-link">â­Kubernetes äºŒè¿›åˆ¶å®‰è£…</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_1-ç¯å¢ƒå‡†å¤‡" class="sidebar-link">1.ç¯å¢ƒå‡†å¤‡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_1-1-kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²æ–¹å¼" class="sidebar-link">1.1.Kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²æ–¹å¼</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_1-2-kubernetesé›†ç¾¤å¼ƒç”¨dockerå®¹å™¨" class="sidebar-link">1.2.Kubernetesé›†ç¾¤å¼ƒç”¨dockerå®¹å™¨</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_1-3-kubernetesé›†ç¾¤æ‰€éœ€çš„è¯ä¹¦" class="sidebar-link">1.3.Kubernetesé›†ç¾¤æ‰€éœ€çš„è¯ä¹¦</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_1-4-ç¯å¢ƒå‡†å¤‡" class="sidebar-link">1.4.ç¯å¢ƒå‡†å¤‡</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_1-5-å®‰è£…cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·" class="sidebar-link">1.5.å®‰è£…cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_2-æ“ä½œç³»ç»Ÿåˆå§‹åŒ–é…ç½®" class="sidebar-link">2.æ“ä½œç³»ç»Ÿåˆå§‹åŒ–é…ç½®</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_3-éƒ¨ç½²etcdé›†ç¾¤" class="sidebar-link">3.éƒ¨ç½²Etcdé›†ç¾¤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_3-1-ä½¿ç”¨cfsslè¯ä¹¦å·¥å…·ç”Ÿæˆetcdè¯ä¹¦" class="sidebar-link">3.1.ä½¿ç”¨cfsslè¯ä¹¦å·¥å…·ç”Ÿæˆetcdè¯ä¹¦</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_3-2-éƒ¨ç½²etcdé›†ç¾¤" class="sidebar-link">3.2.éƒ¨ç½²etcdé›†ç¾¤</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_4-éƒ¨ç½²dockeræœåŠ¡" class="sidebar-link">4.éƒ¨ç½²DockeræœåŠ¡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_4-1-å®‰è£…docker" class="sidebar-link">4.1.å®‰è£…docker</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_4-2-ä¸ºdockeråˆ›å»ºsystemctlå¯åŠ¨è„šæœ¬" class="sidebar-link">4.2.ä¸ºdockeråˆ›å»ºsystemctlå¯åŠ¨è„šæœ¬</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_5-éƒ¨ç½²kubernetes-masterèŠ‚ç‚¹" class="sidebar-link">5.éƒ¨ç½²kubernetes masterèŠ‚ç‚¹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_5-1-ä½¿ç”¨cfsslç”Ÿæˆapiserverçš„è¯ä¹¦æ–‡ä»¶" class="sidebar-link">5.1.ä½¿ç”¨cfsslç”Ÿæˆapiserverçš„è¯ä¹¦æ–‡ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_5-2-è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº" class="sidebar-link">5.2.è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_5-3-éƒ¨ç½²kube-apiserverç»„ä»¶" class="sidebar-link">5.3.éƒ¨ç½²kube-apiserverç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_5-4-éƒ¨ç½²kube-controller-manageç»„ä»¶" class="sidebar-link">5.4.éƒ¨ç½²kube-controller-manageç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_5-5-éƒ¨ç½²kube-schedulerç»„ä»¶" class="sidebar-link">5.5.éƒ¨ç½²kube-schedulerç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_5-6-å‡†å¤‡kubectlæ‰€éœ€çš„kubeconfigæ–‡ä»¶è¿æ¥é›†ç¾¤" class="sidebar-link">5.6.å‡†å¤‡kubectlæ‰€éœ€çš„kubeconfigæ–‡ä»¶è¿æ¥é›†ç¾¤</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_6-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²nodeèŠ‚ç‚¹ç›¸å…³ç»„ä»¶" class="sidebar-link">6.åœ¨masterèŠ‚ç‚¹éƒ¨ç½²nodeèŠ‚ç‚¹ç›¸å…³ç»„ä»¶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_6-1-åœ¨é›†ç¾¤æˆæƒkubelet-bootstrapç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦" class="sidebar-link">6.1.åœ¨é›†ç¾¤æˆæƒkubelet-bootstrapç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_6-2-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kubeletç»„ä»¶" class="sidebar-link">6.2.åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kubeletç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_6-3-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kube-proxy" class="sidebar-link">6.3.åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kube-proxy</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_6-4-æˆæƒapiserverè®¿é—®kubelet" class="sidebar-link">6.4.æˆæƒapiserverè®¿é—®kubelet</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_7-éƒ¨ç½²kubernetes-calicoç½‘ç»œç»„ä»¶" class="sidebar-link">7.éƒ¨ç½²kubernetes calicoç½‘ç»œç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_8-éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹" class="sidebar-link">8.éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_8-1-è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº" class="sidebar-link">8.1.è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_8-2-éƒ¨ç½²kubeletç»„ä»¶" class="sidebar-link">8.2.éƒ¨ç½²kubeletç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_8-3-éƒ¨ç½²kube-proxyç»„ä»¶" class="sidebar-link">8.3.éƒ¨ç½²kube-proxyç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_8-4-å¿«é€Ÿå¢åŠ æ–°çš„nodeèŠ‚ç‚¹" class="sidebar-link">8.4.å¿«é€Ÿå¢åŠ æ–°çš„nodeèŠ‚ç‚¹</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_9-ä¸ºé›†ç¾¤éƒ¨ç½²corednsç»„ä»¶" class="sidebar-link">9.ä¸ºé›†ç¾¤éƒ¨ç½²corednsç»„ä»¶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_9-1-éƒ¨ç½²corednsç»„ä»¶" class="sidebar-link">9.1.éƒ¨ç½²corednsç»„ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_9-2-è¿è¡Œä¸€ä¸ªbusyboxå®¹å™¨æµ‹è¯•dns" class="sidebar-link">9.2.è¿è¡Œä¸€ä¸ªbusyboxå®¹å™¨æµ‹è¯•dns</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_10-æ‰©å®¹masterèŠ‚ç‚¹ç»„å»ºkubernetesé«˜å¯ç”¨é›†ç¾¤" class="sidebar-link">10.æ‰©å®¹masterèŠ‚ç‚¹ç»„å»ºkubernetesé«˜å¯ç”¨é›†ç¾¤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_10-1-kubernetesé«˜å¯ç”¨æ¶æ„æ¦‚å¿µ" class="sidebar-link">10.1.kubernetesé«˜å¯ç”¨æ¶æ„æ¦‚å¿µ</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_10-2-åœ¨é›†ç¾¤ä¸­æ–°å¢ä¸€ä¸ªetcdèŠ‚ç‚¹" class="sidebar-link">10.2.åœ¨é›†ç¾¤ä¸­æ–°å¢ä¸€ä¸ªetcdèŠ‚ç‚¹</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_10-3-éƒ¨ç½²master-2èŠ‚ç‚¹" class="sidebar-link">10.3.éƒ¨ç½²master-2èŠ‚ç‚¹</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_10-4-éƒ¨ç½²nginx-keepalivedå®ç°kubernetesé«˜å¯ç”¨é›†ç¾¤" class="sidebar-link">10.4.éƒ¨ç½²Nginx+Keepalivedå®ç°kubernetesé«˜å¯ç”¨é›†ç¾¤</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_10-5-åˆ‡æ¢kubernetesé›†ç¾¤ä¸ºé«˜å¯ç”¨æ¨¡å¼" class="sidebar-link">10.5.åˆ‡æ¢kubernetesé›†ç¾¤ä¸ºé«˜å¯ç”¨æ¨¡å¼</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_11-æµ‹è¯•kubernetesé«˜å¯ç”¨é›†ç¾¤" class="sidebar-link">11.æµ‹è¯•kubernetesé«˜å¯ç”¨é›†ç¾¤</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_12-åœ¨kubernetesé›†ç¾¤è¿è¡Œä¸€å¥—æœåŠ¡éªŒè¯é›†ç¾¤çš„å¯ç”¨æ€§" class="sidebar-link">12.åœ¨kubernetesé›†ç¾¤è¿è¡Œä¸€å¥—æœåŠ¡éªŒè¯é›†ç¾¤çš„å¯ç”¨æ€§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_12-1-åˆ›å»ºèµ„æºyamlæ–‡ä»¶" class="sidebar-link">12.1.åˆ›å»ºèµ„æºyamlæ–‡ä»¶</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_12-2-åˆ›å»ºèµ„æºå¹¶è¿›è¡Œæµ‹è¯•" class="sidebar-link">12.2.åˆ›å»ºèµ„æºå¹¶è¿›è¡Œæµ‹è¯•</a></li></ul></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_13-éƒ¨ç½²kubernetes-dashboard" class="sidebar-link">13.éƒ¨ç½²kubernetes dashboard</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_13-1-éƒ¨ç½²dashboard" class="sidebar-link">13.1.éƒ¨ç½²dashboard</a></li><li class="sidebar-sub-header"><a href="/myDocsv2/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….html#_13-2-è®¿é—®dashboard" class="sidebar-link">13.2.è®¿é—®dashboard</a></li></ul></li></ul></li><li><a href="/myDocsv2/k8s/Installation/ä½¿ç”¨ Kubespray éƒ¨ç½².html" class="sidebar-link">ä½¿ç”¨ Kubespray éƒ¨ç½²</a></li><li><a href="/myDocsv2/k8s/Installation/ä½¿ç”¨å›½å†…æºåŠç›¸å…³å°å·¥å…·.html" class="sidebar-link">ä½¿ç”¨å›½å†…æºåŠç›¸å…³å°å·¥å…·</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/myDocsv2/k8s/å®æˆ˜æ¡ˆä¾‹/" class="sidebar-heading clickable"><span>K8s å®æˆ˜æ¡ˆä¾‹</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/myDocsv2/k8s/Quicklystart/" class="sidebar-heading clickable"><span>k8s å¿«é€Ÿæ‰‹å†Œ</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/myDocsv2/k8s/Helm/" class="sidebar-heading clickable"><span>Helm</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group depth-0"><a href="/myDocsv2/k8s/" class="sidebar-heading clickable router-link-active"><span>Others</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/myDocsv2/k8s/Kubernetes Yaml quicklystart.html" class="sidebar-link">â­k8s Yaml quicklystart</a></li><li><a href="/myDocsv2/k8s/k8s command.html" class="sidebar-link">â­k8s command quicklystart</a></li><li><a href="/myDocsv2/k8s/Kubernetes with Jenkins CICD.html" class="sidebar-link">Kubernetes with Jenkins CICD</a></li><li><a href="/myDocsv2/k8s/Prometheus+Grafanaå…¨æ–¹ä½ç›‘æ§Kubernetesé›†ç¾¤.html" class="sidebar-link">Prometheus+Grafanaå…¨æ–¹ä½ç›‘æ§Kubernetesé›†ç¾¤</a></li><li><a href="/myDocsv2/k8s/kompose Basic.html" class="sidebar-link">kompose Basic</a></li><li><a href="/myDocsv2/k8s/kubenetesè¿œç¨‹è°ƒè¯•å·¥å…·.html" class="sidebar-link">kubenetesè¿œç¨‹è°ƒè¯•å·¥å…·</a></li><li><a href="/myDocsv2/k8s/Kubernetes REST API.html" class="sidebar-link">Kubernetes REST API</a></li><li><a href="/myDocsv2/k8s/k3d.html" class="sidebar-link">k3d</a></li><li><a href="/myDocsv2/k8s/Minikube Basic.html" class="sidebar-link">Minikube Basic</a></li><li><a href="/myDocsv2/k8s/Remote access k8s.html" class="sidebar-link">Remote access k8s</a></li><li><a href="/myDocsv2/k8s/k8s å›¾è§£å¤§å…¨.html" class="sidebar-link">k8s å›¾è§£å¤§å…¨</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-73c95a87 data-v-584a622c><h3 class="title" style="display:none;" data-v-73c95a87 data-v-73c95a87></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-73c95a87 data-v-73c95a87><input type="password" value="" data-v-73c95a87> <span data-v-73c95a87>Konck! Knock!</span> <button data-v-73c95a87>OK</button></label> <div class="footer" style="display:none;" data-v-73c95a87 data-v-73c95a87><span data-v-73c95a87><i class="iconfont reco-theme" data-v-73c95a87></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-73c95a87>vuePress-theme-reco</a></span> <span data-v-73c95a87><i class="iconfont reco-copyright" data-v-73c95a87></i> <a data-v-73c95a87><span data-v-73c95a87>AGou-ops</span>
          Â Â 
          <!---->
          2022
        </a></span></div></div> <div data-v-584a622c><main class="page"><!----> <div class="page-title" style="display:none;"><h1></h1> <hr> <div data-v-7b2e794a><i class="iconfont reco-account" data-v-7b2e794a><span data-v-7b2e794a>AGou-ops</span></i> <!----> <i class="iconfont reco-eye" data-v-7b2e794a><span id="/myDocsv2/k8s/Installation/Kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-7b2e794a><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><blockquote><p>âš ï¸è½¬è½½è‡ªï¼šhttps://jiangxl.blog.csdn.net/article/details/120428703</p> <p>ä»…ç•¥ä½œä¿®æ”¹ã€‚</p></blockquote> <p>[toc]</p> <h2 id="_1-ç¯å¢ƒå‡†å¤‡"><a href="#_1-ç¯å¢ƒå‡†å¤‡" class="header-anchor">#</a> 1.ç¯å¢ƒå‡†å¤‡</h2> <h3 id="_1-1-kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²æ–¹å¼"><a href="#_1-1-kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²æ–¹å¼" class="header-anchor">#</a> 1.1.Kubernetesé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²æ–¹å¼</h3> <blockquote><p>ç›®å‰ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²Kuberneteså»ºä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p> <p>kubeadmï¼šæä¾›kubeadm initå’Œkubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²Kubernetesé›†ç¾¤ï¼Œkubeadmå®‰è£…çš„k8sé›†ç¾¤ï¼Œæ‰€æœ‰çš„k8sç»„ä»¶éƒ½æ˜¯ä»¥podå½¢å¼è¿è¡Œã€‚</p> <p>äºŒè¿›åˆ¶åŒ…ï¼šä»githubä¸Šä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆkubernetesé›†ç¾¤ã€‚</p> <p>Kubeadmé™ä½éƒ¨ç½²æˆæœ¬ï¼Œä»è€Œå±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œé‡åˆ°é—®é¢˜å¾ˆéš¾æ’æŸ¥ï¼Œå¦‚æœæƒ³æ›´å®¹æ˜“å¯æ§ï¼Œæ¨èä½¿ç”¨äºŒè¿›åˆ¶åŒ…éƒ¨ç½²Kubernetesé›†ç¾¤ï¼Œè™½ç„¶æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ç‚¹ï¼ŒæœŸé—´å¯ä»¥å­¦ä¹ å¾ˆå¤šå·¥ä½œåŸç†ï¼Œä¹Ÿåˆ©äºåæœŸç»´æŠ¤ã€‚</p></blockquote> <h3 id="_1-2-kubernetesé›†ç¾¤å¼ƒç”¨dockerå®¹å™¨"><a href="#_1-2-kubernetesé›†ç¾¤å¼ƒç”¨dockerå®¹å™¨" class="header-anchor">#</a> 1.2.Kubernetesé›†ç¾¤å¼ƒç”¨dockerå®¹å™¨</h3> <blockquote><p>åœ¨k8så¹³å°ä¸­ï¼Œä¸ºäº†è§£å†³ä¸å®¹å™¨è¿è¡Œæ—¶ï¼Œæ¯”å¦‚dockerçš„é›†æˆé—®é¢˜ï¼Œåœ¨æ—©æœŸç¤¾åŒºæ¨å‡ºCRIæ¥å£ï¼Œä»¥æ”¯æŒæ›´å¤šçš„å®¹å™¨ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨Dockerä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œé¦–å…ˆkubeletè°ƒç”¨dockershimçš„CRIå®¹å™¨æ¥å£è¿æ¥dockerè¿›ç¨‹ï¼Œæœ€åç”±dockerå¯åŠ¨å®¹å™¨ã€‚</p> <p>åœ¨k8s1.23ç‰ˆæœ¬ä¸­ï¼Œk8sè®¡åˆ’å¼ƒç”¨kubeletä¸­çš„dockershimæ¥å£ï¼Œdockershimæ¥å£ä¸€æ—¦å¼ƒç”¨ï¼Œkubeletå»è°ƒç”¨CRLæ—¶å°±æ²¡æœ‰å¯ä»¥ä¸dockerå»ºç«‹è¿æ¥çš„ä¸€ä¸ªæ¥å£ï¼Œä»è€Œå¯¼è‡´k8så¼ƒç”¨dockerå®¹å™¨ã€‚</p></blockquote> <h3 id="_1-3-kubernetesé›†ç¾¤æ‰€éœ€çš„è¯ä¹¦"><a href="#_1-3-kubernetesé›†ç¾¤æ‰€éœ€çš„è¯ä¹¦" class="header-anchor">#</a> 1.3.Kubernetesé›†ç¾¤æ‰€éœ€çš„è¯ä¹¦</h3> <blockquote><p>k8sæ‰€æœ‰ç»„ä»¶å‡é‡‡ç”¨httpsåŠ å¯†é€šä¿¡ï¼Œè¿™äº›ç»„ä»¶ä¸€èˆ¬ç”±ä¸¤å¥—æ ¹è¯ä¹¦ç”Ÿæˆï¼šä¸€ä¸ªç”¨äºk8s apiserverä¸€ä¸ªç”¨äºetcdæ•°æ®åº“ã€‚</p> <p>æŒ‰ç…§è§’è‰²æ¥åˆ†ï¼Œè¯ä¹¦åˆ†ä¸ºç®¡ç†èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹ã€‚</p> <ul><li>ç®¡ç†èŠ‚ç‚¹ï¼šæŒ‡controller-managerå’Œschedulerè¿æ¥apiserveræ‰€éœ€çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li> <li>å·¥ä½œèŠ‚ç‚¹ï¼šæŒ‡kubeletå’Œkube-proxyè¿æ¥apiserveræ‰€éœ€è¦çš„å®¢æˆ·ç«¯è¯ä¹¦ï¼Œè€Œä¸€èˆ¬éƒ½ä¼šå¯ç”¨Bootstrap TLSæœºåˆ¶ï¼Œæ‰€ä»¥kubeletçš„è¯ä¹¦åˆæ¬¡å¯åŠ¨ä¼šå‘apiserverç”³è¯·é¢å‘è¯ä¹¦ï¼Œç”±controller-managerç»„ä»¶è‡ªåŠ¨é¢å‘ã€‚</li> <li>å›¾ä¸­çº¢çº¿æ˜¯k8så„ä¸ªç»„ä»¶é€šè¿‡æºå¸¦k8sè‡ªå»ºè¯ä¹¦é¢å‘æœºæ„ç”Ÿæˆçš„å®¢æˆ·ç«¯è¯ä¹¦è®¿é—®apiserverï¼Œå›¾ä¸­è“çº¿æ˜¯k8sapiserverç»„ä»¶é€šè¿‡etcdé¢å‘çš„å®¢æˆ·ç«¯è¯ä¹¦ä¸etcdå»ºç«‹è¿æ¥ã€‚</li></ul> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/3b600f8680a443168cb556a183c19b3f.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"></p></blockquote> <h3 id="_1-4-ç¯å¢ƒå‡†å¤‡"><a href="#_1-4-ç¯å¢ƒå‡†å¤‡" class="header-anchor">#</a> 1.4.ç¯å¢ƒå‡†å¤‡</h3> <table><thead><tr><th>è§’è‰²</th> <th>IP</th> <th>ç»„ä»¶</th></tr></thead> <tbody><tr><td>binary-k8s-master1</td> <td>192.168.20.10</td> <td>kube-apiserverã€kube-controller-manageã€kube-schedulerã€kubeletã€kube-proxyã€dockerã€etcdã€nginxã€keepalived</td></tr> <tr><td>binary-k8s-master2</td> <td>192.168.20.11</td> <td>kube-apiserverã€kube-controller-manageã€kube-schedulerã€kubeletã€kube-proxyã€dockerã€nginxã€keepalivedã€etcdï¼ˆæ‰©å®¹èŠ‚ç‚¹ï¼‰</td></tr> <tr><td>binary-k8s-node1</td> <td>192.168.20.12</td> <td>kubeletã€kube-proxyã€dockerã€etcd</td></tr> <tr><td>binary-k8s-node2</td> <td>192.168.20.13</td> <td>kubeletã€kube-proxyã€dockerã€etcd</td></tr> <tr><td>è´Ÿè½½å‡è¡¡å™¨IP</td> <td>192.168.20.9</td> <td>ï¼ˆä½œç”¨äºkube-apiserverçš„åœ°å€ï¼‰</td></tr></tbody></table> <p>é¦–å…ˆéƒ¨ç½²ä¸€å¥—å•masterèŠ‚ç‚¹çš„kubernetesé›†ç¾¤ï¼Œç„¶ååœ¨å¢åŠ ä¸€å°masterèŠ‚ç‚¹ï¼Œå½¢æˆé«˜å¯ç”¨é›†ç¾¤ã€‚</p> <p>å•masterèŠ‚ç‚¹çš„kubernetesé›†ç¾¤æœåŠ¡å™¨è§„åˆ’ã€‚</p> <table><thead><tr><th>è§’è‰²</th> <th>IP</th> <th>ç»„ä»¶</th></tr></thead> <tbody><tr><td>binary-k8s-master1</td> <td>192.168.20.10</td> <td>kube-apiserverã€kube-controller-manageã€kube-scheduleã€etcd</td></tr> <tr><td>binary-k8s-node1</td> <td>192.168.20.12</td> <td>kubeletã€kube-proxyã€dockerã€etcd</td></tr> <tr><td>binary-k8s-node2</td> <td>192.168.20.13</td> <td>kubeletã€kube-proxyã€dockerã€etcd</td></tr></tbody></table> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/ea0354a4d3cc4b6397ee9397f42e35dc.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h3 id="_1-5-å®‰è£…cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·"><a href="#_1-5-å®‰è£…cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·" class="header-anchor">#</a> 1.5.å®‰è£…cfsslè¯ä¹¦ç”Ÿæˆå·¥å…·</h3> <p>cfsslæ˜¯ä¸€ä¸ªå¼€æºçš„è¯ä¹¦ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨jsonæ–‡ä»¶ç”Ÿæˆè¯ä¹¦ï¼Œç›¸æ¯”opensslæ›´æ–¹ä¾¿ä½¿ç”¨ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">chmod</span> +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> cfssl_linux-amd64 /usr/local/bin/cfssl
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> cfssljson_linux-amd64 /usr/local/bin/cfssljson
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_2-æ“ä½œç³»ç»Ÿåˆå§‹åŒ–é…ç½®"><a href="#_2-æ“ä½œç³»ç»Ÿåˆå§‹åŒ–é…ç½®" class="header-anchor">#</a> 2.æ“ä½œç³»ç»Ÿåˆå§‹åŒ–é…ç½®</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å…³é—­é˜²ç«å¢™
systemctl stop firewalld 
systemctl disable firewalld

<span class="token number">2</span>.å…³é—­selinux
<span class="token function">sed</span> -i <span class="token string">'s/enforcing/disabled/'</span> /etc/selinux/config 
setenforce <span class="token number">0</span> 

<span class="token number">3</span>.å…³é—­äº¤æ¢åˆ†åŒº
swapoff -a
<span class="token function">sed</span> -ri <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab

<span class="token number">4</span>.é…ç½®hosts
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
192.168.20.10 binary-k8s-master1
192.168.20.12 binary-k8s-node1
192.168.20.13 binary-k8s-node2
EOF</span>

<span class="token number">5</span>.ä¼˜åŒ–å†…æ ¸å‚æ•°
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
net.bridge.bridge-nf-call-ip6tables = 1 
net.bridge.bridge-nf-call-iptables = 1 
EOF</span>
sysctl --system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="_3-éƒ¨ç½²etcdé›†ç¾¤"><a href="#_3-éƒ¨ç½²etcdé›†ç¾¤" class="header-anchor">#</a> 3.éƒ¨ç½²Etcdé›†ç¾¤</h2> <p>etcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œkubernetesä½¿ç”¨etcdè¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œä¸ºè§£å†³etcdå•ç‚¹æ•…éšœï¼Œé‡‡ç”¨é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œ3å°ç»„ç»„å»ºé›†ç¾¤ï¼Œå¯ä»¥å1å°ï¼Œå¦‚æœæœ‰5å°å¯ä»¥å2å°ã€‚</p> <table><thead><tr><th>èŠ‚ç‚¹åç§°</th> <th>IP</th></tr></thead> <tbody><tr><td>etcd-1</td> <td>192.168.20.10</td></tr> <tr><td>etcd-2</td> <td>192.168.20.12</td></tr> <tr><td>etcd-3</td> <td>192.168.20.13</td></tr></tbody></table> <h3 id="_3-1-ä½¿ç”¨cfsslè¯ä¹¦å·¥å…·ç”Ÿæˆetcdè¯ä¹¦"><a href="#_3-1-ä½¿ç”¨cfsslè¯ä¹¦å·¥å…·ç”Ÿæˆetcdè¯ä¹¦" class="header-anchor">#</a> 3.1.ä½¿ç”¨cfsslè¯ä¹¦å·¥å…·ç”Ÿæˆetcdè¯ä¹¦</h3> <p><strong>1.ç”ŸæˆCAè‡ªç­¾é¢å‘æœºæ„è¯ä¹¦</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> ca-config.json
<span class="token punctuation">{</span>
  <span class="token string">&quot;signing&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;default&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;87600h&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;profiles&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;www&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
         <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;87600h&quot;</span>,
         <span class="token string">&quot;usages&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;signing&quot;</span>,
            <span class="token string">&quot;key encipherment&quot;</span>,
            <span class="token string">&quot;server auth&quot;</span>,
            <span class="token string">&quot;client auth&quot;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> ca-csr.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;etcd CA&quot;</span>,
    <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
            <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
            <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>


<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca -
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:16:49 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">595276170535764345591605360849177409156623041535</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p><strong>2.ä½¿ç”¨è‡ªç­¾CAç­¾å‘Etcd HTTPSè¯ä¹¦</strong></p> <p>ç”³è¯·è¯ä¹¦çš„jsonæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªhostså­—æ®µï¼Œè¿™ä¸ªå­—æ®µçš„å€¼å°±æ˜¯etcdé›†ç¾¤çš„IPåœ°å€ï¼Œå¯ä»¥å¤šå†™å‡ ä¸ªIPï¼Œä½œä¸ºé¢„ç•™IPï¼Œæ–¹ä¾¿æ‰©å®¹etcdé›†ç¾¤ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> server-csr.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;etcd&quot;</span>,
    <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;192.168.20.10&quot;</span>,
    <span class="token string">&quot;192.168.20.11&quot;</span>,			<span class="token comment">#é¢„ç•™ip</span>
    <span class="token string">&quot;192.168.20.12&quot;</span>,
    <span class="token string">&quot;192.168.20.13&quot;</span>
    <span class="token punctuation">]</span>,
    <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
            <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
            <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.ç”Ÿæˆè¯ä¹¦
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>www server-csr.json <span class="token operator">|</span> cfssljson -bare server
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">390637014214409356442509482537912246480465374076</span>
<span class="token number">2021</span>/08/27 <span class="token number">17</span>:17:08 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><strong>3.æŸ¥çœ‹ç”Ÿäº§çš„è¯ä¹¦æ–‡ä»¶</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/etcd<span class="token punctuation">]</span><span class="token punctuation">\</span># ll
æ€»ç”¨é‡ <span class="token number">36</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">288</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:16 ca-config.json
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">956</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:16 ca.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">210</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:16 ca-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:16 ca-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1265</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:16 ca.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1021</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:17 server.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">311</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:17 server-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:17 server-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1346</span> <span class="token number">8</span>æœˆ  <span class="token number">27</span> <span class="token number">17</span>:17 server.pem
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-2-éƒ¨ç½²etcdé›†ç¾¤"><a href="#_3-2-éƒ¨ç½²etcdé›†ç¾¤" class="header-anchor">#</a> 3.2.éƒ¨ç½²etcdé›†ç¾¤</h3> <p><strong>1.ä¸‹è½½etcdäºŒè¿›åˆ¶æ–‡ä»¶</strong></p> <p>ä¸‹è½½åœ°å€ï¼šhttps://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</p> <p>éƒ¨ç½²äºŒè¿›åˆ¶çš„ç¨‹åºé›†ç¾¤æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åœ¨å…¶ä¸­ä¸€å°ä¸Šé¢éƒ¨ç½²ï¼Œç„¶åå°†æ‰€æœ‰çš„æ–‡ä»¶scpåˆ°å…¶ä»–æœºå™¨ä¸Šä¿®æ”¹é…ç½®ï¼Œä¸€å¥—é›†ç¾¤ä¹Ÿå°±å®Œæˆäº†ã€‚</p> <p>å°†ä¸‹è½½å¥½çš„æ–‡ä»¶ä¸Šä¼ è‡³æ‰€æœ‰etcdèŠ‚ç‚¹ã€‚</p> <p>etcdé…ç½®æ–‡ä»¶è§£é‡Š</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-1&quot;</span>							<span class="token comment">#èŠ‚ç‚¹åç§°</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>					<span class="token comment">#æ•°æ®ç›®å½•</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2380&quot;</span>			<span class="token comment">#é›†ç¾¤é€šä¿¡åœ°å€</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span>		<span class="token comment">#å®¢æˆ·ç«¯è®¿é—®çš„ç›‘å¬åœ°å€ï¼Œåœ¨è¿™é‡ŒåŠ ä¸€ä¸ªhttp://127.0.0.1:2379ï¼Œåœ¨å½“å‰èŠ‚ç‚¹æŸ¥é›†ç¾¤ä¿¡æ¯æ—¶å°±ä¸éœ€è¦æŒ‡å®šè¯ä¹¦å»æŸ¥è¯¢äº†</span>
	
<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2380&quot;</span>			<span class="token comment">#é›†ç¾¤é€šå‘Šåœ°å€</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span>					<span class="token comment">#å®¢æˆ·ç«¯é€šå‘Šåœ°å€ï¼Œï¼Œåœ¨è¿™é‡ŒåŠ ä¸€ä¸ªhttp://127.0.0.1:2379ï¼Œåœ¨å½“å‰èŠ‚ç‚¹æŸ¥é›†ç¾¤ä¿¡æ¯æ—¶å°±ä¸éœ€è¦æŒ‡å®šè¯ä¹¦å»æŸ¥è¯¢äº†</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span>						<span class="token comment">#é›†ç¾¤èŠ‚ç‚¹åœ°å€</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>				<span class="token comment">#é›†ç¾¤çš„å”¯ä¸€æ ‡è¯†</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>						<span class="token comment">#åŠ å…¥é›†ç¾¤çš„çŠ¶æ€ï¼Œnewä¸ºæ–°é›†ç¾¤ï¼Œexistingè¡¨ç¤ºåŠ å…¥ç°æœ‰é›†ç¾¤</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>2.éƒ¨ç½²etcd-1èŠ‚ç‚¹</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åˆ›å»ºç¨‹åºç›®å½•
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> /data/etcd/<span class="token punctuation">{</span>bin,conf,ssl,data<span class="token punctuation">}</span> -p

<span class="token number">2</span>.è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf etcd-v3.4.9-linux-amd64.tar.gz

<span class="token number">3</span>.å°†äºŒè¿›åˆ¶å‘½ä»¤ç§»åŠ¨åˆ°åˆ¶å®šå‡ºç¨‹åºç›®å½•
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> etcd-v3.4.9-linux-amd64/etcd* /data/etcd/bin/

<span class="token number">4</span>.ç¼–è¾‘é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-1&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token number">5</span>.ç¼–å†™systemctlæ§åˆ¶è„šæœ¬
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/etcd.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Etcd Server
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/etcd/conf/etcd.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/etcd/bin/etcd <span class="token punctuation">\</span>
--cert-file<span class="token operator">=</span>/data/etcd/ssl/server.pem <span class="token punctuation">\</span>
--key-file<span class="token operator">=</span>/data/etcd/ssl/server-key.pem <span class="token punctuation">\</span>
--peer-cert-file<span class="token operator">=</span>/data/etcd/ssl/server.pem <span class="token punctuation">\</span>
--peer-key-file<span class="token operator">=</span>/data/etcd/ssl/server-key.pem <span class="token punctuation">\</span>
--trusted-ca-file<span class="token operator">=</span>/data/etcd/ssl/ca.pem <span class="token punctuation">\</span>
--peer-trusted-ca-file<span class="token operator">=</span>/data/etcd/ssl/ca.pem <span class="token punctuation">\</span>
--logger<span class="token operator">=</span>zap
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token number">6</span>.å¤åˆ¶è¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> TLS/etcd/*.pem /data/etcd/ssl/

<span class="token number">7</span>.å¯åŠ¨etcd-1èŠ‚ç‚¹
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start etcd
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> etcd

<span class="token comment">#ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¯åŠ¨ä¼šä¸€ç›´å¤„äºå…¶ä¸­ä¸­çš„çŠ¶æ€ï¼Œåªæœ‰å½“ç¬¬äºŒä¸ªèŠ‚ç‚¹ä¹Ÿå¯åŠ¨äº†ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ‰èƒ½å¯åŠ¨æˆåŠŸï¼Œå› ä¸ºé›†ç¾¤ç‰ˆçš„etcdè‡³å°‘éœ€è¦2ä¸ªèŠ‚ç‚¹æ‰èƒ½æˆåŠŸè¿è¡Œ</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p><strong>3.é…ç½®etcd-2èŠ‚ç‚¹å’Œetcd-3èŠ‚ç‚¹</strong></p> <p>éƒ¨ç½²å®Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥ç›´æ¥å°†ç›®å½•æ‹·è´è‡³å…¶ä»–èŠ‚ç‚¹ï¼Œçœå»å®‰è£…çš„ä¸€äº›æ­¥éª¤ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.æ¨é€etcdç›®å½•
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/etcd root@192.168.20.12:/data
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/etcd root@192.168.20.13:/data

<span class="token number">2</span>.æ¨é€systemctlå¯åŠ¨æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /usr/lib/systemd/system/etcd.service root@192.168.20.12:/usr/lib/systemd/system/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /usr/lib/systemd/system/etcd.service root@192.168.20.13:/usr/lib/systemd/system/

<span class="token number">3</span>.ä¿®æ”¹etcd-2é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-2&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.12:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.12:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.12:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token number">4</span>.ä¿®æ”¹etcd-3é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-3&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.13:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token number">5</span>.å¯åŠ¨etcd-1å’Œetcd-2
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start etcd
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> etcd
------------
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start etcd
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p><strong>4.æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</strong><br>
etcd-1å¯åŠ¨æ—¶ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå½“etcd-2æ‰§è¡Œå¯åŠ¨å‘½ä»¤æ—¶ä¼šç«‹å³å¯åŠ¨æˆåŠŸï¼Œå¹¶ä¸”etcd-1ä¹Ÿä¼šç«‹åˆ»å¯åŠ¨æˆåŠŸã€‚</p> <p>æŸ¥çœ‹etcdçš„æ—¥å¿—å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼š<code>[root@binary-k8s-master1 ~]\# journalctl -u etcd -f</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.æŸ¥çœ‹æœåŠ¡ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> etcd
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:2379      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">9625</span>/etcd           
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:2380      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">9625</span>/etcd

<span class="token number">2</span>.æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
<span class="token comment">#å¦‚æœé…ç½®æ–‡ä»¶ä¸­2379ç«¯å£æ²¡æœ‰åŠ ä¸€ä¸ª127.0.0.1åˆ™è¿™æ ·æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> /data/etcd/bin/etcdctl --cacert<span class="token operator">=</span>/data/etcd/ssl/ca.pem --cert<span class="token operator">=</span>/data/etcd/ssl/server.pem --key<span class="token operator">=</span>/data/etcd/ssl/server-key.pem --endpoints<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379&quot;</span> endpoint health --write-out<span class="token operator">=</span>table
+----------------------------+--------+-------------+-------+
<span class="token operator">|</span>          ENDPOINT          <span class="token operator">|</span> HEALTH <span class="token operator">|</span>    TOOK     <span class="token operator">|</span> ERROR <span class="token operator">|</span>
+----------------------------+--------+-------------+-------+
<span class="token operator">|</span> https://192.168.20.10:2379 <span class="token operator">|</span>   <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token number">32</span>.322714ms <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> https://192.168.20.12:2379 <span class="token operator">|</span>   <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token number">31</span>.524079ms <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> https://192.168.20.13:2379 <span class="token operator">|</span>   <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token number">38</span>.985949ms <span class="token operator">|</span>       <span class="token operator">|</span>
+----------------------------+--------+-------------+-------+
<span class="token comment">#å¦‚æœé…ç½®æ–‡ä»¶æ±‡æ€»2379ç«¯å£åŠ äº†ä¸€ä¸ª127.0.0.1åˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯æ— éœ€æŒ‡å®šè¯ä¹¦</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 /data/etcd/conf<span class="token punctuation">]</span><span class="token punctuation">\</span>#  /data/etcd/bin/etcdctl member list --write-out<span class="token operator">=</span>table
+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span> STATUS  <span class="token operator">|</span>  NAME  <span class="token operator">|</span>         PEER ADDRS         <span class="token operator">|</span>                   CLIENT ADDRS                    <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span>
+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+
<span class="token operator">|</span> 12446003b2a53d43 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-2 <span class="token operator">|</span> https://192.168.20.12:2380 <span class="token operator">|</span> https://127.0.0.1:2379,https://192.168.20.12:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 51ae3f86f3783687 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-1 <span class="token operator">|</span> https://192.168.20.10:2380 <span class="token operator">|</span>  http://127.0.0.1:2379,https://192.168.20.10:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 667c9c7ba890c3f7 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-3 <span class="token operator">|</span> https://192.168.20.13:2380 <span class="token operator">|</span>  http://127.0.0.1:2379,https://192.168.20.13:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
+------------------+---------+--------+----------------------------+---------------------------------------------------+------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>é…ç½®æ–‡ä»¶çŠ¶æ€<br> <img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/da2f8ef902c04e77a4e555d67cc32273.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <p>etcdå¯åŠ¨æˆåŠŸçš„æ—¥å¿—</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/25e40829361b4c78b782ae1b180a90b7.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h2 id="_4-éƒ¨ç½²dockeræœåŠ¡"><a href="#_4-éƒ¨ç½²dockeræœåŠ¡" class="header-anchor">#</a> 4.éƒ¨ç½²DockeræœåŠ¡</h2> <p>æ‰€æœ‰kubernetesèŠ‚ç‚¹éƒ½éœ€è¦å®‰è£…dockeræœåŠ¡ï¼ŒåŒ…æ‹¬masterå’ŒnodeèŠ‚ç‚¹ã€‚</p> <p>dockeräºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½åœ°å€ï¼šhttps://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz</p> <h3 id="_4-1-å®‰è£…docker"><a href="#_4-1-å®‰è£…docker" class="header-anchor">#</a> 4.1.å®‰è£…docker</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.è§£å‹äºŒè¿›åˆ¶åŒ…
<span class="token function">tar</span> zxf docker-19.03.9.tgz

<span class="token number">2</span>.å°†å¯æ‰§è¡Œå‘½ä»¤ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
<span class="token function">mv</span> docker/* /usr/bin

<span class="token number">3</span>.åˆ›å»ºé…ç½®æ–‡ä»¶
<span class="token function">mkdir</span> /etc/docker
<span class="token function">vim</span> /etc/docker/daemon.json
<span class="token punctuation">{</span>
  <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://9wn5tbfh.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_4-2-ä¸ºdockeråˆ›å»ºsystemctlå¯åŠ¨è„šæœ¬"><a href="#_4-2-ä¸ºdockeråˆ›å»ºsystemctlå¯åŠ¨è„šæœ¬" class="header-anchor">#</a> 4.2.ä¸ºdockeråˆ›å»ºsystemctlå¯åŠ¨è„šæœ¬</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ç¼–å†™å¯åŠ¨è„šæœ¬
<span class="token function">vim</span> /usr/lib/systemd/system/docker.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Docker Application Container Engine
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://docs.docker.com
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target firewalld.service
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -s HUP 
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">LimitNPROC</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">LimitCORE</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">TimeoutStartSec</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">Delegate</span><span class="token operator">=</span>yes
<span class="token assign-left variable">KillMode</span><span class="token operator">=</span>process
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">StartLimitBurst</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">StartLimitInterval</span><span class="token operator">=</span>60s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token number">2</span>.å¯åŠ¨docker
systemctl daemon-reload 
systemctl start <span class="token function">docker</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="_5-éƒ¨ç½²kubernetes-masterèŠ‚ç‚¹"><a href="#_5-éƒ¨ç½²kubernetes-masterèŠ‚ç‚¹" class="header-anchor">#</a> 5.éƒ¨ç½²kubernetes masterèŠ‚ç‚¹</h2> <p>éƒ¨ç½²äºŒè¿›åˆ¶çš„kubernetesç»„ä»¶å¤§è‡´å¯åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p> <ul><li>1.è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶</li> <li>2.å¤åˆ¶äºŒè¿›åˆ¶ç¨‹åºåˆ°æŒ‡å®šç›®å½•</li> <li>3.åˆ›å»ºç»„ä»¶é…ç½®æ–‡ä»¶</li> <li>4.ç”Ÿæˆç»„ä»¶çš„kubeconfigæ–‡ä»¶</li> <li>5.åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡</li> <li>6.å¯åŠ¨ç»„ä»¶</li></ul> <p>kubernetesé›†ç¾¤çš„masterèŠ‚ç‚¹å’ŒnodeèŠ‚ç‚¹çš„äºŒè¿›åˆ¶æ–‡ä»¶éƒ½ä»githubä¸Šä¸‹è½½ï¼Œmasterå’Œnodeç›¸å…³çš„æ‰€æœ‰ç»„ä»¶éƒ½åœ¨ä¸€ä¸ªç¨‹åºåŒ…ä¸­ã€‚</p> <p>ä¸‹è½½åœ°å€ï¼š https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/36b71f10da9442808c7a950d2dedd254.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h3 id="_5-1-ä½¿ç”¨cfsslç”Ÿæˆapiserverçš„è¯ä¹¦æ–‡ä»¶"><a href="#_5-1-ä½¿ç”¨cfsslç”Ÿæˆapiserverçš„è¯ä¹¦æ–‡ä»¶" class="header-anchor">#</a> 5.1.ä½¿ç”¨cfsslç”Ÿæˆapiserverçš„è¯ä¹¦æ–‡ä»¶</h3> <p><strong>1.ç”ŸæˆCAè‡ªç­¾é¢å‘æœºæ„è¯ä¹¦</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å‡†å¤‡CAé…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> ca-config.json
<span class="token punctuation">{</span>
  <span class="token string">&quot;signing&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;default&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;87600h&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;profiles&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;kubernetes&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
         <span class="token string">&quot;expiry&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;87600h&quot;</span>,
         <span class="token string">&quot;usages&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;signing&quot;</span>,
            <span class="token string">&quot;key encipherment&quot;</span>,
            <span class="token string">&quot;server auth&quot;</span>,
            <span class="token string">&quot;client auth&quot;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> ca-csr.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes&quot;</span>,
    <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
            <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
            <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Beijing&quot;</span>,
            <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;k8s&quot;</span>,
            <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.ç”Ÿæˆè¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca -
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:43 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:20:43 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">90951268335404710707183639990677546638148434604</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p><strong>2.ä½¿ç”¨è‡ªç­¾CAç­¾å‘apiserver HTTPSè¯ä¹¦</strong></p> <p>ç­¾å‘çš„å®¢æˆ·ç«¯è¯ä¹¦é…ç½®æ–‡ä»¶ä¸­çš„hostså­—æ®µè¦åŒ…å«æ‰€æœ‰Master/LB/VIPçš„IPåœ°å€ï¼ŒNodeèŠ‚ç‚¹çš„åœ°å€å¯å†™å¯ä¸å†™ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å‡†å¤‡å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kube-apiserver-csr.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubernetes&quot;</span>,
    <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;10.0.0.1&quot;</span>,
      <span class="token string">&quot;127.0.0.1&quot;</span>,
      <span class="token string">&quot;192.168.20.10&quot;</span>,
      <span class="token string">&quot;192.168.20.11&quot;</span>,
      <span class="token string">&quot;192.168.20.12&quot;</span>,
      <span class="token string">&quot;192.168.20.13&quot;</span>,
      <span class="token string">&quot;192.168.20.9&quot;</span>,
      <span class="token string">&quot;kubernetes&quot;</span>,
      <span class="token string">&quot;kubernetes.default&quot;</span>,
      <span class="token string">&quot;kubernetes.default.svc&quot;</span>,
      <span class="token string">&quot;kubernetes.default.svc.cluster&quot;</span>,
      <span class="token string">&quot;kubernetes.default.svc.cluster.local&quot;</span>
    <span class="token punctuation">]</span>,
    <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
        <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
            <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
            <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
            <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;k8s&quot;</span>,
            <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.ç”Ÿæˆè¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-apiserver-csr.json <span class="token operator">|</span> cfssljson -bare kube-apiserver
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:25 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:25 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">714472722509814799589567099679496298525490716083</span>
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:30:25 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><strong>3.æŸ¥çœ‹ç”Ÿäº§çš„è¯ä¹¦æ–‡ä»¶</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># ll
æ€»ç”¨é‡ <span class="token number">36</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">294</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-config.json
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">264</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1359</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1277</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">602</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1643</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.pem
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_5-2-è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº"><a href="#_5-2-è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº" class="header-anchor">#</a> 5.2.è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> /data/kubernetes/<span class="token punctuation">{</span>bin,config,ssl,logs<span class="token punctuation">}</span> -p
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf kubernetes-server-linux-amd64.tar.gz 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token builtin class-name">cd</span> kubernetes/server/bin/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/kubernetes/server/bin<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kube-apiserver kube-scheduler kube-controller-manager /data/kubernetes/bin/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/kubernetes/server/bin<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kubectl /usr/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/e7c7eb9ad3ae4b0a8800c575d4e86023.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h3 id="_5-3-éƒ¨ç½²kube-apiserverç»„ä»¶"><a href="#_5-3-éƒ¨ç½²kube-apiserverç»„ä»¶" class="header-anchor">#</a> 5.3.éƒ¨ç½²kube-apiserverç»„ä»¶</h3> <h4 id="_5-3-1-åˆ›å»ºkube-apiserveré…ç½®æ–‡ä»¶"><a href="#_5-3-1-åˆ›å»ºkube-apiserveré…ç½®æ–‡ä»¶" class="header-anchor">#</a> 5.3.1.åˆ›å»ºkube-apiserveré…ç½®æ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-apiserver.conf
<span class="token assign-left variable">KUBE_APISERVER_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--etcd-servers=https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379 \
--bind-address=192.168.20.10 \
--secure-port=6443 \
--advertise-address=192.168.20.10 \
--allow-privileged=true \
--service-cluster-ip-range=10.0.0.0/24 \
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \
--authorization-mode=RBAC,Node \
--enable-bootstrap-token-auth=true \
--token-auth-file=/data/kubernetes/config/token.csv \
--service-node-port-range=30000-32767 \
--kubelet-client-certificate=/data/kubernetes/ssl/kube-apiserver.pem \
--kubelet-client-key=/data/kubernetes/ssl/kube-apiserver-key.pem \
--tls-cert-file=/data/kubernetes/ssl/kube-apiserver.pem  \
--tls-private-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \
--client-ca-file=/data/kubernetes/ssl/ca.pem \
--service-account-key-file=/data/kubernetes/ssl/ca-key.pem \
--service-account-issuer=api \
--service-account-signing-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \
--etcd-cafile=/data/etcd/ssl/ca.pem \
--etcd-certfile=/data/etcd/ssl/server.pem \
--etcd-keyfile=/data/etcd/ssl/server-key.pem \
--requestheader-client-ca-file=/data/kubernetes/ssl/ca.pem \
--proxy-client-cert-file=/data/kubernetes/ssl/kube-apiserver.pem \
--proxy-client-key-file=/data/kubernetes/ssl/kube-apiserver-key.pem \
--requestheader-allowed-names=kubernetes \
--requestheader-extra-headers-prefix=X-Remote-Extra- \
--requestheader-group-headers=X-Remote-Group \
--requestheader-username-headers=X-Remote-User \
--enable-aggregator-routing=true \
--audit-log-maxage=30 \
--audit-log-maxbackup=3 \
--audit-log-maxsize=100 \
--audit-log-path=/data/kubernetes/logs/k8s-audit.log&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>é…ç½®æ–‡ä»¶å„å‚æ•°å«ä¹‰</strong></p> <table><thead><tr><th>é…ç½®å‚æ•°</th> <th>å«ä¹‰</th></tr></thead> <tbody><tr><td>â€“logtostderr</td> <td>æ˜¯å¦å¼€å¯æ—¥å¿—</td></tr> <tr><td>â€“v</td> <td>æ—¥å¿—çš„ç­‰çº§ï¼Œç­‰çº§è¶Šé«˜å†…å®¹è¶Šè¯¦ç»†</td></tr> <tr><td>â€“log-dir</td> <td>æ—¥å¿—å­˜æ”¾è·¯å¾„</td></tr> <tr><td>â€“etcd-servers</td> <td>etcdé›†ç¾¤åœ°å€</td></tr> <tr><td>â€“bind-address</td> <td>ç›‘å¬åœ°å€ï¼Œä¹Ÿå°±æ˜¯æœ¬æœº</td></tr> <tr><td>â€“secure-port</td> <td>httpså®‰å…¨ç«¯å£</td></tr> <tr><td>â€“advertise-address</td> <td>é›†ç¾¤é€šå‘Šåœ°å€</td></tr> <tr><td>â€“allow-privileged</td> <td>ä¼ä¸šæˆæƒ</td></tr> <tr><td>â€“service-cluster-ip-range</td> <td>serviceèµ„æºIPåœ°å€æ®µ</td></tr> <tr><td>â€“enable-admission-plugins</td> <td>å‡†å…¥æ§åˆ¶æ¨¡å—</td></tr> <tr><td>â€“authorization-mode</td> <td>è®¤è¯æˆæƒï¼Œå¯ç”¨RBACæˆæƒå’ŒèŠ‚ç‚¹è‡ªç®¡ç†</td></tr> <tr><td>â€“enable-bootstrap-token-auth</td> <td>å¯ç”¨TLS bootstrapæœºåˆ¶ï¼Œå¯ç”¨ä¹‹åkubeletå¯ä»¥è‡ªåŠ¨ç»™nodeèŠ‚é¢å‘è¯ä¹¦</td></tr> <tr><td>â€“token-auth-file</td> <td>bootstrap tokenæ–‡ä»¶è·¯å¾„</td></tr> <tr><td>â€“service-node-port-range</td> <td>Service nodeportç±»å‹é»˜è®¤åˆ†é…ç«¯å£èŒƒå›´</td></tr> <tr><td>â€“kubelet-client-certificate</td> <td>apiserverè®¿é—®kubeletçš„å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶</td></tr> <tr><td>â€“kubelet-client-key</td> <td>apiserverè®¿é—®kubeletçš„å®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶</td></tr> <tr><td>â€“tls-cert-file</td> <td>apiserver httpsè¯ä¹¦</td></tr> <tr><td>â€“tls-private-key-file</td> <td>apiserver httpsè¯ä¹¦</td></tr> <tr><td>â€“client-ca-file</td> <td>caè¯ä¹¦è·¯å¾„</td></tr> <tr><td>â€“service-account-key-file</td> <td>caç§é’¥è·¯å¾„</td></tr> <tr><td>â€“service-account-issuer</td> <td>saè´¦å·æˆæƒè¿‡æœŸæ—¶é—´çš„ä¸€ä¸ªé…ç½®ï¼Œ1.20ä»¥åæ‰æœ‰çš„ç‰¹æ€§</td></tr> <tr><td>â€“service-account-signing-key-file</td> <td>è¯ä¹¦æ–‡ä»¶è·¯å¾„</td></tr> <tr><td>â€“etcd-cafile</td> <td>etcd caè¯ä¹¦æ–‡ä»¶è·¯å¾„</td></tr> <tr><td>â€“etcd-certfile</td> <td>etcd å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶è·¯å¾„</td></tr> <tr><td>â€“etcd-keyfile</td> <td>etcd å®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶è·¯å¾„</td></tr> <tr><td>â€“requestheader-client-ca-file</td> <td>èšåˆå±‚ç›¸å…³é…ç½®</td></tr> <tr><td>â€“proxy-client-cert-file</td> <td>èšåˆå±‚ç›¸å…³é…ç½®</td></tr> <tr><td>â€“proxy-client-key-file</td> <td>èšåˆå±‚ç›¸å…³é…ç½®</td></tr> <tr><td>â€“requestheader-allowed-names</td> <td>èšåˆå±‚ç›¸å…³é…ç½®</td></tr> <tr><td>â€“requestheader-extra-headers-prefix</td> <td>èšåˆå±‚ç›¸å…³é…ç½®</td></tr> <tr><td>â€“enable-aggregator-routing</td> <td>èšåˆå±‚ç›¸å…³é…ç½®</td></tr></tbody></table> <h4 id="_5-3-2-åˆ›å»ºtls-bootstrappingæ–‡ä»¶"><a href="#_5-3-2-åˆ›å»ºtls-bootstrappingæ–‡ä»¶" class="header-anchor">#</a> 5.3.2.åˆ›å»ºTLS Bootstrappingæ–‡ä»¶</h4> <p>TLS Bootstrapingï¼šMaster apiserverå¯ç”¨TLSè®¤è¯åï¼ŒNodeèŠ‚ç‚¹kubeletå’Œkube-proxyè¦ä¸kube-apiserverè¿›è¡Œé€šä¿¡ï¼Œå¿…é¡»ä½¿ç”¨CAç­¾å‘çš„æœ‰æ•ˆè¯ä¹¦æ‰å¯ä»¥ï¼Œå½“NodeèŠ‚ç‚¹å¾ˆå¤šæ—¶ï¼Œè¿™ç§å®¢æˆ·ç«¯è¯ä¹¦é¢å‘éœ€è¦å¤§é‡å·¥ä½œï¼ŒåŒæ ·ä¹Ÿä¼šå¢åŠ é›†ç¾¤æ‰©å±•å¤æ‚åº¦ã€‚ä¸ºäº†ç®€åŒ–æµç¨‹ï¼ŒKuberneteså¼•å…¥äº†TLS bootstrapingæœºåˆ¶æ¥è‡ªåŠ¨é¢å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œkubeletä¼šä»¥ä¸€ä¸ªä½æƒé™ç”¨æˆ·è‡ªåŠ¨å‘apiserverç”³è¯·è¯ä¹¦ï¼Œkubeletçš„è¯ä¹¦ç”±apiserveråŠ¨æ€ç­¾ç½²ã€‚æ‰€ä»¥å¼ºçƒˆå»ºè®®åœ¨Nodeä¸Šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç›®å‰ä¸»è¦ç”¨äºkubeletï¼Œkube-proxyè¿˜æ˜¯ç”±æˆ‘ä»¬ç»Ÿä¸€é¢å‘ä¸€ä¸ªè¯ä¹¦ã€‚</p> <p>TLS bootstraping å·¥ä½œæµç¨‹ï¼š</p> <p>kubeleté¦–å…ˆå–æŸ¥æ‰¾bootstrapingé…ç½®æ–‡ä»¶ï¼Œç„¶åå»è¿æ¥apiserverï¼Œå¼€å§‹éªŒè¯bootstrap tokenæ–‡ä»¶ï¼Œå†éªŒè¯è¯ä¹¦æ–‡ä»¶ï¼Œæœ€åé¢å‘è¯ä¹¦å¯åŠ¨æˆåŠŸï¼Œå¦åˆ™å°±ä¼šå¯åŠ¨å¤±è´¥ã€‚<br> <img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/17a18dfd43ae4604863e590283b63ebd.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ç”Ÿæˆä¸€ä¸ªtokenå€¼
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">head</span> -c <span class="token number">16</span> /dev/urandom <span class="token operator">|</span> od -An -t x <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">' '</span>
d7f96b0d86c574d0f64a713608db092

<span class="token number">2</span>.åˆ›å»ºtokenæ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/token.csv
d7f96b0d86c574d0f64a713608db0922,kubelet-bootstrap,10001,<span class="token string">&quot;system:node-bootstrapper&quot;</span>

<span class="token comment">#æ ¼å¼ï¼štokenï¼Œç”¨æˆ·åï¼ŒUIDï¼Œç”¨æˆ·ç»„</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_5-3-4-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†apiserver"><a href="#_5-3-4-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†apiserver" class="header-anchor">#</a> 5.3.4.åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†apiserver</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-apiserver.service 
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-apiserver.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-apiserver <span class="token variable">$KUBE_APISERVER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_5-3-5-å¯åŠ¨kube-apiserverç»„ä»¶"><a href="#_5-3-5-å¯åŠ¨kube-apiserverç»„ä»¶" class="header-anchor">#</a> 5.3.5.å¯åŠ¨kube-apiserverç»„ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.æ‹·è´æˆ‘ä»¬éœ€è¦çš„è¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> TLS/k8s/*.pem /data/kubernetes/ssl/

<span class="token number">2</span>.å¯åŠ¨kube-apiserver
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-apiserver 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-apiserver

<span class="token number">3</span>.æŸ¥çœ‹ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:6443      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28546</span>/kube-apiserve 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_5-4-éƒ¨ç½²kube-controller-manageç»„ä»¶"><a href="#_5-4-éƒ¨ç½²kube-controller-manageç»„ä»¶" class="header-anchor">#</a> 5.4.éƒ¨ç½²kube-controller-manageç»„ä»¶</h3> <h4 id="_5-4-1-åˆ›å»ºkube-controller-manageé…ç½®æ–‡ä»¶"><a href="#_5-4-1-åˆ›å»ºkube-controller-manageé…ç½®æ–‡ä»¶" class="header-anchor">#</a> 5.4.1.åˆ›å»ºkube-controller-manageé…ç½®æ–‡ä»¶</h4> <blockquote><p><strong>é…ç½®æ–‡ä»¶å«ä¹‰</strong></p> <p>â€“kubeconfigï¼šæŒ‡å®šç”¨äºè¿æ¥apiserverçš„kubeconfigé…ç½®æ–‡ä»¶</p> <p>â€“leader-electï¼šç”¨äºé«˜å¯ç”¨é›†ç¾¤ï¼Œè‡ªåŠ¨é€‰ä¸¾</p> <p>â€“cluster-signing-cert-fileï¼šæŒ‡å®šCAè¯ä¹¦æ–‡ä»¶ï¼Œä¸ºkubeletè‡ªåŠ¨é¢å‘è¯ä¹¦</p> <p>â€“cluster-signing-key-fileï¼šæŒ‡å®šCAç§é’¥æ–‡ä»¶ï¼Œä¸ºkubeletè‡ªåŠ¨é¢å‘è¯ä¹¦</p> <p>â€“cluster-signing-durationï¼šè¯ä¹¦è¿‡æœŸæ—¶é—´</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-controller-manager.conf 
<span class="token assign-left variable">KUBE_CONTROLLER_MANAGER_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--leader-elect=true \
--kubeconfig=/data/kubernetes/config/kube-controller-manager.kubeconfig \
--bind-address=192.168.20.10 \
--allocate-node-cidrs=true \
--cluster-cidr=10.244.0.0/16 \
--service-cluster-ip-range=10.0.0.0/24 \
--cluster-signing-cert-file=/data/kubernetes/ssl/ca.pem \
--cluster-signing-key-file=/data/kubernetes/ssl/ca-key.pem  \
--root-ca-file=/data/kubernetes/ssl/ca.pem \
--service-account-private-key-file=/data/kubernetes/ssl/ca-key.pem \
--cluster-signing-duration=87600h0m0s&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_5-4-2-ç”Ÿæˆkubeconfigæ–‡ä»¶"><a href="#_5-4-2-ç”Ÿæˆkubeconfigæ–‡ä»¶" class="header-anchor">#</a> 5.4.2.ç”Ÿæˆkubeconfigæ–‡ä»¶</h4> <p>kube-controller-manageåˆ©ç”¨kubeconfigé…ç½®æ–‡ä»¶è¿æ¥apiserverã€‚</p> <p>kubeconfigæ–‡ä»¶ä¸­åŒ…æ‹¬é›†ç¾¤apiserveråœ°å€ã€è¯ä¹¦æ–‡ä»¶ã€ç”¨æˆ·ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ç”±äºkubeconfigéœ€è¦è¯ä¹¦æ–‡ä»¶çš„æ”¯æŒï¼Œå› æ­¤è¦ç”Ÿæˆä¸€ä¸ªè¯ä¹¦
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kube-controller-manager-csr.json 
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-controller-manager&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:masters&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-controller-manager-csr.json <span class="token operator">|</span> cfssljson -bare kube-controller-manager
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
l2021/09/01 <span class="token number">16</span>:36:19 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:19 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">719101376219834763931271155238486242405063666906</span>
<span class="token number">2021</span>/09/01 <span class="token number">16</span>:36:19 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kube-controller-manager*pem /data/kubernetes/ssl/


<span class="token number">2</span>.ç”Ÿæˆkubeconfigæ–‡ä»¶
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.kubeconfig
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯  </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials kube-controller-manager <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kube-controller-manager.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kube-controller-manager-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.kubeconfig
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ ç”¨æˆ·ä¿¡æ¯  </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-controller-manager <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.kubeconfig

<span class="token number">3</span>.æŒ‡å®šç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸ºé›†ç¾¤ä½¿ç”¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.kubeconfig  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/877a98a70b2f47919bcaae2d9d02a4d1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h4 id="_5-4-3-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡"><a href="#_5-4-3-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡" class="header-anchor">#</a> 5.4.3.åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-controller-manager.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Controller Manager
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-controller-manager.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-controller-manager <span class="token variable">$KUBE_CONTROLLER_MANAGER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_5-4-4-å¯åŠ¨kube-controller-manageç»„ä»¶"><a href="#_5-4-4-å¯åŠ¨kube-controller-manageç»„ä»¶" class="header-anchor">#</a> 5.4.4.å¯åŠ¨kube-controller-manageç»„ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å¯åŠ¨æœåŠ¡
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-controller-manager
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-controller-manager

<span class="token number">2</span>.æŸ¥çœ‹ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:6443      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28546</span>/kube-apiserve 
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:10257     <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28941</span>/kube-controll 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10252                :::*                    LISTEN      <span class="token number">28941</span>/kube-controll 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_5-5-éƒ¨ç½²kube-schedulerç»„ä»¶"><a href="#_5-5-éƒ¨ç½²kube-schedulerç»„ä»¶" class="header-anchor">#</a> 5.5.éƒ¨ç½²kube-schedulerç»„ä»¶</h3> <h4 id="_5-5-1-åˆ›å»ºkube-scheduleré…ç½®æ–‡ä»¶"><a href="#_5-5-1-åˆ›å»ºkube-scheduleré…ç½®æ–‡ä»¶" class="header-anchor">#</a> 5.5.1.åˆ›å»ºkube-scheduleré…ç½®æ–‡ä»¶</h4> <blockquote><p>é…ç½®æ–‡ä»¶è§£é‡Š</p> <p>â€“kubeconfigï¼šæŒ‡å®škubeconfigæ–‡ä»¶</p> <p>â€“leader-electï¼šé€‰ä¸¾</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-scheduler.conf 
<span class="token assign-left variable">KUBE_SCHEDULER_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--leader-elect \
--kubeconfig=/data/kubernetes/config/kube-scheduler.kubeconfig \
--bind-address=192.168.20.10&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_5-5-2-ç”Ÿæˆkubeconfigæ–‡ä»¶"><a href="#_5-5-2-ç”Ÿæˆkubeconfigæ–‡ä»¶" class="header-anchor">#</a> 5.5.2.ç”Ÿæˆkubeconfigæ–‡ä»¶</h4> <p>ç”Ÿæˆkubeconfigè¿æ¥é›†ç¾¤apiserverã€‚</p> <p>kube-scheduleåˆ©ç”¨kubeconfigé…ç½®æ–‡ä»¶è¿æ¥apiserverã€‚</p> <p>kubeconfigæ–‡ä»¶ä¸­åŒ…æ‹¬é›†ç¾¤apiserveråœ°å€ã€è¯ä¹¦æ–‡ä»¶ã€ç”¨æˆ·ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åˆ›å»ºè¯ä¹¦é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kube-scheduler-csr.json
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-scheduler&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:masters&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.ç”Ÿæˆè¯ä¹¦
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-scheduler-csr.json <span class="token operator">|</span> cfssljson -bare kube-scheduler
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:40 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:40 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:40 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:42 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">91388852050290848663498441480862532526947759393</span>
<span class="token number">2021</span>/09/02 <span class="token number">14</span>:50:42 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token number">3</span>.æŸ¥çœ‹è¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># ll
æ€»ç”¨é‡ <span class="token number">68</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">294</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-config.json
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">264</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1359</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1277</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">602</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1643</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1045</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">255</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:46 kube-controller-manager-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1436</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1029</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">245</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1424</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler.pem

<span class="token number">4</span>.æ‹·è´è¯ä¹¦æ–‡ä»¶è‡³æŒ‡å®šè·¯å¾„
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kube-scheduler*.pem /data/kubernetes/ssl/

<span class="token number">5</span>.ç”Ÿæˆkubeconfigæ–‡ä»¶
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.kubeconfig
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯ </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials kube-scheduler <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kube-scheduler.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kube-scheduler-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.kubeconfig
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ ç”¨æˆ·ä¿¡æ¯ </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-scheduler <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.kubeconfig

<span class="token number">6</span>.æŒ‡å®šç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸ºé›†ç¾¤ä½¿ç”¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><h4 id="_5-5-3-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡"><a href="#_5-5-3-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡" class="header-anchor">#</a> 5.5.3.åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-scheduler.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Scheduler
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-scheduler.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-scheduler <span class="token variable">$KUBE_SCHEDULER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_5-5-4-å¯åŠ¨kube-schedulerç»„ä»¶"><a href="#_5-5-4-å¯åŠ¨kube-schedulerç»„ä»¶" class="header-anchor">#</a> 5.5.4.å¯åŠ¨kube-schedulerç»„ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å¯åŠ¨æœåŠ¡
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-scheduler
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-scheduler

<span class="token number">2</span>.æŸ¥çœ‹ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:6443      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28546</span>/kube-apiserve 
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:10257     <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28941</span>/kube-controll 
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.10:10259     <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">6127</span>/kube-scheduler 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10251                :::*                    LISTEN      <span class="token number">6127</span>/kube-scheduler 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10252                :::*                    LISTEN      <span class="token number">28941</span>/kube-controll 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_5-6-å‡†å¤‡kubectlæ‰€éœ€çš„kubeconfigæ–‡ä»¶è¿æ¥é›†ç¾¤"><a href="#_5-6-å‡†å¤‡kubectlæ‰€éœ€çš„kubeconfigæ–‡ä»¶è¿æ¥é›†ç¾¤" class="header-anchor">#</a> 5.6.å‡†å¤‡kubectlæ‰€éœ€çš„kubeconfigæ–‡ä»¶è¿æ¥é›†ç¾¤</h3> <p>kubectlæƒ³è¦è¿æ¥é›†ç¾¤å¯¹å„ç§èµ„æºè¿›è¡Œæ“ä½œï¼Œéœ€è¦æœ‰ä¸€ä¸ªkubeconfigæ–‡ä»¶è¿æ¥apiserveræ‰å¯ä»¥å¯¹é›†ç¾¤è¿›è¡Œæ“ä½œï¼Œä¹Ÿå°±æ˜¯kubeadmå®‰è£…k8sé›†ç¾¤ååœ¨masterèŠ‚ç‚¹ç”Ÿæˆçš„/root/.kubeç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸­çš„configæ–‡ä»¶å°±æ˜¯kubectlç”¨äºè¿æ¥apiserverçš„kubeconfigæ–‡ä»¶ã€‚</p> <h4 id="_5-6-1-ç”Ÿæˆè¯ä¹¦æ–‡ä»¶"><a href="#_5-6-1-ç”Ÿæˆè¯ä¹¦æ–‡ä»¶" class="header-anchor">#</a> 5.6.1.ç”Ÿæˆè¯ä¹¦æ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åˆ›å»ºè¯ä¹¦é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kubectl-csr.json 
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;kubectl&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:masters&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.ç”Ÿæˆè¯ä¹¦
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kubectl-csr.json <span class="token operator">|</span> cfssljson -bare kubectl
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:44 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:44 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:44 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:45 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:45 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">398472525484598388169457456772550114435870340604</span>
<span class="token number">2021</span>/09/02 <span class="token number">17</span>:20:45 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token number">3</span>.æŸ¥çœ‹ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># ll
æ€»ç”¨é‡ <span class="token number">84</span>
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">294</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-config.json
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1001</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">264</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1359</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:20 ca.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1277</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">602</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1643</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:30 kube-apiserver.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1045</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">255</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:46 kube-controller-manager-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1436</span> <span class="token number">9</span>æœˆ   <span class="token number">1</span> <span class="token number">16</span>:36 kube-controller-manager.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1013</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">17</span>:20 kubectl.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">231</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">17</span>:20 kubectl-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">17</span>:20 kubectl-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1403</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">17</span>:20 kubectl.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1029</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">245</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1424</span> <span class="token number">9</span>æœˆ   <span class="token number">2</span> <span class="token number">14</span>:50 kube-scheduler.pem

<span class="token number">4</span>.æ‹·è´è¯ä¹¦æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token punctuation">\</span>cp kubectl*.pem /data/kubernetes/ssl/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h4 id="_5-6-2-ç”Ÿæˆkubeconfigæ–‡ä»¶"><a href="#_5-6-2-ç”Ÿæˆkubeconfigæ–‡ä»¶" class="header-anchor">#</a> 5.6.2.ç”Ÿæˆkubeconfigæ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ é›†ç¾¤apiserverä¿¡æ¯
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/root/.kube/config

<span class="token number">2</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials cluster-admin <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kubectl.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kubectl-key.pem  <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/root/.kube/config

<span class="token number">3</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ ç”¨æˆ·ä¿¡æ¯ 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>cluster-admin <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/root/.kube/config
  
<span class="token number">4</span>.æŒ‡å®šç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸ºé›†ç¾¤ä½¿ç”¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/root/.kube/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_5-6-3-ä½¿ç”¨kubectlæŸ¥çœ‹é›†ç¾¤è¿æ¥ä¿¡æ¯"><a href="#_5-6-3-ä½¿ç”¨kubectlæŸ¥çœ‹é›†ç¾¤è¿æ¥ä¿¡æ¯" class="header-anchor">#</a> 5.6.3.ä½¿ç”¨kubectlæŸ¥çœ‹é›†ç¾¤è¿æ¥ä¿¡æ¯</h4> <p>è‡³æ­¤masterèŠ‚ç‚¹ç›¸å…³ç»„ä»¶éƒ¨ç½²å®Œæˆã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
No resources found

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get cs
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/8ea5953c67f6460facc684905acb502c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h2 id="_6-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²nodeèŠ‚ç‚¹ç›¸å…³ç»„ä»¶"><a href="#_6-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²nodeèŠ‚ç‚¹ç›¸å…³ç»„ä»¶" class="header-anchor">#</a> 6.åœ¨masterèŠ‚ç‚¹éƒ¨ç½²nodeèŠ‚ç‚¹ç›¸å…³ç»„ä»¶</h2> <h3 id="_6-1-åœ¨é›†ç¾¤æˆæƒkubelet-bootstrapç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦"><a href="#_6-1-åœ¨é›†ç¾¤æˆæƒkubelet-bootstrapç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦" class="header-anchor">#</a> 6.1.åœ¨é›†ç¾¤æˆæƒkubelet-bootstrapç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦</h3> <p>åœ¨æ­¤å¤„åšäº†è¿™ä¸€æ­¥ä¹‹åï¼ŒnodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶å°±ä¸éœ€è¦åšäº†ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl create clusterrolebinding kubelet-bootstrap <span class="token punctuation">\</span>
--clusterrole<span class="token operator">=</span>system:node-bootstrapper <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kubelet-bootstrap
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_6-2-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kubeletç»„ä»¶"><a href="#_6-2-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kubeletç»„ä»¶" class="header-anchor">#</a> 6.2.åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kubeletç»„ä»¶</h3> <p>ç”±äºmasterä¹Ÿéœ€è¦å¯åŠ¨æŸäº›podï¼Œæ¯”å¦‚calicoç»„ä»¶éƒ½æ˜¯ä»¥podæ–¹å¼è¿è¡Œçš„ï¼Œå› æ­¤åœ¨masterèŠ‚ç‚¹ä¹Ÿéœ€è¦kubeletå’Œkube-proxyç»„ä»¶ã€‚</p> <h4 id="_6-2-1-å°†kubeletå’Œkube-proxyçš„äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´è‡³å¯¹åº”ç›®å½•"><a href="#_6-2-1-å°†kubeletå’Œkube-proxyçš„äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´è‡³å¯¹åº”ç›®å½•" class="header-anchor">#</a> 6.2.1.å°†kubeletå’Œkube-proxyçš„äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´è‡³å¯¹åº”ç›®å½•</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kubernetes/server/bin/<span class="token punctuation">{</span>kubelet,kube-proxy<span class="token punctuation">}</span> /data/kubernetes/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_6-2-2-åˆ›å»ºkubeleté…ç½®æ–‡ä»¶"><a href="#_6-2-2-åˆ›å»ºkubeleté…ç½®æ–‡ä»¶" class="header-anchor">#</a> 6.2.2.åˆ›å»ºkubeleté…ç½®æ–‡ä»¶</h4> <blockquote><p>é…ç½®æ–‡ä»¶å«ä¹‰ï¼š</p> <p>â€“hostname-overrideï¼šèŠ‚ç‚¹åç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€</p> <p>â€“network-pluginï¼šå¯ç”¨CNIç½‘ç»œ</p> <p>â€“kubeconfigï¼šæŒ‡å®šè‡ªåŠ¨ç”Ÿæˆçš„kubeconfigæ–‡ä»¶è·¯å¾„ï¼Œç”¨äºè¿æ¥apiserver</p> <p>â€“bootstrap-kubeconfigï¼šæŒ‡å®šé¦–æ¬¡å¯åŠ¨å‘apiserverç”³è¯·è¯ä¹¦çš„kubeconfigæ–‡ä»¶è·¯å¾„</p> <p>â€“configï¼šé…ç½®å‚æ•°æ–‡ä»¶è·¯å¾„</p> <p>â€“cert-dirï¼škubeletè¯ä¹¦ç”Ÿæˆç›®å½•è·¯å¾„</p> <p>â€“pod-infra-container-imageï¼špodå®¹å™¨çš„æ ¹å®¹å™¨</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet.conf
<span class="token assign-left variable">KUBELET_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--hostname-override=binary-k8s-master1 \
--network-plugin=cni \
--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \
--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \
--config=/data/kubernetes/config/kubelet-config.yml \
--cert-dir=/data/kubernetes/ssl \
--pod-infra-container-image=pause-amd64:3.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_6-2-3-åˆ›å»ºkubelet-config-yamlå‚æ•°é…ç½®æ–‡ä»¶"><a href="#_6-2-3-åˆ›å»ºkubelet-config-yamlå‚æ•°é…ç½®æ–‡ä»¶" class="header-anchor">#</a> 6.2.3.åˆ›å»ºkubelet-config.yamlå‚æ•°é…ç½®æ–‡ä»¶</h4> <p>kubeletå’Œkube-proxyæœåŠ¡çš„å‚æ•°é…ç½®æ˜¯ä»¥yamlå½¢å¼æ¥é…ç½®çš„</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet-config.yml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: <span class="token number">0.0</span>.0.0				<span class="token comment">#ç›‘å¬åœ°å€</span>
port: <span class="token number">10250</span>						<span class="token comment">#ç›‘å¬ç«¯å£</span>
readOnlyPort: <span class="token number">10255</span>
cgroupDriver: cgroupfs			<span class="token comment">#é©±åŠ¨å¼•æ“</span>
clusterDNS:
- <span class="token number">10.0</span>.0.2
clusterDomain: cluster.local
failSwapOn: <span class="token boolean">false</span>
authentication:
  anonymous:
    enabled: <span class="token boolean">false</span>
  webhook:
    cacheTTL: 2m0s
    enabled: <span class="token boolean">true</span>
  x509:
    clientCAFile: /data/kubernetes/ssl/ca.pem		<span class="token comment">#caè¯ä¹¦æ–‡ä»¶è·¯å¾„</span>
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
evictionHard:
  imagefs.available: <span class="token number">15</span>%
  memory.available: 100Mi
  nodefs.available: <span class="token number">10</span>%
  nodefs.inodesFree: <span class="token number">5</span>%
maxOpenFiles: <span class="token number">1000000</span>
maxPods: <span class="token number">110</span>				<span class="token comment">#å¯è¿è¡Œçš„podçš„æ•°é‡</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_6-2-4-åˆ›å»ºbootstrap-kubeconfigæ–‡ä»¶"><a href="#_6-2-4-åˆ›å»ºbootstrap-kubeconfigæ–‡ä»¶" class="header-anchor">#</a> 6.2.4.åˆ›å»ºbootstrap-kubeconfigæ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ é›†ç¾¤apiserverä¿¡æ¯
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
  
<span class="token number">2</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ tokenä¿¡æ¯
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials <span class="token string">&quot;kubelet-bootstrap&quot;</span> <span class="token punctuation">\</span>
--token<span class="token operator">=</span>d7f96b0d86c574d0f64a713608db0922 <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
<span class="token comment">#è¿™ä¸ªtokenå°±æ˜¯ä¹‹å‰ç”Ÿæˆçš„/data/kubernetes/config/token.csvä¸­çš„token</span>
  
<span class="token number">3</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ ç”¨æˆ·ä¿¡æ¯ 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span><span class="token string">&quot;kubelet-bootstrap&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig

<span class="token number">4</span>.æŒ‡å®šç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸ºé›†ç¾¤ä½¿ç”¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_6-2-5-åˆ›å»ºsystemctlè„šæœ¬å¹¶å¯åŠ¨æœåŠ¡"><a href="#_6-2-5-åˆ›å»ºsystemctlè„šæœ¬å¹¶å¯åŠ¨æœåŠ¡" class="header-anchor">#</a> 6.2.5.åˆ›å»ºsystemctlè„šæœ¬å¹¶å¯åŠ¨æœåŠ¡</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åˆ›å»ºsystemctlè„šæœ¬
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kubelet.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Kubelet
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kubelet.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kubelet <span class="token variable">$KUBELET_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token number">2</span>.å¯åŠ¨kubeletæœåŠ¡
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kubelet
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_6-2-6-å°†masterèŠ‚ç‚¹ä½œä¸ºnodeåŠ å…¥é›†ç¾¤å†…éƒ¨"><a href="#_6-2-6-å°†masterèŠ‚ç‚¹ä½œä¸ºnodeåŠ å…¥é›†ç¾¤å†…éƒ¨" class="header-anchor">#</a> 6.2.6.å°†masterèŠ‚ç‚¹ä½œä¸ºnodeåŠ å…¥é›†ç¾¤å†…éƒ¨</h4> <p>å½“kubeletç»„ä»¶å¯åŠ¨æˆåŠŸåï¼Œå°±ä¼šæƒ³apiserverå‘é€ä¸€ä¸ªè¯·æ±‚åŠ å…¥é›†ç¾¤çš„ä¿¡æ¯ï¼Œåªæœ‰å½“masterèŠ‚ç‚¹æˆæƒåŒæ„åï¼Œæ‰å¯ä»¥æ­£å¸¸åŠ å…¥ï¼Œè™½ç„¶æ˜¯masterèŠ‚ç‚¹éƒ¨ç½²çš„nodeç»„ä»¶ï¼Œä½†æ˜¯ä¹Ÿä¼šå‘ç”Ÿä¸€ä¸ªåŠ å…¥é›†ç¾¤çš„ä¿¡æ¯ï¼Œéœ€è¦masteråŒæ„ã€‚</p> <p>å½“kubeletå¯åŠ¨ä¹‹åï¼Œé¦–å…ˆä¼šåœ¨è¯ä¹¦ç›®å½•ç”Ÿæˆä¸€ä¸ªkubelet-client.key.tmpè¿™ä¸ªæ–‡ä»¶ï¼Œå½“ä½¿ç”¨kubectl certificate approveå‘½ä»¤æˆæƒæˆåŠŸnodeçš„è¯·æ±‚ä¹‹åï¼Œkubelet-client.key.tmpå°æ—¶ï¼Œéšä¹‹ä¼šç”Ÿæˆä¸€ä¸ªkubelet-client-current.pemçš„è¯ä¹¦æ–‡ä»¶ï¼Œç”¨äºä¸apiserverå»ºç«‹è¿æ¥ï¼Œæ­¤æ—¶å†ä½¿ç”¨kubectl get nodeå°±ä¼šçœ‹åˆ°èŠ‚ç‚¹ä¿¡æ¯äº†ã€‚</p> <p>æ‰©å±•ï¼šå¦‚æœåæœŸæƒ³è¦ä¿®æ”¹nodeçš„åç§°ï¼Œé‚£ä¹ˆå°±æŠŠç”Ÿæˆçš„kubeletè¯ä¹¦æ–‡ä»¶å…¨éƒ¨åˆ é™¤ï¼Œç„¶åä½¿ç”¨kubectl delete nodeåˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œåœ¨ä¿®æ”¹kubeleté…ç½®æ–‡ä»¶ä¸­è¯¥èŠ‚ç‚¹çš„åç§°ï¼Œç„¶åä½¿ç”¨kubectl delete csråˆ é™¤æˆæƒä¿¡æ¯ï¼Œå†é‡å¯kubeletç”Ÿæˆæ–°çš„æˆæƒä¿¡æ¯ï¼Œç„¶åæˆæƒé€šè¿‡å³å¯çœ‹åˆ°æ–°çš„åå­—çš„nodeèŠ‚ç‚¹ã€‚</p> <p>åªæœ‰å½“æˆæƒé€šè¿‡åï¼Œkubeletç”Ÿæˆäº†è¯ä¹¦æ–‡ä»¶ï¼Œkubeletçš„ç«¯å£æ‰ä¼šè¢«å¯åŠ¨</p> <p>æ³¨æ„ï¼šå½“kubeletçš„æˆæƒè¢«masterè¯·æ±‚é€šåï¼Œkube-proxyå¯åŠ¨æˆåŠŸåï¼ŒèŠ‚ç‚¹æ‰ä¼šæ­£çœŸçš„åŠ å…¥é›†ç¾¤ï¼Œå³ä½¿kubectl get nodeçœ‹åˆ°çš„èŠ‚ç‚¹æ˜¯Readyï¼Œè¯¥èŠ‚ç‚¹ä¹Ÿæ˜¯ä¸å¯ç”¨çš„ï¼Œå¿…é¡»å½“kube-proxyå¯åŠ¨å®Œæ¯•åï¼Œè¿™ä¸ªèŠ‚ç‚¹æ‰ç®—æ­£çœŸçš„å¯åŠ¨å®Œæ¯•&lt;</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ç›´æ¥åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è·å–è¯·æ±‚åˆ—è¡¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get csr
NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4   4s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token number">2</span>.æˆæƒåŒæ„æ­¤èŠ‚ç‚¹åŠ å…¥é›†ç¾¤
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl certificate approve node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4
certificatesigningrequest.certificates.k8s.io/node-csr-JN8q9WljA6oupdWZ2mVO-TOIq2sLodFdkyL5fu6Ius4 approved

<span class="token number">3</span>.æŸ¥çœ‹nodeèŠ‚ç‚¹
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS     ROLES    AGE   VERSION
binary-k8s-master1   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   6s    v1.20.4
<span class="token comment">#æ­¤æ—¶masterèŠ‚ç‚¹å·²ç»å‡ºç°åœ¨é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨ä¸­äº†</span>

<span class="token number">4</span>.æŸ¥çœ‹kubeletç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kubelet
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:10248         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">29092</span>/kubelet       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:41132         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">29092</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10250                :::*                    LISTEN      <span class="token number">29092</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10255                :::*                    LISTEN      <span class="token number">29092</span>/kubelet 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/857b38edfb4c46e99ccd40e7fa296628.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h3 id="_6-3-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kube-proxy"><a href="#_6-3-åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kube-proxy" class="header-anchor">#</a> 6.3.åœ¨masterèŠ‚ç‚¹éƒ¨ç½²kube-proxy</h3> <h4 id="_6-3-1-åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶"><a href="#_6-3-1-åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶" class="header-anchor">#</a> 6.3.1.åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy.conf
<span class="token assign-left variable">KUBE_PROXY_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_6-3-2-åˆ›å»ºkube-proxyå‚æ•°é…ç½®æ–‡ä»¶"><a href="#_6-3-2-åˆ›å»ºkube-proxyå‚æ•°é…ç½®æ–‡ä»¶" class="header-anchor">#</a> 6.3.2.åˆ›å»ºkube-proxyå‚æ•°é…ç½®æ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy-config.yml
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: <span class="token number">0.0</span>.0.0									<span class="token comment">#ç›‘å¬åœ°å€</span>
metricsBindAddress: <span class="token number">0.0</span>.0.0:10249							<span class="token comment">#ç›‘å¬ç«¯å£</span>
clientConnection:
  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig			<span class="token comment">#kubeconfigæ–‡ä»¶ç”¨äºå’Œapiserveré€šä¿¡</span>
hostnameOverride: binary-k8s-master1				<span class="token comment">#å½“å‰èŠ‚ç‚¹åç§°</span>
clusterCIDR: <span class="token number">10.244</span>.0.0/16
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_6-3-3-ç”Ÿæˆkubeconfigæ–‡ä»¶"><a href="#_6-3-3-ç”Ÿæˆkubeconfigæ–‡ä»¶" class="header-anchor">#</a> 6.3.3.ç”Ÿæˆkubeconfigæ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åˆ›å»ºè¯ä¹¦é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> kube-proxy-csr.json 
<span class="token punctuation">{</span>
  <span class="token string">&quot;CN&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;system:kube-proxy&quot;</span>,
  <span class="token string">&quot;hosts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
  <span class="token string">&quot;key&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;algo&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;rsa&quot;</span>,
    <span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2048</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;names&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;C&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;CN&quot;</span>,
      <span class="token string">&quot;L&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;ST&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeiJing&quot;</span>,
      <span class="token string">&quot;O&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;k8s&quot;</span>,
      <span class="token string">&quot;OU&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;System&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>


<span class="token number">2</span>.ç”Ÿæˆè¯ä¹¦
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-proxy-csr.json <span class="token operator">|</span> cfssljson -bare kube-proxy
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:23 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:24 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">677418055440191127932354470575565723194258386145</span>
<span class="token number">2021</span>/09/03 <span class="token number">16</span>:04:24 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.

<span class="token number">3</span>.æŸ¥çœ‹è¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># ll *proxy*
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1009</span> <span class="token number">9</span>æœˆ   <span class="token number">3</span> <span class="token number">16</span>:04 kube-proxy.csr
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">230</span> <span class="token number">9</span>æœˆ   <span class="token number">3</span> <span class="token number">16</span>:04 kube-proxy-csr.json
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">9</span>æœˆ   <span class="token number">3</span> <span class="token number">16</span>:04 kube-proxy-key.pem
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1403</span> <span class="token number">9</span>æœˆ   <span class="token number">3</span> <span class="token number">16</span>:04 kube-proxy.pem


<span class="token number">4</span>.æ‹·è´è¯ä¹¦æ–‡ä»¶è‡³æŒ‡å®šè·¯å¾„
<span class="token punctuation">[</span>root@binary-k8s-master1 ~/TLS/k8s<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kube-proxy*.pem /data/kubernetes/ssl/

<span class="token number">5</span>.ç”Ÿæˆkubeconfigæ–‡ä»¶
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯ </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials kube-proxy <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kube-proxy.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kube-proxy-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ ç”¨æˆ·ä¿¡æ¯ </span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-proxy <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig

<span class="token number">6</span>.æŒ‡å®šç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸ºé›†ç¾¤ä½¿ç”¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h4 id="_6-3-4-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡"><a href="#_6-3-4-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡" class="header-anchor">#</a> 6.3.4.åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-proxy.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Proxy
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-proxy.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-proxy <span class="token variable">$KUBE_PROXY_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_6-3-4-å¯åŠ¨kube-proxyç»„ä»¶"><a href="#_6-3-4-å¯åŠ¨kube-proxyç»„ä»¶" class="header-anchor">#</a> 6.3.4.å¯åŠ¨kube-proxyç»„ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å¯åŠ¨æœåŠ¡
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-proxy
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-proxy

<span class="token number">2</span>.æŸ¥çœ‹ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube-proxy
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10249                :::*                    LISTEN      <span class="token number">29354</span>/kube-proxy    
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10256                :::*                    LISTEN      <span class="token number">29354</span>/kube-proxy 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_6-4-æˆæƒapiserverè®¿é—®kubelet"><a href="#_6-4-æˆæƒapiserverè®¿é—®kubelet" class="header-anchor">#</a> 6.4.æˆæƒapiserverè®¿é—®kubelet</h3> <p>å¦‚æœä¸æ”¶å–apiserverè®¿é—®kubeletï¼Œé‚£ä¹ˆå°†æ— æ³•ä½¿ç”¨kubectlæŸ¥çœ‹é›†ç¾¤çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚kubectl logså°±æ— æ³•ä½¿ç”¨ã€‚</p> <p>å®é™…ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ªrbacèµ„æºè®©apiserverèƒ½å¦è®¿é—®kubeletçš„èµ„æºã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ç¼–å†™èµ„æºyamlæ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> apiserver-to-kubelet-rbac.yaml 
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="token string">&quot;true&quot;</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - <span class="token string">&quot;&quot;</span>
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
      - pods/log
    verbs:
      - <span class="token string">&quot;*&quot;</span>
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: <span class="token string">&quot;&quot;</span>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes

<span class="token number">2</span>.åˆ›å»ºèµ„æº
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f apiserver-to-kubelet-rbac.yaml
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="_7-éƒ¨ç½²kubernetes-calicoç½‘ç»œç»„ä»¶"><a href="#_7-éƒ¨ç½²kubernetes-calicoç½‘ç»œç»„ä»¶" class="header-anchor">#</a> 7.éƒ¨ç½²kubernetes calicoç½‘ç»œç»„ä»¶</h2> <p>åœ¨6ä¸­masterèŠ‚ç‚¹å·²ç»åŠ å…¥é›†ç¾¤ï¼Œä½†æ˜¯çŠ¶æ€ä¸€ç›´å¤„äºNotReadyçŠ¶æ€ï¼Œå°±æ˜¯ç”±äºé›†ç¾¤æ²¡æœ‰ç½‘ç»œç»„ä»¶å¯¼è‡´çš„ï¼Œéƒ¨ç½²å¥½ç½‘ç»œç»„ä»¶ï¼ŒmasterèŠ‚ç‚¹ç«‹é©¬ä¼šæˆä¸ºReadyçŠ¶æ€ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.éƒ¨ç½²calico
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f calico.yaml
configmap/calico-config created
customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrole.rbac.authorization.k8s.io/calico-node created
clusterrolebinding.rbac.authorization.k8s.io/calico-node created
daemonset.apps/calico-node created
serviceaccount/calico-node created
deployment.apps/calico-kube-controllers created
serviceaccount/calico-kube-controllers created

<span class="token number">2</span>.æŸ¥çœ‹èµ„æºçŠ¶æ€
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get pod -n kube-system
NAME                                      READY   STATUS    RESTARTS   AGE
calico-kube-controllers-97769f7c7-bnwcl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
calico-node-mghdj                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m

<span class="token number">3</span>.æŸ¥çœ‹masterèŠ‚ç‚¹çš„çŠ¶æ€
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME          STATUS   ROLES    AGE   VERSION
k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   99m   v1.20.4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="_8-éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹"><a href="#_8-éƒ¨ç½²kubernetes-nodeèŠ‚ç‚¹" class="header-anchor">#</a> 8.éƒ¨ç½²kubernetes nodeèŠ‚ç‚¹</h2> <h3 id="_8-1-è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº"><a href="#_8-1-è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº" class="header-anchor">#</a> 8.1.è§£å‹äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç›¸å…³ç»„ä»¶ç¨‹åº</h3> <p>ä»¥ä¸‹æ“ä½œä»…åœ¨node1èŠ‚ç‚¹æ“ä½œå³å¯ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å‡†å¤‡äºŒè¿›åˆ¶ç¨‹åº
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf kubernetes-server-linux-amd64.tar.gz 
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> -p /data/kubernetes/<span class="token punctuation">{</span>bin,config,ssl,logs<span class="token punctuation">}</span> 
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kubernetes/server/bin/<span class="token punctuation">{</span>kubelet,kube-proxy<span class="token punctuation">}</span> /data/kubernetes/bin/
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> kubernetes/server/bin/kubectl /usr/bin/

<span class="token number">2</span>.å°†masterèŠ‚ç‚¹ä¸Šçš„è¯ä¹¦æ–‡ä»¶æ‹·è´è‡³nodeèŠ‚ç‚¹
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/kubernetes/ssl/* binary-k8s-node1:/data/kubernetes/ssl/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/kubernetes/config/token.csv root@binary-k8s-node1:/data/kubernetes/config

<span class="token number">3</span>.åˆ é™¤ä»masterèŠ‚ç‚¹ä¸Šæ‹·è´è¿‡æ¥çš„kubeletè¯ä¹¦
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/kubernetes/ssl/kubelet-client-*
<span class="token comment">#kubeletè¯ä¹¦éœ€è¦åˆ é™¤ï¼Œå½“nodeèŠ‚ç‚¹çš„kubeletå¯åŠ¨åä¼šç”Ÿæˆä¸´æ—¶è¯ä¹¦æ–‡ä»¶ï¼Œå½“masteræˆæƒé€šè¿‡åï¼Œè¯ä¹¦æ–‡ä»¶äº§ç”Ÿ</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_8-2-éƒ¨ç½²kubeletç»„ä»¶"><a href="#_8-2-éƒ¨ç½²kubeletç»„ä»¶" class="header-anchor">#</a> 8.2.éƒ¨ç½²kubeletç»„ä»¶</h3> <h4 id="_8-2-1-åˆ›å»ºkubeleté…ç½®æ–‡ä»¶"><a href="#_8-2-1-åˆ›å»ºkubeleté…ç½®æ–‡ä»¶" class="header-anchor">#</a> 8.2.1.åˆ›å»ºkubeleté…ç½®æ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet.conf 
<span class="token assign-left variable">KUBELET_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--hostname-override=binary-k8s-node1		#æ³¨æ„ä¿®æ”¹èŠ‚ç‚¹åç§° \
--network-plugin=cni \
--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \
--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \
--config=/data/kubernetes/config/kubelet-config.yml \
--cert-dir=/data/kubernetes/ssl \
--pod-infra-container-image=pause-amd64:3.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_8-2-2-åˆ›å»ºkubeletå‚æ•°é…ç½®æ–‡ä»¶"><a href="#_8-2-2-åˆ›å»ºkubeletå‚æ•°é…ç½®æ–‡ä»¶" class="header-anchor">#</a> 8.2.2.åˆ›å»ºkubeletå‚æ•°é…ç½®æ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet-config.yml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: <span class="token number">0.0</span>.0.0
port: <span class="token number">10250</span>
readOnlyPort: <span class="token number">10255</span>
cgroupDriver: cgroupfs
clusterDNS:
- <span class="token number">10.0</span>.0.2
clusterDomain: cluster.local
failSwapOn: <span class="token boolean">false</span>
authentication:
  anonymous:
    enabled: <span class="token boolean">false</span>
  webhook:
    cacheTTL: 2m0s
    enabled: <span class="token boolean">true</span>
  x509:
    clientCAFile: /data/kubernetes/ssl/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
evictionHard:
  imagefs.available: <span class="token number">15</span>%
  memory.available: 100Mi
  nodefs.available: <span class="token number">10</span>%
  nodefs.inodesFree: <span class="token number">5</span>%
maxOpenFiles: <span class="token number">1000000</span>
maxPods: <span class="token number">110</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_8-2-3-åˆ›å»ºbootstrap-kubeconfigæ–‡ä»¶"><a href="#_8-2-3-åˆ›å»ºbootstrap-kubeconfigæ–‡ä»¶" class="header-anchor">#</a> 8.2.3.åˆ›å»ºbootstrap-kubeconfigæ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ é›†ç¾¤apiserverä¿¡æ¯
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
  
<span class="token number">2</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ tokenä¿¡æ¯
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials <span class="token string">&quot;kubelet-bootstrap&quot;</span> <span class="token punctuation">\</span>
--token<span class="token operator">=</span>d7f96b0d86c574d0f64a713608db0922 <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
<span class="token comment">#è¿™ä¸ªtokenå°±æ˜¯ä¹‹å‰ç”Ÿæˆçš„/data/kubernetes/config/token.csvä¸­çš„token</span>
  
<span class="token number">3</span>.åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ ç”¨æˆ·ä¿¡æ¯ 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span><span class="token string">&quot;kubelet-bootstrap&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig

<span class="token number">4</span>.æŒ‡å®šç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸ºé›†ç¾¤ä½¿ç”¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/bootstrap.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_8-2-4-åˆ›å»ºsystemctlè„šæœ¬å¹¶å¯åŠ¨æœåŠ¡"><a href="#_8-2-4-åˆ›å»ºsystemctlè„šæœ¬å¹¶å¯åŠ¨æœåŠ¡" class="header-anchor">#</a> 8.2.4.åˆ›å»ºsystemctlè„šæœ¬å¹¶å¯åŠ¨æœåŠ¡</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ç¼–å†™systemctlæœåŠ¡è„šæœ¬
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kubelet.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Kubelet
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kubelet.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kubelet <span class="token variable">$KUBELET_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token number">2</span>.å¯åŠ¨kubeletæœåŠ¡
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kubelet
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kubelet
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl status kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_8-2-5-masterèŠ‚ç‚¹æˆæƒåŒæ„nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#_8-2-5-masterèŠ‚ç‚¹æˆæƒåŒæ„nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="header-anchor">#</a> 8.2.5.masterèŠ‚ç‚¹æˆæƒåŒæ„nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h4> <p>kubeletæœåŠ¡å¯åŠ¨åï¼Œä¼šç”Ÿæˆä¸€ä¸ªä¸´æ—¶è¯ä¹¦æ–‡ä»¶ï¼Œç„¶åå‘masterèŠ‚ç‚¹å‘é€ä¸€ä¸ªcsræˆæƒè¯·æ±‚ï¼Œå½“masterèŠ‚ç‚¹æˆæƒåŒæ„åï¼Œkubelet-clinetè¯ä¹¦æ–‡ä»¶ç”Ÿæˆï¼Œç«¯å£ä¹Ÿéšä¹‹å¯åŠ¨ï¼ŒèŠ‚ç‚¹æ­£å¸¸åŠ å…¥é›†ç¾¤ã€‚</p> <p>csråˆ—è¡¨çš„æˆæƒä¿¡æ¯ä¹Ÿä¼šè‡ªåŠ¨æ¸…ç©ºï¼Œå¦‚æœmasterèŠ‚ç‚¹çš„æˆæƒä¸åŠæ—¶ï¼Œä¹Ÿå¯ä»¥é‡å¯ä¸€ä¸‹kubeleté‡æ–°å‘é€ä¸€ä¸ªcsrè¯·æ±‚ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åœ¨nodeèŠ‚ç‚¹æŸ¥çœ‹ä¸´æ—¶è¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># ll /data/kubernetes/ssl/*.tmp
-rw-------. <span class="token number">1</span> root root  <span class="token number">227</span> <span class="token number">9</span>æœˆ   <span class="token number">6</span> <span class="token number">11</span>:28 kubelet-client.key.tmp
<span class="token comment">#åªè¦kubeletå¯åŠ¨å°±ä¼šäº§ç”Ÿä¸€ä¸ªä¸´æ—¶è¯ä¹¦æ–‡ä»¶</span>

<span class="token number">2</span>.åœ¨masterèŠ‚ç‚¹æŸ¥çœ‹csræˆæƒè¯·æ±‚åˆ—è¡¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get csr
NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI   11s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token number">3</span>.æˆæƒé€šè¿‡
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl certificate approve node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI
certificatesigningrequest.certificates.k8s.io/node-csr-JmO7N8iDvyD0D-2Pu7_yHJ3ngZ5xXfA_TwRevqmHAXI approved

<span class="token number">4</span>.æ­¤æ—¶ä¸´æ—¶æ–‡ä»¶å·²åˆ é™¤ï¼Œå·²ç»ç”Ÿæˆkubeletè¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># ll /data/kubernetes/ssl/kubelet-client*
-rw-------. <span class="token number">1</span> root root <span class="token number">1236</span> <span class="token number">9</span>æœˆ   <span class="token number">6</span> <span class="token number">11</span>:28 kubelet-client-2021-09-06-11-28-54.pem
lrwxrwxrwx. <span class="token number">1</span> root root   <span class="token number">59</span> <span class="token number">9</span>æœˆ   <span class="token number">6</span> <span class="token number">11</span>:28 kubelet-client-current.pem -<span class="token operator">&gt;</span> /data/kubernetes/ssl/kubelet-client-2021-09-06-11-28-54.pem

<span class="token number">5</span>.node1èŠ‚ç‚¹æˆåŠŸåŠ å…¥é›†ç¾¤
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2d22h   v1.20.4
binary-k8s-node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4h59m   v1.20.4

<span class="token number">6</span>.åœ¨nodeèŠ‚ç‚¹æŸ¥çœ‹kubeletæœåŠ¡çš„ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kubelet
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:10248         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">29220</span>/kubelet       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:44151         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">29220</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10250                :::*                    LISTEN      <span class="token number">29220</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10255                :::*                    LISTEN      <span class="token number">29220</span>/kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_8-3-éƒ¨ç½²kube-proxyç»„ä»¶"><a href="#_8-3-éƒ¨ç½²kube-proxyç»„ä»¶" class="header-anchor">#</a> 8.3.éƒ¨ç½²kube-proxyç»„ä»¶</h3> <h4 id="_8-3-1-åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶"><a href="#_8-3-1-åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶" class="header-anchor">#</a> 8.3.1.åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy.conf
<span class="token assign-left variable">KUBE_PROXY_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--config=/data/kubernetes/config/kube-proxy-config.yml&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_8-3-2-åˆ›å»ºkube-proxyå‚æ•°é…ç½®æ–‡ä»¶"><a href="#_8-3-2-åˆ›å»ºkube-proxyå‚æ•°é…ç½®æ–‡ä»¶" class="header-anchor">#</a> 8.3.2.åˆ›å»ºkube-proxyå‚æ•°é…ç½®æ–‡ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy-config.yml
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: <span class="token number">0.0</span>.0.0									<span class="token comment">#ç›‘å¬åœ°å€</span>
metricsBindAddress: <span class="token number">0.0</span>.0.0:10249							<span class="token comment">#ç›‘å¬ç«¯å£</span>
clientConnection:
  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig			<span class="token comment">#kubeconfigæ–‡ä»¶ç”¨äºå’Œapiserveré€šä¿¡</span>
hostnameOverride: binary-k8s-node1				<span class="token comment">#å½“å‰èŠ‚ç‚¹åç§°</span>
clusterCIDR: <span class="token number">10.244</span>.0.0/16
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_8-3-3-ç”Ÿæˆkube-configæ–‡ä»¶"><a href="#_8-3-3-ç”Ÿæˆkube-configæ–‡ä»¶" class="header-anchor">#</a> 8.3.3.ç”Ÿæˆkube-configæ–‡ä»¶</h4> <p>ç”±äºkube-proxyçš„è¯ä¹¦æ–‡ä»¶åœ¨8.1ä¸­å·²ç»ä»masterèŠ‚ç‚¹æ‹·è´åˆ°nodeèŠ‚ç‚¹äº†ï¼Œå› æ­¤ç›´æ¥ç”Ÿæˆkubeconfigæ–‡ä»¶å³å¯ã€‚</p> <p>é›†ç¾¤ä¸­ä¸åŒèŠ‚ç‚¹çš„ç»„ä»¶éƒ½è¦ç”¨åŒä¸€ä¸ªè¯ä¹¦æ–‡ä»¶ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ç”Ÿæˆkubeconfigæ–‡ä»¶
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/data/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.10:6443&quot;</span> <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯ </span>
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-credentials kube-proxy <span class="token punctuation">\</span>
--client-certificate<span class="token operator">=</span>/data/kubernetes/ssl/kube-proxy.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/data/kubernetes/ssl/kube-proxy-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
<span class="token comment">#åœ¨kubeconfigæ–‡ä»¶ä¸­å¢åŠ ç”¨æˆ·ä¿¡æ¯ </span>
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config set-context default <span class="token punctuation">\</span>
--cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-proxy <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig

<span class="token number">2</span>.æŒ‡å®šç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸ºé›†ç¾¤ä½¿ç”¨
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl config use-context default --kubeconfig<span class="token operator">=</span>/data/kubernetes/config/kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_8-3-4-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡"><a href="#_8-3-4-åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡" class="header-anchor">#</a> 8.3.4.åˆ›å»ºsystemctlè„šæœ¬ç®¡ç†æœåŠ¡</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /usr/lib/systemd/system/kube-proxy.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Proxy
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/data/kubernetes/config/kube-proxy.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/data/kubernetes/bin/kube-proxy <span class="token variable">$KUBE_PROXY_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.targ
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_8-3-5-å¯åŠ¨kube-proxyç»„ä»¶"><a href="#_8-3-5-å¯åŠ¨kube-proxyç»„ä»¶" class="header-anchor">#</a> 8.3.5.å¯åŠ¨kube-proxyç»„ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å¯åŠ¨æœåŠ¡
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-proxy
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-proxy

<span class="token number">2</span>.æŸ¥çœ‹ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube-proxy
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10249                :::*                    LISTEN      <span class="token number">26954</span>/kube-proxy    
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10256                :::*                    LISTEN      <span class="token number">26954</span>/kube-proxy  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_8-4-å¿«é€Ÿå¢åŠ æ–°çš„nodeèŠ‚ç‚¹"><a href="#_8-4-å¿«é€Ÿå¢åŠ æ–°çš„nodeèŠ‚ç‚¹" class="header-anchor">#</a> 8.4.å¿«é€Ÿå¢åŠ æ–°çš„nodeèŠ‚ç‚¹</h3> <p>äºŒè¿›åˆ¶éƒ¨ç½²çš„ç¨‹åºç‰¹åˆ«å¥½çš„ä¸€ä¸ªåœ°æ–¹å°±åœ¨äºï¼Œèƒ½å¤Ÿå¿«é€Ÿéƒ¨ç½²ä¸€ä¸ªæ–°çš„æœåŠ¡ï¼Œåšæ³•å°±æ˜¯ç›´æ¥æ‹·è´å·²ç»éƒ¨ç½²å¥½çš„ç›®å½•åˆ°ä¸€ä¸ªæ–°çš„ä½ç½®ï¼Œæ”¹æ”¹å…¶ä¸­çš„å‚æ•°å³å¯å¯åŠ¨ä½¿ç”¨äº†ã€‚</p> <h4 id="_8-4-1-å°†kubeletå’Œkube-proxyç›®å½•æ‹·è´è‡³æ–°çš„nodeèŠ‚ç‚¹"><a href="#_8-4-1-å°†kubeletå’Œkube-proxyç›®å½•æ‹·è´è‡³æ–°çš„nodeèŠ‚ç‚¹" class="header-anchor">#</a> 8.4.1.å°†kubeletå’Œkube-proxyç›®å½•æ‹·è´è‡³æ–°çš„nodeèŠ‚ç‚¹</h4> <p>è¦æ‹·è´kubeletå’Œkube-proxyéƒ¨ç½²ç›®å½•ä»¥åŠsystemctlå¯åŠ¨è„šæœ¬æ–‡ä»¶ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/kubernetes root@binary-k8s-node2:/data
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> /usr/lib/systemd/system/kube* root@binary-k8s-node2:/usr/lib/systemd/system/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_8-4-2-é…ç½®å¹¶å¯åŠ¨kubeletç»„ä»¶"><a href="#_8-4-2-é…ç½®å¹¶å¯åŠ¨kubeletç»„ä»¶" class="header-anchor">#</a> 8.4.2.é…ç½®å¹¶å¯åŠ¨kubeletç»„ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.åˆ é™¤æ²¡ç”¨çš„è¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/kubernetes/ssl/kubelet-client-*

<span class="token number">2</span>.ä¿®æ”¹kubeleté…ç½®æ–‡ä»¶ä¸­çš„èŠ‚ç‚¹åç§°
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet.conf 
<span class="token assign-left variable">KUBELET_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=false \
--v=2 \
--log-dir=/data/kubernetes/logs \
--hostname-override=binary-k8s-node2 \
--network-plugin=cni \
--kubeconfig=/data/kubernetes/config/kubelet.kubeconfig \
--bootstrap-kubeconfig=/data/kubernetes/config/bootstrap.kubeconfig \
--config=/data/kubernetes/config/kubelet-config.yml \
--cert-dir=/data/kubernetes/ssl \
--pod-infra-container-image=pause-amd64:3.0&quot;</span>
<span class="token comment">#å°†--hostname-overrideå€¼ä¿®æ”¹ä¸ºå½“å‰èŠ‚ç‚¹åç§°å³å¯</span>

<span class="token number">3</span>.å¯åŠ¨kubelet
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload 
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kubelet
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_8-4-3-masterèŠ‚ç‚¹æˆæƒæ–°nodeèŠ‚ç‚¹çš„è¯·æ±‚"><a href="#_8-4-3-masterèŠ‚ç‚¹æˆæƒæ–°nodeèŠ‚ç‚¹çš„è¯·æ±‚" class="header-anchor">#</a> 8.4.3.masterèŠ‚ç‚¹æˆæƒæ–°nodeèŠ‚ç‚¹çš„è¯·æ±‚</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.masterèŠ‚ç‚¹æŸ¥çœ‹æˆæƒä¿¡æ¯åˆ—è¡¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get csr
NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE   48s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token number">2</span>.æˆæƒé€šè¿‡nodeèŠ‚ç‚¹çš„kubelet
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl certificate approve node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE
certificatesigningrequest.certificates.k8s.io/node-csr-u_AHUS7T5rku-hnhnGsGi8uGBqlgMquOq_3oq6jrOyE approved

<span class="token number">3</span>.æˆåŠŸåŠ å…¥é›†ç¾¤
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2d23h   v1.20.4
binary-k8s-node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   5h54m   v1.20.4
binary-k8s-node2     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   1s      v1.20.4

<span class="token number">4</span>.æŸ¥çœ‹kubeletçš„ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:41121         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16694</span>/kubelet       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:10248         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10250                :::*                    LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10255                :::*                    LISTEN      <span class="token number">16694</span>/kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_8-4-4-é…ç½®å¹¶å¯åŠ¨kube-proxyç»„ä»¶"><a href="#_8-4-4-é…ç½®å¹¶å¯åŠ¨kube-proxyç»„ä»¶" class="header-anchor">#</a> 8.4.4.é…ç½®å¹¶å¯åŠ¨kube-proxyç»„ä»¶</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ä¿®æ”¹kube-proxyå‚æ•°é…ç½®æ–‡ä»¶ä¸­çš„ä¸»æœºå
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy-config.yml 
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: <span class="token number">0.0</span>.0.0
metricsBindAddress: <span class="token number">0.0</span>.0.0:10249
clientConnection:
  kubeconfig: /data/kubernetes/config/kube-proxy.kubeconfig
hostnameOverride: binary-k8s-node2
clusterCIDR: <span class="token number">10.244</span>.0.0/16

<span class="token number">2</span>.å¯åŠ¨kubelet
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload 
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-proxy
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-proxy

<span class="token number">3</span>æŸ¥çœ‹kube-proxyç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> kube
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:41121         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16694</span>/kubelet       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:10248         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10249                :::*                    LISTEN      <span class="token number">20410</span>/kube-proxy    
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10250                :::*                    LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10255                :::*                    LISTEN      <span class="token number">16694</span>/kubelet       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::10256                :::*                    LISTEN      <span class="token number">20410</span>/kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="_9-ä¸ºé›†ç¾¤éƒ¨ç½²corednsç»„ä»¶"><a href="#_9-ä¸ºé›†ç¾¤éƒ¨ç½²corednsç»„ä»¶" class="header-anchor">#</a> 9.ä¸ºé›†ç¾¤éƒ¨ç½²corednsç»„ä»¶</h2> <h3 id="_9-1-éƒ¨ç½²corednsç»„ä»¶"><a href="#_9-1-éƒ¨ç½²corednsç»„ä»¶" class="header-anchor">#</a> 9.1.éƒ¨ç½²corednsç»„ä»¶</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.coredns.yamlæ–‡ä»¶å†…å®¹
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cat</span> coredns.yaml 
<span class="token comment"># Warning: This is a file generated from the base underscore template file: coredns.yaml.base</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coredns
  namespace: kube-system
  labels:
      kubernetes.io/cluster-service: <span class="token string">&quot;true&quot;</span>
      addonmanager.kubernetes.io/mode: Reconcile
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
    addonmanager.kubernetes.io/mode: Reconcile
  name: system:coredns
rules:
- apiGroups:
  - <span class="token string">&quot;&quot;</span>
  resources:
  - endpoints
  - services
  - pods
  - namespaces
  verbs:
  - list
  - <span class="token function">watch</span>
- apiGroups:
  - <span class="token string">&quot;&quot;</span>
  resources:
  - nodes
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="token string">&quot;true&quot;</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
    addonmanager.kubernetes.io/mode: EnsureExists
  name: system:coredns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:coredns
subjects:
- kind: ServiceAccount
  name: coredns
  namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
  labels:
      addonmanager.kubernetes.io/mode: EnsureExists
data:
  Corefile: <span class="token operator">|</span>
    .:53 <span class="token punctuation">{</span>
        log
        errors
        health <span class="token punctuation">{</span>
            lameduck 5s
        <span class="token punctuation">}</span>
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa <span class="token punctuation">{</span>
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl <span class="token number">30</span>
        <span class="token punctuation">}</span>
        prometheus :9153
        forward <span class="token builtin class-name">.</span> /etc/resolv.conf
        cache <span class="token number">30</span>
        loop
        reload
        loadbalance
    <span class="token punctuation">}</span>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: <span class="token string">&quot;true&quot;</span>
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: <span class="token string">&quot;CoreDNS&quot;</span>
spec:
  <span class="token comment"># replicas: not specified here:</span>
  <span class="token comment"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span>
  <span class="token comment"># 2. Default is 1.</span>
  <span class="token comment"># 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span>
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: <span class="token number">1</span>
  selector:
    matchLabels:
      k8s-app: kube-dns
  template:
    metadata:
      labels:
        k8s-app: kube-dns
      annotations:
        seccomp.security.alpha.kubernetes.io/pod: <span class="token string">'runtime/default'</span>
    spec:
      priorityClassName: system-cluster-critical
      serviceAccountName: coredns
      tolerations:
        - key: <span class="token string">&quot;CriticalAddonsOnly&quot;</span>
          operator: <span class="token string">&quot;Exists&quot;</span>
      nodeSelector:
        kubernetes.io/os: linux
      containers:
      - name: coredns
        image: coredns:1.6.7
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 512Mi 
          requests:
            cpu: 100m
            memory: 70Mi
        args: <span class="token punctuation">[</span> <span class="token string">&quot;-conf&quot;</span>, <span class="token string">&quot;/etc/coredns/Corefile&quot;</span> <span class="token punctuation">]</span>
        volumeMounts:
        - name: config-volume
          mountPath: /etc/coredns
          readOnly: <span class="token boolean">true</span>
        ports:
        - containerPort: <span class="token number">53</span>
          name: dns
          protocol: UDP
        - containerPort: <span class="token number">53</span>
          name: dns-tcp
          protocol: TCP
        - containerPort: <span class="token number">9153</span>
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: <span class="token number">8080</span>
            scheme: HTTP
          initialDelaySeconds: <span class="token number">60</span>
          timeoutSeconds: <span class="token number">5</span>
          successThreshold: <span class="token number">1</span>
          failureThreshold: <span class="token number">5</span>
        readinessProbe:
          httpGet:
            path: /ready
            port: <span class="token number">8181</span>
            scheme: HTTP
        securityContext:
          allowPrivilegeEscalation: <span class="token boolean">false</span>
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - all
          readOnlyRootFilesystem: <span class="token boolean">true</span>
      dnsPolicy: Default
      volumes:
        - name: config-volume
          configMap:
            name: coredns
            items:
            - key: Corefile
              path: Corefile
---
apiVersion: v1
kind: Service
metadata:
  name: kube-dns
  namespace: kube-system
  annotations:
    prometheus.io/port: <span class="token string">&quot;9153&quot;</span>
    prometheus.io/scrape: <span class="token string">&quot;true&quot;</span>
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: <span class="token string">&quot;true&quot;</span>
    addonmanager.kubernetes.io/mode: Reconcile
    kubernetes.io/name: <span class="token string">&quot;CoreDNS&quot;</span>
spec:
  selector:
    k8s-app: kube-dns
  clusterIP: <span class="token number">10.0</span>.0.2 
  ports:
  - name: dns
    port: <span class="token number">53</span>
    protocol: UDP
  - name: dns-tcp
    port: <span class="token number">53</span>
    protocol: TCP
  - name: metrics
    port: <span class="token number">9153</span>
    protocol: TCP

<span class="token number">2</span>.éƒ¨ç½²coredns
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f coredns.yaml 
serviceaccount/coredns created
clusterrole.rbac.authorization.k8s.io/system:coredns created
clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
configmap/coredns created
deployment.apps/coredns created
service/kube-dns created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br></div></div><h3 id="_9-2-è¿è¡Œä¸€ä¸ªbusyboxå®¹å™¨æµ‹è¯•dns"><a href="#_9-2-è¿è¡Œä¸€ä¸ªbusyboxå®¹å™¨æµ‹è¯•dns" class="header-anchor">#</a> 9.2.è¿è¡Œä¸€ä¸ªbusyboxå®¹å™¨æµ‹è¯•dns</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl run -it --rm dns-test --image<span class="token operator">=</span>busybox:1.28.4 <span class="token function">sh</span>
If you don't see a <span class="token builtin class-name">command</span> prompt, try pressing enter.
/ <span class="token comment"># nslookup kubernetes</span>
Server:    <span class="token number">10.0</span>.0.2
Address <span class="token number">1</span>: <span class="token number">10.0</span>.0.2 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address <span class="token number">1</span>: <span class="token number">10.0</span>.0.1 kubernetes.default.svc.cluster.local

/ <span class="token comment"># nslookup kube-dns.kube-system</span>
Server:    <span class="token number">10.0</span>.0.2
Address <span class="token number">1</span>: <span class="token number">10.0</span>.0.2 kube-dns.kube-system.svc.cluster.local

Name:      kube-dns.kube-system
Address <span class="token number">1</span>: <span class="token number">10.0</span>.0.2 kube-dns.kube-system.svc.cluster.local
/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_10-æ‰©å®¹masterèŠ‚ç‚¹ç»„å»ºkubernetesé«˜å¯ç”¨é›†ç¾¤"><a href="#_10-æ‰©å®¹masterèŠ‚ç‚¹ç»„å»ºkubernetesé«˜å¯ç”¨é›†ç¾¤" class="header-anchor">#</a> 10.æ‰©å®¹masterèŠ‚ç‚¹ç»„å»ºkubernetesé«˜å¯ç”¨é›†ç¾¤</h2> <h3 id="_10-1-kubernetesé«˜å¯ç”¨æ¶æ„æ¦‚å¿µ"><a href="#_10-1-kubernetesé«˜å¯ç”¨æ¶æ„æ¦‚å¿µ" class="header-anchor">#</a> 10.1.kubernetesé«˜å¯ç”¨æ¶æ„æ¦‚å¿µ</h3> <p>kubernetesé›†ç¾¤é€šè¿‡å¥åº·æ£€æŸ¥å’Œé‡å¯ç­–ç•¥å®ç°äº†Podæ•…éšœè‡ªæ„ˆèƒ½åŠ›ï¼Œä¹Ÿé€šè¿‡è°ƒåº¦ç®—æ³•å®ç°å°†Podåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¹¶å¯ä»¥é€šè¿‡è®¾ç½®Podçš„å‰¯æœ¬æ•°ï¼Œå®ç°é«˜å¹¶å‘èƒ½åŠ›ï¼Œå³ä½¿NodeèŠ‚ç‚¹å‡ºç°æ•…éšœï¼ŒMasterèŠ‚ç‚¹ä¹Ÿä¼šå°†æ•…éšœçš„NodeèŠ‚ç‚¹ä¸Šçš„Podè¿ç§»åˆ°æ­£å¸¸å·¥ä½œçš„NodeèŠ‚ç‚¹ä¸Šï¼Œå®ç°åº”ç”¨å±‚çš„é«˜å¯ç”¨æ€§</p> <p>é’ˆå¯¹Kubernetesé›†ç¾¤ï¼Œé«˜å¯ç”¨æ€§åŒ…æ‹¬Etcdæ•°æ®åº“é«˜å¯ç”¨ã€MatserèŠ‚ç‚¹ç»„ä»¶çš„é«˜å¯ç”¨ï¼ŒEtcdå¯ä»¥é€šè¿‡é›†ç¾¤æ–¹å¼å®ç°é«˜å¯ç”¨ï¼Œè€Œåªæœ‰å•å°MasterèŠ‚ç‚¹ï¼Œä¸€æ—¦MasterèŠ‚ç‚¹ä¸Šçš„ç»„ä»¶å‡ºç°äº†æ•…éšœï¼Œæ•´ä¸ªé›†ç¾¤å°†ä¼šä¸å¯ç”¨ã€‚</p> <p>MasterèŠ‚ç‚¹æ˜¯å±äºæ§åˆ¶æ•´ä¸ªé›†ç¾¤çš„è§’è‰²ï¼Œæ‰€æœ‰çš„ç»„ä»¶éƒ½éœ€è¦ä¸MasterèŠ‚ç‚¹çš„ApiServerè¿›è¡Œäº¤äº’ï¼Œä¸æ–­ä¸NodeèŠ‚ç‚¹ä¸Šçš„Kubeletå’ŒKube-Proxyè¿›è¡Œé€šä¿¡æ¥ç»´æŠ¤æ•´ä¸ªé›†ç¾¤çš„å·¥ä½œçŠ¶æ€ï¼Œå¦‚æœApiServerå‘ç”Ÿæ•…éšœï¼Œå°†æ— æ³•ä¸NodeèŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼Œä¹Ÿå°±æ— æ³•ç®¡ç†é›†ç¾¤ã€‚</p> <p>å› æ­¤Kubernetesé›†ç¾¤æœ€ä¸»è¦çš„å°±æ˜¯å¯¹MasterèŠ‚ç‚¹è¿›è¡Œé«˜å¯ç”¨é…ç½®ã€‚</p> <p>MasterèŠ‚ç‚¹ä¸»è¦æœ‰ä¸‰ä¸ªæœåŠ¡ï¼škube-apiserverã€kube-controller-manageã€kube-schedulerï¼Œå½“é›†ç¾¤æœ‰å¤šå°MasterèŠ‚ç‚¹æ—¶ï¼Œå…¶ä¸­kube-controller-manageå’Œkube-scheduleréƒ½å¯ä»¥é€šè¿‡è‡ªèº«çš„é€‰ä¸¾æœºåˆ¶å®ç°é«˜å¯ç”¨ï¼Œä½†æ˜¯kube-apiserverå°±æ²¡æœ‰è¿™ç§æœºåˆ¶ï¼Œå› æ­¤ä¸»è¦é’ˆå¯¹kube-apiserveré…ç½®é«˜å¯ç”¨å³å¯ï¼Œkube-apiserveræä¾›çš„æ˜¯HTTP APIæ¥å£æœåŠ¡ï¼Œå› æ­¤å¯ä»¥åƒwebæœåŠ¡é‚£ç§ï¼Œä½¿ç”¨nginx+keepalivedæ–¹å¼å®ç°MasterèŠ‚ç‚¹é«˜å¯ç”¨ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥æ°´å¹³æ‰©å®¹ã€‚</p> <p>é…ç½®kubernetesé›†ç¾¤é«˜å¯ç”¨çš„ä¸»è¦æ­¥éª¤å°±æ˜¯ï¼š</p> <p>1ã€å¢åŠ ä¸€å°æˆ–å¤šå°MasterèŠ‚ç‚¹ï¼Œéƒ¨ç½²MasterèŠ‚ç‚¹ç›¸å…³ç»„ä»¶ï¼Œåœ¨è¿™ä¸ªmasterèŠ‚ç‚¹ä¸Šé…ç½®çš„ç›‘å¬åœ°å€è¿˜æ˜¯è‡ªèº«çš„åœ°å€ï¼›</p> <p>2ã€åœ¨æ–°å¢çš„MasterèŠ‚ç‚¹ä¸Šéƒ¨ç½²etcdï¼Œä½¿etcdåŠ å…¥ç°æœ‰çš„etcdé›†ç¾¤ï¼Œä½¿etcdçš„æ€§èƒ½æ›´å¼ºï¼›</p> <p>3ã€é…ç½®nginx+keepalivedå®ç°Apiserverç»„ä»¶é«˜å¯ç”¨ï¼›</p> <p>4ã€é…ç½®æ‰€æœ‰çš„NodeèŠ‚ç‚¹ï¼Œå°†æ‰€é…ç½®çš„Apiserveråœ°å€æ”¹æˆkeepalivedè™šæ‹Ÿå‡ºæ¥çš„VIPåœ°å€ï¼Œå®ç°é›†ç¾¤é«˜å¯ç”¨ï¼›</p> <p>é«˜å¯ç”¨kubernetesé›†ç¾¤ä¸€èˆ¬3å°masterèŠ‚ç‚¹è¶³çŸ£ï¼Œä½†æ˜¯etcdæ•°æ®åº“ä¸€å®šè¦å¤šå¤šç›Šå–„</p> <h3 id="_10-2-åœ¨é›†ç¾¤ä¸­æ–°å¢ä¸€ä¸ªetcdèŠ‚ç‚¹"><a href="#_10-2-åœ¨é›†ç¾¤ä¸­æ–°å¢ä¸€ä¸ªetcdèŠ‚ç‚¹" class="header-anchor">#</a> 10.2.åœ¨é›†ç¾¤ä¸­æ–°å¢ä¸€ä¸ªetcdèŠ‚ç‚¹</h3> <p>æ‰©å®¹etcdæ­¥éª¤ï¼š</p> <p>1ã€éƒ¨ç½²ä¸€å°å•èŠ‚ç‚¹çš„etcdï¼Œèƒ½å¤Ÿæ­£å¸¸å¯åŠ¨æœåŠ¡</p> <p>2ã€åœ¨ç°æœ‰etcdé›†ç¾¤ä¸­å¢åŠ æ–°çš„etcdèŠ‚ç‚¹</p> <p>3ã€å°†å•ç‚¹çš„etcdé…ç½®æˆé›†ç¾¤æ¨¡å¼</p> <p>4ã€åˆ é™¤å•ç‚¹é€ æˆçš„æ•°æ®æ–‡ä»¶</p> <p>5ã€æ‰€æœ‰èŠ‚ç‚¹ä¿®æ”¹é…ç½®æ–‡ä»¶å¢åŠ æ–°çš„etcdèŠ‚ç‚¹ä¿¡æ¯</p> <p>6ã€é‡å¯æ‰€æœ‰etcdèŠ‚ç‚¹</p> <h4 id="_10-2-1-é¦–å…ˆæ–°å¢åŠ ä¸€å°å•ç‚¹çš„etcd"><a href="#_10-2-1-é¦–å…ˆæ–°å¢åŠ ä¸€å°å•ç‚¹çš„etcd" class="header-anchor">#</a> 10.2.1.é¦–å…ˆæ–°å¢åŠ ä¸€å°å•ç‚¹çš„etcd</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å®‰è£…etcdç¨‹åº
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf etcd-v3.4.9-linux-amd64.tar.gz 
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> /data/etcd/<span class="token punctuation">{</span>bin,conf,ssl,data<span class="token punctuation">}</span> -p
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mv</span> etcd-v3.4.9-linux-amd64/etcd* /data/etcd/bin/

<span class="token number">2</span>.åˆ›å»ºå•ç‚¹é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Service]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-4&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[cluster]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-4=https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token number">4</span>.æ‹·è´è¯ä¹¦æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> root@192.168.20.10:/data/etcd/ssl/* /data/etcd/ssl/

<span class="token number">5</span>.æ‹·è´systemctlç®¡ç†è„šæœ¬
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> root@192.168.20.10:/usr/lib/systemd/system/etcd.service /usr/lib/systemd/system/

<span class="token number">6</span>.å¯åŠ¨etcdæœåŠ¡
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span>#  systemctl start etcd

<span class="token number">7</span>.æŸ¥çœ‹ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> etcd
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.11:2379      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">15753</span>/etcd          
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:2379          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">15753</span>/etcd          
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.20.11:2380      <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">15753</span>/etcd 

<span class="token number">8</span>.æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># /data/etcd/bin/etcdctl endpoint health --write-out<span class="token operator">=</span>table
+----------------+--------+------------+-------+
<span class="token operator">|</span>    ENDPOINT    <span class="token operator">|</span> HEALTH <span class="token operator">|</span>    TOOK    <span class="token operator">|</span> ERROR <span class="token operator">|</span>
+----------------+--------+------------+-------+
<span class="token operator">|</span> <span class="token number">127.0</span>.0.1:2379 <span class="token operator">|</span>   <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token number">7</span>.146222ms <span class="token operator">|</span>       <span class="token operator">|</span>
+----------------+--------+------------+-------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h4 id="_10-2-2-åœ¨ç°æœ‰etcdé›†ç¾¤ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå¢åŠ æ–°etcdèŠ‚ç‚¹"><a href="#_10-2-2-åœ¨ç°æœ‰etcdé›†ç¾¤ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå¢åŠ æ–°etcdèŠ‚ç‚¹" class="header-anchor">#</a> 10.2.2.åœ¨ç°æœ‰etcdé›†ç¾¤ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå¢åŠ æ–°etcdèŠ‚ç‚¹</h4> <blockquote><p>å¢åŠ èŠ‚ç‚¹çš„å‘½ä»¤ä¸ºï¼š<code>/data/etcd/bin/etcdctl member add èŠ‚ç‚¹åç§° --peer-urls=&quot;é€šä¿¡åœ°å€&quot;</code></p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å¢åŠ etcd-4èŠ‚ç‚¹
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># /data/etcd/bin/etcdctl member <span class="token function">add</span> etcd-4 --peer-urls<span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
Member aae107adddd0d3d8 added to cluster 20b119eb5f91aa4b

<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-4&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;existing&quot;</span>
<span class="token comment">#è¾“å‡ºçš„é…ç½®ä¿¡æ¯ä¸€å®šè¦åœ¨æ–°çš„etcd-4èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶å†™å…¥ï¼Œå¦åˆ™ä¼šåŠ å…¥é›†ç¾¤å¤±è´¥</span>

<span class="token number">2</span>.æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># /data/etcd/bin/etcdctl member list --write-out<span class="token operator">=</span>table
+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span>  STATUS   <span class="token operator">|</span>  NAME  <span class="token operator">|</span>         PEER ADDRS         <span class="token operator">|</span>                   CLIENT ADDRS                   <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span>
+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token operator">|</span> 12446003b2a53d43 <span class="token operator">|</span>   started <span class="token operator">|</span> etcd-2 <span class="token operator">|</span> https://192.168.20.12:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.12:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 51ae3f86f3783687 <span class="token operator">|</span>   started <span class="token operator">|</span> etcd-1 <span class="token operator">|</span> https://192.168.20.10:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.10:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 667c9c7ba890c3f7 <span class="token operator">|</span>   started <span class="token operator">|</span> etcd-3 <span class="token operator">|</span> https://192.168.20.13:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.13:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> aae107adddd0d3d8 <span class="token operator">|</span> unstarted <span class="token operator">|</span>        <span class="token operator">|</span> https://192.168.20.11:2380 <span class="token operator">|</span>                                                  <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
+------------------+-----------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token comment">#å‘ç°åˆšåˆšæ–°åŠ å…¥çš„etcd-4èŠ‚ç‚¹å¤„äºunstartedçŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦å†é…ç½®etcd-4èŠ‚ç‚¹ä½¿ç”¨èƒ½å¤ŸåŠ å…¥é›†ç¾¤</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_10-2-3-é…ç½®æ–°å¢çš„etcdèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#_10-2-3-é…ç½®æ–°å¢çš„etcdèŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="header-anchor">#</a> 10.2.3.é…ç½®æ–°å¢çš„etcdèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h4> <p>åœ¨å·²æœ‰é›†ç¾¤å¢åŠ å®Œæ–°èŠ‚ç‚¹ä¹‹åï¼Œè¿˜éœ€è¦å°†æ–°çš„etcdèŠ‚ç‚¹é…ç½®æ–‡ä»¶å¢åŠ é›†ç¾¤ç›¸å…³å±æ€§ï¼Œç„¶ååˆ é™¤ç”±å•ç‚¹æ—¶é€ æˆçš„etcdæ•°æ®æ–‡ä»¶ï¼Œæœ€ååœ¨æ‰€æœ‰èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ä¸­å¢åŠ æ–°èŠ‚ç‚¹çš„é€šä¿¡åœ°å€ï¼Œé‡å¯æ‰€æœ‰èŠ‚ç‚¹çš„etcdæœåŠ¡ï¼Œåˆ°æ­¤æ‰©å®¹æˆåŠŸã€‚</p> <p>ä¸»è¦åœ¨æ–°çš„etcdèŠ‚ç‚¹ä¸­é…ç½®ETCD_NAMEã€ETCD_INITIAL_CLUSTERã€ETCD_INITIAL_CLUSTER_TOKENã€ETCD_INITIAL_CLUSTER_STATEè¿™ä¸‰ä¸ªå‚æ•°ã€‚</p> <p>ETCD_NAMEï¼šé›†ç¾¤èŠ‚ç‚¹åç§°</p> <p>ETCD_INITIAL_CLUSTERï¼šç”±å•ç‚¹çš„ä¸€ä¸ªèŠ‚ç‚¹ä¿¡æ¯æ”¹æˆé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯</p> <p>ETCD_INITIAL_CLUSTER_TOKENï¼šå¡«å†™é›†ç¾¤çš„å”¯ä¸€æ ‡è¯†ï¼Œè¡¨ç¤ºåŠ å…¥å“ªä¸ªetcdé›†ç¾¤</p> <p>ETCD_INITIAL_CLUSTER_STATEï¼šé›†ç¾¤çŠ¶æ€è°ƒæ•´ä¸ºåŠ å…¥å·²å­˜åœ¨çš„é›†ç¾¤</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ä¿®æ”¹etcdé…ç½®æ–‡ä»¶ï¼Œå¢åŠ é›†ç¾¤é…ç½®å‚æ•°
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token comment">#[Service]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd-4&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/data/etcd/data&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span>

<span class="token comment">#[cluster]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.20.11:2379,http://127.0.0.1:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-2=https://192.168.20.12:2380,etcd-1=https://192.168.20.10:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;existing&quot;</span>

<span class="token number">2</span>.åˆ é™¤ç”±å•ç‚¹æ—¶äº§ç”Ÿçš„æ•°æ®æ–‡ä»¶
<span class="token comment">#å¦‚æœä¸åˆ é™¤ï¼ŒåŠ å…¥é›†ç¾¤æ—¶ä¼šå¤±è´¥</span>
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/etcd/data/*

<span class="token number">3</span>.æ‰€æœ‰etcdçš„é…ç½®æ–‡ä»¶ä¸­å¢åŠ æ–°èŠ‚ç‚¹çš„é€šä¿¡åœ°å€
æ³¨æ„ï¼šæ‰€æœ‰etcdèŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶éƒ½è¦å¢åŠ è¿™ä¸€è¡Œé…ç½®
<span class="token function">vim</span> /data/etcd/conf/etcd.conf 
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd-1=https://192.168.20.10:2380,etcd-2=https://192.168.20.12:2380,etcd-3=https://192.168.20.13:2380,etcd-4=https://192.168.20.11:2380&quot;</span>

<span class="token number">4</span>.é‡å¯æ‰€æœ‰èŠ‚ç‚¹çš„ectdæœåŠ¡
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart etcd
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart etcd
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart etcd
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart etcd

<span class="token number">5</span>.å†æ¬¡æŸ¥çœ‹é›†ç¾¤çš„èŠ‚ç‚¹ä¿¡æ¯
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># /data/etcd/bin/etcdctl member list --write-out<span class="token operator">=</span>table
+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token operator">|</span>        ID        <span class="token operator">|</span> STATUS  <span class="token operator">|</span>  NAME  <span class="token operator">|</span>         PEER ADDRS         <span class="token operator">|</span>                   CLIENT ADDRS                   <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span>
+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token operator">|</span> 12446003b2a53d43 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-2 <span class="token operator">|</span> https://192.168.20.12:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.12:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 51ae3f86f3783687 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-1 <span class="token operator">|</span> https://192.168.20.10:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.10:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> 667c9c7ba890c3f7 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-3 <span class="token operator">|</span> https://192.168.20.13:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.13:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
<span class="token operator">|</span> aae107adddd0d3d8 <span class="token operator">|</span> started <span class="token operator">|</span> etcd-4 <span class="token operator">|</span> https://192.168.20.11:2380 <span class="token operator">|</span> http://127.0.0.1:2379,https://192.168.20.11:2379 <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>
+------------------+---------+--------+----------------------------+--------------------------------------------------+------------+
<span class="token comment">#etcdåˆ°æ­¤æ‰©å®¹æˆåŠŸ</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="_10-2-4-é…ç½®kube-apiserverå¢åŠ æ–°çš„etcdèŠ‚ç‚¹"><a href="#_10-2-4-é…ç½®kube-apiserverå¢åŠ æ–°çš„etcdèŠ‚ç‚¹" class="header-anchor">#</a> 10.2.4.é…ç½®kube-apiserverå¢åŠ æ–°çš„etcdèŠ‚ç‚¹</h4> <p>etcdèŠ‚ç‚¹æ–°å¢å®Œï¼Œéœ€è¦é…ç½®ä¸‹kube-apiserverç»„ä»¶ï¼Œå¢åŠ æ–°çš„etcdèŠ‚ç‚¹ä¿¡æ¯ã€‚</p> <p>æ³¨æ„æ‰€æœ‰k8s masterèŠ‚ç‚¹éƒ½å¿…é¡»ä¿®æ”¹é…ç½®kube-apiserver.confæ–‡ä»¶å¢åŠ æ–°çš„etcdèŠ‚ç‚¹ï¼Œå¦åˆ™etcdä¹Ÿä¸ä¼šä¸ºk8sæ‰€ç”¨ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.masterèŠ‚ç‚¹ä¿®æ”¹é…ç½®æ–‡ä»¶å¢åŠ æ–°çš„etcdèŠ‚ç‚¹
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-apiserver.conf 
Â·Â·Â·Â·Â·Â·
--etcd-servers<span class="token operator">=</span>https://192.168.20.10:2379,https://192.168.20.12:2379,https://192.168.20.13:2379,https://192.168.20.11:2379 <span class="token punctuation">\</span>
Â·Â·Â·Â·Â·Â·

<span class="token number">2</span>.é‡å¯apiserverç»„ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart kube-apiserver

<span class="token number">3</span>.æŸ¥çœ‹ç»„ä»¶ä¿¡æ¯
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get cs -o wide
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-3               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_10-3-éƒ¨ç½²master-2èŠ‚ç‚¹"><a href="#_10-3-éƒ¨ç½²master-2èŠ‚ç‚¹" class="header-anchor">#</a> 10.3.éƒ¨ç½²master-2èŠ‚ç‚¹</h3> <p>ç”±äºæ‰€æœ‰ç»„ä»¶éƒ½æ˜¯äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²çš„ï¼Œå› æ­¤å¯ä»¥åœ¨master1ä¸Šå°†ç›®å½•ç›´æ¥æ‹·è´è‡³master2ä¸Šå³å¯ä½¿ç”¨ã€‚</p> <h4 id="_10-3-1-éƒ¨ç½²docker"><a href="#_10-3-1-éƒ¨ç½²docker" class="header-anchor">#</a> 10.3.1.éƒ¨ç½²docker</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å®‰è£…docker
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tar</span> xf docker-19.03.9.tgz 
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">cp</span> docker/* /usr/bin/

<span class="token number">2</span>.æ‹·è´master1èŠ‚ç‚¹ä¸Šçš„dockeré…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp root@binary-k8s-master1:/etc/docker /etc/

<span class="token number">3</span>.æ‹·è´master1èŠ‚ç‚¹ä¸Šçš„docker systemctlè„šæœ¬
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp root@binary-k8s-master1:/usr/lib/systemd/system/docker.service /usr/lib/systemd/system/

<span class="token number">4</span>.å¯åŠ¨docker
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start <span class="token function">docker</span>
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_10-3-2-éƒ¨ç½²kuberneteså„ä¸ªç»„ä»¶"><a href="#_10-3-2-éƒ¨ç½²kuberneteså„ä¸ªç»„ä»¶" class="header-anchor">#</a> 10.3.2.éƒ¨ç½²kuberneteså„ä¸ªç»„ä»¶</h4> <p>ç”±äºæ˜¯äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œç›´æ¥æ‹·è´master1èŠ‚ç‚¹ä¸Šçš„/data/kubernetesç›®å½•å³å¯ï¼Œ/data/kubernetesç›®å½•ä¸‹åŒ…å«äº†æ‰€æœ‰çš„masterä»¥åŠnodeç›¸å…³ç»„ä»¶</p> <p>masterèŠ‚ç‚¹éœ€è¦å®‰è£…æ‰€æœ‰çš„masterç»„ä»¶å’Œnodeç»„ä»¶ã€‚</p> <p><strong>1.å‡†å¤‡äºŒè¿›åˆ¶ç¨‹åº</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.æ‹·è´ç»„ä»¶æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/kubernetes root@binary-k8s-master2:/data
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> /usr/bin/kubectl root@binary-k8s-master2:/usr/bin
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /usr/lib/systemd/system/kube* root@binary-k8s-master2:/usr/lib/systemd/system/
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp .kube root@binary-k8s-master2:/root

<span class="token number">2</span>.å¦‚æœæ²¡æœ‰æ‰©å®¹æ–°çš„etcdèŠ‚ç‚¹çš„æƒ…å†µéœ€è¦æ‹·è´etcdè¯ä¹¦
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">scp</span> -rp /data/etcd/ssl root@binary-k8s-master2:/data/etcd/ss

<span class="token number">3</span>.åˆ é™¤kubeletæ–‡ä»¶
<span class="token comment">#kubeletæŸäº›é—®é¢˜éƒ½æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¸ç›¸åŒï¼Œå› æ­¤éœ€è¦åˆ é™¤é‡æ–°ç”Ÿæˆ</span>
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/kubernetes/config/kubelet.kubeconfig 
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">rm</span> -rf /data/kubernetes/ssl/kubelet-client-*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>2.ä¿®æ”¹å„ä¸ªç»„ä»¶çš„é…ç½®æ–‡ä»¶</strong></p> <p>ä¸»è¦å°±æ˜¯ä¿®æ”¹å„ä¸ªç»„ä»¶ç›‘å¬çš„æœ¬æœºipåœ°å€å’ŒèŠ‚ç‚¹åç§°ï¼Œç”Ÿæˆçš„kubeconfigæ–‡ä»¶ä¸­çš„apiserveråœ°å€æ— éœ€æ›´æ”¹ï¼Œä¿æŒmaster1å³å¯ï¼Œå› ä¸ºæœ€åé«˜å¯ç”¨çš„æ—¶å€™è¿˜æ˜¯ä¼šæ”¹æˆVIPåœ°å€ï¼Œå½“å‰æ— éœ€æ›´æ”¹ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.ä¿®æ”¹kube-apiserveré…ç½®æ–‡ä»¶ä¸­çš„IPåœ°å€
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-apiserver.conf 
Â·Â·Â·Â·Â·Â·
--bind-address<span class="token operator">=</span><span class="token number">192.168</span>.20.11  <span class="token punctuation">\</span>
--advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.20.11 <span class="token punctuation">\</span>
Â·Â·Â·Â·Â·Â·

<span class="token number">2</span>.ä¿®æ”¹kube-controller-manageré…ç½®æ–‡ä»¶ä¸­çš„IPåœ°å€
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-controller-manager.conf 
Â·Â·Â·Â·Â·Â·
--bind-address<span class="token operator">=</span><span class="token number">192.168</span>.20.11 <span class="token punctuation">\</span>
Â·Â·Â·Â·Â·Â·

<span class="token number">3</span>.ä¿®æ”¹kube-scheduleré…ç½®æ–‡ä»¶ä¸­çš„IPåœ°å€
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-scheduler.conf 
Â·Â·Â·Â·Â·Â·
--bind-address<span class="token operator">=</span><span class="token number">192.168</span>.20.11&quot;
Â·Â·Â·Â·Â·Â·

<span class="token number">4</span>.ä¿®æ”¹kubeleté…ç½®æ–‡ä»¶ä¸­çš„IPåœ°å€
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kubelet.conf 
Â·Â·Â·Â·Â·Â·
--hostname-override<span class="token operator">=</span>binary-k8s-master2 <span class="token punctuation">\</span>
Â·Â·Â·Â·Â·Â·

<span class="token number">5</span>.ä¿®æ”¹kube-apiserveré…ç½®æ–‡ä»¶ä¸­çš„IPåœ°å€
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /data/kubernetes/config/kube-proxy-config.yml 
Â·Â·Â·Â·Â·Â·
hostnameOverride: binary-k8s-master2
Â·Â·Â·Â·Â·Â·
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>3.å¯åŠ¨å„ä¸ªç»„ä»¶</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl daemon-reload 
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-apiserver
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-controller-manager
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-scheduler
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kubelet
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start kube-proxy
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-apiserver
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-controller-manager
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-scheduler
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kubelet
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_10-3-3-æˆæƒmaster2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#_10-3-3-æˆæƒmaster2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="header-anchor">#</a> 10.3.3.æˆæƒmaster2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.æŸ¥çœ‹æˆæƒæ–°ç³»åˆ—è¡¨
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get csr
NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION
node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE   4m45s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending

<span class="token number">2</span>.æˆæƒé€šè¿‡
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl certificate approve node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE
certificatesigningrequest.certificates.k8s.io/node-csr-fgCu0hUU4sK9-jaLzl8n-H4MVWi314NhzYssddgThOE approved

<span class="token number">3</span>.æŸ¥çœ‹æ˜¯å¦åŠ å…¥é›†ç¾¤
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4d21h   v1.20.4
binary-k8s-master2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4m33s   v1.20.4
binary-k8s-node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2d3h    v1.20.4
binary-k8s-node2     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   45h     v1.20.4

<span class="token number">4</span>.æŸ¥çœ‹æ ¸å¿ƒç»„ä»¶çŠ¶æ€
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get cs
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_10-4-éƒ¨ç½²nginx-keepalivedå®ç°kubernetesé«˜å¯ç”¨é›†ç¾¤"><a href="#_10-4-éƒ¨ç½²nginx-keepalivedå®ç°kubernetesé«˜å¯ç”¨é›†ç¾¤" class="header-anchor">#</a> 10.4.éƒ¨ç½²Nginx+Keepalivedå®ç°kubernetesé«˜å¯ç”¨é›†ç¾¤</h3> <p>keepalivedæ˜¯ä¸»æµçš„é«˜å¯ç”¨è½¯ä»¶ï¼ŒåŸºäºVIPç»‘å®šå®ç°æœåŠ¡å™¨çš„åŒæœºçƒ­å¤‡ï¼Œå¯ä»¥ç†è§£ä¸ºkeepalivedæ˜¯é’ˆå¯¹æœåŠ¡å™¨IPçš„é«˜å¯ç”¨é›†ç¾¤ï¼Œå¦‚æœAæœºå™¨å®•æœºäº†ï¼ŒBæœºå™¨ä¼šç«‹åˆ»æˆä¸ºmasterè§’è‰²ï¼ŒæŠ¢å VIPåœ°å€ï¼Œä½¿å…¶ä¸é—´æ–­çš„æä¾›æœåŠ¡ï¼Œä»è€Œå½¢æˆé«˜å¯ç”¨é›†ç¾¤ã€‚</p> <p>ä½¿ç”¨nginx+keepalivedåšå¾—k8s masterèŠ‚ç‚¹é«˜å¯ç”¨é›†ç¾¤ï¼Œåªè¦masterèŠ‚ç‚¹ä¸Šé¢æ²¡æœ‰etcdç»„ä»¶ï¼Œé‚£ä¹ˆæ•´ä¸ªé›†ç¾¤masterèŠ‚ç‚¹åªè¦æœ‰ä¸€ä¸ªå·¥ä½œæ­£å¸¸ï¼Œæ•´ä¸ªé›†ç¾¤å°±ä¸ä¼šå®•æœºã€‚</p> <p>ç”Ÿäº§ç¯å¢ƒä¸­nginx+keepalivedæ˜¯ç‹¬ç«‹äºé›†ç¾¤ä¹‹å¤–çš„ä¸¤å°æœåŠ¡å™¨ï¼Œé«˜å¯ç”¨é›†ç¾¤ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ä¸€ä¸»ä¸€å¤‡ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å°±å¯ä»¥æ»¡è¶³æ­£å¸¸éœ€æ±‚ï¼Œæ­£å¥½masterèŠ‚ç‚¹æœ‰2ä¸ªï¼Œå¯ä»¥åœ¨ä¸¤ä¸ªmasterä¸Šéƒ½éƒ¨ç½²nginxå’Œkeepalivedå½¢æˆé«˜å¯ç”¨é›†ç¾¤ã€‚</p> <p>æˆ‘ä»¬é‡‡ç”¨nginxå››å±‚è´Ÿè½½å‡è¡¡ï¼Œå››å±‚è´Ÿè½½å‡è¡¡çš„ä½œç”¨å°±æ˜¯å¯¹IPè¿›è¡Œè´Ÿè½½ï¼Œä¸æ¶‰åŠåº”ç”¨å±‚ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨keepalivedåšé«˜å¯ç”¨é›†ç¾¤ï¼Œkeepalivedå°±æ˜¯é’ˆå¯¹IPåœ°å€å®ç°é«˜å¯ç”¨ï¼Œå› æ­¤éœ€è¦é…åˆnginxå››å±‚è´Ÿè½½å‡è¡¡æ¥å®ç°ï¼Œå½“ç”¨æˆ·è®¿é—®keepalivedçš„VIPæ—¶ï¼Œç›´æ¥å°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„masterè§’è‰²ä¸»æœºä¸Šï¼Œå°†VIPåœ°å€è½¬æ¢æˆmasterèŠ‚ç‚¹IP+ç«¯å£ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå³ä½¿master1æŒ‚æ‰äº†ï¼Œmaster2æˆä¸ºäº†masterè§’è‰²ï¼Œè¯·æ±‚è½¬å‘è¿›æ¥ï¼Œä¹Ÿä¼šå°†VIPè½¬æ¢æˆmaster2èŠ‚ç‚¹çš„åœ°å€ï¼Œé«˜å¯ç”¨ä¹Ÿå°±å®ç°äº†ã€‚</p> <p><strong>kube-apiserveré«˜å¯ç”¨æ¶æ„å›¾</strong></p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/4166bf6696044bc1b4f47efb7cf03acd.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h4 id="_10-4-1-éƒ¨ç½²nginxè´Ÿè½½å‡è¡¡"><a href="#_10-4-1-éƒ¨ç½²nginxè´Ÿè½½å‡è¡¡" class="header-anchor">#</a> 10.4.1.éƒ¨ç½²Nginxè´Ÿè½½å‡è¡¡</h4> <p>master1å’Œmaster2ä¸Šçš„nginxéƒ¨ç½²å’Œé…ç½®æ–‡ä»¶å†…å®¹ä¸€æ ·ï¼Œè¿™é‡Œåªå†™master1çš„æ“ä½œæ­¥éª¤ã€‚</p> <p>nginxè´Ÿè½½å‡è¡¡é‡‡ç”¨å››å±‚è´Ÿè½½ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å®‰è£…nginxå’ŒkeepalivedåŠnginxå››å±‚è´Ÿè½½å‡è¡¡æ¨¡å—ç­‰è½¯ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span>#  yum -y <span class="token function">install</span> nginx keepalived nginx-mod-stream

<span class="token number">2</span>.ä¿®æ”¹nginxä¸»é…ç½®æ–‡ä»¶å¢åŠ includeæ¨¡å—å¼•å…¥4å±‚è´Ÿè½½é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/nginx/nginx.conf
include /etc/nginx/conf.c/*.conf<span class="token punctuation">;</span>			<span class="token comment">#17è¡Œå·¦å³ï¼Œä¸httpæ¨¡å—åŒçº§</span>

<span class="token number">3</span>.ç¼–å†™é…ç½®æ–‡ä»¶
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">mkdir</span> /etc/nginx/conf.c
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/nginx/conf.c/k8s-apiserver.conf 
stream <span class="token punctuation">{</span>
	log_format  main  <span class="token string">'$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent'</span><span class="token punctuation">;</span>

	access_log /var/log/nginx/k8s-apiserver.log main<span class="token punctuation">;</span>
	
	upstream k8s-apiserver <span class="token punctuation">{</span>
		server <span class="token number">192.168</span>.20.11:6443<span class="token punctuation">;</span>
		server <span class="token number">192.168</span>.20.12:6443<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	server <span class="token punctuation">{</span>
		listen <span class="token number">16443</span><span class="token punctuation">;</span>			<span class="token comment">#ç”±äºæˆ‘ä»¬çš„nginxä¸k8s masteråœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œé˜²æ­¢ç«¯å£å†²çªï¼Œå› æ­¤æ”¹ä¸º16443ç«¯å£</span>
		proxy_pass k8s-apiserver<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">4</span>.å¯åŠ¨nginx
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># nginx -t
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># nginx

<span class="token number">5</span>.æŸ¥çœ‹ç«¯å£
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:16443           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">3181</span>/nginx: worker 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="_10-4-2-éƒ¨ç½²keepalivedåŒæœºçƒ­å¤‡"><a href="#_10-4-2-éƒ¨ç½²keepalivedåŒæœºçƒ­å¤‡" class="header-anchor">#</a> 10.4.2.éƒ¨ç½²keepalivedåŒæœºçƒ­å¤‡</h4> <p>åœ¨é…ç½®keepalivedçš„æ—¶å€™ä¹Ÿéœ€è¦é…ç½®ä¸€ä¸ª<strong>vrrp_script</strong>æ¨¡å—ï¼Œkeepalivedåªèƒ½åšåˆ°å¯¹ç½‘ç»œæ•…éšœå’Œkeepalivedæœ¬èº«çš„ç›‘æ§ï¼Œå³å½“å‡ºç°ç½‘ç»œæ•…éšœæˆ–è€…keepalivedæœ¬èº«å‡ºç°é—®é¢˜æ—¶ï¼Œè¿›è¡Œåˆ‡æ¢ã€‚ä½†æ˜¯è¿™äº›è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç›‘æ§keepalivedæ‰€åœ¨æœåŠ¡å™¨ä¸Šçš„å…¶ä»–ä¸šåŠ¡è¿›ç¨‹ï¼Œæ¯”å¦‚è¯´nginxï¼Œkeepalived+nginxå®ç°nginxçš„è´Ÿè½½å‡è¡¡é«˜å¯ç”¨ï¼Œå¦‚æœnginxå¼‚å¸¸ï¼Œä»…ä»…keepalivedä¿æŒæ­£å¸¸ï¼Œæ˜¯æ— æ³•å®Œæˆç³»ç»Ÿçš„æ­£å¸¸å·¥ä½œçš„ï¼Œå› æ­¤éœ€è¦æ ¹æ®ä¸šåŠ¡è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€å†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œä¸»å¤‡åˆ‡æ¢ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–å†™è„šæœ¬å¯¹nginxè¿›ç¨‹è¿›è¡Œæ£€æµ‹ç›‘æ§ã€‚</p> <p><strong>1.MASTERèŠ‚ç‚¹éƒ¨ç½²</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å®‰è£…keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span>#  yum -y <span class="token function">install</span> keepalived

<span class="token number">2</span>.é…ç½®keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/keepalived/keepalived.conf 
global_defs <span class="token punctuation">{</span>
   notification_email <span class="token punctuation">{</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server <span class="token number">127.0</span>.0.1
   smtp_connect_timeout <span class="token number">30</span>
   router_id NGINX_MASTER
<span class="token punctuation">}</span>

vrrp_script check_nginx <span class="token punctuation">{</span>				<span class="token comment">#å®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬</span>
    script <span class="token string">&quot;/etc/keepalived/check_nginx.sh&quot;</span>
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{</span>
    state MASTER					<span class="token comment">#çŠ¶æ€ä¸ºMASTER</span>
    interface ens192				<span class="token comment">#å°†VIPç»‘å®šåœ¨å“ªå—ç½‘å¡ä¸Š</span>
    virtual_router_id <span class="token number">51</span>			<span class="token comment">#å®ä¾‹IDï¼Œé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦ä¿æŒä¸€è‡´</span>
    priority <span class="token number">100</span>					<span class="token comment">#ä¼˜å…ˆçº§ï¼Œ255æœ€é«˜</span>
    advert_int <span class="token number">1</span>					<span class="token comment">#æŒ‡å®šVRRPå¿ƒè·³åŒ…é€šå‘Šé—´éš”æ—¶é—´ï¼Œé»˜è®¤1ç§’</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">192.168</span>.20.9/23					<span class="token comment">#å®šä¹‰VIPåœ°å€</span>
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>	
        check_nginx					
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">3</span>.ç¼–å†™æ£€æŸ¥nginxçŠ¶æ€çš„æ£€æŸ¥è„šæœ¬
<span class="token comment">#å½“nginxå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨å°†å½“å‰ä¸»æœºçš„keepalivedè¿›ç¨‹å…³é—­ï¼Œä½¿BACKUPä¸Šçš„keepalivedæˆä¸ºMASTERç»§ç»­æä¾›æœåŠ¡</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/keepalived/check_nginx.sh 
<span class="token assign-left variable">nginx_ch</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span><span class="token operator">|</span> <span class="token function">egrep</span> -cv <span class="token function">grep</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$nginx_ch</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
	systemctl stop keepalived
	<span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">else</span>
	<span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>

<span class="token number">4</span>.å¯åŠ¨keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> keepalived

<span class="token number">5</span>.æŸ¥çœ‹VIPåœ°å€
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> ens192
<span class="token number">2</span>: ens192: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc mq state UP group default qlen <span class="token number">1000</span>
    inet <span class="token number">192.168</span>.20.10/23 brd <span class="token number">192.168</span>.21.255 scope global noprefixroute ens192
    inet <span class="token number">192.168</span>.20.9/23 scope global secondary ens192
<span class="token comment">#VIPå·²ç»å‡†å¤‡å°±ç»ª</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p><strong>2.BACKUPèŠ‚ç‚¹éƒ¨ç½²</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.å®‰è£…keepalived
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span>#  yum -y <span class="token function">install</span> keepalived

<span class="token number">2</span>.é…ç½®keepalived
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/keepalived/keepalived.conf 
global_defs <span class="token punctuation">{</span>
   notification_email <span class="token punctuation">{</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server <span class="token number">127.0</span>.0.1
   smtp_connect_timeout <span class="token number">30</span>
   router_id NGINX_MASTER
<span class="token punctuation">}</span>

vrrp_script check_nginx <span class="token punctuation">{</span>
    script <span class="token string">&quot;/etc/keepalived/check_nginx.sh&quot;</span>
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{</span>
    state BACKUP				<span class="token comment">#çŠ¶æ€ä¸ºBACKUP</span>
    interface ens192
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">90</span>				<span class="token comment">#ä¼˜å…ˆçº§è¦æ¯”MASTERä½</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        <span class="token number">192.168</span>.20.9/23
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{</span>
        check_nginx
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token number">3</span>.ç¼–å†™æ£€æŸ¥nginxçŠ¶æ€çš„æ£€æŸ¥è„šæœ¬
<span class="token comment">#å½“nginxå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨å°†å½“å‰ä¸»æœºçš„keepalivedè¿›ç¨‹å…³é—­ï¼Œä½¿BACKUPä¸Šçš„keepalivedæˆä¸ºMASTERç»§ç»­æä¾›æœåŠ¡</span>
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> /etc/keepalived/check_nginx.sh 
<span class="token assign-left variable">nginx_ch</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">netstat</span> -lnpt <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span><span class="token operator">|</span> <span class="token function">egrep</span> -cv <span class="token function">grep</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$nginx_ch</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
	systemctl stop keepalived
	<span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">else</span>
	<span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>

<span class="token number">4</span>.å¯åŠ¨keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl start keepalived
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl <span class="token builtin class-name">enable</span> keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h4 id="_10-4-3-ä½¿ç”¨vipè®¿é—®kubernetesæœåŠ¡"><a href="#_10-4-3-ä½¿ç”¨vipè®¿é—®kubernetesæœåŠ¡" class="header-anchor">#</a> 10.4.3.ä½¿ç”¨VIPè®¿é—®kubernetesæœåŠ¡</h4> <p>å¯ä»¥æ­£ç¡®è·å–åˆ°K8sç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯´æ˜è´Ÿè½½å‡è¡¡å™¨æ­å»ºæ­£å¸¸ã€‚è¯¥è¯·æ±‚æ•°æ®æµç¨‹ï¼šcurl -&gt; vip(nginx) -&gt; apiserverã€‚</p> <p>æ—¥å¿—ä¸­ä¹Ÿä¼šè®°å½•è®¿é—®è®°å½•ã€‚</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">curl</span> -k https://192.168.20.9:16443/version
<span class="token punctuation">{</span>
  <span class="token string">&quot;major&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
  <span class="token string">&quot;minor&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;20&quot;</span>,
  <span class="token string">&quot;gitVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1.20.4&quot;</span>,
  <span class="token string">&quot;gitCommit&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;e87da0bd6e03ec3fea7933c4b5263d151aafd07c&quot;</span>,
  <span class="token string">&quot;gitTreeState&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;clean&quot;</span>,
  <span class="token string">&quot;buildDate&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-02-18T16:03:00Z&quot;</span>,
  <span class="token string">&quot;goVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;go1.15.8&quot;</span>,
  <span class="token string">&quot;compiler&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;gc&quot;</span>,
  <span class="token string">&quot;platform&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;linux/amd64&quot;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">tail</span> -f /var/log/nginx/k8s-apiserver.log 
<span class="token number">127.0</span>.0.1 <span class="token number">192.168</span>.20.11:6443 - <span class="token punctuation">[</span>09/Sep/2021:11:28:15 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">79</span>
<span class="token number">127.0</span>.0.1 <span class="token number">192.168</span>.20.11:6443 - <span class="token punctuation">[</span>09/Sep/2021:11:28:20 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">178</span>
<span class="token number">192.168</span>.20.10 <span class="token number">192.168</span>.20.11:6443 - <span class="token punctuation">[</span>09/Sep/2021:15:20:29 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">178</span>
<span class="token number">192.168</span>.20.10 <span class="token number">192.168</span>.20.12:6443, <span class="token number">192.168</span>.20.11:6443 - <span class="token punctuation">[</span>09/Sep/2021:16:19:00 +0800<span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">0</span>, <span class="token number">420</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_10-4-4-æµ‹è¯•keepalivedé«˜å¯ç”¨"><a href="#_10-4-4-æµ‹è¯•keepalivedé«˜å¯ç”¨" class="header-anchor">#</a> 10.4.4.æµ‹è¯•keepalivedé«˜å¯ç”¨</h4> <p><strong>1.åœæ‰master1ä¸Šçš„keepalivedï¼ŒæŸ¥çœ‹VIPæ˜¯å¦ä¼šåˆ‡æ¢åˆ°master2èŠ‚ç‚¹</strong></p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/dba9f62a2a0744c3b3ccc86981ad86a4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <p><strong>2.é‡æ–°å¯åŠ¨master1ä¸Šçš„keepalivedï¼ŒæŸ¥çœ‹VIPæ˜¯å¦ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°master1</strong></p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/54cdc63de7c040519287127263385c0c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h3 id="_10-5-åˆ‡æ¢kubernetesé›†ç¾¤ä¸ºé«˜å¯ç”¨æ¨¡å¼"><a href="#_10-5-åˆ‡æ¢kubernetesé›†ç¾¤ä¸ºé«˜å¯ç”¨æ¨¡å¼" class="header-anchor">#</a> 10.5.åˆ‡æ¢kubernetesé›†ç¾¤ä¸ºé«˜å¯ç”¨æ¨¡å¼</h3> <p>è™½ç„¶æˆ‘ä»¬å¢åŠ äº†Master2 Nodeå’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯ä»å•Masteræ¶æ„æ‰©å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç›®å‰æ‰€æœ‰çš„Worker Nodeç»„ä»¶è¿æ¥éƒ½è¿˜æ˜¯Master1 Nodeï¼Œå¦‚æœä¸æ”¹ä¸ºè¿æ¥VIPèµ°è´Ÿè½½å‡è¡¡å™¨ï¼Œé‚£ä¹ˆMasterè¿˜æ˜¯å•ç‚¹æ•…éšœã€‚</p> <p>ç”±äºå·²ç»å¯ä»¥é€šè¿‡keepalivedçš„VIPåœ°å€è®¿é—®åˆ°apiserverï¼Œé«˜å¯ç”¨æ•ˆæœå·²è¾¾æˆï¼Œç›®å‰åªéœ€è¦å°†é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆkubectl get nodeï¼‰èƒ½çœ‹åˆ°çš„ä¸€åˆ‡èŠ‚ç‚¹ï¼Œå°†é…ç½®æ–‡ä»¶ä¸­çš„apiserverçš„åœ°å€æ¢æˆVIPåœ°å€åŠ ç«¯å£ï¼Œæ‰èƒ½çœŸæ­£çš„å®ç°kubernetesé«˜å¯ç”¨ã€‚</p> <p>ä¹‹å‰å‰æœŸä½¿ç”¨VIPæµ‹è¯•kube-apiserveræ²¡é—®é¢˜ï¼Œå³ä½¿åœ¨åˆ‡æ¢é«˜å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¹Ÿä¸ä¼šå¤„äºNotReadyçŠ¶æ€ã€‚</p> <p><strong>1.åˆ‡æ¢é«˜å¯ç”¨ç¯å¢ƒ</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.binary-k8s-master1èŠ‚ç‚¹åˆ‡æ¢
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /data/kubernetes/config/*
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /root/.kube/config 
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy

<span class="token number">2</span>.binary-k8s-master2åˆ‡æ¢
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /data/kubernetes/config/*
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /root/.kube/config
<span class="token punctuation">[</span>root@binary-k8s-master2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart  kube-controller-manager kube-scheduler kubelet kube-proxy

<span class="token number">3</span>.binary-k8s-node1åˆ‡æ¢
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /data/kubernetes/config/*
<span class="token punctuation">[</span>root@binary-k8s-node1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart kubelet kube-proxy

<span class="token number">4</span>.binary-k8s-node2åˆ‡æ¢
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">sed</span> -ri <span class="token string">'s#192.168.20.10:6443#192.168.20.9:16443#'</span> /data/kubernetes/config/*
<span class="token punctuation">[</span>root@binary-k8s-node2 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># systemctl restart kubelet kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>2.æŸ¥çœ‹é›†ç¾¤çŠ¶æ€åŠèµ„æº</strong></p> <p>åˆ°æ­¤ä¸ºæ­¢kubernetesé«˜å¯ç”¨é›†ç¾¤å®ç°å®Œæ¯•</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get <span class="token function">node</span>
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   5d22h   v1.20.4
binary-k8s-master2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   25h     v1.20.4
binary-k8s-node1     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3d5h    v1.20.4
binary-k8s-node2     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   2d23h   v1.20.4

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get cs
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_11-æµ‹è¯•kubernetesé«˜å¯ç”¨é›†ç¾¤"><a href="#_11-æµ‹è¯•kubernetesé«˜å¯ç”¨é›†ç¾¤" class="header-anchor">#</a> 11.æµ‹è¯•kubernetesé«˜å¯ç”¨é›†ç¾¤</h2> <p><strong>1.åœæ‰master1ä¸Šçš„keepalivedéªŒè¯é›†ç¾¤æ˜¯å¦å¯ç”¨</strong></p> <p>çŠ¶æ€ï¼šâ€œokâ€</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/c146811a76994c2eb7ecea1a95bae2ab.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <p><strong>2.åœæ‰master1ä¸Šæ‰€æœ‰k8sç»„ä»¶éªŒè¯é›†ç¾¤æ˜¯å¦å¯ç”¨</strong></p> <p>çŠ¶æ€ï¼šâ€œokâ€</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/a5cfe03d354441798591ae5add26898e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h2 id="_12-åœ¨kubernetesé›†ç¾¤è¿è¡Œä¸€å¥—æœåŠ¡éªŒè¯é›†ç¾¤çš„å¯ç”¨æ€§"><a href="#_12-åœ¨kubernetesé›†ç¾¤è¿è¡Œä¸€å¥—æœåŠ¡éªŒè¯é›†ç¾¤çš„å¯ç”¨æ€§" class="header-anchor">#</a> 12.åœ¨kubernetesé›†ç¾¤è¿è¡Œä¸€å¥—æœåŠ¡éªŒè¯é›†ç¾¤çš„å¯ç”¨æ€§</h2> <p>ç®€å•éƒ¨ç½²ä¸€ä¸ªåŸºäºnginxçš„webæœåŠ¡ã€‚</p> <h3 id="_12-1-åˆ›å»ºèµ„æºyamlæ–‡ä»¶"><a href="#_12-1-åˆ›å»ºèµ„æºyamlæ–‡ä»¶" class="header-anchor">#</a> 12.1.åˆ›å»ºèµ„æºyamlæ–‡ä»¶</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># <span class="token function">vim</span> know-system.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-know-system
spec:
  replicas: <span class="token number">3</span>
  selector:
    matchLabels:
      app: know-system-pod
  template:
    metadata:
      labels:
        app: know-system-pod
    spec:
      containers:
      - name: know-system
        image: know-system:v1
        ports:
        - containerPort: <span class="token number">80</span>
      nodeName: binary-k8s-master1

---
apiVersion: v1
kind: Service
metadata:
  name: know-system-service
spec:
  selector:
    app: know-system-pod
  type: NodePort
  ports:
  - port: <span class="token number">80</span>
    targetPort: <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_12-2-åˆ›å»ºèµ„æºå¹¶è¿›è¡Œæµ‹è¯•"><a href="#_12-2-åˆ›å»ºèµ„æºå¹¶è¿›è¡Œæµ‹è¯•" class="header-anchor">#</a> 12.2.åˆ›å»ºèµ„æºå¹¶è¿›è¡Œæµ‹è¯•</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f know-system.yaml 
deployment.apps/deploy-know-system created
service/know-system-service created

<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get pod,svc
NAME                                     READY   STATUS    RESTARTS   AGE
pod/deploy-know-system-b4c9c55d7-5mf2f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s
pod/deploy-know-system-b4c9c55d7-97ckx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          48s
pod/deploy-know-system-b4c9c55d7-kb97t   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s

NAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/know-system-service   NodePort    <span class="token number">10.0</span>.0.38    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:32702/TCP   47s
service/kubernetes            ClusterIP   <span class="token number">10.0</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        10d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>è®¿é—®https://é›†ç¾¤ä»»æ„èŠ‚ç‚¹+32702ç«¯å£å³å¯æµè§ˆwebæœåŠ¡ã€‚</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/8c7dc7f2aad14d74a07b8ab6c35e09a9.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <h2 id="_13-éƒ¨ç½²kubernetes-dashboard"><a href="#_13-éƒ¨ç½²kubernetes-dashboard" class="header-anchor">#</a> 13.éƒ¨ç½²kubernetes dashboard</h2> <h3 id="_13-1-éƒ¨ç½²dashboard"><a href="#_13-1-éƒ¨ç½²dashboard" class="header-anchor">#</a> 13.1.éƒ¨ç½²dashboard</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.éƒ¨ç½²yaml
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl apply -f kubernetes-dashboard.yaml 
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created

<span class="token number">2</span>.åˆ›å»ºæˆæƒè´¦å·
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl create serviceaccount dashboard-admin -n kube-system
serviceaccount/dashboard-admin created
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl create clusterrolebinding dashboard-admin --clusterrole<span class="token operator">=</span>cluster-admin --serviceaccount<span class="token operator">=</span>kube-system:dashboard-admin
clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created

<span class="token number">3</span>.æŸ¥çœ‹ç™»é™†ä½¿ç”¨çš„tokenå­—ç¬¦ä¸²
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl describe secrets -n kube-system <span class="token variable"><span class="token variable">$(</span>kubectl -n kube-system get secret <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/dashboard-admin/{print $1}'</span><span class="token variable">)</span></span>
Name:         dashboard-admin-token-lnm2r
Namespace:    kube-system
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: 73b370c9-b1b4-4418-b02d-fee9b6cf6342

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkgwWGJXQ1duVVI4eFh4Ykw2U25JVk9fa2hDOGZVRTRRMVZyVmdwWXM1Nk0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tbG5tMnIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNzNiMzcwYzktYjFiNC00NDE4LWIwMmQtZmVlOWI2Y2Y2MzQyIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.XWJLZDB7mNk_NNpXVv64LrbKy5f1hB2PS5qER5YFATzl3U9ISX05PCrnCEY-6uVSbPkRGZbTQZTBwiGjOfsyLZljvY3cbmGlH2oW2shUS8LDqli4MKA14JyUX1ubbQ8vq9uSqkQMCQBzZTUGIuZt95jw3-IMv2rfZ9ET8_uVuXIoZXbckY6VHFy8QOB6sy1n9j0j4qcOttyKHVXN8Q5KjsIlb44Y5HtiveKxpw_LA81eTwml_aiVvO9rgMKVdSHIg8CY1Mcp06ezz0kD0jsBLt7xaAujSNZnCiXzmpg51xujbR0k-4BVlwPBBpQLaSWGoHR3X7z5E02onXttbbX6-w
ca.crt:     <span class="token number">1359</span> bytes
namespace:  <span class="token number">11</span> bytes

<span class="token number">4</span>.æŸ¥çœ‹podçš„çŠ¶æ€
<span class="token punctuation">[</span>root@binary-k8s-master1 ~<span class="token punctuation">]</span><span class="token punctuation">\</span># kubectl get pod,svc -n kubernetes-dashboard
NAME                                             READY   STATUS    RESTARTS   AGE
pod/dashboard-metrics-scraper-7445d59dfd-bg9c8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m51s
pod/kubernetes-dashboard-5ddcdf9c99-nkgqw        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m52s

NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
service/dashboard-metrics-scraper   ClusterIP   <span class="token number">10.0</span>.0.83    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8000</span>/TCP        8m52s
service/kubernetes-dashboard        NodePort    <span class="token number">10.0</span>.0.153   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>:30001/TCP   8m53s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h3 id="_13-2-è®¿é—®dashboard"><a href="#_13-2-è®¿é—®dashboard" class="header-anchor">#</a> 13.2.è®¿é—®dashboard</h3> <p>è®¿é—®https://é›†ç¾¤ä»»æ„èŠ‚ç‚¹+30001ç«¯å£ï¼Œç„¶åå¡«å†™åˆšåˆšæŸ¥åˆ°çš„tokenå€¼ï¼Œç‚¹å‡»ç™»é™†ã€‚</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/2c6c6346e8854ffcb85a23d3569c056e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> <p>ä»ªè¡¨ç›˜</p> <p><img src="https://agou-images.oss-cn-qingdao.aliyuncs.com/others/f2dfdb9364bb4b0e875851131d711e34.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p></div> <footer class="page-edit" style="display:none;"><div class="edit-link"><a href="https://github.com/AGou-ops/myDocsv2/edit/master/docs/k8s/Installation/Kubernetes äºŒè¿›åˆ¶å®‰è£….md" target="_blank" rel="noopener noreferrer">åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µï¼</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°: </span> <span class="time">2022/06/01, 14:44:58</span></div></footer> <!----> <!----> <div class="article-list" data-v-2af88190><div class="article-title" data-v-2af88190><a href="/myDocsv2/timeline/" class="iconfont icon-shizhong" data-v-2af88190>æœ€è¿‘æ›´æ–°</a></div> <div class="article-wrapper" data-v-2af88190><dl data-v-2af88190><dd data-v-2af88190>01</dd> <dt data-v-2af88190><a href="/myDocsv2/timeline/2022-03-09.html" data-v-2af88190><div data-v-2af88190>ç”Ÿå‘½çŸ­æš‚ï¼ŒçŠ¹å¦‚éœ²ç æ¶ˆæ•£ï¼Œäººä»¬åœ¨å¥”æ³¢ä¸­å¯»æ±‚ç­”æ¡ˆã€‚</div></a> <span data-v-2af88190>03-09</span></dt></dl><dl data-v-2af88190><dd data-v-2af88190>02</dd> <dt data-v-2af88190><a href="/myDocsv2/timeline/2018-05-06.html" data-v-2af88190><div data-v-2af88190>äººç”Ÿå¤©åœ°ä¹‹é—´ï¼Œè‹¥ç™½é©¹è¿‡éš™ï¼Œå¿½ç„¶è€Œå·²ã€‚</div></a> <span data-v-2af88190>05-06</span></dt></dl></div> <div data-v-2af88190><a href="/myDocsv2/timeline/" class="article-more" data-v-2af88190>æ›´å¤šæ–‡ç«  &gt;</a></div></div></main> <!----> <div class="comments-wrapper" data-v-584a622c><div class="valine-wrapper"><div id="valine"></div></div></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div><!----><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      æ¬¢è¿æ¥åˆ° AGou's Docs-v2
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    çœ‹æ¿å¨˜
  </div></div><div></div><!----><div data-v-3338c3f8><div class="DetailsOpenFlag" style="right:1rem;bottom:9rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;font-size:14px;font-weight:500;display:none;" data-v-3338c3f8>
 å±•å¼€

</div></div></div></div>
    <script src="/myDocsv2/assets/js/app.792c833e.js" defer></script><script src="/myDocsv2/assets/js/5.dd197eb6.js" defer></script><script src="/myDocsv2/assets/js/1.3bd7010a.js" defer></script><script src="/myDocsv2/assets/js/2.0c757b52.js" defer></script><script src="/myDocsv2/assets/js/41.1b06014c.js" defer></script><script src="/myDocsv2/assets/js/17.ce9a229a.js" defer></script>
  </body>
</html>
