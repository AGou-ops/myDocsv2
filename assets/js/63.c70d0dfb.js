(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{698:function(s,a,e){"use strict";e.r(a);var t=e(6),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"十三-用户认证系统"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#十三-用户认证系统"}},[s._v("#")]),s._v(" 十三 用户认证系统")]),s._v(" "),e("p",[s._v("apiserver 是所有请求访问的网关接口，请求过程中，认证用于实现身份识别，授权用于实现权限检查，实际上，我们使用命令行：kubectl apply -f ment.yaml，实际上是转换为 HTTP 协议向 apiserver 发起请求的，而认证是信息由 ~/.kube/config 这个文件提供的，这个文件记录了管理员权限的用户信息。")]),s._v(" "),e("ul",[e("li",[s._v("k8s 的 API 是 RESTfull 风格的，所以资源是由路径标明的，在 k8s 中，资源只能属于两个地方：属于集群 或 属于名称空间。")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("集群级别：namespace、pv\n名称空间：POD、deployment、daemonSet、 service、PCV\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("例如：请求 delfault 名称空间下的 myapp-deploy 控制器，就是下面的写法")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("http://172.16.100.100/apis/apps/v1/namespaces/default/deployments/myapp-deploy\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("上面表示：http://172.16.100.100:6443 集群的 apis 下的 apps 组的 v1 版本的 namespaces 下寻找 default 下的 myapp-deploy 控制器")]),s._v(" "),e("h2",{attrs:{id:"_13-1-用户的类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-1-用户的类型"}},[s._v("#")]),s._v(" 13.1 用户的类型")]),s._v(" "),e("p",[s._v("我们使用 kubectl 连接 k8s 集群进行控制，实际上是使用用户家目录下 .kube/config 这个文件中的用户连接到 apiserver 实现认证的，而有些 POD （如：CoreDNS）也需要获取集群的信息，它们也需要连接到 k8s 集群中，所以 k8s 中用户的类型有两种：")]),s._v(" "),e("ol",[e("li",[s._v("人类使用的用户：useraccount，处于用户家目录 .kube/config 文件中，可使用 kubectl config --help 获取帮助创建")]),s._v(" "),e("li",[s._v("POD 使用的用户：serviceaccunt，是一种 k8s 对象，它可以使用 kubectl create serviceaccount --help 获取帮助创建")])]),s._v(" "),e("h2",{attrs:{id:"_13-2-pod如何连接集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-2-pod如何连接集群"}},[s._v("#")]),s._v(" 13.2 POD如何连接集群")]),s._v(" "),e("p",[s._v("POD 需要使用 serviceaccount 连接并认证到集群，POD 之所以能够连接到集群是因为有一个内置的 service 将 POD 的请求代理至 apiserver 的地址了。")]),s._v(" "),e("ul",[e("li",[s._v("名字为 kubernetes 的 servie 为 POD 连接到 apiserver 提供了通信")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ kubectl describe "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" kubernetes                            "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群内部的 POD 与 apiserver 通信使用的 service ，但是注意 apiserver 需要认证的")]),s._v("\n\nName:              kubernetes\nNamespace:         default\nLabels:            "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("component")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("apiserver\n                   "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("provider")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes\nAnnotations:       "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nSelector:          "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nType:              ClusterIP\nIP:                "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.1                                     "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群内部访问 apiserver 的网关")]),s._v("\nPort:              https  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP\nTargetPort:        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v("/TCP\nEndpoints:         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".100.101:6443                           "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apiserver 工作的地址")]),s._v("\nSession Affinity:  None\nEvents:            "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h2",{attrs:{id:"_13-3-serviceaccount-对象"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-3-serviceaccount-对象"}},[s._v("#")]),s._v(" 13.3 serviceaccount 对象")]),s._v(" "),e("p",[s._v("k8s 的认证有两种一种是：human user、一种是 serviceaccount，下面就是创建 serviceaccount 它是 POD 访问 apiserver 所用的一种对象，而 human user，即使 kubectl 命令行通过读取 config 中的用户而认证到 apiserver 的。")]),s._v(" "),e("ul",[e("li",[s._v("创建一个 serviceaccount 对象，它会自动创建并关联一个 secret，这个 serviceaccount 可以到 apiserver 上进行认证，但是认证不代表有权限，所以需要授权")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ kubectl create serviceaccount admin\n$ kubectl get secret\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[s._v("创建 POD 使用指定的 serviceaccount 对象")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("serviceaccount"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("demo\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" myapp\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" frontend\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ikubernetes/myapp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v1\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceAccountName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" admin\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h3",{attrs:{id:"_13-3-1-在-pod-中使用-serviceaccount"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-3-1-在-pod-中使用-serviceaccount"}},[s._v("#")]),s._v(" 13.3.1 在 POD 中使用 serviceaccount")]),s._v(" "),e("ul",[e("li",[s._v("POD 连接 apiserver 时候，需要在清单中指定 serviceAccountName 这个字段，详见：kubectl explain pods.spec")])]),s._v(" "),e("p",[s._v("每个 POD 默认自带一个 volumes，这是一个 secret，这个存储卷保存着 default-token-bq2gn 用来访问 apiserver ，而这个 secret 权限仅仅能通过 api 访问当前 POD 自身的信息，如果想要一个 POD 拥有管理集群的权限，那么可以手动创建一个 secret 并通过 volumes 挂载到 POD 上。")]),s._v(" "),e("p",[s._v("serviceaccout 也属于标准的 k8s 对象，这个对象提供了账号信息，但是账号由没有权限需要 rbac 机制来决定。")]),s._v(" "),e("h2",{attrs:{id:"_13-4-kubectl-配置文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-4-kubectl-配置文件"}},[s._v("#")]),s._v(" 13.4 kubectl 配置文件")]),s._v(" "),e("ul",[e("li",[s._v("kubectl 配置文件解析，详见：kubectl config view")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Config\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                             "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群列表")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                            "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列表中的一个集群对象")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("certificate-authority-data")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DATA+OMITTED          "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器认证方式")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//172.16.100.101"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v("               "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群的 apiserver 地址")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes                                    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群名称")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("users")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                                "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用户列表")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("admin                              "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列表中的一个用户对象")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                               "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("client-certificate-data")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" REDACTED                 "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端证书")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("client-key-data")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" REDACTED                         "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端私钥")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("contexts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                             "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上下文列表")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("context")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                            "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列表中的一个上下文对象")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes                               "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群名称")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("admin                            "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用户名称")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("admin@kubernetes                   "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上下文名称")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("current-context")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("admin@kubernetes          "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前上下文")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("preferences")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("ul",[e("li",[s._v("配置文件保存了：多个集群、多用户的配置，kubectl 可以使用不同的用户访问不同的集群。")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("集群列表：集群对象列表\n用户列表：用户对象列表\n上下文：是描述集群与用户的关系列表。\n当前上下文：表示当前使用哪个用户访问哪个集群\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("自定义配置信息：详见：kubectl config  --help\nca 和证书保存路径：/etc/kubernetes 保存了所有的 ca 和签发的证书信息。\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"_13-5-添加证书用户到-config"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-5-添加证书用户到-config"}},[s._v("#")]),s._v(" 13.5 添加证书用户到 config")]),s._v(" "),e("p",[s._v("k8s apiserver 认证方式有两种：ssl证书 和 token 认证，本次使用 ssl 证书创建用户")]),s._v(" "),e("h3",{attrs:{id:"_13-5-1-创建ssl证书用户"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-5-1-创建ssl证书用户"}},[s._v("#")]),s._v(" 13.5.1 创建SSL证书用户")]),s._v(" "),e("ul",[e("li",[s._v("创建连接 apiserver 的用户证书")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建私钥")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("umask 077"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" openssl genrsa -out kaliarch.key "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成证书签署请求，O 是组，CN 就是账号，这个账号被 k8s 用来识别身份，授权也需要授权这个账号")]),s._v("\nopenssl req -new -key kaliarch.key -out kaliarch.csr -subj "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/CN=kaliarch"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#penssl req -new -key kaliarch.key -out kaliarch.csr -subj "O=system:masters/CN=kaliarch/"')]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用 CA 签署证书，并且在 1800 天内有效")]),s._v("\nopenssl x509 -req -in kaliarch.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out kaliarch.crt -days "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1800")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看证书")]),s._v("\nopenssl x509 -in kaliarch.crt -text -noout\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h3",{attrs:{id:"_13-5-2-添加ssl证书用户到config"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-5-2-添加ssl证书用户到config"}},[s._v("#")]),s._v(" 13.5.2 添加SSL证书用户到config")]),s._v(" "),e("ul",[e("li",[s._v("将 kaliarch 用户添加到 k8s 的 config 中，设置客户端证书为 kaliarch.crt，设置客户端私钥为：kaliarch.key，使用 --embed-certs=true 来隐藏这些机密信息")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config set-credentials kaliarch --client-certificate"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./kaliarch.crt --client-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./kaliarch.key --embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"_13-5-3-创建切换上下文"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-5-3-创建切换上下文"}},[s._v("#")]),s._v(" 13.5.3 创建切换上下文")]),s._v(" "),e("ul",[e("li",[s._v("创建上下文对象，授权 kaliarch 用户访问名称为 kubernetes 的集群")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config set-context kaliarch@kubernetes --cluster"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes --user"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kaliarch\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("切换当前使用的上下文，到授权 kaliarch 到 kubernetes 的上下文上")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config use-context kaliarch@kubernetes\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("由于这个用户没有授权，所以这个用户是无法 get 到信息的，可以再切换回来")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ kubectl get pods\n$ kubectl config use-context kubernetes-admin@kubernetes\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"_13-6-创建新-config-文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-6-创建新-config-文件"}},[s._v("#")]),s._v(" 13.6 创建新 config 文件")]),s._v(" "),e("p",[s._v("使用 kubectl config set-cluster 创建一个新的 config 文件，想要设定这个新创建的 config 文件可以使用 --kubeconfig=/tmp/test.conf 指明。")]),s._v(" "),e("ul",[e("li",[s._v("设置集群的连接的 ca 机构证书，--kubeconfig 可以指定 kubectl 使用的配置文件位置，默认为用户家目录 .kube 目录中的 config")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config set-cluster k8s-cluster --server"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://172.16.100.101:6443 --certificate-authority"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.crt --embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true --kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/test.conf \n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("将 kaliarch 用户添加到 k8s 的 config 中，设置客户端证书为 kaliarch.crt，设置客户端私钥为：kaliarch.key，使用 --embed-certs=true 来隐藏这些机密信息")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config set-credentials kaliarch --client-certificate"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./kaliarch.crt --client-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./kaliarch.key --embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("创建上下文对象，授权 kaliarch 用户访问名称为 kubernetes 的集群")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config set-context def-ns-admin@k8s-cluster --cluster"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("k8s-cluster --user"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("def-ns-admin --kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/test.conf\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("切换当前使用的上下文，到授权 kaliarch 到 kubernetes 的上下文上")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config use-context def-ns-admin@k8s-cluster --kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/test.con\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"_13-7-基于-token-认证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-7-基于-token-认证"}},[s._v("#")]),s._v(" 13.7 基于 token 认证")]),s._v(" "),e("h3",{attrs:{id:"_13-7-1-创建-serviceaccount"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-7-1-创建-serviceaccount"}},[s._v("#")]),s._v(" 13.7.1 创建 serviceaccount")]),s._v(" "),e("ul",[e("li",[s._v("为 POD 创建一个 serviceaccount 对象，它是 POD 访问 apiserver 的凭证")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl create serviceaccount dashborad-admin -n kube-system\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h3",{attrs:{id:"_13-7-2-绑定集群管理员角色"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-7-2-绑定集群管理员角色"}},[s._v("#")]),s._v(" 13.7.2 绑定集群管理员角色")]),s._v(" "),e("ul",[e("li",[s._v("创建 clusterrolebinding 将用户绑定至 cluster-admin 集群管理员（最高权限）")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl create clusterrolebinding dashborad-cluster-admin --clusterrole"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cluster-admin --serviceaccount"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-system:dashborad-admin\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h3",{attrs:{id:"_13-7-3-通过-serviceaccount-得到-token"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_13-7-3-通过-serviceaccount-得到-token"}},[s._v("#")]),s._v(" 13.7.3 通过 serviceaccount 得到 Token")]),s._v(" "),e("ul",[e("li",[s._v("找到刚才创建的 serviceaccount 对象")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get secret -n kube-system\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("得到 serviceaccount 对象中的 Token")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl describe secret -n kube-system dashborad-admin-token-skz95\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);