(window.webpackJsonp=window.webpackJsonp||[]).push([[171],{803:function(s,e,t){"use strict";t.r(e);var a=t(6),n=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"kubectlè¿œç¨‹è¿æ¥k8s"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubectlè¿œç¨‹è¿æ¥k8s"}},[s._v("#")]),s._v(" kubectlè¿œç¨‹è¿æ¥k8s")]),s._v(" "),t("h2",{attrs:{id:"é€šè¿‡å®‰å…¨ä¸Šä¸‹æ–‡è®¿é—®æœ¬åœ°ç½‘ç»œk8s"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#é€šè¿‡å®‰å…¨ä¸Šä¸‹æ–‡è®¿é—®æœ¬åœ°ç½‘ç»œk8s"}},[s._v("#")]),s._v(" é€šè¿‡å®‰å…¨ä¸Šä¸‹æ–‡è®¿é—®æœ¬åœ°ç½‘ç»œk8s")]),s._v(" "),t("h3",{attrs:{id:"åŸºæœ¬æµç¨‹æ“ä½œ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#åŸºæœ¬æµç¨‹æ“ä½œ"}},[s._v("#")]),s._v(" åŸºæœ¬æµç¨‹æ“ä½œ")]),s._v(" "),t("p",[s._v("é¦–å…ˆè¦ç¡®ä¿k8sçš„"),t("code",[s._v("apiServer")]),s._v("å¯ä»¥è¢«å½“å‰ç½‘ç»œè®¿é—®ï¼Œç¡®ä¿ç½‘æ®µåœ¨å…¶ç›‘å¬çš„èŒƒå›´ä¹‹å†…ã€‚ï¼ˆé‡è¦ï¼‰")]),s._v(" "),t("p",[s._v("ç™»å½•åˆ°"),t("code",[s._v("master")]),s._v("ä¸»æœºä¸Šï¼š")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ kubectl cluster-info\nKubernetes control plane is running at https://0.0.0.0:6443 \nCoreDNS is running at https://0.0.0.0:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy \n\nTo further debug and diagnose cluster problems, use "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl cluster-info dump'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("âš ï¸æä¸æ¨èä½¿ç”¨"),t("code",[s._v("0.0.0.0")]),s._v("ï¼Œè¿™é‡Œæˆ‘åªæ˜¯å›¾æ–¹ä¾¿è¿›è¡Œæµ‹è¯•ä½¿ç”¨ã€‚")]),s._v(" "),t("p",[s._v("è·å–å½“å‰é›†ç¾¤çš„é…ç½®æ–‡ä»¶ï¼š")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ~/.kube/config\napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: LS0tLS1CRUdJTiBã€æ­¤å¤„çœç•¥ã€‚ã€‚ã€‚ã€‘"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\n    server: https://0.0.0.0:6443\n  name: kind-my-cluster\ncontexts:\n- context:\n    cluster: kind-my-cluster\n    user: kind-my-cluster\n  name: kind-my-cluster\ncurrent-context: kind-my-cluster\nkind: Config\npreferences: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nusers:\n- name: kind-my-cluster\n  user:\n    client-certificate-data: LS0tLS1ã€æ­¤å¤„çœç•¥ã€‚ã€‚ã€‚ã€‘"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\n    client-key-data: LS0tã€æ­¤å¤„çœç•¥ã€‚ã€‚ã€‚ã€‘"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("é…ç½®æ–‡ä»¶ä¸­çš„"),t("code",[s._v("certificate-authority-dataã€æœåŠ¡å™¨ç«¯CAã€‘")]),s._v("ã€"),t("code",[s._v("client-certificate-dataã€å®¢æˆ·ç«¯è¯ä¹¦ã€‘")]),s._v("å’Œ"),t("code",[s._v("client-key-dataã€å®¢æˆ·ç«¯ç§é’¥ã€‘")]),s._v("éƒ½æ˜¯"),t("code",[s._v("base64")]),s._v("ç®€å•åŠ å¯†è¿‡çš„ï¼Œæ‰€ä»¥åœ¨å¼•å…¥ä¸Šä¸‹æ–‡ä¹‹å‰å…ˆå°†å…¶è§£å¯†ã€‚")]),s._v(" "),t("ul",[t("li",[s._v("ä½¿ç”¨"),t("code",[s._v("base64")]),s._v("å‘½ä»¤è¿›è¡Œè§£å¯†ï¼š"),t("code",[s._v("echo <data> | base64 -d")])]),s._v(" "),t("li",[s._v("ä½¿ç”¨åœ¨çº¿ç½‘ç«™è¿›è¡Œè§£å¯†ï¼šhttps://www.base64decode.org/")])]),s._v(" "),t("p",[s._v("å°†è§£å¯†ä¹‹åçš„æ–‡ä»¶ä¿å­˜åœ¨å½“å‰ä¸»æœºçš„"),t("code",[s._v("~/.kube/")]),s._v("ç›®å½•ä¹‹ä¸‹ï¼Œåˆ†åˆ«å‘½åä¸ºï¼ˆåå­—éšæ„ï¼Œè®°ä½å°±å¥½ï¼‰ï¼š")]),s._v(" "),t("ul",[t("li",[s._v("my-cluster.ca")]),s._v(" "),t("li",[s._v("k8s.crt")]),s._v(" "),t("li",[s._v("k8s.key")])]),s._v(" "),t("blockquote",[t("p",[s._v("å½“å‰ä¸»æœºè¿˜æ²¡æœ‰"),t("code",[s._v("kubectl")]),s._v("ï¼Ÿä¸‰æ¡å‘½ä»¤å¿«é€Ÿå®‰è£…ã€‚")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -LO "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://dl.k8s.io/release/'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -L -s https://dl.k8s.io/release/stable.txt"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('/bin/linux/amd64/kubectl"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -o root -g root -m 0755 kubectl /usr/local/bin/kubectl\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubectl version --client\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("p",[s._v("æ‰“å¼€ç»ˆç«¯ï¼Œç¡®ä¿"),t("code",[s._v("kubectl")]),s._v("å·²æ­£ç¡®å®‰è£…åè¿è¡Œä»¥ä¸‹å‡ æ¡å‘½ä»¤æ¥æ·»åŠ å®‰å…¨ä¸Šä¸‹æ–‡ï¼š")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# æ·»åŠ é›†ç¾¤åœ°å€ï¼Œå¹¶è®¾ç½®é›†ç¾¤ca")]),s._v("\nkubectl config set-cluster my-k8s --server https://10.0.0.18:6443  --certificate-authority"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/agou-ops/.kube/my-cluster.ca\t\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# æ·»åŠ ç”¨æˆ·ï¼Œä»¥åŠè®¾ç½®å®¢æˆ·ç«¯è¯ä¹¦åŠç§é’¥")]),s._v("\nkubectl config set-credentials kubernetes-admin     --client-certificate"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/agou-ops/.kube/k8s.crt     --client-key"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/agou-ops/.kube/k8s.key\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# æŒ‡å®šä¸Šä¸‹æ–‡ï¼Œset-contextåç§°å¯éšä¾¿å–")]),s._v("\nkubectl config set-context ubuntu --cluster"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my-k8s  --namespace"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default --user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes-admin \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# æ¿€æ´»ä¸Šä¸‹æ–‡")]),s._v("\nkubectl config use-context ubuntu \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("ä½¿ç”¨"),t("code",[s._v("kubectl config view")]),s._v("å‘½ä»¤æ£€æŸ¥é…ç½®æ–‡ä»¶ã€‚")]),s._v(" "),t("p",[s._v("æœ€åä½¿ç”¨"),t("code",[s._v("kubectl cluster info")]),s._v("è¿›è¡ŒæŸ¥çœ‹å³å¯ï¼š")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" kubectl --insecure-skip-tls-verify cluster-info\nKubernetes control plane is running at https://10.0.0.18:6443\nCoreDNS is running at https://10.0.0.18:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\n\nTo further debug and diagnose cluster problems, use "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl cluster-info dump'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("Done. ğŸ˜„")]),s._v(" "),t("h3",{attrs:{id:"é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ"}},[s._v("#")]),s._v(" é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("Unable to connect to the server: x509: certificate is valid for 10.96.0.1, 172.18.0.4, 0.0.0.0, not 10.0.0.18")])])]),s._v(" "),t("blockquote",[t("p",[s._v("One option is to tell "),t("code",[s._v("kubectl")]),s._v(" that you don't want the certificate to be validated. Obviously this brings up security issues but I guess you are only testing so here you go:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubectl --insecure-skip-tls-verify --context"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("employee-context get pods\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("æˆ–è€…å°†å…¶å†™å…¥é…ç½®æ–‡ä»¶ï¼š")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubectl config set-cluster my-k8s --insecure-skip-tls-verify"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("The better option is to fix the certificate. Easiest if you reinitialize the cluster by running "),t("code",[s._v("kubeadm reset")]),s._v(" on all nodes including the master and then do")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubeadm init --apiserver-cert-extra-sans"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("114.215")]),s._v(".201.87\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("It's also possible to fix that certificate without wiping everything, but that's a bit more tricky. Execute something like this on the master as root:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" /etc/kubernetes/pki/apiserver.*\nkubeadm init phase certs all --apiserver-advertise-address"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 --apiserver-cert-extra-sans"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.161")]),s._v(".233.80,114.215.201.87\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -q -f "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name=k8s_kube-apiserver*'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\nsystemctl restart kubelet\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("æ¥è‡ªï¼šhttps://stackoverflow.com/a/46360852")])]),s._v(" "),t("h2",{attrs:{id:"è®¿é—®äº‘ç«¯k8s"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#è®¿é—®äº‘ç«¯k8s"}},[s._v("#")]),s._v(" è®¿é—®äº‘ç«¯k8s")]),s._v(" "),t("h2",{attrs:{id:"è®¿é—®äº‘ç«¯k8s-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#è®¿é—®äº‘ç«¯k8s-2"}},[s._v("#")]),s._v(" è®¿é—®äº‘ç«¯k8s")]),s._v(" "),t("p",[s._v("æœªå®Œã€‚")])])}),[],!1,null,null,null);e.default=n.exports}}]);