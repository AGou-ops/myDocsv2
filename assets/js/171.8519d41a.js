(window.webpackJsonp=window.webpackJsonp||[]).push([[171],{803:function(s,e,t){"use strict";t.r(e);var a=t(6),n=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"kubectl远程连接k8s"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubectl远程连接k8s"}},[s._v("#")]),s._v(" kubectl远程连接k8s")]),s._v(" "),t("h2",{attrs:{id:"通过安全上下文访问本地网络k8s"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#通过安全上下文访问本地网络k8s"}},[s._v("#")]),s._v(" 通过安全上下文访问本地网络k8s")]),s._v(" "),t("h3",{attrs:{id:"基本流程操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基本流程操作"}},[s._v("#")]),s._v(" 基本流程操作")]),s._v(" "),t("p",[s._v("首先要确保k8s的"),t("code",[s._v("apiServer")]),s._v("可以被当前网络访问，确保网段在其监听的范围之内。（重要）")]),s._v(" "),t("p",[s._v("登录到"),t("code",[s._v("master")]),s._v("主机上：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ kubectl cluster-info\nKubernetes control plane is running at https://0.0.0.0:6443 \nCoreDNS is running at https://0.0.0.0:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy \n\nTo further debug and diagnose cluster problems, use "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl cluster-info dump'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("⚠️极不推荐使用"),t("code",[s._v("0.0.0.0")]),s._v("，这里我只是图方便进行测试使用。")]),s._v(" "),t("p",[s._v("获取当前集群的配置文件：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ~/.kube/config\napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: LS0tLS1CRUdJTiB【此处省略。。。】"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\n    server: https://0.0.0.0:6443\n  name: kind-my-cluster\ncontexts:\n- context:\n    cluster: kind-my-cluster\n    user: kind-my-cluster\n  name: kind-my-cluster\ncurrent-context: kind-my-cluster\nkind: Config\npreferences: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nusers:\n- name: kind-my-cluster\n  user:\n    client-certificate-data: LS0tLS1【此处省略。。。】"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\n    client-key-data: LS0t【此处省略。。。】"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("配置文件中的"),t("code",[s._v("certificate-authority-data【服务器端CA】")]),s._v("、"),t("code",[s._v("client-certificate-data【客户端证书】")]),s._v("和"),t("code",[s._v("client-key-data【客户端私钥】")]),s._v("都是"),t("code",[s._v("base64")]),s._v("简单加密过的，所以在引入上下文之前先将其解密。")]),s._v(" "),t("ul",[t("li",[s._v("使用"),t("code",[s._v("base64")]),s._v("命令进行解密："),t("code",[s._v("echo <data> | base64 -d")])]),s._v(" "),t("li",[s._v("使用在线网站进行解密：https://www.base64decode.org/")])]),s._v(" "),t("p",[s._v("将解密之后的文件保存在当前主机的"),t("code",[s._v("~/.kube/")]),s._v("目录之下，分别命名为（名字随意，记住就好）：")]),s._v(" "),t("ul",[t("li",[s._v("my-cluster.ca")]),s._v(" "),t("li",[s._v("k8s.crt")]),s._v(" "),t("li",[s._v("k8s.key")])]),s._v(" "),t("blockquote",[t("p",[s._v("当前主机还没有"),t("code",[s._v("kubectl")]),s._v("？三条命令快速安装。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -LO "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://dl.k8s.io/release/'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -L -s https://dl.k8s.io/release/stable.txt"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('/bin/linux/amd64/kubectl"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -o root -g root -m 0755 kubectl /usr/local/bin/kubectl\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubectl version --client\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("p",[s._v("打开终端，确保"),t("code",[s._v("kubectl")]),s._v("已正确安装后运行以下几条命令来添加安全上下文：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加集群地址，并设置集群ca")]),s._v("\nkubectl config set-cluster my-k8s --server https://10.0.0.18:6443  --certificate-authority"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/agou-ops/.kube/my-cluster.ca\t\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加用户，以及设置客户端证书及私钥")]),s._v("\nkubectl config set-credentials kubernetes-admin     --client-certificate"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/agou-ops/.kube/k8s.crt     --client-key"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/agou-ops/.kube/k8s.key\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定上下文，set-context名称可随便取")]),s._v("\nkubectl config set-context ubuntu --cluster"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my-k8s  --namespace"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default --user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes-admin \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 激活上下文")]),s._v("\nkubectl config use-context ubuntu \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("使用"),t("code",[s._v("kubectl config view")]),s._v("命令检查配置文件。")]),s._v(" "),t("p",[s._v("最后使用"),t("code",[s._v("kubectl cluster info")]),s._v("进行查看即可：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" kubectl --insecure-skip-tls-verify cluster-info\nKubernetes control plane is running at https://10.0.0.18:6443\nCoreDNS is running at https://10.0.0.18:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\n\nTo further debug and diagnose cluster problems, use "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl cluster-info dump'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("Done. 😄")]),s._v(" "),t("h3",{attrs:{id:"问题及解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题及解决方案"}},[s._v("#")]),s._v(" 问题及解决方案")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("Unable to connect to the server: x509: certificate is valid for 10.96.0.1, 172.18.0.4, 0.0.0.0, not 10.0.0.18")])])]),s._v(" "),t("blockquote",[t("p",[s._v("One option is to tell "),t("code",[s._v("kubectl")]),s._v(" that you don't want the certificate to be validated. Obviously this brings up security issues but I guess you are only testing so here you go:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubectl --insecure-skip-tls-verify --context"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("employee-context get pods\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("或者将其写入配置文件：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubectl config set-cluster my-k8s --insecure-skip-tls-verify"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("The better option is to fix the certificate. Easiest if you reinitialize the cluster by running "),t("code",[s._v("kubeadm reset")]),s._v(" on all nodes including the master and then do")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubeadm init --apiserver-cert-extra-sans"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("114.215")]),s._v(".201.87\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("It's also possible to fix that certificate without wiping everything, but that's a bit more tricky. Execute something like this on the master as root:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" /etc/kubernetes/pki/apiserver.*\nkubeadm init phase certs all --apiserver-advertise-address"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 --apiserver-cert-extra-sans"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.161")]),s._v(".233.80,114.215.201.87\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -q -f "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name=k8s_kube-apiserver*'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\nsystemctl restart kubelet\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("来自：https://stackoverflow.com/a/46360852")])]),s._v(" "),t("h2",{attrs:{id:"访问云端k8s"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问云端k8s"}},[s._v("#")]),s._v(" 访问云端k8s")]),s._v(" "),t("h2",{attrs:{id:"访问云端k8s-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问云端k8s-2"}},[s._v("#")]),s._v(" 访问云端k8s")]),s._v(" "),t("p",[s._v("未完。")])])}),[],!1,null,null,null);e.default=n.exports}}]);