(window.webpackJsonp=window.webpackJsonp||[]).push([[88],{721:function(a,s,t){"use strict";t.r(s);var e=t(6),n=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"gitlab-备份和数据迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-备份和数据迁移"}},[a._v("#")]),a._v(" GitLab 备份和数据迁移")]),a._v(" "),t("h2",{attrs:{id:"数据备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据备份"}},[a._v("#")]),a._v(" 数据备份")]),a._v(" "),t("h3",{attrs:{id:"主动备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主动备份"}},[a._v("#")]),a._v(" 主动备份")]),a._v(" "),t("p",[a._v("备份时需要保持"),t("code",[a._v("gitlab")]),a._v("处于正常运行状态, 在要备份的主机上执行以下命令:")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("gitlab-rake gitlab:backup:create\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("命令执行完成之后, 默认会在"),t("code",[a._v("/var/opt/gitlab/backups")]),a._v("目录之下, 备份内容包括含："),t("em",[a._v("数据库脚本、代码仓库、wiki、大文件、ssh用户秘钥")]),a._v("等数据。")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("$ ll /var/opt/gitlab/backups\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("43414650880")]),a._v(" Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("27")]),a._v(" 00:10 1543846302_2020_7_23_gitlab_backup.tar\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("p",[a._v("ℹ️修改"),t("code",[a._v("GitLab")]),a._v("备份目录, 编辑"),t("code",[a._v("gitlab")]),a._v("配置文件"),t("code",[a._v("/etc/gitlab/gitlab.rb")]),a._v(", 修改以下配置:")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(".\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'backup_path'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/var/opt/gitlab/backups"')]),a._v(" \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 修改成自定义目录")]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'backup_keep_time'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("604800")]),a._v(" \t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 备份保留时长(7天), 避免因为备份文件爆满存储空间")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(".\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[a._v("最后, 重载配置文件或者重启"),t("code",[a._v("GitLab")]),a._v("即可:")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("gitlab-ctl reconfigure \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 或者 gitlab-ctl  restart")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("h3",{attrs:{id:"自动备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自动备份"}},[a._v("#")]),a._v(" 自动备份")]),a._v(" "),t("p",[a._v("使用"),t("code",[a._v("crontab")]),a._v("来进行自动备份:")]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("crontab")]),a._v(" -e  \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 每天凌晨两点备份")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("CRON")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("  \n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("h2",{attrs:{id:"数据迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据迁移"}},[a._v("#")]),a._v(" 数据迁移")]),a._v(" "),t("ol",[t("li",[a._v("从源主机迁移到目标主机, 首先源主机备份一份"),t("code",[a._v(".tar")]),a._v("数据包, 并拷贝到目标主机的"),t("code",[a._v("/var/opt/gitlab/backups")]),a._v("目录.")])]),a._v(" "),t("p",[a._v("⚠️注意: 确保备份和恢复的"),t("code",[a._v("GitLab")]),a._v("版本相同, 不然可能会出现不可预料的事情.(保险起见)")]),a._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[a._v("赋予"),t("code",[a._v(".tar")]),a._v("包权限, 以免出现因权限不足无法解压缩的问题:")])]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chown")]),a._v(" git.git 1543846302_2020_7_23_gitlab_backup.tar\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("600")]),a._v(" 1543846302_2020_7_23_gitlab_backup.tar\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[a._v("执行恢复前, 停止"),t("code",[a._v("GitLab")]),a._v("与"),t("code",[a._v("数据库")]),a._v("的连接, 保留其他进程:")])]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("gitlab-ctl stop unicorn\ngitlab-ctl stop sidekiq \n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[a._v("执行恢复命令:")])]),a._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# gitlab-rake gitlab:backup:restore BACKUP=备份文件编号")]),a._v("\ngitlab-rake gitlab:backup:restore "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("1543846302_2020_7_23\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("p",[a._v("途中, 输入两次"),t("code",[a._v("yes")]),a._v("即可完成数据迁移.")]),a._v(" "),t("ol",{attrs:{start:"5"}},[t("li",[a._v("最后重启"),t("code",[a._v("GitLab")]),a._v(": "),t("code",[a._v("gitlab-ctl restart")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);