(window.webpackJsonp=window.webpackJsonp||[]).push([[288],{921:function(s,a,e){"use strict";e.r(a);var t=e(6),r=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"varnish-架构、工作原理及简单配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#varnish-架构、工作原理及简单配置"}},[s._v("#")]),s._v(" varnish 架构、工作原理及简单配置")]),s._v(" "),e("p",[s._v("[TOC]")]),s._v(" "),e("h2",{attrs:{id:"缓存http头部相关介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#缓存http头部相关介绍"}},[s._v("#")]),s._v(" 缓存HTTP头部相关介绍")]),s._v(" "),e("p",[s._v("缓存类型：代理式缓存（递归方式）；旁挂式缓存（迭代）")]),s._v(" "),e("p",[s._v("缓存机制：过期机制（Expires）、条件式缓存（通过最近文件修改时间戳或Etag的扩展标签来辨别）。")]),s._v(" "),e("p",[s._v("过期时间：Expires\nHTTP/1.0\nExpires：过期\nHTTP/1.1\nCache-Control: max-age=  （私有缓存，单位秒）\nCache-Control: s-maxage=  （共有缓存）")]),s._v(" "),e("p",[s._v("缓存层级：\n私有缓存：用户代理附带的本地缓存机制；\n公共缓存：反向代理服务器的缓存功能；\n条件式请求：\nLast-Modified/If-Modified-Since：基于文件的修改时间戳来\n判别：Etag/If-None-Match：基于文件的校验码来判别；\nUser-Agent <--\x3e private cache <--\x3e public cache <--\x3e public cache 2 <--\x3e Original Server")]),s._v(" "),e("h2",{attrs:{id:"varnish工作原理及简单配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#varnish工作原理及简单配置"}},[s._v("#")]),s._v(" varnish工作原理及简单配置")]),s._v(" "),e("p",[s._v("Varnish是一款高性能的开源HTTP加速器，具有"),e("strong",[s._v("反向代理")]),s._v("，"),e("strong",[s._v("缓存")]),s._v("的功能。")]),s._v(" "),e("h3",{attrs:{id:"varnish官方架构图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#varnish官方架构图"}},[s._v("#")]),s._v(" varnish官方架构图")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/varnish/architecture.svg",alt:"varnish-arch"}})]),s._v(" "),e("p",[s._v("Varnish主要运行2个进程，"),e("code",[s._v("Management")]),s._v("进程和"),e("code",[s._v("Child")]),s._v("进程")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("Management进程")]),s._v("：主要实现应用新的配置、编译VCL、监控varnish、初始化varnish以及提供一个命令行接口等。Management进程会每隔几秒钟探测一下Child进程以判断其是否正常运行，如果在指定的时长内未得到Child进程的回应，Management将会重启此Child进程。")]),s._v(" "),e("li",[e("code",[s._v("Child进程")]),s._v("：主要是监听客户端请求，管理worker线程，建立缓存，更新统计计数器和记录流量")])]),s._v(" "),e("p",[e("code",[s._v("VCL")]),s._v("（Varnish Configuration Language）是varnish配置缓存策略的工具，拥有它自己独立的一种编程语言。在策略启动前，会由Management进程转换为c代码（利用VCC，将VCL转换成C的编译器），然后通过gcc编译器编译成2进制程序。编译完成后Management负责将其连接到child进程，可以在varnish运行过程中动态切换缓存策略。")]),s._v(" "),e("p",[e("code",[s._v("shared memory log")]),s._v("（共享内存日志）为了与系统的其它部分进行交互，Child进程使用了可以通过文件系统接口进行访问的共享内存日志，因此，如果某线程需要记录信息，其仅需要持有一个锁，而后向共享内存中的某内存区域写入数据，再释放持有的锁即可。而为了减少竞争，每个worker线程都使用了日志数据缓存。\n共享内存日志大小一般为90M，其分为两部分，前一部分为计数器，后半部分为客户端请求的数据。varnish提供了多个不同的工具如varnishlog、varnishncsa或varnishstat等来分析共享内存日志中的信息并能够以指定的方式进行显示。")]),s._v(" "),e("p",[e("code",[s._v("varnishadm")]),s._v("和"),e("code",[s._v("vagent2")]),s._v("是管理Management的一个管理接口")]),s._v(" "),e("h3",{attrs:{id:"varnish工作流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#varnish工作流程"}},[s._v("#")]),s._v(" varnish工作流程")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/varnish/varnish-02.png",alt:"varnish02"}})]),s._v(" "),e("ul",[e("li",[e("code",[s._v("vcl_recv函数")]),s._v("：在Varnish完成对请求报文的解码为基本数据结构后第一个要执行的子例程，它通常有四个主要用途：1.修改客户端数据以减少缓存对象差异性；比如删除URL中的www.等字符；2.基于客户端数据选用缓存策略；比如仅缓存特定的URL请求、不缓存POST请求等；3.为某web应用程序执行URL重写规则； 4.挑选合适的后端Web服务器；")]),s._v(" "),e("li",[e("code",[s._v("vcl_hash函数")]),s._v("：默认VCL将主机名或IP地址以及请求的URL进行hash")]),s._v(" "),e("li",[e("code",[s._v("vcl_hit函数")]),s._v("：在缓存中找到请求的内容后将自动调用该函数")]),s._v(" "),e("li",[e("code",[s._v("vcl_pass函数")]),s._v("：此函数在进入pass模式时被调用，用户将请求直接传递至后端主机。后端主机在应答数据后将应答数据发送给客户端，但不进行任何缓存，在当前链接下每次都返回最新的内容。")]),s._v(" "),e("li",[e("code",[s._v("vcl_miss函数")]),s._v("：在缓存中没有找到请求的内容时自动调用该方法。此函数可用于判断是否需要从后端服务器获取内容")]),s._v(" "),e("li",[e("code",[s._v("vcl_purge函数")]),s._v("：移除缓存")]),s._v(" "),e("li",[e("code",[s._v("vcl_pipe函数")]),s._v("：进入pipe模式时，用户将"),e("strong",[s._v("请求直接传递至后端主机")]),s._v("，在请求和返回的内容没有改变的情况下，将不变的内容返回给客户端，直到这个链接被关闭。")]),s._v(" "),e("li",[e("code",[s._v("vcl_backend_fetch函数")]),s._v("：可能是被vcl_miss或者vcl_pass调用。如果是被vcl_miss函数：调用则所获取的对象会被缓存，如果是被vcl_pass调用则获取的对象不会缓存")]),s._v(" "),e("li",[e("code",[s._v("vcl_deliver函数")]),s._v("：将在缓存中找到请求的内容发送给客户端前调用此函数")]),s._v(" "),e("li",[e("code",[s._v("vcl_synth函数")]),s._v("：创建合成响应，例如个性化定制错误消息，要调用此函数")])]),s._v(" "),e("p",[s._v("actions有以下几种:")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("pass")]),s._v("：当一个请求被 pass 后,这个请求将通过 varnish 转发到后端服务器,\n但是它不会被缓存。pass 可以放在 vcl_recv 和 vcl_fetch 中。")]),s._v(" "),e("li",[e("code",[s._v("lookup")]),s._v("：当一个请求在 vcl_recv 中被 lookup 后,varnish 将从缓存中提取数\n据,如果缓存中没有数据,将被设置为 pass,不能在 vcl_fetch 中设置 lookup。")]),s._v(" "),e("li",[e("code",[s._v("pipe")]),s._v("：pipe 和 pass 相似,都要访问后端服务器,不过当进入 pipe 模式后,在\n此连接未关闭前,后续的所有请求都发到后端服务器")]),s._v(" "),e("li",[e("code",[s._v("deliver")]),s._v("：请求的目标被缓存,然后发送给客户端")])]),s._v(" "),e("p",[s._v("3个重要的数据结构：Requests、Responses 、 objects")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("req")]),s._v("：请求目标,当 varnish 接收到一个请求,这时 req object 就被创建了,\n你在 vcl_recv 中的大部分工作,都是在 req object 上展开的。")]),s._v(" "),e("li",[e("code",[s._v("beresp")]),s._v("：后端服务器返回的目标,它包含返回的头信息,你在 vcl_fetch 中的大部分工作都是在 beresp object 上开展的。")]),s._v(" "),e("li",[e("code",[s._v("obj")]),s._v("：被 cache 的目标,只读的目标被保存于内存中,obj.ttl 的值可修改,其他的只能读。")])]),s._v(" "),e("h2",{attrs:{id:"varnish内建变量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#varnish内建变量"}},[s._v("#")]),s._v(" varnish内建变量")]),s._v(" "),e("ul",[e("li",[s._v("·req.*：request，表示由客户端发来的请求报文相关；")]),s._v(" "),e("li",[e("em",[s._v("·bereq.")]),s._v("：由varnish发往BE主机的httpd请求相关；")]),s._v(" "),e("li",[s._v("·beresp.*：由BE主机响应给varnish的响应报文相关；")]),s._v(" "),e("li",[e("em",[s._v("·resp.")]),s._v("：由varnish响应给client相关；")]),s._v(" "),e("li",[s._v("·obj.*：存储在缓存空间中的缓存对象的属性；只读；")])]),s._v(" "),e("p",[e("strong",[s._v("常用变量：")])]),s._v(" "),e("ul",[e("li",[s._v("·bereq."),e("em",[s._v(", req.")]),s._v("：\nbereq.http.HEADERS\nbereq.request：请求方法；\nbereq.url：请求的url；\nbereq.proto：请求的协议版本；\nbereq.backend：指明要调用的后端主机；\nreq.http.Cookie：客户端的请求报文中Cookie首部的值；\nreq.http.User-Agent ~ “chrome”")]),s._v(" "),e("li",[s._v("·beresp."),e("em",[s._v(", resp.")]),s._v("：\nberesp.http.HEADERS\nberesp.status：响应的状态码；\nreresp.proto：协议版本；\nberesp.backend.name：BE主机的主机名；\nberesp.ttl：BE主机响应的内容的余下的可缓存时长；")]),s._v(" "),e("li",[s._v("·obj.*\nobj.hits：此对象从缓存中命中的次数；\nobj.ttl：对象的ttl值")]),s._v(" "),e("li",[s._v("·server.*\nserver.ip\nserver.hostname")]),s._v(" "),e("li",[s._v("·client.*\nclient.ip")])]),s._v(" "),e("h2",{attrs:{id:"varnish日志-shared-memory-log"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#varnish日志-shared-memory-log"}},[s._v("#")]),s._v(" varnish日志(Shared memory log)")]),s._v(" "),e("p",[s._v("显示详细日志：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("varnishlog")]),s._v(":用于访问特定的数据，它提供了特定客户的信息和要求。\n"),e("ul",[e("li",[e("code",[s._v("varnishlog")]),s._v("可以运行为守护进程,将日志保存到文件当中去")])])]),s._v(" "),e("li",[e("code",[s._v("varnishncsa")]),s._v(":以NCSA通用日志格式显示varnish访问日志。")]),s._v(" "),e("li",[e("code",[s._v("varnishtest")]),s._v(":允许显示测试中的日志记录和计数器。")])]),s._v(" "),e("p",[s._v("统计工具：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("varnishstat")]),s._v(":用于访问全局计数器，不读取varnish日志中的条目。\n"),e("ul",[e("li",[e("code",[s._v("-1")]),s._v(":一次性输出,非持续性输出")]),s._v(" "),e("li",[e("code",[s._v("-f")]),s._v(":指定输出的字段名称列表,如若查看多个字段,需要添加多个"),e("code",[s._v("-f")]),s._v("参数")])])]),s._v(" "),e("li",[e("code",[s._v("varnishtop")]),s._v(":读取Varnish日志并呈现最常出现的日志条目的不断更新的列表。\n"),e("ul",[e("li",[e("code",[s._v("-1")]),s._v(":一次性输出,非持续性输出")]),s._v(" "),e("li",[e("code",[s._v("-i <taglist>")]),s._v(":查看指定字段,如若查看多个字段,需要添加多个"),e("code",[s._v("-i")]),s._v("参数,另,"),e("code",[s._v("-I <[taglist:]regex>")]),s._v("可以使用正则表达式进行匹配筛选")]),s._v(" "),e("li",[e("code",[s._v("-x <taglist>")]),s._v(",用法同"),e("code",[s._v("-i")]),s._v("选项,将某个字段排除在外,"),e("code",[s._v("-X")]),s._v("表示使用正则表达式匹配")])])]),s._v(" "),e("li",[e("code",[s._v("varnishhist")]),s._v(":读取Varnish日志，并显示一个连续更新的直方图，显示最后N个请求的处理分布情况。")])]),s._v(" "),e("h2",{attrs:{id:"varnishadm交互式配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#varnishadm交互式配置"}},[s._v("#")]),s._v(" varnishadm交互式配置")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("登录：\n    -S /etc/varnish/secret -T "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:80\n配置文件相关：\n    vcl.list ：状态引擎列表；\n    vcl.load：装载，加载并编译；\n    vcl.use：激活；\n    vcl.discard：删除；\n    vcl.show "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-v"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("configname"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("：查看指定的配置文件的详细信息，可看默认配置；\n运行时参数：\n    param.show -l：显示列表；\n    param.show "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("PARAM"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    param.set "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("PARAM"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("VALUE"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n缓存存储：\n    storage.list\n后端服务器：\n    backend.list\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("除了使用"),e("code",[s._v("varnishadm")]),s._v("来编译激活vcl外,还可以使用"),e("code",[s._v("varnish_reload_vcl")]),s._v("来一次性完成.")]),s._v(" "),e("h2",{attrs:{id:"简单配置-及opts优化选项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#简单配置-及opts优化选项"}},[s._v("#")]),s._v(" 简单配置 及OPTS优化选项")]),s._v(" "),e("p",[s._v("varnish 安装完毕之后会在"),e("code",[s._v("/etc/varnish")]),s._v("生成两个配置文件")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("/etc/varnish\n├── default.vcl         "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置各Child/Cache线程的缓存策略；")]),s._v("\n├── secret          "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# varnish连接时的安全秘钥文件")]),s._v("\n└── varnish.params      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置varnish服务进程的工作特性，例如监听的地址和端口，缓存机制；")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" directories, "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" files\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("code",[s._v("varnish.params")]),s._v("主要配置信息")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VARNISH_VCL_CONF")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/varnish/default.vcl\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# VCL 配置文件路径")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VARNISH_LISTEN_PORT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\t\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听端口")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VARNISH_ADMIN_LISTEN_ADDRESS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# varnish-admin监听地址及端口")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VARNISH_ADMIN_LISTEN_PORT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6082")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Shared secret file for admin interface")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VARNISH_SECRET_FILE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/varnish/secret\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理员秘钥")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# VARNISH_STORAGE="malloc,256M"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VARNISH_STORAGE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"file,/data/varnish/cache,1g"')]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# varnish存储模式")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# User and group for the varnishd worker processes")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VARNISH_USER")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("varnish\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VARNISH_GROUP")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("varnish\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Other options, see the man page varnishd(1)")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#DAEMON_OPTS="-p thread_pool_min=5 -p thread_pool_max=500 -p thread_pool_timeout=300"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DAEMON_OPTS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("”-p "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("thread_pools")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" -p "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("thread_pool_min")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" -p "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("thread_pool_max")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v(" -p "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("thread_pool_timeout")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("″\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("p",[s._v("varnish的缓存存储机制( Storage Types)：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("malloc[,size]")]),s._v("    内存存储，[,size]用于定义空间大小；重启后所有缓存项失效；一般4G较合适，内存空间有限，且内存碎片会大大影响性能；")]),s._v(" "),e("li",[e("code",[s._v("file[,path[,size[,granularity]]]")]),s._v("磁盘文件存储，黑盒；重启后所有缓存项失效；")]),s._v(" "),e("li",[e("code",[s._v("persistent,path,size")]),s._v("文件存储，黑盒；重启后所有缓存项有效；在"),e("code",[s._v("5.2.0")]),s._v("版本为实验状态,"),e("code",[s._v("6.4.0")]),s._v("版本官方不推荐该模式；")])]),s._v(" "),e("p",[e("strong",[s._v("DAEMON_OPTS附加选项:")])]),s._v(" "),e("p",[s._v("在线程池内部，其每一个请求由一个线程来处理； 其worker线程的最大数决定了varnish的并发响应能力；")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("thread_pools")]),s._v("：Number of worker thread pools. 最好小于或等于CPU核心数量；")]),s._v(" "),e("li",[e("code",[s._v("thread_pool_max")]),s._v("： 每线程池的最大线程数；")]),s._v(" "),e("li",[e("code",[s._v("thread_pool_min")]),s._v("：The minimum number of worker threads in each pool. 额外意义为“最大空闲线程数”；\n最大并发连接数 = "),e("strong",[s._v("thread_pools * thread_pool_max")])]),s._v(" "),e("li",[e("code",[s._v("thread_pool_timeout")]),s._v("：Thread idle threshold. Threads inexcess of thread_pool_min, which have been idle for at least this long,线程超时时间")]),s._v(" "),e("li",[s._v("thread_pool_add_delay：新创建线程的延迟时间")]),s._v(" "),e("li",[s._v("thread_pool_destroy_delay：杀死空闲线程延迟时间,也就是摧毁之前需要犹豫一下，这个犹豫的时间")])]),s._v(" "),e("p",[e("strong",[s._v("Timer相关的参数")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("send_timeout：设置客户端链接的超时时间\ntimeout_idle：设置保持链接的空闲时长，经常需要！！\ntimeout_req：接收客户端请求报文首部的最长时间\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"参考链接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),e("ul",[e("li",[s._v("varnish官方文档:https://www.varnish-cache.org/")])])])}),[],!1,null,null,null);a.default=r.exports}}]);