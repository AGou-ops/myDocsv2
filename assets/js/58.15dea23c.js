(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{693:function(s,a,e){"use strict";e.r(a);var t=e(6),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"八-service-配置清单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#八-service-配置清单"}},[s._v("#")]),s._v(" 八 Service 配置清单")]),s._v(" "),e("p",[s._v("Service 为 POD 控制器控制的 POD 集群提供一个固定的访问端点，Service 的工作还依赖于 K8s 中的一个附件，就是 CoreDNS ，它将 Service 地址提供一个域名解析。")]),s._v(" "),e("h2",{attrs:{id:"_8-1-service-工作模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-service-工作模式"}},[s._v("#")]),s._v(" 8.1 Service 工作模式")]),s._v(" "),e("ol",[e("li",[s._v("userspace: 1.1 之前版本")]),s._v(" "),e("li",[s._v("iptables: 1.10 之前版本")]),s._v(" "),e("li",[s._v("ipvs：1.11 之后版本")])]),s._v(" "),e("h2",{attrs:{id:"_8-2-service-类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-service-类型"}},[s._v("#")]),s._v(" 8.2 Service 类型")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("类型")]),s._v(" "),e("th",[s._v("作用")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("ClusterIP")]),s._v(" "),e("td",[s._v("默认值，分配一个 Service 网络的地址，仅用于集群内部通信")])]),s._v(" "),e("tr",[e("td",[s._v("NodePort")]),s._v(" "),e("td",[s._v("如果需要集群外部访问，可以使用这个类型")])]),s._v(" "),e("tr",[e("td",[s._v("ExternalName")]),s._v(" "),e("td",[s._v("把集群外部的服务引入到集群内部，方便在集群内部使用")])]),s._v(" "),e("tr",[e("td",[s._v("LoadBalancer")]),s._v(" "),e("td",[s._v("K8S 工作在云环境中，调用云环境创建负载均衡器")])])])]),s._v(" "),e("h2",{attrs:{id:"_8-3-资源记录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-资源记录"}},[s._v("#")]),s._v(" 8.3 资源记录")]),s._v(" "),e("p",[s._v("SVC_NAME.NS_NAME.DOMAIN.LTD")]),s._v(" "),e("p",[s._v("例如：redis.default.svc.cluster.local.")]),s._v(" "),e("h2",{attrs:{id:"_8-4-service-清单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-service-清单"}},[s._v("#")]),s._v(" 8.4 Service 清单")]),s._v(" "),e("ul",[e("li",[s._v("清单组成")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("apiVersion\t"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("string"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# api 版本号，v1")]),s._v("\nkind\t    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("string"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 资源类别，标记创建什么类型的资源")]),s._v("\nmetadata    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Object"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# POD 元数据")]),s._v("\nspec\t    "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Object"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 元数据")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h2",{attrs:{id:"_8-5-service-spec-规范"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-service-spec-规范"}},[s._v("#")]),s._v(" 8.5 service.spec 规范")]),s._v(" "),e("ol",[e("li",[s._v("clusterIP：指定 Service 处于 service 网络的哪个 IP，默认为动态分配")]),s._v(" "),e("li",[s._v("type： service 类型，可用：ExternalName, ClusterIP, NodePort, and LoadBalancer")])]),s._v(" "),e("h2",{attrs:{id:"_8-6-clusterip-类型的-service"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-6-clusterip-类型的-service"}},[s._v("#")]),s._v(" 8.6 ClusterIP 类型的 service")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" redis\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" logstor\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterIP\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusterIP")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.96.0.100\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("         "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service 端口")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("   "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pod 监听的端口")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h2",{attrs:{id:"_8-7-nodeport-类型的-service"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-7-nodeport-类型的-service"}},[s._v("#")]),s._v(" 8.7 NodePort 类型的 service")]),s._v(" "),e("p",[s._v("NodePort 是在 ClusterIP 类型上增加了一个暴露在了 node 的网络命名空间上的一个 nodePort，所以用户可以从集群外部访问到集群了，因而用户的请求流程是：Client -> NodeIP:NodePort -> ClusterIP:ServicePort -> PodIP:ContainerPort。")]),s._v(" "),e("p",[s._v("可以理解为 NodePort 增强了 ClusterIP 的功能，让客户端可以在每个集群外部访问任意一个 nodeip 从而访问到 clusterIP，再由 clusterIP 进行负载均衡至 POD。")]),s._v(" "),e("ul",[e("li",[s._v("清单示例")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" myapp\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" myapp\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("release")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" canary\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("         "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service 端口")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("   "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pod 监听的端口")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodePort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("30080")]),s._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service 会在每个 node 上添加 iptables/ipvs 规则重定向这个端口的访问，所以必须保证所有 node 的这个端口没被占用")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("在集群外部就可以使用: http://172.16.100.102:30080 来访问这个 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" 地址了\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("在集群内可以使用 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" 的域名在 coredns 上解析得到 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" 地址: "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("dig")]),s._v(" -t A myapp.default.svc.cluster.local @10.96.0.10\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"_8-8-loadbalancerip-类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-8-loadbalancerip-类型"}},[s._v("#")]),s._v(" 8.8 loadBalancerIP 类型")]),s._v(" "),e("p",[s._v("service 在每台主机的 iptables/ipvs 规则内，访问任意一台 node 都可以到达 pod，所以应该在这些 nodeip 前加负载均衡器，如果工作在公有云，可以使用 k8s 内置的 loadBalancerIP，操作公有云的负载均衡器即服务，实现动态的增删。")]),s._v(" "),e("p",[s._v("可以理解为 loadBalancerIP 增强了 NodePort 类型的 service ，在集群外部对每台 nodeip 进行负载均衡。")]),s._v(" "),e("h2",{attrs:{id:"_8-9-无集群地址的-service"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-9-无集群地址的-service"}},[s._v("#")]),s._v(" 8.9 无集群地址的 Service")]),s._v(" "),e("p",[s._v("无头 service 表示 service 没有 ClusterIP 也不映射 NodePort，而是将 service 的域名直接解析为 nodeIP 从而直接访问 nodeIP 上的 POD。")]),s._v(" "),e("ul",[e("li",[s._v("清单示例")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("apiVersion: v1\nkind: Service\nmetadata:\n  name: myapp-nohead\n  namespace: default\nspec:\n  selector:\n    app: myapp-nohead\n    release: canary\n  type: ClusterIP\n  clusterIP: None\n  ports:\n    - port: 80         # service 端口\n      targetPort: 80   # pod 监听的端口\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("ul",[e("li",[s._v("查看 CoreDNS 服务器的地址")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get svc -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("在集群内使用 CoreDNS 的地址解析无头的 serive 域名，得到的直接为 nodeip 中的 pod 地址，利用 dns 的多条 A 记录来负载均衡")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("dig")]),s._v(" -t A myapp-nohead.default.svc.cluster.local. @10.96.0.10\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(";; ANSWER SECTION:\nmyapp-nohead.default.svc.cluster.local.\t5 IN A\t10.244.1.75\nmyapp-nohead.default.svc.cluster.local.\t5 IN A\t10.244.2.74\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"_8-10-externalname-类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-10-externalname-类型"}},[s._v("#")]),s._v(" 8.10 externalName 类型")]),s._v(" "),e("p",[s._v("当 POD 需要访问一个集群外部的服务时候，externalName 可以映射一个集群外部的服务到集群内部，供集群内 POD 访问。")]),s._v(" "),e("p",[s._v("就是把外部的一个域名地址，映射为集群内部 coredns 解析的一个内部地址，提供集群内部访问。")])])}),[],!1,null,null,null);a.default=n.exports}}]);