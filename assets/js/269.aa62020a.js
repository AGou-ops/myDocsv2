(window.webpackJsonp=window.webpackJsonp||[]).push([[269],{900:function(s,t,e){"use strict";e.r(t);var a=e(6),r=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"ssh-tunnel"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssh-tunnel"}},[s._v("#")]),s._v(" SSH Tunnel")]),s._v(" "),e("h2",{attrs:{id:"ssh-tunnel-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssh-tunnel-2"}},[s._v("#")]),s._v(" SSH Tunnel")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("角色")]),s._v(" "),e("th",[s._v("IP")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("HostA")]),s._v(" "),e("td",[s._v("172.16.1.130")])]),s._v(" "),e("tr",[e("td",[s._v("HostB")]),s._v(" "),e("td",[s._v("172.16.1.129")])]),s._v(" "),e("tr",[e("td",[s._v("HostC")]),s._v(" "),e("td",[s._v("172.16.1.128")])]),s._v(" "),e("tr",[e("td",[s._v("HostD")]),s._v(" "),e("td",[s._v("172.16.1.127")])])])]),s._v(" "),e("h3",{attrs:{id:"ssh-l"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssh-l"}},[s._v("#")]),s._v(" SSH -L")]),s._v(" "),e("p",[s._v("类似于正向代理（本地转发）")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/ssh%20tunnel/ssh-tunnel-2.png",alt:"ssh-tunnel-1"}})]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("HostB")]),s._v("主机上，在其本地起一个"),e("code",[s._v("8888")]),s._v("端口，使之映射到"),e("code",[s._v("HostC")]),s._v("主机的SSH默认"),e("code",[s._v("22")]),s._v("端口，如此，在"),e("code",[s._v("HostA")]),s._v("上可以使用 "),e("code",[s._v("HostB:8888")]),s._v(" 就像使用 "),e("code",[s._v("HostC:22")]),s._v(" 一样。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在HostA主机上执行")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -L "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:8888:172.16.1.128:22 root@172.16.1.129\t\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认不指明HostB地址为本地localhost")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("当链接断开时，隧道会自动关闭，临时性。")]),s._v(" "),e("p",[s._v("应用场景：通过公网远程如果直接使用mysql客户端连接是不安全的，因为其传输报文是明文的，所以可以在客户端与服务器之间搭建一条ssh 隧道来增强安全性。")]),s._v(" "),e("p",[e("strong",[s._v("示例：")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -L "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("9906")]),s._v(":10.1.0.2:3306 root@10.1.0.2\n\n* 上述命令表示从本机"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ServerA"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("建立一个到ServerB"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.1")]),s._v(".0.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("的ssh隧道，使用本地端口转发模式，监听ServerA本地的9906端口，访问本机的9906端口时，通讯数据将会被转发到ServerB"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.1")]),s._v(".0.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("的3306端口。\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("此时就可以在serverA主机上通过本地的9906端口较为安全的访问serverB主机上的mysql服务")]),s._v(" "),e("h3",{attrs:{id:"ssh-r"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssh-r"}},[s._v("#")]),s._v(" SSH -R")]),s._v(" "),e("p",[s._v("类似于反向代理（远程转发）")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/ssh%20tunnel/ssh-tunnel-3.png",alt:""}})]),s._v(" "),e("p",[s._v("在 "),e("code",[s._v("HostC")]),s._v(" 上，让 "),e("code",[s._v("HostB")]),s._v("起"),e("code",[s._v("8888")]),s._v("端口，使之映射到 "),e("code",[s._v("localhost")]),s._v(" 的 "),e("code",[s._v("22")]),s._v("端口。如此，在"),e("code",[s._v("HostA")]),s._v("上可以使用 "),e("code",[s._v("HostB:8888")]),s._v(" 就像使用 "),e("code",[s._v("HostC:22")]),s._v("一样。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在HostC上执行")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -R "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8888")]),s._v(":localhost:22 root@172.16.1.129\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("img",{attrs:{src:"http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/ssh%20tunnel/ssh-tunnel-4.png",alt:""}})]),s._v(" "),e("p",[s._v("在 "),e("code",[s._v("HostC 上")]),s._v("，让 "),e("code",[s._v("HostB")]),s._v("起 "),e("code",[s._v("8888")]),s._v("端口，使之映射到"),e("code",[s._v("HostD")]),s._v(" 的 "),e("code",[s._v("22")]),s._v("端口。如此，在 "),e("code",[s._v("HostA")]),s._v("上可以使用 "),e("code",[s._v("HostB:8888")]),s._v("就像使用 "),e("code",[s._v("HostD:22")]),s._v(" 一样。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在HostC上执行")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -R "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8888")]),s._v(":172.16.1.127:22 root@172.16.1.129\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("应用场景：内网穿透，外网访问内网服务。假如公司内网环境中有一台mysql服务器（公司所有主机通过典型的NAT模式进行上网），通常的做法是，通过路由器或者防火墙，将公司的固定外网IP上的某个端口映射到ServerB内网IP的3306端口上，这样，我们只要访问公司外网IP的对应端口，即可访问到内网ServerB中的mysql服务了，但是你没有权限控制公司的防火墙或者路由器。但是，公司在公网上有另外一台服务器ServerA，ServerA有自己的公网IP，你有权控制ServerA，这时，我们就可以利用ServerA达到我们的目的。")]),s._v(" "),e("p",[s._v("显然，使用ssh本地正向代理的方式无法实现，因为外网主机仍无法连接到内网mysql服务器上，但是内网mysql服务器通过NAT可以ssh连接到那台具有公网ip的主机。")]),s._v(" "),e("p",[e("strong",[s._v("示例：")])]),s._v(" "),e("p",[s._v("条件1：从ServerB(10.1.0.2)中主动连接到ServerA(10.1.0.1)，即在ServerB中执行创建隧道的命令，连接到ServerA。")]),s._v(" "),e("p",[s._v("条件2：隧道创建后，转发端口需要监听在ServerA中，以便利用ServerA访问到内网的ServerB。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在severB上执行")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -N -f -R "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("9906")]),s._v(":10.1.0.2:3306 root@10.1.0.1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("上述命令在ServerB中执行，执行后，即可在ServerA与ServerB之间建立ssh隧道，此时，ServerB是ssh客户端，ServerA是ssh服务端，隧道建立后，ServerA中的9906端口会被监听")]),s._v(" "),e("blockquote",[e("p",[s._v('不过你肯定注意到了，当使用远程转发的命令时，我并没有指定监听ServerA的外网IP，也没有使用"-g选项"开启网关功能，这是因为，即使你在命令中指定了IP地址，最终在ServerA中还是会只监听127.0.0.1的9906端口，你可以在ServerB中尝试一下如下命令')]),s._v(" "),e("p",[e("code",[s._v("ssh -f -N -R 10.1.0.1:9906:10.1.0.2:3306 root@10.1.0.1")])]),s._v(" "),e("p",[s._v("即使在ServerB中执行上述命令时指定了IP或者开启了网关功能，ServerA的9906端口仍然只监听在127.0.0.1上，当然，如果你一心想要通过别的主机访问ServerA的9906端口，也可以使用其他程序去反代ServerA的9906端口，还有，我在实际的使用过程中，如果使用远程转发穿透到内网，ssh隧道将会非常不稳定，隧道会莫名其妙的消失或者失效，特别是在没有固定IP的网络内，网上有些朋友提供了autossh的解决方案，不过我并没有尝试过，如果你有兴趣，可以试一试。")])]),s._v(" "),e("h3",{attrs:{id:"ssh-d"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssh-d"}},[s._v("#")]),s._v(" SSH -D")]),s._v(" "),e("p",[s._v("创建一个socks5代理")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -g -D "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" root@172.16.1.130\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"ssh-选项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssh-选项"}},[s._v("#")]),s._v(" SSH 选项")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("-N")]),s._v("：当配合此选项创建ssh隧道时，并不会打开远程shell连接到目标主机，仅使用该选项时，可以发现终端会停留在输入密码之后的位置，显示空白，但此时连接已经建立")]),s._v(" "),e("li",[e("code",[s._v("-f")]),s._v('：表示后台运行ssh隧道，即使我们关闭了创建隧道时所使用的ssh会话，对应的ssh隧道也不会消失，"-f"选项需要跟"-N"选项配合使用，例如：'),e("code",[s._v("ssh -N -f -L 172.16.1.129:2222:172.16.1.128:22 root@172.16.1.128")])]),s._v(" "),e("li",[e("code",[s._v("-g")]),s._v('：表示ssh隧道对应的转发端口将监听在主机的所有IP中，不使用"-g选项"时，转发端口默认只监听在主机的本地回环地址中，"-g"表示开启网关模式，远程端口转发中，无法开启网关功能，例如：'),e("code",[s._v("ssh -g -N -f -L 0.0.0.0:2222:172.16.1.128:22 root@172.16.1.128")])])]),s._v(" "),e("h2",{attrs:{id:"ssh-代理转发"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssh-代理转发"}},[s._v("#")]),s._v(" SSH 代理转发")]),s._v(" "),e("p",[s._v("原理简单示例：")]),s._v(" "),e("p",[s._v("在A主机上，把B主机上的某个文件复制到C主机上")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" root@hostB:/root/test root@hostC:/root\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"参考资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),e("ul",[e("li",[s._v("朱双印博客：https://www.zsythink.net/archives/2450")]),s._v(" "),e("li",[s._v("CSDN @蜜汁小强 ： https://blog.csdn.net/wxqee/article/details/49234595")])])])}),[],!1,null,null,null);t.default=r.exports}}]);