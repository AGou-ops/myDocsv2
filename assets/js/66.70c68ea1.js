(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{701:function(s,a,e){"use strict";e.r(a);var t=e(6),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"十五-dashboard"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#十五-dashboard"}},[s._v("#")]),s._v(" 十五 dashboard")]),s._v(" "),e("p",[s._v("它作为 k8s 集群的附件存在，是 kubernetes 官方的项目之一，详见：https://github.com/kubernetes/dashboard")]),s._v(" "),e("h2",{attrs:{id:"_15-1-部署流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_15-1-部署流程"}},[s._v("#")]),s._v(" 15.1 部署流程")]),s._v(" "),e("ul",[e("li",[s._v("为 dashboard 提供 ssl 证书")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成私钥")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("umask 077"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" openssl genrsa -out dashboard.key "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成一个自签证书，注意 CN 的值必须要与自己的域名完全一致")]),s._v("\nopenssl req -new -x509 -key dashboard.key -out dashboard.crt -subj "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/O=dashboard/CN=k8s.dashboard.com"')]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看证书")]),s._v("\nopenssl x509 -in dashboard.crt -text -noout\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("ul",[e("li",[s._v("下载 dashboard 的清单文件")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[s._v("wget https"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dashboard.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("为 dashboard 创建 secret 对象")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system create secret generic kubernetes-dashboard-certs --from-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("dashboard.crt"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./dashboard.crt --from-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("dashboard.key"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./dashboard.key\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("修改 dashboard 清单中 service 的工作模式为 nodeport")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/targetPort: 8443/a\\ \\ type: NodePort'")]),s._v(" kubernetes-dashboard.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("注释掉 kubernetes-dashboard.yaml 清单文件中的 Dashboard Secret 这个证书的清单定义")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ------------------- Dashboard Secret ------------------- #")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#apiVersion: v1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#kind: Secret")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#metadata:")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  labels:")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    k8s-app: kubernetes-dashboard")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  name: kubernetes-dashboard-certs")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  namespace: kube-system")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#type: Opaque")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#---")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("ul",[e("li",[s._v("部署 dashboard 清单")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl apply -f kubernetes-dashboard.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("取得 service 运行的端口")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("使用 chrome 访问 dashboard")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("https://172.16.100.102:31097/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"_15-2-使用令牌登录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_15-2-使用令牌登录"}},[s._v("#")]),s._v(" 15.2 使用令牌登录")]),s._v(" "),e("ul",[e("li",[s._v("为 POD 创建一个 serviceaccount 对象，它是 POD 访问 apiserver 的凭证")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl create serviceaccount dashborad-admin -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("创建 clusterrolebinding 将用户绑定至 cluster-admin 集群管理员（最高权限）")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl create clusterrolebinding dashborad-cluster-admin --clusterrole"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cluster-admin --serviceaccount"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-system:dashborad-admin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("找到刚才创建的 serviceaccount 对象")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get secret -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("得到 serviceaccount 对象中的 Token")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl describe secret -n kube-system dashborad-admin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"_15-3-分级管理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_15-3-分级管理"}},[s._v("#")]),s._v(" 15.3 分级管理")]),s._v(" "),e("p",[s._v("现在需要创建一个只能管理 default 名称空间的用户，那么我们可以用 rolebinding 去绑定 admin 这个 clusterrolue 对象，那么就获得了当前名称空间的管理员权限了。")]),s._v(" "),e("ul",[e("li",[s._v("创建 serviceaccount 登录")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl create serviceaccount def-ns-admin -n default\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("使用 rolebinding 对象，将 default 名称空间的 def-ns-admin 这个 serviceaccunt 与 admin 这个 clusterrole 绑定")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl create rolebinding def-ns-admin --clusterrole"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("admin --serviceaccount"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default:def-ns-admin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("找到刚才创建的 serviceaccount 对象")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get secret -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("得到 serviceaccount 对象中的 Token")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl describe secret def-ns-admin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"_15-4-配置文件认证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_15-4-配置文件认证"}},[s._v("#")]),s._v(" 15.4 配置文件认证")]),s._v(" "),e("p",[s._v("与之前基于 SSL 证书的 config 文件不同，这次使用是基于 Token 的 config 文件，可以不用创建证书了，使用已有的 serviceaccount 对象的 token。")]),s._v(" "),e("ul",[e("li",[s._v("设置集群的连接的 ca 机构证书，--kubeconfig 可以指定 kubectl 使用的配置文件位置，默认为用户家目录 .kube 目录中的 config")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config set-cluster k8s-cluster --server"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://172.16.100.101:6443 --certificate-authority"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/ca.crt --embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true --kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/test.conf \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("取得一个已经绑定角色的 serviceaccount 对象的 Token")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl describe secret def-ns-admin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("使用 Token 来创建配置文件中的用户")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config set-credentials def-ns-admin --token"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("TOKEN"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" --kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/test.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("创建上下文对象，授权 kaliarch 用户访问名称为 kubernetes 的集群")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config set-context def-ns-admin@k8s-cluster --cluster"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("k8s-cluster --user"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("def-ns-admin --kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/test.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("切换当前使用的上下文，到授权 kaliarch 到 kubernetes 的上下文上")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl config use-context def-ns-admin@k8s-cluster --kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/test.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("复制 /tmp/test.conf 这个文件到 dashboard 中就可以登录了")])])])}),[],!1,null,null,null);a.default=n.exports}}]);