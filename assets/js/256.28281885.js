(window.webpackJsonp=window.webpackJsonp||[]).push([[256],{888:function(s,a,n){"use strict";n.r(a);var t=n(6),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"consul-入门"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#consul-入门"}},[s._v("#")]),s._v(" Consul 入门")]),s._v(" "),n("h2",{attrs:{id:"consul-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#consul-简介"}},[s._v("#")]),s._v(" Consul 简介")]),s._v(" "),n("p",[s._v("Consul 是基于 GO 语言开发的开源工具，主要面向分布式，服务化的系统提供服务注册、服务发现和配置管理的功能。Consul 提供服务注册/发现、健康检查、Key/Value存储、多数据中心和分布式一致性保证等功能。之前我们通过 Prometheus 实现监控，当新增一个 Target 时，需要变更服务器上的配置文件，即使使用 file_sd_configs 配置，也需要登录服务器修改对应 Json 文件，会非常麻烦。不过 Prometheus 官方支持多种自动服务发现的类型，其中就支持 Consul。")]),s._v(" "),n("h3",{attrs:{id:"consul-基础架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#consul-基础架构"}},[s._v("#")]),s._v(" Consul 基础架构")]),s._v(" "),n("p",[n("img",{attrs:{src:"http://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/promethues%20%2B%20consul/consul-arch.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"consul-安装与配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#consul-安装与配置"}},[s._v("#")]),s._v(" Consul 安装与配置")]),s._v(" "),n("h3",{attrs:{id:"使用官方二进制包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用官方二进制包"}},[s._v("#")]),s._v(" 使用官方二进制包")]),s._v(" "),n("p",[s._v("官方下载站点：https://www.consul.io/downloads.html")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://releases.hashicorp.com/consul/1.7.2/consul_1.7.2_linux_amd64.zip\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("unzip")]),s._v(" consul_1.7.2_linux_amd64.zip\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("解压完成之后发现只有一个二进制程序，即"),n("code",[s._v("consul")]),s._v("，将其添加至环境变量，或者直接链接到环境变量当中去.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -sv /root/consul /usr/bin/consul\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看"),n("code",[s._v("consul")]),s._v("是否成功配置：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("# consul -v\nConsul v1.7.2\nProtocol "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" spoken by default, understands "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" to "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("agent will automatically use protocol "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" when speaking to compatible agents"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("启动一个"),n("code",[s._v("consul agent")]),s._v("（开发模式）：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("# ./consul agent -dev   \n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Starting Consul agent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n           Version: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'v1.7.2'")]),s._v("\n           Node ID: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'23e32a9f-73d8-48c9-27e9-adb38a069a83'")]),s._v("\n         Node name: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'master'")]),s._v("\n        Datacenter: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'dc1'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Segment: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<all>'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            Server: "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Bootstrap: "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n       Client Addr: "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("HTTP: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8500")]),s._v(", HTTPS: -1, gRPC: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8502")]),s._v(", DNS: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8600")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      Cluster Addr: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LAN: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8301")]),s._v(", WAN: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8302")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n           Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false, Auto-Encrypt-TLS: "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n           "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("切记，不要在生产环境中使用开发模式。")]),s._v(" "),n("p",[s._v("此时打开浏览器，输入http://127.0.0.1:8500 即可看到 consul 的web端")]),s._v(" "),n("p",[s._v("通过在新的终端窗口中运行"),n("code",[s._v("consul Members")]),s._v("命令，检查Consul数据中心的成员身份，输出内容列出了数据中心中的代理（目前只有主机自己）：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("# consul members\nNode    Address         Status  Type    Build  Protocol  DC   Segment\nmaster  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8301  alive   server  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v(".2  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         dc1  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("all"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("获取节点详细信息可以使用："),n("code",[s._v("curl localhost:8500/v1/catalog/nodes")])]),s._v(" "),n("p",[s._v("除了HTTP API，您还可以使用DNS接口来发现节点："),n("code",[s._v("dig @127.0.0.1 -p 8600 master.node.consul")])]),s._v(" "),n("p",[s._v("停止代理：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("consul leave\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"使用-docker-部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-docker-部署"}},[s._v("#")]),s._v(" 使用 Docker 部署")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("首先从 Docker Hub 上拉取镜像："),n("code",[s._v("docker pull consul")])])]),s._v(" "),n("li",[n("p",[s._v("在启动集群之前，建立 "),n("code",[s._v("/data/consul")]),s._v(" 文件夹, 用于保存 consul 的数据，"),n("code",[s._v("mkdir -pv /data/consul")])])]),s._v(" "),n("li",[n("p",[s._v("在本地启动 Consul 集群进行测试：")])])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d -p "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8500")]),s._v(":8500 -v /data/consul:/consul/data -e "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONSUL_BIND_INTERFACE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'eth0'")]),s._v(" --name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("consul1 consul agent -server -bootstrap -ui -client"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0.0.0.0'")]),s._v("\n\n* 参数说明：\n    agent: 表示启动 agent 进程\n    server: 表示 consul 为 server 模式\n    client: 表示 consul 为 client 模式\n    bootstrap: 表示这个节点是 Server-Leader\n    ui: 启动 Web UI, 默认端口 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8500")]),s._v("\n    node: 指定节点名称, 集群中节点名称唯一\n    client: 绑定客户端接口地址, "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 表示所有地址都可以访问\n    datacenter:要创建多个datacenter的话，需要指定该参数\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下面创建了3个Server，使用`--bootstrap-expect`来触发选举功能")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name=consul1 -p 8500:8500 -e CONSUL_BIND_INTERFACE=eth0 consul agent --server=true --bootstrap-expect=3 --client=0.0.0.0 -ui --datacenter=dc2")]),s._v("\n* 关联dc1和dc2\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("CONSUL_SERVER"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" consul "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" -wan "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2  \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("一般第一个容器的ip地址是"),n("code",[s._v("172.17.0.2")]),s._v("，可以通过下面的命令查询容器ip：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" inspect --format "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'【【 .NetworkSettings.IPAddress 】】'")]),s._v(" consul1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",{attrs:{start:"4"}},[n("li",[s._v("添加节点")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d --name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("consul2 -e "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONSUL_BIND_INTERFACE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'eth0'")]),s._v(" consul agent --server"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false --client"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 --join "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# join加入集群")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -d --name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("consul3 -e "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONSUL_BIND_INTERFACE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'eth0'")]),s._v(" consul agent --server"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false --client"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 --join "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# join加入集群")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ol",{attrs:{start:"5"}},[n("li",[s._v("查看容器中集群节点")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("# "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it consul1 consul members\nNode          Address          Status  Type    Build  Protocol  DC   Segment\n8b90d158b4f5  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2:8301  alive   server  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v(".2  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         dc1  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("all"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n3a639e89644c  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.5:8301  alive   client  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v(".2  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         dc1  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("default"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\na21fff77c185  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.4:8301  alive   client  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v(".2  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         dc1  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("default"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h4",{attrs:{id:"使用-docker-compose-快速部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-docker-compose-快速部署"}},[s._v("#")]),s._v(" 使用 docker-compose 快速部署")]),s._v(" "),n("p",[s._v("创建"),n("code",[s._v("docker-compose.yml")]),s._v("文件，内容如下：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("version: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3.0"')]),s._v("\n\nservices:\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# consul server，对外暴露的ui接口为8500，只有在2台consul服务器的情况下集群才起作用")]),s._v("\n    consulserver:\n        image: consul:latest\n        hostname: consulserver\n        ports:\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8300"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8400"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8500:8500"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"53"')]),s._v("\n        command: agent -server --bootstrap-expect"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" -ui -client"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0.0.0.0'")]),s._v(" \n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# consul server1在consul server服务起来后，加入集群中")]),s._v("\n    consulserver1:\n        image: consul:latest\n        hostname: consulserver1\n        depends_on:\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"consulserver"')]),s._v("\n        ports:\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8300"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8400"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8500"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"53"')]),s._v("\n        command: agent --server"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true --client"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 --join consulserver\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# consul server2在consul server服务起来后，加入集群中")]),s._v("\n    consulserver2:\n        image: consul:latest\n        hostname: consulserver2\n        depends_on:\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"consulserver"')]),s._v("\n        ports:\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8300"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8400"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8500"')]),s._v("\n            - "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"53"')]),s._v("\n        command: agent --server"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true --client"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 --join consulserver\n   \n   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加registrator，如果服务已停止，则从注册中心中移除")]),s._v("\n   registrator:\n        image: gliderlabs/registrator:master\n        hostname: registrator\n        depends_on:\n       \t\t- "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"consulserver"')]),s._v("\n        volumes:\n        \t- "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/docker.sock:/tmp/docker.sock"')]),s._v("\n        command: -internal consul://consulserver:8500\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br")])]),n("p",[s._v("然后运行："),n("code",[s._v("docker-compose up -d")]),s._v("即可")]),s._v(" "),n("h3",{attrs:{id:"服务注册"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#服务注册"}},[s._v("#")]),s._v(" 服务注册")]),s._v(" "),n("p",[s._v("编写测试服务，在这里我使用 nginx 来进行测试.")]),s._v(" "),n("p",[s._v("将下面的内容保存成文件"),n("code",[s._v("nginx.json")]),s._v("，并上传到容器的"),n("code",[s._v("/consul/config")]),s._v("目录中，或者容器创建时指明存储卷也可.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ID"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test-nginx"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test-nginx"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Tags"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),s._v(",\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.16.1.132"')]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v(":8080,\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Meta"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"X-TAG"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test_nginx"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EnableTagOverride"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Check"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#        "DeregisterCriticalServiceAfter": "90m",')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://172.16.1.132:8080/"')]),s._v(",\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Interval"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10s"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("将文件复制到容器中，并重载服务：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" nginx.json consul2:/consul/config\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" consul2 consul reload\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("或者直接使用"),n("code",[s._v("HTTP API")]),s._v("的方式进行注册：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X PUT -d "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"id": "nginx","name": "nginx","address": "172.16.1.132","port": 80,"checks": [{"http": "http://172.16.1.132/","interval": "5s"}]}\'')]),s._v(" http://127.0.0.1:8500/v1/agent/service/register\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X PUT --data @nginx.json http://localhost:8500/v1/agent/service/register\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("注销服务使用："),n("code",[s._v("curl -X PUT http://172.16.1.132:8500/v1/agent/service/deregister/nginx_test")])]),s._v(" "),n("p",[s._v("查看服务健康状态检查：")]),s._v(" "),n("p",[s._v("打开浏览器访问：http://172.16.1.132:8500/v1/health/service/test-nginx 即可.")]),s._v(" "),n("h2",{attrs:{id:"参考链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),n("ul",[n("li",[s._v("Consul Get-Started ： https://learn.hashicorp.com/consul/getting-started/agent")]),s._v(" "),n("li",[s._v("Consul Arch ：https://www.consul.io/docs/internals/architecture.html")])])])}),[],!1,null,null,null);a.default=e.exports}}]);