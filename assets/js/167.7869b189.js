(window.webpackJsonp=window.webpackJsonp||[]).push([[167],{799:function(s,a,e){"use strict";e.r(a);var t=e(6),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"使用-kubespray-部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-kubespray-部署"}},[s._v("#")]),s._v(" 使用 Kubespray 部署")]),s._v(" "),e("h2",{attrs:{id:"kubespray-简介"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubespray-简介"}},[s._v("#")]),s._v(" Kubespray 简介")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/kubernetes-incubator/kubespray",target:"_blank",rel:"noopener noreferrer"}},[s._v("Kubespray"),e("OutboundLink")],1),s._v(" 是 Kubernetes incubator 中的项目，目标是提供 Production Ready Kubernetes 部署方案，该项目基础是通过 Ansible Playbook 来定义系统与 Kubernetes 集群部署的任务，具有以下几个特点：")]),s._v(" "),e("ul",[e("li",[s._v("可以部署在 AWS, GCE, Azure, OpenStack 以及裸机上.")]),s._v(" "),e("li",[s._v("部署 High Available Kubernetes 集群.")]),s._v(" "),e("li",[s._v("可组合性 (Composable)，可自行选择 Network Plugin (flannel, calico, canal, weave) 来部署.")]),s._v(" "),e("li",[s._v("支持多种 Linux distributions(CoreOS, Debian Jessie, Ubuntu 16.04, CentOS/RHEL7).")])]),s._v(" "),e("p",[s._v("Kubespray 由一系列的 "),e("a",{attrs:{href:"http://docs.ansible.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Ansible"),e("OutboundLink")],1),s._v(" playbook、生成 "),e("a",{attrs:{href:"https://github.com/kubernetes-incubator/kubespray/blob/master/docs/ansible.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("inventory"),e("OutboundLink")],1),s._v(" 的命令行工具以及生成 OS/Kubernetes 集群配置管理任务的专业知识构成。")]),s._v(" "),e("h2",{attrs:{id:"初始化环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#初始化环境"}},[s._v("#")]),s._v(" 初始化环境")]),s._v(" "),e("p",[s._v("主机环境：")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("角色")]),s._v(" "),e("th",[s._v("IP")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("master")]),s._v(" "),e("td",[s._v("172.16.1.128")])]),s._v(" "),e("tr",[e("td",[s._v("node01")]),s._v(" "),e("td",[s._v("172.16.1.129")])])])]),s._v(" "),e("p",[s._v("编辑"),e("code",[s._v("/etc/hosts")]),s._v("文件，使各主机之间可以通过主机名互相通信：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加以下内容")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.128 master master.agou-ops.com\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.129 node01 node01.agou-ops.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("关闭 SELinux 和防火墙：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/SELINUX=*/SELINUX=disabled/'")]),s._v(" /etc/selinux/config\nsystemctl disable firewalld "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl stop firewalld\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("Kubernetes 1.8 开始要求关闭系统的 Swap 交换分区，方法如下：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("swapoff -a "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vm.swappiness=0"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/sysctl.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" sysctl -p "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),s._v(" –h\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("Docker 从 1.13 版本开始调整了默认的防火墙规则，禁用了 "),e("code",[s._v("iptables filter")]),s._v("表中"),e("code",[s._v("FOWARD")]),s._v("链，这样会引起 Kubernetes 集群中跨 Node 的 Pod 无法通信，在各个 Docker 节点执行下面的命令：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("iptables -P FORWARD ACCEPT\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("配置 SSH Key 认证。确保本机也可以 SSH 连接，否则下面部署失败。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ssh-keygen -t rsa -N "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ~/.ssh/id_rsa.pub "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.ssh/authorized_keys\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("更新系统内核为 4.4.x , CentOS 默认为 3.10.x 。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm\nyum --enablerepo"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("elrepo-kernel "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y kernel-lt kernel-lt-devel \ngrub2-set-default "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("重启系统："),e("code",[s._v("reboot")])]),s._v(" "),e("p",[s._v("增加内核配置，编辑"),e("code",[s._v("/etc/sysctl.conf")]),s._v("文件：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增加以下内容")]),s._v("\nnet.bridge.bridge-nf-call-iptables "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.bridge.bridge-nf-call-ip6tables "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("使其内核配置生效：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("sysctl -p\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"安装-kubespray"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-kubespray"}},[s._v("#")]),s._v(" 安装 Kubespray")]),s._v(" "),e("p",[s._v("安装 Centos 的 EPEL 源：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" yum -y "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" epel-release\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("更新缓存：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" yum clean all "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum makecache\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("安装相关软件（Ansible 版本必须 >= 2.7）：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" yum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y python-pip python3 python-netaddr python3-pip ansible "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("下载源码，当前 Kubespray 项目的 Master 分支默认安装 K8s 1.13.1 版本：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/kubernetes-sigs/kubespray.git\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("安装 Kubespray 依赖，若无特殊说明，后续操作均在 ~/kubespray `目录下执行：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" kubespray \n pip3 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -r requirements.txt\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("配置 Kubespray：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -rfp inventory/sample inventory/mycluster\n \n "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Update Ansible inventory file with inventory builder")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("declare")]),s._v(" -a "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("IPS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".1.3 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".1.4 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".1.5"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONFIG_FILE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${IPS"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("@"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("修改配置文件 "),e("code",[s._v("inventory/mycluster/hosts.ini")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language-ini line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-ini"}},[e("code",[e("span",{pre:!0,attrs:{class:"token section"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("all")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("master ansible_host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("master ip=172.16.1.128")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token section"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("kube-master")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\nmaster\n\n"),e("span",{pre:!0,attrs:{class:"token section"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("etcd")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\nmaster\n\n"),e("span",{pre:!0,attrs:{class:"token section"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("kube-node")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\nnode01\n\n"),e("span",{pre:!0,attrs:{class:"token section"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("k8s-cluster:children")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\nkube-master\nkube-node\n\n"),e("span",{pre:!0,attrs:{class:"token section"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("calico-rr")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("p",[s._v("ℹ️此处也可以用："),e("code",[s._v("kubespray prepare --masters master1 --etcds master1 --nodes node1 node2 node3")]),s._v("来自动生成"),e("code",[s._v("inventory")]),s._v("文件")]),s._v(" "),e("p",[s._v("修改配置文件"),e("code",[s._v("inventory/mycluster/group_vars/all/all.yml")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改如下配置:")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("loadbalancer_apiserver_localhost")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v(" \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加载内核模块，否则 ceph, gfs 等无法挂载客户端")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubelet_load_modules")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("修改镜像默认的 Repo 地址，使用 Calico 三层网络，同时可以指定安装的 K8s版本，参数为"),e("code",[s._v("kube_version")]),s._v("。编辑文件"),e("code",[s._v("inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml")]),s._v("(在这里我能够科学上网就不做修改了)：")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kube_image_repo")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"gcr.io/google-containers"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("如需设置代理，在"),e("code",[s._v("cluster.yml")]),s._v("中编辑 default 值即可：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nproxy_env:\n          http_proxy: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"【【 http_proxy | default ('192.168.43.37:8888') 】】\"")]),s._v("\n          HTTP_PROXY: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"【【 http_proxy | default ('192.168.43.37:8888') 】】\"")]),s._v("\n          https_proxy: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"【【 https_proxy | default ('192.168.43.37:8888') 】】\"")]),s._v("\n          HTTPS_PROXY: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"【【 https_proxy | default ('192.168.43.37:8888') 】】\"")]),s._v("\n          no_proxy: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"【【 no_proxy | default ('') 】】\"")]),s._v("\n          NO_PROXY: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"【【 no_proxy | default ('') 】】\"")]),s._v("\n      no_log: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("如需设置"),e("code",[s._v("docker pull")]),s._v(" 代理，新建"),e("code",[s._v("/etc/systemd/system/docker.service.d/http-proxy.conf")]),s._v("文件，添加以下内容：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http_proxy=192.168.43.37:8888"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https_proxy=192.168.43.37:8888"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"NO_PROXY= hostname.example.com,172.10.10.10"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最后重启docker")]),s._v("\nsystemctl daemon-reload\nsystemctl restart "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("修改"),e("code",[s._v("./roles/kubernetes-apps/ansible/templates/dashboard.yml.j2")]),s._v("文件，使用 "),e("code",[s._v("NodePort")]),s._v(" 方式访问 Dashboard：")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ------------------- Dashboard Service ------------------- #…………      ")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8443")]),s._v("  \n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort    //添加这一行      \n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dashboard\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("⚠️ 注意：如果是单节点部署 K8s，Kubespray 默认会创建 2 个 coredns Pod，但 Deployment 中又用到了 podAntiAffinity，因此会导致其中一个 coredns pod pending，所以需要修改"),e("code",[s._v("./roles/kubernetes-apps/ansible/templates/coredns-deployment.yml.j2")]),s._v("代码如下：")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注释掉以下几行代码")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("affinity")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#podAntiAffinity:")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  requiredDuringSchedulingIgnoredDuringExecution:")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#  - topologyKey: "kubernetes.io/hostname"')]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    labelSelector:")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#      matchLabels:")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#        k8s-app: coredns【【 coredns_ordinal_suffix | default('') 】】")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者在spec一行添加代码：")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1   //指定pod为1个副本\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("最后执行部署命令：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ansible-playbook -i inventory/mycluster/hosts.ini  --become --become-user"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root cluster.yml -b -v\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"登录-dashboard"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#登录-dashboard"}},[s._v("#")]),s._v(" 登录 Dashboard")]),s._v(" "),e("p",[s._v("登陆 Dashboard 支持 kubeconfig 和 token 两种认证方式，kubeconfig 也依赖 token 字段，所以生成 token 这一步是必不可少的。此处，我们获取集群管理员（拥有所有命名空间的 admin 权限）的 token。")]),s._v(" "),e("p",[s._v("查看 kubernetes-dashboard 暴露的端口，如下所示，这里是31777端口。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master kubespray"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("#  kubectl get svc --all-namespaces "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kubernetes-dashboard\nkube-system   kubernetes-dashboard        NodePort    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.233")]),s._v(".41.202   "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(":30548/TCP            8m16s\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("获取 admin 的 token")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master kubespray"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("#  kubectl -n kube-system describe "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl -n kube-system get secret -n kube-system -o name "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" namespace"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" token\nName:         namespace-controller-token-ksdvp\nType:  kubernetes.io/service-account-token\ntoken:      eyJhbGciOiJSUzI1NiIsImtpZCI6IkV0N0pLMXVqMzNxS2xCNXRlTkxpRTlOYnNMVzRiajNrLU9kdi1qRW5jTDQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlci10b2tlbi1rc2R2cCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImZiM2NkMDBhLTE4ZjAtNGI4OC1hZGNiLWYwNGVjZWNlZTUzNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpuYW1lc3BhY2UtY29udHJvbGxlciJ9.bYWcoopcYFC6EYNMNPkoiZeUQqfidC9NwlrMzzkZD3T9e-PbDd37pmTeWAcU_E4DCDzeVc9CXfWPhWCfr3syZKWiIXPNtDrNrIgnGs34Id2evsh7evVTgOjQtWkRoqX9UFdjWZdQPxvJChLZacRqbUp718umCzhR9evuE0zq8JeruBCTrcilQDDYobavfYs72HrwZ5xlIj2GMb66FeS7mYZacP-2-M3oVsziIWLs_kfBIaN_OkpImUPpvJxF-8xMmVP2BCKWyHWaLPIUdVsF8FkiLWH7bIS8f0cm8D4wEcMZ4IYkVe2FMcmMaiFJx5HEXrwA4YT7bMVy4PJhR71Thg\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("在 dashboard 登录页面上使用上面输出中的那个非常长的字符串作为 token 登录，即可以拥有管理员权限操作整个 kubernetes 集群中的对象。当然您也可以将这串 token 加到 admin 用户的 kubeconfig 文件中，继续使用 kubeconfig 登录，两种认证方式任您选择。")]),s._v(" "),e("p",[s._v("登录 dashboard：https://172.16.1.128:30548")]),s._v(" "),e("blockquote",[e("p",[s._v("注意：由于这里使用的 HTTPS，并未使用证书，因此使用 Google 等浏览器会终止访问。")])]),s._v(" "),e("h2",{attrs:{id:"验证-k8s-集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证-k8s-集群"}},[s._v("#")]),s._v(" 验证 K8s 集群")]),s._v(" "),e("ul",[e("li",[s._v("查看集群版本")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master ~"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("# kubelet --version\nKubernetes v1.18.2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("查看集群状态")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" kubectl get nodes\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("查看集群 Pod")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" kubectl get pods --all-namespaces\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("查看 IPVS")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v(" ipvsadm -L -n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"其他"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[s._v("#")]),s._v(" 其他")]),s._v(" "),e("p",[s._v("增加 node 节点（提前在"),e("code",[s._v("hosts.ini")]),s._v("文件中增加主机节点）：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ansible-playbook -i inventory/mycluster/hosts.ini scale.yml -b -v -k\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("将"),e("code",[s._v("hosts.ini")]),s._v(" 文件中的 master 和 etcd 的机器增加到多台，执行部署命令：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ansible-playbook -i inventory/mycluster/hosts.ini cluster.yml -b -vvv\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("刪除节点，如果不指定节点就是刪除整个集群：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ansible-playbook -i inventory/mycluster/hosts.ini remove-node.yml -b -v\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("如果需要卸载，可以执行以下命令：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ansible-playbook -i inventory/mycluster/hosts.ini reset.yml -b –vvv\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("升级 K8s 集群，选择对应的 K8s 版本信息，执行升级命令。涉及文件为 "),e("code",[s._v("upgrade-cluster.yml")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ansible-playbook upgrade-cluster.yml -b -i inventory/mycluster/hosts.ini -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kube_version")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("vX.XX.XX -vvv\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"参考链接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("kubespray GetStarted：https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md")])]),s._v(" "),e("li",[e("p",[s._v("使用 Kubespray 在基础设施或云平台上安装 Kubernetes：https://k8smeetup.github.io/docs/getting-started-guides/kubespray/")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);