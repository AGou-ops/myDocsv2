(window.webpackJsonp=window.webpackJsonp||[]).push([[190],{822:function(s,a,t){"use strict";t.r(a);var n=t(6),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"kafka-elfk分布式日志收集"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kafka-elfk分布式日志收集"}},[s._v("#")]),s._v(" Kafka + ELFK分布式日志收集")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/elk%20stack/log_collect.png",alt:""}})]),s._v(" "),t("center",[s._v("***Filebeat --\x3e Kafka --\x3e Logstash --\x3e ES Cluster --\x3e Kibana/Grafana***")]),s._v(" "),t("h2",{attrs:{id:"使用背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用背景"}},[s._v("#")]),s._v(" 使用背景")]),s._v(" "),t("p",[s._v("由于"),t("code",[s._v("ELFK")]),s._v("的局限性，随着"),t("code",[s._v("Beats")]),s._v(" 收集的每秒数据量越来越大，"),t("code",[s._v("Logstash")]),s._v("可能无法承载这么大量日志的处理。虽然说，可以增加 Logstash 节点数量，提高每秒数据的处理速度，但是仍需考虑可能"),t("code",[s._v("Elasticsearch")]),s._v("无法承载这么大量的日志的写入。此时，我们可以考虑 "),t("strong",[s._v("引入消息队列")]),s._v(" （"),t("code",[s._v("Kafka")]),s._v("），进行缓存。")]),s._v(" "),t("h2",{attrs:{id:"filebeat-kafka"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#filebeat-kafka"}},[s._v("#")]),s._v(" Filebeat --\x3e Kafka")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /usr/local/filebeat-7.7.1-linux-x86_64/filebeat.yml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filebeat.inputs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" log\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /usr/local/apache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tomcat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("9.0.34/logs/tomcat_access_log."),t("span",{pre:!0,attrs:{class:"token important"}},[s._v("*.log")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("output.kafka")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# initial brokers for reading cluster metadata")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#hosts: ["kafka1:9092", "kafka2:9092", "kafka3:9092"]')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.16.1.131:9092"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# message topic selection + partitioning")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# topic: '%{[fields.log_topic]}'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("topic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" tomcat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("log\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("partition.round_robin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("reachable_only")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h2",{attrs:{id:"启动-kafka"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动-kafka"}},[s._v("#")]),s._v(" 启动 Kafka")]),s._v(" "),t("p",[s._v("这里为了方便起见，我使用"),t("code",[s._v("docker-compose")]),s._v("脚本来进行快速部署，脚本内容参见[使用 docker-compose 部署 Kafka](../Kafka/使用 docker-compose 部署 Kafka.md)")]),s._v(" "),t("h2",{attrs:{id:"logstash-elasticsearch"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#logstash-elasticsearch"}},[s._v("#")]),s._v(" Logstash --\x3e ElasticSearch")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /usr/local/logstash-7.7.1/config/kafka2es.conf")]),s._v("\ninput "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    kafka "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    codec "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"json"')]),s._v("\n    topics "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tomcat-log"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    bootstrap_servers "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.16.1.131:9092"')]),s._v("\n    auto_offset_reset "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"latest"')]),s._v("\n    group_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"logstash-g1"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\noutput "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    elasticsearch "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    hosts "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://172.16.1.131:9200"')]),s._v("\n    index "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"filebeat_%{[fields][log_source]}-%{+YYYY.MM.dd}"')]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])])],1)}),[],!1,null,null,null);a.default=e.exports}}]);