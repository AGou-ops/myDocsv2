(window.webpackJsonp=window.webpackJsonp||[]).push([[155],{787:function(s,a,n){"use strict";n.r(a);var t=n(6),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"docker-openvswitch"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#docker-openvswitch"}},[s._v("#")]),s._v(" Docker openvswitch")]),s._v(" "),n("h2",{attrs:{id:"openvswitch-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#openvswitch-简介"}},[s._v("#")]),s._v(" openvswitch 简介")]),s._v(" "),n("p",[s._v("openvswitch为我们建立一个扩展到三层网络的网桥，我们知道vlan是不能跨子网的，openvswitch利用了隧道技术，将二层的报文用三层的协议(udp/sdn）重新封装，从而实现二层网络在三层中进行扩展，如下图所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://images2015.cnblogs.com/blog/659305/201604/659305-20160411021401410-1725005604.jpg",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"openvswitch-安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#openvswitch-安装"}},[s._v("#")]),s._v(" openvswitch 安装")]),s._v(" "),n("p",[s._v("openvswitch 官方并未在 REHL 系列提供现成的 RPM 包，所以需要我们手动编译进行安装，在这里我制作一个可直接安装的 RPM 包。")]),s._v(" "),n("ol",[n("li",[s._v("首先从官网下载最新的 LTS 版本：")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://www.openvswitch.org/releases/openvswitch-2.5.9.tar.gz\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xf openvswitch-2.5.9.tar.gz \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ol",{attrs:{start:"3"}},[n("li",[s._v("安装编译所需的依赖包：")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("   yum "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" gcc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" python-devel openssl-devel kernel-devel graphviz "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n       kernel-debug-devel autoconf automake rpm-build redhat-rpm-config "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n       libtool -y\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("ol",{attrs:{start:"3"}},[n("li",[s._v("建立"),n("code",[s._v("rpmbuild")]),s._v("目录：")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" openvswitch-2.5.9.tar.gz /root/rpmbuild/SOURCES\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",{attrs:{start:"4"}},[n("li",[s._v("检查内核开发"),n("code",[s._v("kernel-devel")]),s._v("源码的位置是否正确：")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node01 ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("# "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /lib/modules/"),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("uname")]),s._v(" -r"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" -ln\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3276")]),s._v("\nlrwxrwxrwx.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":26 build -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("/usr/src/kernels/3.10.0-1062.18.1.el7.x86_64"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果这里闪红，则表示不正确")]),s._v("\ndrwxr-xr-x.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 07:53 extra\ndrwxr-xr-x. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":26 kernel\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("852612")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.alias\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("813600")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.alias.bin\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1333")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 07:53 modules.block\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7357")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 07:53 modules.builtin\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9425")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.builtin.bin\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("271605")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.dep\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("379944")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.dep.bin\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("361")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.devname\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("140")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 07:53 modules.drm\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("69")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 07:53 modules.modesetting\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1787")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 07:53 modules.networking\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("97175")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 07:53 modules.order\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("569")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.softdep\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("395089")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.symbols\n-rw-r--r--.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("483655")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 modules.symbols.bin\nlrwxrwxrwx.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":26 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" build\ndrwxr-xr-x.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Mar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 07:53 updates\ndrwxr-xr-x.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("95")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":26 vdso\ndrwxr-xr-x.  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Apr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":28 weak-updates\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[s._v("build是一个无效的称号链接，删除这个链接，重新链接到正确目录：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" /lib/modules/"),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("uname")]),s._v(" -r"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("/build\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /usr/src/kernels/3.10.0-1062.18.1.el7.x86_64 /lib/modules/"),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("uname")]),s._v(" -r"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("/build\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ol",{attrs:{start:"5"}},[n("li",[s._v("开始制作"),n("code",[s._v("RPM")]),s._v("包")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" openvswitch-2.5.9\nrpmbuild -bb --without check rhel/openvswitch.spec\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("ol",{attrs:{start:"6"}},[n("li",[s._v("最后安装所生成的 RPM 包")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("yum localinstall -y /root/rpmbuild/RPMS/x86_64/openvswitch-2.5.9-1.x86_64.rpm \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h2",{attrs:{id:"建立-vxlan-拓扑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#建立-vxlan-拓扑"}},[s._v("#")]),s._v(" 建立 vxLAN 拓扑")]),s._v(" "),n("p",[s._v("环境:")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("主机IP")]),s._v(" "),n("th",[s._v("容器IP及网络")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("172.16.1.128")]),s._v(" "),n("td",[s._v("172.16.128.128（172.16.128.0/24）")])]),s._v(" "),n("tr",[n("td",[s._v("172.16.1.129")]),s._v(" "),n("td",[s._v("172.16.129.129（172.16.129.0/24）")])])])]),s._v(" "),n("p",[s._v("将制作好的 RPM 包发送给另一台主机，直接安装.")]),s._v(" "),n("p",[s._v("在两主机上启动服务："),n("code",[s._v("systemctl start openvswitch.service")])]),s._v(" "),n("p",[s._v("在"),n("code",[s._v("172.16.1.128")]),s._v("主机上：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/sys/net/ipv4/ip_forward \n\novs-vsctl add-br obr0\novs-vsctl add-port obr0 gre0 -- "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" Interface gre0 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gre options:remote_ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.128\nbrctl addbr kbr0\nbrctl addif kbr0 obr0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev docker0 down\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" del dev docker0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/sysconfig/network-scripts/ifcfg-kbr0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ONBOOT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BOOTPROTO")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("static\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("IPADDR")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".128.1\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NETMASK")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GATEWAY")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".128.0\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("USERCTL")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TYPE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Bridge\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("IPV6INIT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/sysconfig/network-scripts/route-ens33 ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".129.0/24 via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.128 dev ens33\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl  restart network.service")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/sys/net/ipv4/ip_forward \n\novs-vsctl add-br obr0\novs-vsctl add-port obr0 gre0 -- "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" Interface gre0 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gre options:remote_ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.129\nbrctl addbr kbr0\nbrctl addif kbr0 obr0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev docker0 down\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" del dev docker0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vi /etc/sysconfig/network-scripts/ifcfg-kbr0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ONBOOT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BOOTPROTO")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("static\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("IPADDR")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".129.1\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NETMASK")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GATEWAY")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".129.0\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("USERCTL")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TYPE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Bridge\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("IPV6INIT")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/sysconfig/network-scripts/route-ens33 ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".128.0/24 via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.129 dev ens33\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl  restart network.service")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[s._v("在"),n("code",[s._v("172.16.1.128")]),s._v("主机执行以下脚本：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 有错误则停止执行")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个openvswitch bridge")]),s._v("\novs-vsctl add-br ovs-br0\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加一个到172.16.1.129的接口")]),s._v("\novs-vsctl add-port ovs-br0 vxlan-port-to-172.16.1.129 -- "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v("  interface vxlan-port-to-172.16.1.129 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("vxlan option:remote_ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.16.1.129"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一对虚拟网卡veth")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" vethx "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name vethContainer\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sleep 3 seconds to wait for the completion of previous work.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将vethx接入到ovs-br0中")]),s._v("\novs-vsctl add-port ovs-br0 vethx\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" vethx up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动docker容器，使用--net=none策略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("containerID")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -tid --net"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("none busybox:latest /bin/sh"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pid")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" inspect -f "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"【【.State.Pid】】"')]),s._v(" $"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("containerID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("containerID")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${containerID}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pid")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果net namespace目录没有创建则新建一个")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/netns"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/run/netns\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将docker容器使用的net namespace 打回原形")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /proc/"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v("/ns/net /var/run/netns/"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns list\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将vethContainer加入到容器的net namespace中")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vethContainer netns "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置vethContainer接口")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" vethContainer "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".128.128/24 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" -a\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br")])]),n("blockquote",[n("p",[s._v("脚本来源于网络。")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 有错误则停止执行")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个openvswitch bridge")]),s._v("\novs-vsctl add-br ovs-br0\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加一个到172.16.1.128的接口")]),s._v("\novs-vsctl add-port ovs-br0 vxlan-port-to-172.16.1.128 -- "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v("  interface vxlan-port-to-172.16.1.128 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("vxlan option:remote_ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.16.1.128"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一对虚拟网卡veth")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" vethx "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name vethContainer\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sleep 3 seconds to wait for the completion of previous work.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将vethx接入到ovs-br0中")]),s._v("\novs-vsctl add-port ovs-br0 vethx\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" vethx up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动docker容器，使用--net=none策略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("containerID")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run -tid --net"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("none busybox:latest /bin/sh"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pid")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" inspect -f "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"【【.State.Pid】】"')]),s._v(" $"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("containerID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("containerID")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${containerID}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pid")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果net namespace目录没有创建则新建一个")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/netns"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/run/netns\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将docker容器使用的net namespace 打回原形")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /proc/"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v("/ns/net /var/run/netns/"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns list\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将vethContainer加入到容器的net namespace中")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vethContainer netns "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置vethContainer接口")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" vethContainer "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".129.129/24 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${pid}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" -a\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);