(window.webpackJsonp=window.webpackJsonp||[]).push([[307],{940:function(s,n,a){"use strict";a.r(n);var t=a(6),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"nginx-平滑升级与回滚"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-平滑升级与回滚"}},[s._v("#")]),s._v(" Nginx 平滑升级与回滚")]),s._v(" "),a("h2",{attrs:{id:"平滑升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#平滑升级"}},[s._v("#")]),s._v(" 平滑升级")]),s._v(" "),a("p",[s._v("大体步骤： 编译安装新版本（与旧版本不同目录）--》备份旧版本的二进制文件 --》拷贝新版本的二进制文件至旧版本目录 --》将旧work进程停掉 --》SUCCESS")]),s._v(" "),a("p",[s._v("以下仅记录关键步骤：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在旧版本的目录的sbin目录下，备份旧版本的二进制文件")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" nginx nginx-1.12.2\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将新版本的二进制文件放置于旧版本的sbin目录下")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/nginx-1.14.2/sbin/nginx "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看旧版本的work进程")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" nginx\nroot       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6324")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:06 ?        00:00:00 nginx: master process /usr/local/nginx-1.12.2/sbin/nginx\nnobody     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6325")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6324")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:06 ?        00:00:00 nginx: worker process\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# work进程")]),s._v("\nroot       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6338")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1244")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:11 pts/0    00:00:00 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" --color"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto nginx\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill掉旧版本的work进程")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" -USR2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6324")]),s._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6324为work进程pid")]),s._v("\n\n* 这时新的master进程已经正常开启，但旧版本work进程仍然存在，使用如下命令将旧work进程平滑停止：\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" -WINCH "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6324")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("ℹ️如果在版本升级完成后，没有任何问题，需要关闭老的master进程的话，可以使用下面的命令：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" -QUIT "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("OLD_MASTER_PID"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"回滚"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#回滚"}},[s._v("#")]),s._v(" 回滚")]),s._v(" "),a("blockquote",[a("p",[s._v("在上面的结果中，我们也能看到老的master进程是一直存在，在没有手工关闭前，它是不会自已关闭的，这种设计是有好处的，好处就是为了升级新版本后，如果出现问题能及时快速的回滚到上一个稳定版本。")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" nginx\nroot       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7513")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:06 ?        00:00:00 nginx: master process /usr/local/nginx-1.12.2/sbin/nginx\nroot       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7413")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7518")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:12 ?        00:00:00 nginx: master process /usr/local/nginx-1.12.2/sbin/nginx\nnobody     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7415")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7624")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:12 ?        00:00:00 nginx: worker processroot       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6350")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1244")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:23 pts/0    00:00:00 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" --color"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("回滚步骤与升级步骤类似，就是用旧版本的二进制文件替换掉新版本的二进制文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" nginx nginx_newer\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" nginx-1.12.2 nginx\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill 掉新版本的master进程")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" -USR1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7518")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);