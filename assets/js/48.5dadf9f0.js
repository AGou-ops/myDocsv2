(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{682:function(s,t,a){"use strict";a.r(t);var n=a(6),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"基于kubernetes平台的cicd持续集成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于kubernetes平台的cicd持续集成"}},[s._v("#")]),s._v(" 基于kubernetes平台的CICD持续集成")]),s._v(" "),a("h3",{attrs:{id:"文章目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文章目录"}},[s._v("#")]),s._v(" 文章目录")]),s._v(" "),a("p",[s._v("[toc]")]),s._v(" "),a("h2",{attrs:{id:"_1-基于k8s集群的jenkins持续集成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-基于k8s集群的jenkins持续集成"}},[s._v("#")]),s._v(" 1.基于k8s集群的Jenkins持续集成")]),s._v(" "),a("p",[s._v("Jenkins更新传统LNMT项目流程很简单，Jenkins也只需要部署在物理服务器即可实现项目版本的持续更新迭代")]),s._v(" "),a("p",[s._v("如果项目是部署在k8s集群，Jenkins还在物理机上部署的话，项目更新流程将会变得繁琐，大致流程：首先Jenkins将项目编译成war包，然后将war在一台物理机上运行，如果运行成功，再调用另一个Jenkins任务，这个Jenkins任务主要的作用就是将war包和ROOT目录copy到初始镜像中，当镜像构建完毕后，将镜像推送至harbor平台，再由运维拿着镜像版本放在k8s里去升级。")]),s._v(" "),a("p",[s._v("如果Jenkins只是单单部署在一台物理机上，某台Jenkins挂掉后，整个CI/CD平台将无法更新迭代，这是一个很严重的后果，如果将Jenkins部署在k8s平台，借助k8s pod自愈功能，Jenkins挂掉的情况几乎不会发生。")]),s._v(" "),a("p",[s._v("Jenkins部署在k8s环境之后，通过建立RBAC授权机制，可以实现Jenkins一键更新迭代到k8s环境，无需在使用物理机环境那么繁琐的步骤")]),s._v(" "),a("blockquote",[a("p",[s._v("当Jenkins与kubernetes集成后的更新流程：")]),s._v(" "),a("p",[s._v("1）Jenkins从gitlab上拉取开发提交的代码")]),s._v(" "),a("p",[s._v("2）Jenkins调用maven进行编译项目")]),s._v(" "),a("p",[s._v("3）Jenkins调用docker将写好dockerfile构建成镜像")]),s._v(" "),a("p",[s._v("4）将镜像推送至harbor仓库")]),s._v(" "),a("p",[s._v("5）Jenkins调用k8s将镜像部署在k8s环境")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/fcebc6a2b3f3211c4481fe783597dce6.png",alt:"img"}})]),s._v(" "),a("h2",{attrs:{id:"_2-将jenkins部署在k8s集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-将jenkins部署在k8s集群"}},[s._v("#")]),s._v(" 2.将Jenkins部署在k8s集群")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("部署思路：")])]),s._v(" "),a("p",[s._v("1.由于Jenkins要更新项目到各个namespace，因此需要做RBAC授权，准备一个ServiceAccount，直接将ServiceAccount绑定到cluster-admin集群角色上，使Jenkins拥有对所有namespace下的项目有操作权限。")]),s._v(" "),a("p",[s._v("2.Jenkins部署采用statefulset控制器，并配合StorageClass动态将Jenkins数据进行持久化。")]),s._v(" "),a("p",[s._v("3.准备svc资源，将Jenkins的8080/50000端口进行暴露。")])]),s._v(" "),a("h3",{attrs:{id:"_2-1-编写jenkins-namespace文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-编写jenkins-namespace文件"}},[s._v("#")]),s._v(" 2.1.编写Jenkins namespace文件")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat jenkins-namespace.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1 \n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Namespace \n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"_2-2-编写jenkins-rbac授权文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-编写jenkins-rbac授权文件"}},[s._v("#")]),s._v(" 2.2.编写Jenkins rbac授权文件")]),s._v(" "),a("p",[s._v("创建一个serviceaccount账号Jenkins，直接将sa账号与cluster-admin集群角色进行绑定")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat jenkins-rbac.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ServiceAccount\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1beta1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterRoleBinding\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("crb\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roleRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterRole\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("admin\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subjects")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ServiceAccount\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"_2-3-编写jenkins-statefulset资源文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-编写jenkins-statefulset资源文件"}},[s._v("#")]),s._v(" 2.3.编写Jenkins statefulset资源文件")]),s._v(" "),a("p",[s._v("Jenkins也会产生数据，因此采用statefulset部署有状态的服务，并配合StorageClass动态创建存储系统")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat jenkins-statefulset.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" StatefulSet\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceAccount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initContainers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("chown\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/jenkins/busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.30")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chown -R 1000:1000 /var/jenkins_home"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("securityContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/jenkins_home\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/jenkins/jenkinsci"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("blueocean"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.24.6\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" JAVA_OPTS\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Xms4096m -Xmx5120m -Duser.timezone=Asia/Shanghai -Dhudson.model.DirectoryBrowserSupport.CSP="')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" slave\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50000")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/jenkins_home\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeClaimTemplates")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storageClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storageclass\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteMany\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10Gi\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br")])]),a("h3",{attrs:{id:"_2-4-编写jenkins-storageclass资源文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-编写jenkins-storageclass资源文件"}},[s._v("#")]),s._v(" 2.4.编写Jenkins StorageClass资源文件")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat jenkins-storageclass.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" storage.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" StorageClass\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storageclass\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("provisioner")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nfs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("01")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("reclaimPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Retain\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"_2-5-编写jenkins-svc资源文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-编写jenkins-svc资源文件"}},[s._v("#")]),s._v(" 2.5.编写Jenkins svc资源文件")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat jenkins-svc.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("svc\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodePort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("38080")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" slave\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50000")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50000")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodePort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50000")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h3",{attrs:{id:"_2-6-准备jenkins镜像并推送至harbor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-准备jenkins镜像并推送至harbor"}},[s._v("#")]),s._v(" 2.6.准备Jenkins镜像并推送至harbor")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker pull jenkinsci/blueocean:1.24.6")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker tag jenkinsci/blueocean:1.24.6 harbor.jiangxl.com/jenkins/jenkinsci-blueocean:1.24.6")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker push harbor.jiangxl.com/jenkins/jenkinsci-blueocean:1.24.6")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_2-7-创建所有资源并查看资源的状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-7-创建所有资源并查看资源的状态"}},[s._v("#")]),s._v(" 2.7.创建所有资源并查看资源的状态")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".创建所有资源\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f ./")]),s._v("\nnamespace/jenkins created\nserviceaccount/jenkins created\nclusterrolebinding.rbac.authorization.k8s.io/jenkins-crb created\nstatefulset.apps/jenkins-master created\nstorageclass.storage.k8s.io/jenkins-storageclass created\nservice/jenkins-svc created\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".查看资源状态\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod,statefulset,svc,storageclass,sa -n jenkins")]),s._v("\nNAME                   READY   STATUS    RESTARTS   AGE\npod/jenkins-master-0   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          31m\n\nNAME                              READY   AGE\nstatefulset.apps/jenkins-master   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     31m\n\nNAME                  TYPE       CLUSTER-IP   EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                         AGE\nservice/jenkins-svc   NodePort   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".2.5   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":38080/TCP,50000:50000/TCP   31m\n\nNAME                                               PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE\nstorageclass.storage.k8s.io/jenkins-storageclass   nfs-storage-01   Retain          Immediate           "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("                  31m\n\nNAME                     SECRETS   AGE\nserviceaccount/jenkins   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         31m\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".查看pvc，已经动态创建\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 jenkins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pvc -n jenkins")]),s._v("\nNAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS           AGE\njenkins-data-jenkins-master-0   Bound    pvc-3f49831b-7faa-456e-9a2f-65b6085933de   10Gi       RWX            jenkins-storageclass   32m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("h3",{attrs:{id:"_2-8-页面安装jenkins"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-8-页面安装jenkins"}},[s._v("#")]),s._v(" 2.8.页面安装Jenkins")]),s._v(" "),a("blockquote",[a("p",[s._v("访问集群节点任意ip+38080端口")]),s._v(" "),a("p",[s._v("访问看到如下页面说明Jenkins还在启动中，当日志输出到下图样子时，刷新Jenkins即可进入系统，复制日志中password解锁Jenkins")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/5072a83139484c61860f966035834408.png",alt:"请添加图片描述"}})])]),s._v(" "),a("p",[a("strong",[s._v("1）解锁Jenkins")])]),s._v(" "),a("p",[s._v("可以在日志中复制password，也可以查看/var/jenkins_home/secrets/initialAdminPassword这个文件")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/fd63e40a9e9f4cc8b62736a8f95e13fd.png",alt:"请添加图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("2）选择插件来安装")])]),s._v(" "),a("p",[s._v("把所有的插件都勾选上，避免后期出现软件依赖")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/a5dc04c56dc34f3098980e8a45329ad3.png",alt:"[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-c56lPtNX-1629451468838)(.\\k8s+jenkins实现持续集成-笔记图片存放\\1621416040614.png)]"}})]),s._v(" "),a("p",[s._v("点击全部即可全部勾选\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20a43cdcdaf04446a9e34d3910cf3720.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("3）等待插件安装完")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/a192f76b08cf490d924b8c07e2fca199.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("4）创建Jenkins账号")]),s._v(" "),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/6da90fc978394f78a6973653aa2d9b40.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("5）设置实例地址")]),s._v(" "),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/b7698c5a282d4fd7805a01ea7e0d7785.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("6）重启Jenkins")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/0147db61d00345bb9bb5c89f20fb3f91.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_2-9-登陆jenkins"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-9-登陆jenkins"}},[s._v("#")]),s._v(" 2.9.登陆Jenkins")]),s._v(" "),a("p",[s._v("账号admin密码admin\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/ad1325a8e3a347d3bc795029cb401a12.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"_3-使用docker部署gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用docker部署gitlab"}},[s._v("#")]),s._v(" 3.使用docker部署gitlab")]),s._v(" "),a("blockquote",[a("p",[s._v("这里只是扩展一下如何用docker部署gitlab，建议采用4中的k8s部署gitlab")])]),s._v(" "),a("h3",{attrs:{id:"_3-1-部署gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-部署gitlab"}},[s._v("#")]),s._v(" 3.1.部署gitlab")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master2 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --hostname 192.168.16.105 -p 8443:443 -p 8080:80 -p 8022:22 --name gitlab --restart always -v /data2/k8s/gitlab-data/config/:/etc/gitlab -v /data2/k8s/gitlab-data/logs/:/var/log/gitlab -v /data2/k8s/gitlab-data/data/:/var/opt/gitlab gitlab/gitlab-ce:13.11.4-ce.0")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master2 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker ps")]),s._v("\nCONTAINER ID        IMAGE                           COMMAND                  CREATED             STATUS                   PORTS                                                               NAMES\n33d868fe0369        gitlab/gitlab-ce:13.11.4-ce.0   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/assets/wrapper"')]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" minutes ago      Up "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" minutes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:8022-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("/tcp, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:8080-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/tcp, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:8443-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/tcp   gitlab\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("当出现以下页面表示gitlab启动完成\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/8aecebfb08ed4dce8db08a824c33bdb1.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_3-2-访问gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-访问gitlab"}},[s._v("#")]),s._v(" 3.2.访问gitlab")]),s._v(" "),a("p",[s._v("访问http://192.168.16.105:8080/")]),s._v(" "),a("p",[s._v("第一次登陆需要设置root密码\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/31be9f25fca64dd699b78ef9bbeaf6c4.png",alt:"在这里插入图片描述"}}),s._v("\n设置完密码即可登陆系统\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/cb47d2b998d940dd897ce6c253a29f20.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"_4-将gitlab部署在k8s集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-将gitlab部署在k8s集群"}},[s._v("#")]),s._v(" 4.将gitlab部署在k8s集群")]),s._v(" "),a("p",[a("strong",[s._v("部署分析：")])]),s._v(" "),a("ul",[a("li",[s._v("gitlab采用statefulset控制器部署，通过StorageClass将gitlab的配置文件、gitlab的数据文件进行持久化存储")]),s._v(" "),a("li",[s._v("由于gitlab镜像集成了很多组件，每个组件在gitlab数据目录所使用的用户属组不同，因此都需要针对每个组件去修改对应的所属用户，否则无权限启动相关组件，首先用docker运行gitlab镜像，查询出gitlab数据目录中不同组件对应的不用所属用户，然后在初始化容器中进行赋权")]),s._v(" "),a("li",[s._v("修改gitlab的配置文件，确定对外提供访问的url")]),s._v(" "),a("li",[s._v("gitlab的80端口通过svc资源进行暴露")])]),s._v(" "),a("h3",{attrs:{id:"_4-1-将gitlab镜像推送至harbor仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-将gitlab镜像推送至harbor仓库"}},[s._v("#")]),s._v(" 4.1.将gitlab镜像推送至harbor仓库")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker tag gitlab/gitlab-ce:13.11.4-ce.0 harbor.jiangxl.com/jenkins/gitlab-ce:13.11.4-ce.0 ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker push  harbor.jiangxl.com/jenkins/gitlab-ce:13.11.4-ce.0 ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"_4-2-使用docker运行gitlab查询用户的id号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-使用docker运行gitlab查询用户的id号"}},[s._v("#")]),s._v(" 4.2.使用docker运行gitlab查询用户的id号")]),s._v(" "),a("p",[s._v("gitlab每个组件都是不同的所属用户来管理，我们不明确每个用户的uid、gid是多少，因此需要先用docker启动查询一下")]),s._v(" "),a("p",[s._v("需要记好这些组件的用户uid、gid，一会在statfulset资源中定义初始化容器时会用到")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".使用docker运行gitlab容器\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d harbor.jiangxl.com/jenkins/gitlab-ce:13.11.4-ce.0")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".进入容器\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it 33d868fe0369 bash")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".查看gitlab数据路径下各组件使用的所属用户\nroot@192:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll /var/opt/gitlab/")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" root              root       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:12 ./\ndrwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root              root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":17 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/\ndrwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:01 .bundle/\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("363")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:01 .gitconfig\ndrwx---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:01 .ssh/\ndrwxr-x---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" gitlab-prometheus root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:11 alertmanager/\ndrwx---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               root          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:01 backups/\n-rw---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("-  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root              root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("38")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:06 bootstrapped\ndrwx---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:01 git-data/\ndrwx---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               root        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:11 gitaly/\ndrwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:01 gitlab-ci/\ndrwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:11 gitlab-exporter/\ndrwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               root        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("160")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:11 gitlab-rails/\ndrwx---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:10 gitlab-shell/\ndrwxr-x---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("               gitlab-www   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:11 gitlab-workhorse/\ndrwx---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" gitlab-prometheus root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:12 grafana/\ndrwx---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" root              root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" 02:21 logrotate/\ndrwxr-x---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" root              gitlab-www  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("163")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:05 nginx/\ndrwx---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" gitlab-psql       root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:11 postgres-exporter/\ndrwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" gitlab-psql       root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("81")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:11 postgresql/\ndrwxr-x---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" gitlab-prometheus root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:11 prometheus/\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root              root        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("226")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:12 public_attributes.json\ndrwxr-x---"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" gitlab-redis      "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" 02:29 redis/\n-rw-r--r--  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root              root         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" 09:01 trusted-certs-directory-hash\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".只需要看postgresql、reids、gitlab-data、prometheus目录的用户即可，主要这四个\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#可以看到gitlab-data的用户是git、postgresql的用户是gitlab-psql、redis的是gitlab-redis")]),s._v("\nroot@192:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id git")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("998")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("git"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("998")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("git"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("998")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("git"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot@192:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@192:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id gitlab-psql")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("996")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-psql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("996")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-psql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("996")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-psql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot@192:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@192:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id gitlab-redis")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("997")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("997")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("997")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot@192:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nroot@192:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id gitlab-prometheus")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("992")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-prometheus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("992")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-prometheus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("992")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gitlab-prometheus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br")])]),a("h3",{attrs:{id:"_4-3-编写gitlab-storageclass-资源文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-编写gitlab-storageclass-资源文件"}},[s._v("#")]),s._v(" 4.3.编写gitlab StorageClass 资源文件")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim gitlab-storageclass.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" storage.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" StorageClass\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storageclass\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("provisioner")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nfs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("01")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("reclaimPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Retain\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"_4-4-编写gitlab-statefulset-资源文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-编写gitlab-statefulset-资源文件"}},[s._v("#")]),s._v(" 4.4.编写gitlab statefulset 资源文件")]),s._v(" "),a("p",[s._v("StorageClass pvc模板定义两个，一个存储gitlab数据，一个存储gitlab配置文件")]),s._v(" "),a("p",[s._v("将刚刚查到的用户uid、gid，通过初始化容器分别赋权限给每个组件目录")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim gitlab-statefulset.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" StatefulSet\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initContainers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#定义初始化容器，将每个组件路径赋予对应的用户权限")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("git\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/jenkins/busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.30")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chown -R 998:998 /var/opt/gitlab"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#git用户授权整个gitlab数据目录")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("securityContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启特权模式")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("  \n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将数据持久化的pvc进行挂载")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/opt/gitlab\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("psql\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/jenkins/busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.30")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chown -R 996:996 /var/opt/gitlab/postgresql*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#gitlab-psql授权postgresql目录")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("securityContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/opt/gitlab\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("redis\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/jenkins/busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.30")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chown -R 997:997 /var/opt/gitlab/redis"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#gitlab-redis授权redis目录")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("securityContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/opt/gitlab\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prome                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#gitlab-prometheus用户授权prometheus目录")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/jenkins/busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.30")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chown -R 992:992 /var/opt/gitlab/alertmanager /var/opt/gitlab/grafana /var/opt/gitlab/prometheus"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("securityContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/opt/gitlab\n\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("chown         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这个初始化容器主要就是把配置目录进行授权，可做可不做，因为这个目录的所属用户就是root，而nfs创建的存储路径默认也是root的所属")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/jenkins/busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.30")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chown -R 998:998 /etc/gitlab"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#授权给gitlab用户")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("securityContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  \n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/gitlab\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#定义主容器")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/jenkins/gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ce"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("13.11.4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ce.0\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#挂载持久化数据卷到容器的路径")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/opt/gitlab\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/gitlab\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeClaimTemplates")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#定义pvc模板")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#metadata是数组形式，因此可以定义多个，一个metadata就是一个pvc模板")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#pvc名称")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storageClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storageclass     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#使用的StorageClass名称")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteMany           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#访问模式为多主机可读写")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10Gi\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storageClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storageclass\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteMany\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1Gi\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br")])]),a("h3",{attrs:{id:"_4-5-编写gitlab-service-资源文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-编写gitlab-service-资源文件"}},[s._v("#")]),s._v(" 4.5.编写gitlab service 资源文件")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim gitlab-svc.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("svc\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" jenkins\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodePort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30080")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gitlab\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h3",{attrs:{id:"_4-6-创建所有资源并查看状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-创建所有资源并查看状态"}},[s._v("#")]),s._v(" 4.6.创建所有资源并查看状态")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".创建所有资源\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f ./")]),s._v("\nstatefulset.apps/gitlab created\nstorageclass.storage.k8s.io/gitlab-storageclass created\nservice/gitlab-svc created\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".查看资源的状态\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get all -n jenkins")]),s._v("\nNAME                   READY   STATUS    RESTARTS   AGE\npod/gitlab-0           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4m21s\npod/jenkins-master-0   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          18h\n\nNAME                  TYPE       CLUSTER-IP      EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                          AGE\nservice/gitlab-svc    NodePort   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".97.95    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":30080/TCP                     57m\nservice/jenkins-svc   NodePort   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.99")]),s._v(".113.179   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":38080/TCP,50000:50000/TCP   23h\n\nNAME                              READY   AGE\nstatefulset.apps/gitlab           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     57m\nstatefulset.apps/jenkins-master   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     23h\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".查看pvc资源的状态\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pvc -n jenkins")]),s._v("\nNAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS           AGE\ngitlab-config-gitlab-0          Bound    pvc-91e63538-e07d-4196-82e8-4195b29d9352   1Gi        RWX            gitlab-storageclass    64m\ngitlab-data-gitlab-0            Bound    pvc-2a300c8d-49e6-4035-99f1-81c3e190fe3e   10Gi       RWX            gitlab-storageclass    57m\njenkins-data-jenkins-master-0   Bound    pvc-9efb572b-d566-418d-bb6e-b225b43de4a5   10Gi       RWX            jenkins-storageclass   23h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("h3",{attrs:{id:"_4-7-修改gitlab配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-7-修改gitlab配置"}},[s._v("#")]),s._v(" 4.7.修改gitlab配置")]),s._v(" "),a("p",[s._v("当gitlab服务启动之后，配置文件和数据目录就会存储在pvc上，我们需要修改gitlab的配置文件明确访问地址")]),s._v(" "),a("p",[s._v("主要：这里只写地址，不要加端口，如果加了除80以外的端口，那么容器里gitlab的80就会改成你指定的端口，那么做得svc将会失效，无法暴露gitlab")]),s._v(" "),a("p",[s._v("这一步也可以不做，因为对于k8s而言都是通过集群任意节点ip去映射的")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master2 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /data2/k8s/storageclass/jenkins-gitlab-config-gitlab-0-pvc-91e63538-e07d-4196-82e8-4195b29d9352/gitlab.rb ")]),s._v("\nexternal_url "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://192.168.16.106'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("修改完重新部署一下gitlab即可")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl replace -f gitlab-statefulset.yaml ")]),s._v("\nstatefulset.apps/gitlab replaced\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_4-8-访问gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-访问gitlab"}},[s._v("#")]),s._v(" 4.8.访问gitlab")]),s._v(" "),a("p",[s._v("访问http://集群任意节点ip:30080端口")]),s._v(" "),a("blockquote",[a("p",[s._v("gitlab启动缓慢，进入容器查看gitlab状态，都是run后即可访问")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/3cb3db85c0a44853bb427cc3f739f8ef.png",alt:"在这里插入图片描述"}})])]),s._v(" "),a("p",[a("strong",[s._v("1）设置用户密码")])]),s._v(" "),a("p",[s._v("最少8位，这里设置admin123\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/f272c0ffc079443199a81e55f95fba69.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("2）进入gitlab")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/207da6d0e57b43008394ab964311a6f2.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("3）设置语言为中文")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/b1c0dfdc00c24d8588f29c1ef4664fae.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"_5-提交程序代码到gitlab上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-提交程序代码到gitlab上"}},[s._v("#")]),s._v(" 5.提交程序代码到gitlab上")]),s._v(" "),a("h3",{attrs:{id:"_5-1-新建一个项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-新建一个项目"}},[s._v("#")]),s._v(" 5.1.新建一个项目")]),s._v(" "),a("p",[a("strong",[s._v("1）点击新建项目")]),s._v(" "),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/77ce6e59d41d4ec1b016f50bd766ef68.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("2）创建空白项目")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/bf036a4f46f84a9e94d1d137ee7d310f.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("3）填写项目信息")])]),s._v(" "),a("p",[s._v("可见级别设置为公开\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/101cb12d291e489abf69647313fecc9d.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("4）创建完成")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/c1de124f7b624b2b95efcf335767eecb.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_5-2-将程序代码提交到gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-将程序代码提交到gitlab"}},[s._v("#")]),s._v(" 5.2.将程序代码提交到gitlab")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 python-demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git init")]),s._v("\n初始化空的 Git 版本库于 /root/gitlab_project/python-demo/.git/\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 python-demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git remote add origin http://192.168.16.106:30080/root/blog_project.git")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 python-demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git add .")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 python-demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# git commit -m "Initial commit"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 python-demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git push -u origin master")]),s._v("\nUsername "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://192.168.16.106:30080'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" root        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#输入用户名")]),s._v("\nPassword "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://root@192.168.16.106:30080'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#输入密码")]),s._v("\nCounting objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(", done.\nDelta compression using up to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" threads.\nCompressing objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v("/44"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", done.\nWriting objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v("/48"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("978.49")]),s._v(" KiB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes/s, done.\nTotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("delta "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", reused "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("delta "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nTo http://192.168.16.106:30080/root/blog_project.git\n * "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("new branch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("      master -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" master\n分支 master 设置为跟踪来自 origin 的远程分支 master。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/d4306e08735645e5ae24a93123b7a064.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"_6-jenkins集成gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-jenkins集成gitlab"}},[s._v("#")]),s._v(" 6.Jenkins集成gitlab")]),s._v(" "),a("p",[s._v("必须在jenkins配置gitlab地址，否则pipeline找不到git地址")]),s._v(" "),a("h3",{attrs:{id:"_6-1-在jenkins上安装gitlab插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-在jenkins上安装gitlab插件"}},[s._v("#")]),s._v(" 6.1.在Jenkins上安装gitlab插件")]),s._v(" "),a("p",[s._v("修改Jenkins默认源为清华源")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".修改源\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /data2/k8s/storageclassjenkins-jenkins-data-jenkins-master-0-pvc-9efb572b-d566-418d-bb6e-b225b43de4a5/updates\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/http:\\/\\/updates.jenkins- ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g'")]),s._v(" default.json\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g'")]),s._v(" default.json\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".重启Jenkins\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl replace -f /root/k8s1.19/jenkins/jenkins-statefulset.yaml ")]),s._v("\nstatefulset.apps/jenkins-master replaced\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("系统管理—>插件管理—>可选插件—>搜索gitlab—>安装\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/07defd42b2a5485ba30659d6d4d775af.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_6-2-在gitlab上生成token"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-在gitlab上生成token"}},[s._v("#")]),s._v(" 6.2.在gitlab上生成token")]),s._v(" "),a("p",[s._v("edit profile—>>访问令牌—>>填写token名称—>>勾选权限范围\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/63547133425548b5a3e5e3a902cf90b3.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("token只显示一次，妥善保管：F4N8_LrfC7BdNWXXyJA2")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/41554f761e5742c9af47c519ceedaf51.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_6-3-在jenkins添加gitlab-api-token"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-在jenkins添加gitlab-api-token"}},[s._v("#")]),s._v(" 6.3.在Jenkins添加gitlab api token")]),s._v(" "),a("p",[s._v("系统管理—>找到gitlab—>进行配置即可")]),s._v(" "),a("p",[s._v("Connection name：gitlab-token")]),s._v(" "),a("p",[s._v("Gitlab host URL：http://192.168.16.104:30080/")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/04b27f6631e648c0a81627335fdab789.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("填写完基本信息后点击添加gitlab token，类型只能选择gitlab api token，将token粘进去即可")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/3a3cf1606a7b45c6b02a3132aab80ac0.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("添加完token之后，下拉选择刚刚添加的token，不再变红说明连接gitlab成功")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/6af8522a35b843e7a3da53e2a3179bd4.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"_7-jenkins分布式master-slave模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-jenkins分布式master-slave模式"}},[s._v("#")]),s._v(" 7.Jenkins分布式master-slave模式")]),s._v(" "),a("p",[s._v("jenkins分布式就是有多个slave节点，当需要构建的项目非常多时，master的性能会有影响，slave会承担master的工作量，在slave在上创建项目。slave节点与master的区别就在于slave不需要安装Jenkins")]),s._v(" "),a("p",[s._v("slave节点有很多方式部署，我们采用")]),s._v(" "),a("h3",{attrs:{id:"_7-1-新增jenkins节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-新增jenkins节点"}},[s._v("#")]),s._v(" 7.1.新增Jenkins节点")]),s._v(" "),a("p",[a("strong",[s._v("1）系统管理—>节点管理—>新建节点—>填写节点名称—>固定节点—>确定")]),s._v(" "),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/95f634c391aa41359aba7c928eb3e693.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("2）添加节点详细信息")])]),s._v(" "),a("p",[s._v("名字：Jenkins-slave1-107")]),s._v(" "),a("p",[s._v("执行器数量：3")]),s._v(" "),a("p",[s._v("远程工作目录：/data/jenkins_jobs")]),s._v(" "),a("p",[s._v("标签：Jenkins-slave1-107 #用于让Jenkins某个任务运行在某个节点上")]),s._v(" "),a("p",[s._v("用法：尽可能的使用这个节点")]),s._v(" "),a("p",[s._v("启动方式：通过java web启动代理")]),s._v(" "),a("p",[s._v("自定义工作目录：/data/jenkins_jobs\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/24e8095eed63443f90c3b86db984ec93.jpg",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("3）添加完节点发现节点是红的，这说明代理程序还没有启动，Jenkins不知道节点是谁")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/3dccdb73b2834db791fb00270d95d0e5.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("点击节点，进去后会看到如何启动agent，右键复制agent.jar拿到链接地址，去对应的服务器上下载jar包，然后启动即可成功添加节点\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/747440af22584bf5867db7b32b7fa9dc.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".创建节点工作目录\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node2 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /data/jenkins_jobs")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node2 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /data/jenkins_jobs")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".下载agent程序\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node2 /data/jenkins_jobs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget http://192.168.16.104:38080/jnlpJars/agent.jar")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".启动agent\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node2 /data/jenkins_jobs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# nohup java -jar agent.jar -jnlpUrl http://192.168.16.104:38080/computer/Jenkins-slave1-107/jenkins-agent.jnlp -secret efbde6c51590ca2c9097e6866de9f2d18520bfc05440a1872135e78b47283721 -workDir "/data/jenkins_jobs" &')]),s._v("\n\n\n命令解释：\n java -jar agent.jar "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动jar包")]),s._v("\n -jnlpUrl http://192.168.16.104:38080/computer/Jenkins-slave1-107/jenkins-agent.jnlp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这个路径就是我们在Jenkins上新建节点之后的节点所在路径，如果不指定，Jenkins根本不知道这个节点对应哪台服务器")]),s._v("\n -secret efbde6c51590ca2c9097e6866de9f2d18520bfc05440a1872135e78b47283721 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#认证")]),s._v("\n -workDir "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data/jenkins_obs"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#工作目录")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("agent启动后在Jenkins页面上观察节点，发现已经是可用状态\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/5199668c5f564bb78b30223cc63d465d.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_7-2-新建一个任务运行在slave1节点上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-新建一个任务运行在slave1节点上"}},[s._v("#")]),s._v(" 7.2.新建一个任务运行在slave1节点上")]),s._v(" "),a("p",[a("strong",[s._v("1）配置任务—>general—>限制项目的运行节点—>填写节点设置的标签即可")]),s._v(" "),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/385087446afa435da77418de3cebfdf5.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("2）运行任务观察运行在哪个节点")])]),s._v(" "),a("p",[s._v("选择master分支，开始构建\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/11026daa09754df8892cc7c42d434b32.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("任务已经运行到了Jenkins-slave1-107节点上")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/f4003605156e44fc994c7a9da3f63b69.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("钉钉已经收到信息并且在节点工作目录已经产生数据")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/2b0b214b6069439c837821a44b043a74.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_7-3-观察节点关联的执行任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-观察节点关联的执行任务"}},[s._v("#")]),s._v(" 7.3.观察节点关联的执行任务")]),s._v(" "),a("blockquote",[a("p",[s._v("到这一步CI/CD平台已经部署完成，我们可以新建一个流程，更新程序到kubernetes平台\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/37216cf5a5824c899d172e8f4137e2c0.png",alt:"[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-EzMPDf4Q-1629451468904)(.\\k8s+jenkins实现持续集成-笔记图片存放\\1623125096721.png)]"}})])]),s._v(" "),a("h2",{attrs:{id:"_8-使用pipeline流水线将know-system项目更新到kubernetes环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-使用pipeline流水线将know-system项目更新到kubernetes环境"}},[s._v("#")]),s._v(" 8.使用pipeline流水线将know-system项目更新到kubernetes环境")]),s._v(" "),a("p",[a("strong",[s._v("k8s更新可以采用两种方式")])]),s._v(" "),a("p",[s._v("1.将资源yaml文件也上传到代码仓库，项目打完镜像后，可以通过替换deployment资源我们指定image的字符串，把最新版本的镜 像替换到deployment资源中，最后执行kubectl apply ./完成更新")]),s._v(" "),a("p",[s._v("2.执行kubectl 命令更新deployment资源的镜像")]),s._v(" "),a("p",[a("strong",[s._v("由于我们构建任务都是通过agent去运行的，agent部署在k8s node节点，继承了docker、kubectl命令，因此不必担心kubectl命令不能用")])]),s._v(" "),a("h3",{attrs:{id:"_8-1-实现思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-实现思路"}},[s._v("#")]),s._v(" 8.1.实现思路")]),s._v(" "),a("p",[s._v("1.首先将know-system在k8s中进行部署，实现可以访问的状态")]),s._v(" "),a("p",[s._v("2.将部署know-system的yaml文件复制到代码目录中，并将deployment资源中容器image对应的镜像改成一个字符串，这样pipeline更新时可以通过更换这个字符串，把最新的镜像版本替换到deployment资源中完成更新，最后将代码及部署文件推送到gitlab")]),s._v(" "),a("p",[s._v("3.优化pipeline脚本，增加k8s部署步骤")]),s._v(" "),a("p",[s._v("4.更新代码，使用流水线更新项目到k8s")]),s._v(" "),a("h3",{attrs:{id:"_8-2-将know-system部署在k8s中"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-将know-system部署在k8s中"}},[s._v("#")]),s._v(" 8.2.将know-system部署在k8s中")]),s._v(" "),a("p",[a("strong",[s._v("1）准备项目yaml文件")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[s._v("1.准备deployment资源\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat nginx-depoly.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.jiangxl.com/project/nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("code\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data/code\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data/nginx/conf/conf.d/\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("configMap")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("configmap\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("persistentVolumeClaim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("claimName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pvc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("know\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readOnly")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n\n2.准备configmap资源\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat nginx-configmap.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ConfigMap\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("configmap\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("know.jiangxl.com.conf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v("\n    server {\n      listen 80;\n      server_name know.jiangxl.com;\n      location / {\n        root /data/code/know_system;\n        index index.html;\n      }\n    }")]),s._v("\n\n3.准备svc资源\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master1 know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat nginx-svc.yaml ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" know"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("    \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br")])]),a("p",[a("strong",[s._v("2）创建所有资源")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 know-system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f ./")]),s._v("\nconfigmap/nginx-configmap unchanged\ndeployment.apps/know-system configured\nservice/nginx-service configured\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("3）查看项目首页")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/5c579af45d324e1c857e235d62ca72f1.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_8-3-将k8s资源文件提交至gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-将k8s资源文件提交至gitlab"}},[s._v("#")]),s._v(" 8.3.将k8s资源文件提交至gitlab")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".将部署文件复制到代码目录\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 know_system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir deploy")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 know_system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp /root/k8s1.19/know-system/* deploy/")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".修改deployment资源中的image\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将image对应的镜像改成一个字符串，pipeline更新时可以通过更换这个字符串把最新的镜像替换到deployment资源中")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 know_system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim deploy/nginx-depoly.yaml ")]),s._v("\n        image: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("updateimage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".提交至gitlab\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 know_system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git add .")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 know_system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# git commit -m "deploy"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master1 know_system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git push origin master")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"_8-4-编写jenkins-pipeline将项目更新到k8s"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-编写jenkins-pipeline将项目更新到k8s"}},[s._v("#")]),s._v(" 8.4.编写Jenkins pipeline将项目更新到k8s")]),s._v(" "),a("blockquote",[a("p",[s._v("当前pipeline脚本主要是更新用yaml文件创建的项目pod现")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pipeline "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    agent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" label "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Jenkins-slave1-107'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                //让该pipeline始终运行在Jenkins-slave1-107 Jenkins agent节点上，因为这个节点所在的服务器可以运行k8s集群的docker、kubelet命令\n\n    environment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                                   //environment主要用于定义环境变量，可以把一些常用到的值做成环境变量\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("IMAGE_REPO")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"harbor.jiangxl.com/project"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  parameters "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                               //定义参数化构建流程\n    gitParameter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'VERSION'")]),s._v(",defaultValue: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'master'")]),s._v(",type: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'BRANCH'")]),s._v(",description: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'选择要更新的分支'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("             //定义一个gitparamters参数化构建过程，用于选择更新的代码\n    string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'project'")]),s._v(",defaultValue: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'know-system'")]),s._v(",description: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'项目名称'")]),s._v(",trim: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                  //定义一个空白字符串，声明项目名称\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n    stages "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                        //定义pipeline执行阶段\n        stage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'运维确认信息'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                                 //阶段1，使用一个交互式，让运行确认更新信息，如果有误可直接退出更新，避免更新错误\n            steps "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                input message: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('"                          \n                jobname: '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project}")]),s._v("\n                branch: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${VERSION}")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('", ok: '),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"更新"')]),s._v("                       //交互式输出一个更新的项目和分支号\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        stage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'拉取项目代码'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                                  //阶段2，用于拉取git上对应的项目代码\n            steps "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        checkout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$class")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'GitSCM'")]),s._v(", branches: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$VERSION'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", extensions: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", userRemoteConfigs: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("credentialsId: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gitlab-root'")]),s._v(", url: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://192.168.16.106:30080/root/know_system.git'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  \n        stage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'构建项目镜像'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                             //阶段3.用于将项目代码更新到docker初始镜像中，主要步骤就是生产一个dockerfile，将代码复制到镜像中，最后根据Dockerfile构建出镜像\n            steps "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('"              \n                '),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\nFROM harbor.jiangxl.com/project/nginx-project:v1-code\n\nRUN mkdir /data/code/know_system\nCOPY  ./* /data/code/know_system/\nEXPOSE 80\n        "')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("Dockerfile\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('"                             //编写一个Dockerfile，定义初始镜像，并将更新的代码复制到容器的指定路径\n\n        '),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'docker build -t ${IMAGE_REPO}/${project}:master-v${BUILD_ID} .'")]),s._v("   //最终镜像的名称就是harbor.jiangxl.com/project/know-system:master-v1                \n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("   \n\n        stage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'推送镜像到harbor仓库'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("             //阶段4，将构建好的镜像推送至harbor仓库中，便于k8s拉取更新程序\n            steps "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'docker push ${IMAGE_REPO}/${project}:master-v${BUILD_ID}'")]),s._v("   //推送镜像到harbor仓库\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("           \n        stage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'将项目更新到k8s'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                     //阶段5，主要是更新k8s中项目使用的容器，将最新构建的镜像替换到项目pod中，然后更新pod\n            steps "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                                     //使用kubectl命令更新项目\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"sed -i 's#{{updateimage}}#"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${IMAGE_REPO}")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project}")]),s._v(":master-v"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${BUILD_ID}")]),s._v("#g' deploy/*\"")]),s._v("       //将deployment资源中我们写死的镜像版本字符串，替换成刚刚推送至harbor仓库的镜像版本\n                "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl apply -f deploy/'")]),s._v("                   //当镜像版本替换后，更新资源的yaml文件即可完成项目更新\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                  \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    post "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      success "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("       //构建成功了发送一个构成成功的消息到钉钉\n          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"构建成功，发送消息到钉钉"')]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('"\n          '),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://oapi.dingtalk.com/robot/send?access_token=6719ac958daf4f31114cb0c1289837c9aca45d111d8653b04c3d6ae164f25146'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"msgtype": "text","text": {"content":"😄👍构建成功👍😄\\n 关键字：jenkins\\n 项目 名称: ${JOB_BASE_NAME}\\n 更新的分支号: ${VERSION}\\n 本次构建的镜像版本：${IMAGE_REPO}/${project}:master-v${BUILD_ID}\\n 构建地址：${RUN_DISPLAY_URL} "}}\'')]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('"\n      '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      failure "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("       //构建失败了发送一个构成成功的消息到钉钉\n          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"构建失败，发送消息到钉钉"')]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('"\n          '),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://oapi.dingtalk.com/robot/send?access_token=6719ac958daf4f31114cb0c1289837c9aca45d111d8653b04c3d6ae164f25146'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n -H "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-Type: application/json'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"msgtype": "text","text": {"content":"😖❌构建失败❌😖\\n 关键字：jenkins\\n 项目 名称: ${JOB_BASE_NAME}\\n 更新的分支号: ${VERSION}\\n 本次构建的镜像版本：${IMAGE_REPO}/${project}:master-v${BUILD_ID}\\n 构建地址：${RUN_DISPLAY_URL} "}}\'')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v('"\n      '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      always "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("          //无论成功还是失败都执行此步骤\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"构建流程结束"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br")])]),a("h3",{attrs:{id:"_8-5-将pipeline粘贴到流水线任务中"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-将pipeline粘贴到流水线任务中"}},[s._v("#")]),s._v(" 8.5.将pipeline粘贴到流水线任务中")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/6b567d43deb0474e8b57f717070c1e95.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h3",{attrs:{id:"_8-6-构建master分支完成项目更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-6-构建master分支完成项目更新"}},[s._v("#")]),s._v(" 8.6.构建master分支完成项目更新")]),s._v(" "),a("p",[a("strong",[s._v("1）选择更新信息")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/cebe0301954b46e0a696ebe6e2d05e93.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("2）运维确认信息")]),s._v(" "),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/e14279c1a0824528a12931943441b2ab.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("3）pipeline任务更新成功")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/b322ccd2bf6e48f5a5609660bc537d55.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("4）在blue ocean查看此次更新的镜像版本")]),s._v(" "),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/0e471501cd6c4617b630b6bebb53f41c.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("5）在rancher上观察项目是否更新成最新的镜像版本")])]),s._v(" "),a("p",[s._v("更新流程顺利完成！\n"),a("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/b261c18ee6c646a2848342ae64dda144.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("blockquote",[a("p",[s._v("该文章为转载内容，仅做备份私人学习使用，原文：https://jiangxl.blog.csdn.net/article/details/119828244")])])])}),[],!1,null,null,null);t.default=e.exports}}]);