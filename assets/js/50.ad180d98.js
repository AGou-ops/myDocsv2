(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{685:function(s,a,t){"use strict";t.r(a);var n=t(6),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"prometheus-grafana全方位监控kubernetes集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#prometheus-grafana全方位监控kubernetes集群"}},[s._v("#")]),s._v(" Prometheus+Grafana全方位监控Kubernetes集群")]),s._v(" "),t("h3",{attrs:{id:"文章目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#文章目录"}},[s._v("#")]),s._v(" 文章目录")]),s._v(" "),t("p",[s._v("[toc]")]),s._v(" "),t("h2",{attrs:{id:"_1-k8s监控指标"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-k8s监控指标"}},[s._v("#")]),s._v(" 1.k8s监控指标")]),s._v(" "),t("p",[t("strong",[s._v("kubernetes本身监控")])]),s._v(" "),t("ul",[t("li",[s._v("Node资源利用率")]),s._v(" "),t("li",[s._v("Node数量")]),s._v(" "),t("li",[s._v("Pods数量")]),s._v(" "),t("li",[s._v("资源对象状态")])]),s._v(" "),t("p",[t("strong",[s._v("Pod监控")])]),s._v(" "),t("ul",[t("li",[s._v("pod数量")]),s._v(" "),t("li",[s._v("容器资源利用率")]),s._v(" "),t("li",[s._v("应用程序")])]),s._v(" "),t("p",[t("strong",[s._v("实现思路")])]),s._v(" "),t("ul",[t("li",[s._v("pod性能\n"),t("ul",[t("li",[s._v("使用cadvisor进行实现，监控容器的CPU、内存利用率")])])]),s._v(" "),t("li",[s._v("Node性能\n"),t("ul",[t("li",[s._v("使用node-exporter实现，主要监控节点CPU、内存利用率")])])]),s._v(" "),t("li",[s._v("K8S资源对象\n"),t("ul",[t("li",[s._v("使用kube-state-metrics实现，主要用于监控pod、deployment、service")])])])]),s._v(" "),t("p",[s._v("k8s服务发现参考文档： https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config")]),s._v(" "),t("p",[s._v("本文将会实现k8s全方位监控，并配合grafana展示k8s资源对象的使用状态，以及配合alertmanager告警")]),s._v(" "),t("h2",{attrs:{id:"_2-k8s基础环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-k8s基础环境准备"}},[s._v("#")]),s._v(" 2.k8s基础环境准备")]),s._v(" "),t("h3",{attrs:{id:"_2-1-环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-环境准备"}},[s._v("#")]),s._v(" 2.1.环境准备")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("IP")]),s._v(" "),t("th",[s._v("角色")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("192.168.16.106")]),s._v(" "),t("td",[s._v("k8s-master")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.16.104")]),s._v(" "),t("td",[s._v("k8s-node1")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.16.107")]),s._v(" "),t("td",[s._v("k8s-node2")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.16.105")]),s._v(" "),t("td",[s._v("nfs")])])])]),s._v(" "),t("h3",{attrs:{id:"_2-2-部署nfs作为prometheus存储"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-部署nfs作为prometheus存储"}},[s._v("#")]),s._v(" 2.2.部署nfs作为prometheus存储")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /data/prometheus")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum -y install nfs-utils")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/exports")]),s._v("\n/data/prometheus   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".16.0/24"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw,sync,no_root_squash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart nfs")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# showmount -e")]),s._v("\nExport list "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" nfs:\n/data/prometheus "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".16.0/24\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chomd -R 777 /data")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("h3",{attrs:{id:"_2-3-获取prometheus-yaml文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-获取prometheus-yaml文件"}},[s._v("#")]),s._v(" 2.3.获取prometheus yaml文件")]),s._v(" "),t("blockquote",[t("p",[s._v("在这里下载")]),s._v(" "),t("p",[s._v("https://github.com/kubernetes/kubernetes/tree/release-1.16/cluster/addons/prometheus")]),s._v(" "),t("p",[s._v("直接克隆完整目录也可以")]),s._v(" "),t("p",[s._v("https://github.com/kubernetes/kubernetes.git")]),s._v(" "),t("p",[s._v("⚠️修改：https://gitlab.com/AGou-ops/k8s_prometheus_yaml.git")]),s._v(" "),t("p",[s._v("prometheus在github的k8s目录中master分支已经找不到了，可以在release-1.16这里找到")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".拉取prometheus yaml文件\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git clone https://github.com/kubernetes/kubernetes.git")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".将prometheus yaml文件复制到其他目录\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp -rp kubernetes/cluster/addons/prometheus/ . ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[t("strong",[s._v("本人的yaml文件")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106165528931.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("官方yaml文件")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106165536705.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("文件说明")])]),s._v(" "),t("p",[s._v("主要分为四部分：prometheus部署、alertmanager部署、kube-state-metrics部署、node-exporter部署")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("文件名")]),s._v(" "),t("th",[s._v("作用")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("alertmanager-configmap.yaml")]),s._v(" "),t("td",[s._v("alertmanager配置集合的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("alertmanager-deployment.yaml")]),s._v(" "),t("td",[s._v("alertmanager创建pod的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("alertmanager-pvc.yaml")]),s._v(" "),t("td",[s._v("alertmanager挂载存储卷的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("alertmanager-service.yaml")]),s._v(" "),t("td",[s._v("alertmanager对外暴露端口的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("grafana_pv_pvc.yaml")]),s._v(" "),t("td",[s._v("grafana挂载存储卷的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("grafana_statefulset.yaml")]),s._v(" "),t("td",[s._v("grafana发布pod的yaml文件，采用statefulset资源")])]),s._v(" "),t("tr",[t("td",[s._v("grafana_svc.yaml")]),s._v(" "),t("td",[s._v("grafana对外暴露端口的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("install_node_exportes.sh")]),s._v(" "),t("td",[s._v("批量在node节点安装node_exporter的脚本")])]),s._v(" "),t("tr",[t("td",[s._v("k8s_time.yaml")]),s._v(" "),t("td",[s._v("k8s同步宿主机时间的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("kube-state-metrics-deployment.yaml")]),s._v(" "),t("td",[s._v("k8s采集资源状态指标程序的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("kube-state-metrics-rbac.yaml")]),s._v(" "),t("td",[s._v("8s采集程序授权的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("kube-state-metrics-service.yaml")]),s._v(" "),t("td",[s._v("k8s采集程序对外暴露的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("node-exporter-ds.yml")]),s._v(" "),t("td",[s._v("node_exporter部署的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("node-exporter-service.yaml")]),s._v(" "),t("td",[s._v("node_exporter对外暴露的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("prometheus-configmap.yaml")]),s._v(" "),t("td",[s._v("prometheus的配置文件集")])]),s._v(" "),t("tr",[t("td",[s._v("prometheus-pv-pvc.yaml")]),s._v(" "),t("td",[s._v("prometheus挂载存储的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("prometheus-rbac.yaml")]),s._v(" "),t("td",[s._v("prometheus授权访问api的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("prometheus-rules-pvc.yaml")]),s._v(" "),t("td",[s._v("prometheus告警规则存储卷的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("prometheus-rules.yaml")]),s._v(" "),t("td",[s._v("prometheus将rule做成cm资源的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("prometheus-service.yaml")]),s._v(" "),t("td",[s._v("prometheus对外提供访问的yaml文件")])]),s._v(" "),t("tr",[t("td",[s._v("prometheus-statefulset-static-pv.yaml")]),s._v(" "),t("td",[s._v("prometheus程序部署的yaml文件")])])])]),s._v(" "),t("h3",{attrs:{id:"_2-4-创建命名空间prometheus"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-创建命名空间prometheus"}},[s._v("#")]),s._v(" 2.4.创建命名空间prometheus")]),s._v(" "),t("p",[s._v("创建一个ns为prometheus，将除了kube-state-metrics外的yaml中的namespace修改为prometheus")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".创建ns\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create namespace prometheus")]),s._v("\nnamespace/prometheus created\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".修改\n用vim打开输入以下命令\n:%s/namespace: kube-system/namespace: prometheus/g\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h2",{attrs:{id:"_3-在k8s中部署prometheus"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-在k8s中部署prometheus"}},[s._v("#")]),s._v(" 3.在k8s中部署prometheus")]),s._v(" "),t("h3",{attrs:{id:"_3-1-prometheus-yaml准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-prometheus-yaml准备"}},[s._v("#")]),s._v(" 3.1.prometheus-yaml准备")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("主要用到以下几个yaml\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls prometheus-*")]),s._v("\nprometheus-configmap.yaml  prometheus-rbac.yaml  prometheus-service.yaml  prometheus-statefulset.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("创建顺序")]),s._v(" "),t("blockquote",[t("p",[s._v("先创建prometheus-rbac.yaml")]),s._v(" "),t("p",[s._v("在创建prometheus-configmap.yaml")]),s._v(" "),t("p",[s._v("在创建prometheus-statefulset.yaml")]),s._v(" "),t("p",[s._v("最后创建prometheus-service.yaml")])]),s._v(" "),t("h3",{attrs:{id:"_3-2-创建rbac资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-创建rbac资源"}},[s._v("#")]),s._v(" 3.2.创建rbac资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f prometheus-rbac.yaml ")]),s._v("\nserviceaccount/prometheus created\nclusterrole.rbac.authorization.k8s.io/prometheus created\nclusterrolebinding.rbac.authorization.k8s.io/prometheus created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"_3-3-创建configmap资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-创建configmap资源"}},[s._v("#")]),s._v(" 3.3.创建configmap资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f prometheus-configmap.yaml ")]),s._v("\nconfigmap/prometheus-config created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_3-4-创建statefulset资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-创建statefulset资源"}},[s._v("#")]),s._v(" 3.4.创建statefulset资源")]),s._v(" "),t("p",[s._v("github上的statefulset资源使用的是storageclasee动态创建pv，由于不会使用storageclass，因此将statefulset资源进行改造，使用静态pv做存储")]),s._v(" "),t("h4",{attrs:{id:"_3-4-1-改造statefulst资源支持静态pv"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-1-改造statefulst资源支持静态pv"}},[s._v("#")]),s._v(" 3.4.1.改造statefulst资源支持静态pv")]),s._v(" "),t("p",[s._v("改造思路：在yaml中增加pv、pvc的配置，在将原来的storageclass配置项删除，在120行的volume中增加pvc的配置即可")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim prometheus-statefulset-static-pv.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolumeClaim\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 16Gi\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolume\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prometheus\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("capacity")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 16Gi\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nfs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data/prometheus/prometheus_data\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.16.105\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" StatefulSet\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/cluster-service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addonmanager.kubernetes.io/mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Reconcile\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v2.2.1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prometheus"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podManagementPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Parallel"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("updateStrategy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RollingUpdate"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("priorityClassName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" system"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("critical\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceAccountName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initContainers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"init-chown-data"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"busybox:latest"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"IfNotPresent"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chown"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-R"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"65534:65534"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("configmap"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("reload\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jimmidyson/configmap-reload:v0.1"')]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"IfNotPresent"')]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("volume"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dir=/etc/config\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("url=http"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("9090/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("/reload\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("volume\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/config\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readOnly")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10m\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10Mi\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10m\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10Mi\n\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prom/prometheus:v2.23.0"')]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"IfNotPresent"')]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config.file=/etc/config/prometheus.yml\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage.tsdb.path=/data\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("web.console.libraries=/etc/prometheus/console_libraries\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("web.console.templates=/etc/prometheus/consoles\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("web.enable"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("lifecycle\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readinessProbe")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("httpGet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("/ready\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initialDelaySeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeoutSeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("livenessProbe")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("httpGet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("/healthy\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initialDelaySeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeoutSeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# based on 10 running nodes with 30 pods each")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 200m\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1000Mi\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 200m\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1000Mi\n\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("volume\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/config\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("terminationGracePeriodSeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("volume\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("configMap")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("persistentVolumeClaim")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("claimName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br"),t("span",{staticClass:"line-number"},[s._v("85")]),t("br"),t("span",{staticClass:"line-number"},[s._v("86")]),t("br"),t("span",{staticClass:"line-number"},[s._v("87")]),t("br"),t("span",{staticClass:"line-number"},[s._v("88")]),t("br"),t("span",{staticClass:"line-number"},[s._v("89")]),t("br"),t("span",{staticClass:"line-number"},[s._v("90")]),t("br"),t("span",{staticClass:"line-number"},[s._v("91")]),t("br"),t("span",{staticClass:"line-number"},[s._v("92")]),t("br"),t("span",{staticClass:"line-number"},[s._v("93")]),t("br"),t("span",{staticClass:"line-number"},[s._v("94")]),t("br"),t("span",{staticClass:"line-number"},[s._v("95")]),t("br"),t("span",{staticClass:"line-number"},[s._v("96")]),t("br"),t("span",{staticClass:"line-number"},[s._v("97")]),t("br"),t("span",{staticClass:"line-number"},[s._v("98")]),t("br"),t("span",{staticClass:"line-number"},[s._v("99")]),t("br"),t("span",{staticClass:"line-number"},[s._v("100")]),t("br"),t("span",{staticClass:"line-number"},[s._v("101")]),t("br"),t("span",{staticClass:"line-number"},[s._v("102")]),t("br"),t("span",{staticClass:"line-number"},[s._v("103")]),t("br"),t("span",{staticClass:"line-number"},[s._v("104")]),t("br"),t("span",{staticClass:"line-number"},[s._v("105")]),t("br"),t("span",{staticClass:"line-number"},[s._v("106")]),t("br"),t("span",{staticClass:"line-number"},[s._v("107")]),t("br"),t("span",{staticClass:"line-number"},[s._v("108")]),t("br"),t("span",{staticClass:"line-number"},[s._v("109")]),t("br"),t("span",{staticClass:"line-number"},[s._v("110")]),t("br"),t("span",{staticClass:"line-number"},[s._v("111")]),t("br"),t("span",{staticClass:"line-number"},[s._v("112")]),t("br"),t("span",{staticClass:"line-number"},[s._v("113")]),t("br"),t("span",{staticClass:"line-number"},[s._v("114")]),t("br"),t("span",{staticClass:"line-number"},[s._v("115")]),t("br"),t("span",{staticClass:"line-number"},[s._v("116")]),t("br"),t("span",{staticClass:"line-number"},[s._v("117")]),t("br"),t("span",{staticClass:"line-number"},[s._v("118")]),t("br"),t("span",{staticClass:"line-number"},[s._v("119")]),t("br"),t("span",{staticClass:"line-number"},[s._v("120")]),t("br"),t("span",{staticClass:"line-number"},[s._v("121")]),t("br"),t("span",{staticClass:"line-number"},[s._v("122")]),t("br"),t("span",{staticClass:"line-number"},[s._v("123")]),t("br"),t("span",{staticClass:"line-number"},[s._v("124")]),t("br"),t("span",{staticClass:"line-number"},[s._v("125")]),t("br"),t("span",{staticClass:"line-number"},[s._v("126")]),t("br")])]),t("h4",{attrs:{id:"_3-4-2-创建statefulset资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-2-创建statefulset资源"}},[s._v("#")]),s._v(" 3.4.2.创建statefulset资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f  prometheus-statefulset-static-pv.yaml ")]),s._v("\npersistentvolumeclaim/prometheus-data created\npersistentvolume/pv-prometheus created\nstatefulset.apps/prometheus created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"_3-5-创建service资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-创建service资源"}},[s._v("#")]),s._v(" 3.5.创建service资源")]),s._v(" "),t("h4",{attrs:{id:"_3-5-1-修改service资源支持nodeport"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-1-修改service资源支持nodeport"}},[s._v("#")]),s._v(" 3.5.1.修改service资源支持nodeport")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim prometheus-service.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Prometheus"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/cluster-service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addonmanager.kubernetes.io/mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Reconcile\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("h4",{attrs:{id:"_3-5-2-创建service资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-2-创建service资源"}},[s._v("#")]),s._v(" 3.5.2.创建service资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f prometheus-service.yaml ")]),s._v("\nservice/prometheus created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_3-6-查看创建的prometheus所有资源类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-查看创建的prometheus所有资源类型"}},[s._v("#")]),s._v(" 3.6.查看创建的prometheus所有资源类型")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod,svc,pv,pvc -n prometheus -o wide")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171837694.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("主要访问30387端口看到prometheus")]),s._v(" "),t("h3",{attrs:{id:"_3-7-访问prometheus"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-访问prometheus"}},[s._v("#")]),s._v(" 3.7.访问prometheus")]),s._v(" "),t("p",[s._v("使用任意node节点的ip加30387端口即可访问：http://192.168.16.106:30387/")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171846551.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("查看监控主机")]),s._v(" "),t("p",[s._v("可以看到已经有很多了，这些配置都是configmap资源中配置的\n"),t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171854253.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_3-8-prometheus配置文件解释"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-prometheus配置文件解释"}},[s._v("#")]),s._v(" 3.8.prometheus配置文件解释")]),s._v(" "),t("h4",{attrs:{id:"_3-8-1-进入prometheus容器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-1-进入prometheus容器"}},[s._v("#")]),s._v(" 3.8.1.进入prometheus容器")]),s._v(" "),t("p",[s._v("语法：kubectl exec -it pod名 进入的环境 -c 容器名称 -n 命名空间")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it prometheus-0 sh -c prometheus-server -n prometheus")]),s._v("\n/prometheus $ \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("配置文件位于:/etc/config/prometheus.yml")]),s._v(" "),t("p",[s._v("tsdb存储位于:/data")]),s._v(" "),t("h4",{attrs:{id:"_3-8-2-配置文件解释"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-2-配置文件解释"}},[s._v("#")]),s._v(" 3.8.2.配置文件解释")]),s._v(" "),t("p",[s._v("/prometheus $ more /etc/config/prometheus.yml")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scrape_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("job_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("static_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targets")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("\n    \n静态配置，将本机加到了prometheus监控，这个localhost就是运行prometheus容器的地址\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[t("strong",[s._v("kubernetes-apiservers自动发现")])]),s._v(" "),t("p",[s._v("将apiserver的地址进行暴露并获取监控指标")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("job_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("apiservers\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes_sd_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" endpoints\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("relabel_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" keep\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" default;kubernetes;https\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_namespace\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_service_name\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_endpoint_port_name\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scheme")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" https\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tls_config")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ca_file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("insecure_skip_verify")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bearer_token_file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/run/secrets/kubernetes.io/serviceaccount/token\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171909965.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("k8s的node节点自动发现")])]),s._v(" "),t("p",[s._v("自动发现k8s中的所有node节点并进行监控")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("- job_name: kubernetes-nodes-cadvisor\n  kubernetes_sd_configs:\n  - role: "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  - target_label: __metrics_path__\n    replacement: /metrics/cadvisor\n  scheme: https\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    insecure_skip_verify: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171919584.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("发现endpoint的资源")])]),s._v(" "),t("p",[s._v("主要是发现endpoint资源类型的pod，可以通过kubectl get ep查看谁是endpoint资源")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("job_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("endpoints\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes_sd_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" endpoints\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("relabel_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" keep\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_service_annotation_prometheus_io_scrape\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" (https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v(")\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_service_annotation_prometheus_io_scheme\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __scheme__\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" (.+)\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_service_annotation_prometheus_io_path\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __metrics_path__\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ("),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("^"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("+)("),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\\d+)"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v(";(\\d+)\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replacement")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$2\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __address__\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_service_annotation_prometheus_io_port\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __address__\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" labelmap\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __meta_kubernetes_service_label_(.+)\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_namespace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes_namespace\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_service_name\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes_name\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171929948.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("发现services")])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("job_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("services\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes_sd_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" service\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metrics_path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /probe\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("params")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("module")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" http_2xx\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("relabel_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" keep\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_service_annotation_prometheus_io_probe\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __address__\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __param_target\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replacement")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" blackbox\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __address__\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __param_target\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" instance\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" labelmap\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __meta_kubernetes_service_label_(.+)\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_namespace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes_namespace\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" __meta_kubernetes_service_name\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes_name\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("p",[t("strong",[s._v("发现pod")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("- job_name: kubernetes-pods\n  kubernetes_sd_configs:\n  - role: pod\n  relabel_configs:\n  - action: keep\n    regex: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    source_labels:\n    - __meta_kubernetes_pod_annotation_prometheus_io_scrape\n  - action: replace\n    regex: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    source_labels:\n    - __meta_kubernetes_pod_annotation_prometheus_io_path\n    target_label: __metrics_path__\n  - action: replace\n    regex: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("^:"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("?::"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("d+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("?"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("d+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    replacement: "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),s._v("\n    source_labels:\n    - __address__\n    - __meta_kubernetes_pod_annotation_prometheus_io_port\n    target_label: __address__\n  - action: labelmap\n    regex: __meta_kubernetes_pod_label_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  - action: replace\n    source_labels:\n    - __meta_kubernetes_namespace\n    target_label: kubernetes_namespace\n  - action: replace\n    source_labels:\n    - __meta_kubernetes_pod_name\n    target_label: kubernetes_pod_name\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("h3",{attrs:{id:"_3-9-k8s-metrics页面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-k8s-metrics页面"}},[s._v("#")]),s._v(" 3.9.k8s metrics页面")]),s._v(" "),t("p",[s._v("metrics页面访问如下也没关系，metrics貌似只能集群内部进行访问")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171942988.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("只要能在prometheus搜索到container数据就可以")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106171951255.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"_4-在k8s中部署grafana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-在k8s中部署grafana"}},[s._v("#")]),s._v(" 4.在k8s中部署grafana")]),s._v(" "),t("h3",{attrs:{id:"_4-1-编写granfana-pv-pvc资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-编写granfana-pv-pvc资源"}},[s._v("#")]),s._v(" 4.1.编写granfana-pv-pvc资源")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("1.编写资源\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim grafana_pv_pvc.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolumeClaim\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ui"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ui\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 3Gi\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolume\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ui"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ui\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("capacity")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 3Gi\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nfs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data/prometheus/grafana\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.16.105\n    \n2.在nfs上创建对应的挂载点\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /data/prometheus/grafana")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("h3",{attrs:{id:"_4-2-编写granfana-statefulset资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-编写granfana-statefulset资源"}},[s._v("#")]),s._v(" 4.2.编写granfana-statefulset资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim grafana_statefulset.yaml ")]),s._v("\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: grafana-ui\n  namespace: grafana-ui\nspec:\n  serviceName: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grafana-ui"')]),s._v("\n  replicas: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  selector:\n    matchLabels:\n      app: grafana-ui\n  template:\n    metadata:\n      labels:\n        app: grafana-ui\n    spec:\n      containers:\n      - name: grafana-ui\n        image: grafana/grafana:6.6.2\n        imagePullPolicy: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"IfNotPresent"')]),s._v("\n        ports:\n          - containerPort: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\n            protocol: TCP\n        resources:\n          limits:\n            cpu: 100m\n            memory: 256Mi\n          requests:\n            cpu: 100m\n            memory: 256Mi\n        volumeMounts:\n          - name: grafana-ui-data\n            mountPath: /var/lib/grafana\n            subPath: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      securityContext:\n        fsGroup: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("472")]),s._v("\n        runAsUser: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("472")]),s._v("\n      volumes:\n        - name: grafana-ui-data\n          persistentVolumeClaim:\n            claimName: grafana-ui-data\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br")])]),t("h3",{attrs:{id:"_4-3-编写granfana-svc资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-编写granfana-svc资源"}},[s._v("#")]),s._v(" 4.3.编写granfana-svc资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim grafana_svc.yaml ")]),s._v("\napiVersion: v1\nkind: Service\nmetadata:\n  name: grafana-ui\n  namespace: grafana-ui\nspec:\n  type: NodePort\n  ports:\n    - name: http\n      port: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\n      protocol: TCP\n      targetPort: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\n  selector:\n    app: grafana-ui\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("h3",{attrs:{id:"_4-4-k8s创建grafana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-k8s创建grafana"}},[s._v("#")]),s._v(" 4.4.k8s创建grafana")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f grafana_pv_pvc.yaml ")]),s._v("\npersistentvolumeclaim "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grafana-ui-data"')]),s._v(" created\npersistentvolume "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pv-grafana-ui-data"')]),s._v(" created\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f prometheus-statefulset-static-pv.yaml")]),s._v("\npersistentvolumeclaim/prometheus-data created\npersistentvolume/pv-prometheus created\nstatefulset.apps/prometheus created\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f grafana_svc.yaml ")]),s._v("\nservice/grafana-ui created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h3",{attrs:{id:"_4-5-查看资源运行状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-查看资源运行状态"}},[s._v("#")]),s._v(" 4.5.查看资源运行状态")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pv,pvc,pod,statefulset,svc -n grafana-ui")]),s._v("\nNAME                                  CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS        CLAIM                         STORAGECLASS   REASON   AGE\npersistentvolume/pv-grafana-ui-data   3Gi        RWO            Retain           Terminating   grafana-ui/grafana-ui-data                            151m\npersistentvolume/pv-prometheus        16Gi       RWO            Retain           Bound         kube-system/prometheus-data                           47m\n\nNAME                                    STATUS        VOLUME               CAPACITY   ACCESS MODES   STORAGECLASS   AGE\npersistentvolumeclaim/grafana-ui-data   Terminating   pv-grafana-ui-data   3Gi        RWO                           151m\n\nNAME               READY   STATUS    RESTARTS   AGE\npod/grafana-ui-0   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16m\n\nNAME                          READY   AGE\nstatefulset.apps/grafana-ui   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     16m\n\nNAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("          AGE\nservice/grafana-ui   NodePort   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".170.142   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(":32040/TCP   85m\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172010434.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_4-6-登陆grafana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-登陆grafana"}},[s._v("#")]),s._v(" 4.6.登陆grafana")]),s._v(" "),t("p",[s._v("访问：集群任意ip和32040端口即可访问")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172018940.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_4-7-导入k8s资源监控pod资源模板"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-7-导入k8s资源监控pod资源模板"}},[s._v("#")]),s._v(" 4.7.导入k8s资源监控pod资源模板")]),s._v(" "),t("p",[s._v("推荐模板：")]),s._v(" "),t("ul",[t("li",[s._v("集群资源监控：3119")]),s._v(" "),t("li",[s._v("资源状态监控：6417")]),s._v(" "),t("li",[s._v("node监控：9276")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172028210.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("导入成功")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172037255.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_4-8-解决模板表达式问题无法展现所有pod"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-解决模板表达式问题无法展现所有pod"}},[s._v("#")]),s._v(" 4.8.解决模板表达式问题无法展现所有pod")]),s._v(" "),t("h4",{attrs:{id:"_4-8-1-问题描述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-1-问题描述"}},[s._v("#")]),s._v(" 4.8.1.问题描述")]),s._v(" "),t("p",[s._v("模板中的图形关于pod和docker的全部有问题，仅单单显示一个pod")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172046186.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h4",{attrs:{id:"_4-8-2-问题解决"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-2-问题解决"}},[s._v("#")]),s._v(" 4.8.2.问题解决")]),s._v(" "),t("p",[s._v("修改他们的表达式就可以了，将pod_name修改为pod")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172056945.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("修改为立马显示出所有pod，所有关于pod和docker的都是这么改")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172106157.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("最终展示效果")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172114765.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"_5-监控k8s-node节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-监控k8s-node节点"}},[s._v("#")]),s._v(" 5.监控k8s node节点")]),s._v(" "),t("p",[s._v("对于node节点的监控我们不用部署在k8s里，直接在每台node机器上安装node_exporter即可")]),s._v(" "),t("h3",{attrs:{id:"_5-1-编写一键部署node-exporter脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-编写一键部署node-exporter脚本"}},[s._v("#")]),s._v(" 5.1.编写一键部署node_exporter脚本")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim install_node_exportes.sh ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#批量安装node_exporter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("soft_dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/root/soft\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$soft_dir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$soft_dir")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" -lnpt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9100")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("use")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" -lnpt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9100")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" -F/ "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $NF}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9100端口已经被占用，占用者是 '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$use")]),s._v('"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$soft_dir")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://192.168.16.106:888/prometheus/node_exporter-1.0.1.linux-amd64.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xf node_exporter-1.0.1.linux-amd64.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" node_exporter-1.0.1.linux-amd64 /usr/local/node_exporter\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),t("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/usr/lib/systemd/system/node_exporter.service")]),s._v("\n[Unit]\nDescription=https://prometheus.io\n\n[Service]\nRestart=on-failure\nExecStart=/usr/local/node_exporter/node_exporter --collector.systemd --collector.systemd.unit-whitelist=(docker|kubelet|node_exporter).service\n\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n\nsystemctl daemon-reload\nsystemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" node_exporter\nsystemctl restart node_exporter\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" -lnpt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9100")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        ehoc "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node_eporter install finish..."')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br")])]),t("h3",{attrs:{id:"_5-2-对k8s的node进行执行node-exporter脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-对k8s的node进行执行node-exporter脚本"}},[s._v("#")]),s._v(" 5.2.对k8s的node进行执行node_exporter脚本")]),s._v(" "),t("p",[s._v("在这里下载脚本用就行了")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172136934.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget http://192.168.16.106:888/install_node_exportes.sh")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sh install_node_exportes.sh ")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  netstat -lnpt | grep 9100")]),s._v("\ntcp6       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" :::9100                 :::*                    LISTEN      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14906")]),s._v("/node_exporter \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"_5-3-在prometheus的configmap资源中增加node节点配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-在prometheus的configmap资源中增加node节点配置"}},[s._v("#")]),s._v(" 5.3.在prometheus的configmap资源中增加node节点配置")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim prometheus-configmap.yaml ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("job_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("static_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targets")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 192.168.16.104"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9100")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 192.168.16.107"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9100")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172150508.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("更新配置")])]),s._v(" "),t("p",[s._v("更新完配置，prometheus页面会立马显示，因此每当configmap一修改，prometheus容器就会重载")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f prometheus-configmap.yaml")]),s._v("\nconfigmap/prometheus-config created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("成功添加node监控")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172200609.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_5-4-导入k8s-node主机监控模板"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-导入k8s-node主机监控模板"}},[s._v("#")]),s._v(" 5.4.导入k8s node主机监控模板")]),s._v(" "),t("p",[s._v("node监控：9276")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172210569.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("填写信息")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172219328.png",alt:"在这里插入图片描述"}}),s._v(" "),t("strong",[s._v("查看图形")]),s._v(" "),t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172235454.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"_6-k8s使用kube-state-metrics-监控资源状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-k8s使用kube-state-metrics-监控资源状态"}},[s._v("#")]),s._v(" 6.k8s使用kube-state-metrics-监控资源状态")]),s._v(" "),t("h3",{attrs:{id:"_6-1-创建rbac资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-创建rbac资源"}},[s._v("#")]),s._v(" 6.1.创建rbac资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create kube-state-metrics-rbac.yaml ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_6-2-创建deployment资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-创建deployment资源"}},[s._v("#")]),s._v(" 6.2.创建deployment资源")]),s._v(" "),t("p",[s._v("deployment资源里面结合了configmap资源")]),s._v(" "),t("p",[s._v("需要把镜像的地址修改成lizhenliang/kube-state-metrics:v1.8.0、lizhenliang/addon-resizer:1.8.6")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f kube-state-metrics-deployment.yaml ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172259875.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_6-3-创建service资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-创建service资源"}},[s._v("#")]),s._v(" 6.3.创建service资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f kube-state-metrics-service.yaml ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_6-4-资源准备就绪"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-资源准备就绪"}},[s._v("#")]),s._v(" 6.4.资源准备就绪")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get all -n kube-system | grep kube-state")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172316131.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_6-5-在prometheus查看是否获取监控指标"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-在prometheus查看是否获取监控指标"}},[s._v("#")]),s._v(" 6.5.在prometheus查看是否获取监控指标")]),s._v(" "),t("p",[s._v("安装完kube-state-metrics之后，直接就可以在prometheus上查询监控指标，都是以kube开头的")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172326163.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_6-6-导入k8s-资源状态模板"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-导入k8s-资源状态模板"}},[s._v("#")]),s._v(" 6.6.导入k8s 资源状态模板")]),s._v(" "),t("p",[s._v("资源状态监控：6417")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/2021010617233747.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("查看图形，也是有很多监控不到")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172345276.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"_7-在k8s中部署alertmanager实现告警系统"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-在k8s中部署alertmanager实现告警系统"}},[s._v("#")]),s._v(" 7.在k8s中部署alertmanager实现告警系统")]),s._v(" "),t("h3",{attrs:{id:"_7-1-创建alertmanager-pv-pvc资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-创建alertmanager-pv-pvc资源"}},[s._v("#")]),s._v(" 7.1.创建alertmanager-pv-pvc资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".编写yaml\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim alertmanager-pvc.yaml ")]),s._v("\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: alertmanager-data\n  namespace: alertmanager\n  labels:\n    kubernetes.io/cluster-service: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n    addonmanager.kubernetes.io/mode: EnsureExists\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2Gi"')]),s._v("\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv-alertmanager-data\n  namespace: alertmanager\nspec:\n  capacity:\n    storage: 2Gi\n  accessModes:\n    - ReadWriteOnce\n  nfs:\n    path: /data/prometheus/alertmanager\n    server: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".16.105\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".创建\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f alertmanager-pvc.yaml")]),s._v("\npersistentvolumeclaim/alertmanager created\npersistentvolume/pv-alertmanager-data create\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br")])]),t("h3",{attrs:{id:"_7-2-创建alertmanager-cm资源增加微信告警配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-创建alertmanager-cm资源增加微信告警配置"}},[s._v("#")]),s._v(" 7.2.创建alertmanager-cm资源增加微信告警配置")]),s._v(" "),t("p",[s._v("增加微信报警")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".增加微信告警配置\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim alertmanager-configmap.yaml ")]),s._v("\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: alertmanager-config\n  namespace: alertmanager\n  labels:\n    kubernetes.io/cluster-service: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n    addonmanager.kubernetes.io/mode: EnsureExists\ndata:\n  alertmanager.yml: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n    global:\n      resolve_timeout: 5m\n\n    receivers:\n    - name: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'wechat'")]),s._v("\n      wechat_configs:\n        - corp_id: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ww48f74fc8ed3a07ba'")]),s._v("\n          to_party: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),s._v("\n          agent_id: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1000003'")]),s._v("\n          api_secret: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'j3ocaGJJM7KejlqzBIJ38b6D6t9QhqlIAh7k4fA1cT0'")]),s._v("\n          send_resolved: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n\n    route:\n      group_interval: 1m\n      group_wait: 10s\n      receiver: wechat\n      repeat_interval: 1m\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".创建资源\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f alertmanager-configmap.yaml ")]),s._v("\nconfigmap/alertmanager-config created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br")])]),t("h3",{attrs:{id:"_7-3-创建alertmanager-deployment资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-创建alertmanager-deployment资源"}},[s._v("#")]),s._v(" 7.3.创建alertmanager-deployment资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f alertmanager-deployment.yaml ")]),s._v("\ndeployment.apps/alertmanager created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_7-4-创建alertmanager-service资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-4-创建alertmanager-service资源"}},[s._v("#")]),s._v(" 7.4.创建alertmanager-service资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f alertmanager-service.yaml")]),s._v("\nservice/alertmanager created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_7-5查看alertmanager所有资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-5查看alertmanager所有资源"}},[s._v("#")]),s._v(" 7.5查看alertmanager所有资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get all,pv,pvc,cm -n alertmanager")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172401946.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_7-6-访问alertmanager"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-6-访问alertmanager"}},[s._v("#")]),s._v(" 7.6.访问alertmanager")]),s._v(" "),t("p",[s._v("任意node节点+31831端口即可")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172410897.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("配置文件已经支持微信报警")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172419513.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"_8-配置alertmanager实现k8s告警系统"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-配置alertmanager实现k8s告警系统"}},[s._v("#")]),s._v(" 8.配置alertmanager实现k8s告警系统")]),s._v(" "),t("h3",{attrs:{id:"_8-1-在nfs上准备两个告警规则文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-在nfs上准备两个告警规则文件"}},[s._v("#")]),s._v(" 8.1.在NFS上准备两个告警规则文件")]),s._v(" "),t("p",[s._v("我们对于告警规则文件不采用configmap的方式而是采用pv、pvc的方式把告警规则挂载到容器里")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".在nfs上创建pv存储路径\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /data/prometheus/rules")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod -R 777 /data")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /data/prometheus/rules")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".准备主机宕机的告警规则文件\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs rules"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim hostdown.yml ")]),s._v("\ngroups:\n- name: general.rules\n  rules:\n  - alert: 主机宕机\n    expr: up "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    for: 1m\n    labels:\n      serverity: error\n    annotations:\n      summary: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"主机 {{ '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v('.instance }} 停止工作"')]),s._v("\n      description: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v(".instance }} job {{ "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v('.job }} 已经宕机5分钟以上!"')]),s._v("\n      \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".准备主机基础监控告警规则文件      \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs rules"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim node.yml ")]),s._v("\ngroups:\n- name: node.rules\n  rules:\n  - alert: NodeFilessystemUsage\n    expr: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" - "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("node_filesystem_free_bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("fstype"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=~")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ext4|xfs"')]),s._v(",mountpoint"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" / node_filesystem_size_bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("fstype"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=~")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ext4|xfs"')]),s._v(",mountpoint"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" *100"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    for: 1m\n    labels:\n      serverity: warning\n    annotations:\n      summary: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"主机 {{ '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v(".instance }} : {{ "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v('.mountpoint }} 磁盘使用率过高"')]),s._v("\n      description: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v(".instance }} : {{ "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v(".mountpoint }} 磁盘使用率超过80% (当前值: {{ "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$value")]),s._v(' }}) "')]),s._v("\n\n  - alert: NodeMemoryUsage\n    expr: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" - "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("((")]),s._v("node_memory_MemFree_bytes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("node_memory_Cached_bytes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("node_memory_Buffers_bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" node_memory_MemTotal_bytes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    for"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("m\n    labels"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      serverity"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" warning\n    annotations"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      summary"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(' "主机 {{ $labels.instance }} 内存使用率过高"\n      description'),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(' "{{ $labels.instance }} 内存使用率超过'),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("当前值"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" {{ $value }}"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(' "\n\n  '),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" alert"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" NodeCpuUsage\n    expr"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("avg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("irate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("node_cpu_seconds_total{mode"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("'idle'}["),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("m]"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")])]),s._v(" by "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" *100"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    for: 1m\n    labels:\n      serverity: warning\n    annotations:\n      summary: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"主机 {{ '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v('.instance }} CPU使用率过高"')]),s._v("\n      description: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v(".instance }} CPU使用率超过80% (当前值: {{ "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$value")]),s._v(' }}) "')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br")])]),t("h3",{attrs:{id:"_8-2-编写rules告警规则的pv、pvcyaml文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-编写rules告警规则的pv、pvcyaml文件"}},[s._v("#")]),s._v(" 8.2.编写rules告警规则的pv、pvcyaml文件")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".编写资源文件\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim prometheus-rules-pvc.yaml ")]),s._v("\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: prometheus-rules\n  namespace: kube-system\n  labels:\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2Gi"')]),s._v("\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv-prometheus-rules\nspec:\n  capacity:\n    storage: 2Gi\n  accessModes:\n    - ReadWriteOnce\n  nfs:\n    path: /data/prometheus/rules\n    server: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".16.105\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".创建资源\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f prometheus-rules-pvc.yaml")]),s._v("\npersistentvolumeclaim/prometheus-rules created\npersistentvolume/pv-prometheus-rules created\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br")])]),t("h3",{attrs:{id:"_8-3-修改prometheus的statefulset资源集成rules"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-修改prometheus的statefulset资源集成rules"}},[s._v("#")]),s._v(" 8.3.修改prometheus的statefulset资源集成rules")]),s._v(" "),t("p",[s._v("在prometheus的statefulset资源中增加rules的pvc挂载路径")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim prometheus-statefulset-static-pv.yaml ")]),s._v("\n          volumeMounts:\n            - name: config-volume\n              mountPath: /etc/config\n            - name: prometheus-rules\n              mountPath: /etc/config/rules\n            - name: prometheus-data\n              mountPath: /data\n              subPath: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      terminationGracePeriodSeconds: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n      volumes:\n        - name: config-volume\n          configMap:\n            name: prometheus-config\n        - name: prometheus-rules\n          persistentVolumeClaim:\n            claimName: prometheus-rules\n        - name: prometheus-data\n          persistentVolumeClaim:\n            claimName: prometheus-data\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172451817.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_8-4-更新prometheus-statefulset资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-更新prometheus-statefulset资源"}},[s._v("#")]),s._v(" 8.4.更新prometheus-statefulset资源")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f prometheus-statefulset-static-pv.yaml ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_8-5-修改prometheus-configmap资源配置alertmanager地址"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-修改prometheus-configmap资源配置alertmanager地址"}},[s._v("#")]),s._v(" 8.5.修改prometheus-configmap资源配置alertmanager地址")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".修改配置增加alertmanager地址\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim prometheus-configmap.yaml ")]),s._v("\n    alerting:\n      alertmanagers:\n      - static_configs:\n        - targets:\n          - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".16.106:31831\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".更新资源\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master ~/k8s/prometheus3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f prometheus-configmap.yaml")]),s._v("\nconfigmap/prometheus-config configured      \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h3",{attrs:{id:"_8-5-查看页面是否增加告警规则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-查看页面是否增加告警规则"}},[s._v("#")]),s._v(" 8.5.查看页面是否增加告警规则")]),s._v(" "),t("p",[s._v("已经成功填加rules告警规则")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172502911.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h3",{attrs:{id:"_8-6-模拟node主机宕机并查看微信告警内容"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-6-模拟node主机宕机并查看微信告警内容"}},[s._v("#")]),s._v(" 8.6.模拟node主机宕机并查看微信告警内容")]),s._v(" "),t("p",[t("strong",[s._v("模拟触发告警")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("将任意一个node节点的node_exporter停掉即可\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl stop node_exporter")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("告警已经产生")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172537744.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("告警消息已经发送")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172545238.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("查看告警内容")])]),s._v(" "),t("p",[s._v("已经成功收到告警，k8s监控系列篇到此结束")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://agou-images.oss-cn-qingdao.aliyuncs.com/others/20210106172554537.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("blockquote",[t("p",[s._v("该文章为转载内容，仅做备份私人学习使用，原文：https://jiangxl.blog.csdn.net/article/details/112283085")])])])}),[],!1,null,null,null);a.default=e.exports}}]);